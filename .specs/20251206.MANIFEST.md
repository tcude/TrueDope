# TrueDope v2 - Project Manifest

**Created**: December 6, 2024
**Status**: Planning
**Goal**: Complete rewrite with unified session-based architecture, modern React frontend, and improved UX

---

## Executive Summary

TrueDope v1 was built as a DOPE recording tool and grew organically to include velocity and group tracking. This resulted in two parallel, disconnected recording systems (`ShootingRecord` for DOPE, `ShootingString` for velocity/groups) with duplicated metadata and a clunky user experience.

TrueDope v2 introduces a **session-first architecture** where a single `RangeSession` entity serves as the anchor, with DOPE, chrono, and group data as optional children. This fundamental model change, combined with a React frontend rewrite, will deliver a cleaner UX and more maintainable codebase.

---

## What's Changing

### Data Model
| v1 | v2 | Change |
|----|----|----|
| `ShootingRecord` | `RangeSession` | Unified session concept |
| `ShootingString` | `ChronoSession` | Clearer naming, child of RangeSession |
| `DistanceHold` | `DopeEntry` | Child of RangeSession |
| `GroupData` | `GroupEntry` | No longer nested under chrono |
| `IndividualShot` | `VelocityReading` | Clearer naming |
| `SessionType` enum | Removed | Replaced by presence of child data |
| Dual ammo system | Linked only | Remove legacy manual ammo fields |

### Technology Stack
| Component | v1 | v2 |
|-----------|----|----|
| Backend | ASP.NET Core 8 + Razor Pages | ASP.NET Core 8 API only |
| Frontend | Razor Pages (server-rendered) | React + Vite + Tailwind |
| Database | PostgreSQL 15 | PostgreSQL 15 (new schema) |
| Object Storage | MinIO | MinIO (evaluate alternatives later) |
| Mobile | Swift/SwiftUI (in progress) | Swift/SwiftUI (update for new API) |

### Features
| Feature | Status in v2 |
|---------|--------------|
| Session recording (DOPE, Chrono, Groups) | Unified flow |
| Rifle management | Carry over |
| Ammunition library + lots | Carry over |
| Saved locations | Carry over |
| Weather auto-fetch | Carry over |
| Image uploads (HEIC conversion, thumbnails) | Carry over |
| DOPE Charts | Carry over |
| Velocity trends | Carry over |
| Ammo comparison | Carry over |
| Lot comparison | Carry over |
| Cost analysis | Carry over |
| Analytics dashboard | Carry over |
| Admin panel | Carry over |
| **Ballistic Calculator** | **Intentionally not included** |
| Unit preferences (MOA/MIL, Imperial/Metric) | New in v2 |

---

## Phase Overview

### Phase 1: Project Setup & Infrastructure
Set up the new project structure, development environment, and CI/CD pipeline.

- Initialize monorepo structure (`backend/`, `frontend/`)
- Set up .NET 8 Web API project with clean architecture
- Set up React + Vite + TypeScript + Tailwind project
- Configure Docker Compose for local development (PostgreSQL, MinIO, Redis)
- Set up GitHub repository and Actions for CI
- Configure deployment pipeline to new VM
- Create base configuration (appsettings, environment variables)
- Set up logging and error handling patterns

**Deliverable**: Empty but runnable project with full dev/deploy infrastructure

---

### Phase 2: Authentication & User Management
Implement user authentication and basic user management.

- Implement ASP.NET Core Identity with PostgreSQL
- JWT token generation and refresh flow
- Registration endpoint (email, password, first name, last name)
- Login/logout endpoints
- Password reset flow (SMTP integration)
- React auth context and protected routes
- Login/Register pages
- User settings page (profile, password change)
- Admin user management (list users, basic admin functions)

**Deliverable**: Working auth system with login/register UI

---

### Phase 3: Core Data Model & API
Implement the new unified data model and CRUD APIs.

- Define EF Core entities:
  - `RangeSession` (the unified anchor)
  - `DopeEntry` (DOPE holds)
  - `ChronoSession` (velocity session)
  - `VelocityReading` (individual shots)
  - `GroupEntry` (group data)
  - `RifleSetup`
  - `Ammunition`
  - `AmmoLot`
  - `SavedLocation`
  - `Image`
- Configure entity relationships and constraints
- Create initial EF migration
- Implement repository/service layer
- Build REST API endpoints:
  - `/api/sessions` - full CRUD with nested data
  - `/api/rifles` - CRUD
  - `/api/ammo` - CRUD with lots
  - `/api/locations` - CRUD
  - `/api/images` - upload/download
- Add request validation (FluentValidation or DataAnnotations)
- Add unit tests for critical business logic (velocity stats calculation)

**Deliverable**: Complete API with all endpoints tested via Swagger/Postman

---

### Phase 4: Rifle & Ammunition Management UI
Build the "Setup" section of the app.

- Rifles list page with filtering/sorting
- Rifle create/edit form
- Rifle detail view with session history
- Rifle image upload
- Ammunition list page
- Ammunition create/edit form
- Ammo lot management (list, create, edit)
- Form validation and error handling
- Responsive design (mobile-friendly)

**Deliverable**: Fully functional rifle and ammo management

---

### Phase 5: Session Recording - Core Flow
Implement the main session recording experience.

- "New Session" entry point
- Session creation wizard:
  - Step 1: Date/time, rifle selection, location (GPS or saved)
  - Step 2: Conditions (manual or auto-fetch from weather API)
  - Step 3: What are you recording? (checkboxes: DOPE, Chrono, Groups)
- Dynamic form sections based on selections:
  - DOPE: Distance/elevation/windage table entry
  - Chrono: Ammo selection, velocity entry with live stats
  - Groups: Distance, shot count, group size, image upload
- Session notes and photos
- Save session flow
- Session list view with filters (by type, rifle, date range)
- Session detail view
- Session edit and delete

**Deliverable**: Complete session recording flow (the core of the app)

---

### Phase 6: Analytics & DOPE Charts
Implement analytics features.

- Analytics dashboard with summary cards
- DOPE Charts:
  - Select rifle
  - Aggregate DOPE data across sessions
  - Display elevation/windage by distance
  - Export/print functionality
- Velocity trends:
  - Chart velocity over time by ammo
  - SD/ES tracking
- Ammunition comparison:
  - Compare velocity stats across ammo types
  - Compare group sizes
- Lot comparison:
  - Compare performance between lots of same ammo
- Cost analysis:
  - Cost per round tracking
  - Rounds fired summary
  - Cost per session/rifle

**Deliverable**: All analytics features working

---

### Phase 7: Image Handling & Storage
Implement image upload, processing, and storage.

- MinIO integration for object storage
- Image upload endpoint with validation
- HEIC to JPEG conversion (ImageMagick/ImageSharp)
- Thumbnail generation
- Pre-signed URL generation for secure access
- Image gallery component
- Image attachment to sessions, rifles
- Bulk image operations

**Deliverable**: Full image handling pipeline

---

### Phase 8: Location & Weather Services
Implement location and weather features.

- Saved locations CRUD
- Location picker component (map with pin drop)
- GPS coordinate capture
- OpenWeatherMap integration
- Auto-fetch weather for current location
- Weather display in session form
- Altitude handling

**Deliverable**: Location and weather features working

---

### Phase 9: User Preferences & Settings
Implement user-configurable settings.

- Unit preferences:
  - Distance: yards / meters
  - Adjustment: MIL / MOA
  - Temperature: Fahrenheit / Celsius
  - Pressure: inHg / hPa
  - Velocity: fps / m/s
- Apply unit conversions throughout the app
- User profile settings (name, email)
- Password change
- Theme preferences (if implementing dark mode)
- Notification preferences (if applicable)

**Deliverable**: User preferences system with unit support

---

### Phase 10: Admin Panel
Implement administrative features.

- Admin dashboard with system stats
- User management (list, view, edit, disable)
- System statistics (total users, sessions, storage usage)
- Image maintenance (regenerate thumbnails)
- Database maintenance utilities

**Deliverable**: Admin panel for system management

---

### Phase 11: Polish & Performance
Final polish, optimization, and hardening.

- UI/UX polish pass
- Loading states and skeletons
- Error handling improvements
- Form validation messages
- Responsive design verification
- Performance optimization:
  - API response times
  - Frontend bundle size
  - Image loading optimization
  - Database query optimization
- Accessibility audit (basic a11y compliance)
- Security hardening review

**Deliverable**: Production-ready web application

---

### Phase 12: Data Import from v1
Migrate personal data from v1 to v2.

- Write import script to parse v1 JSON exports:
  - `rifles.json` → `RifleSetup`
  - `ammunition.json` → `Ammunition`
  - `ammo-lots.json` → `AmmoLot`
  - `locations.json` → `SavedLocation`
  - `shooting-records-full.json` → `RangeSession` + `DopeEntry[]`
  - `shooting-strings-full.json` → `RangeSession` + `ChronoSession` + `GroupEntry[]`
- Handle data mapping and transformation
- Validate imported data
- Run import for personal data
- Verify data integrity

**Deliverable**: v1 data successfully migrated to v2

---

### Phase 13: iOS App Updates
Update the existing Swift/SwiftUI app for the new API.

- Update API client for new endpoints
- Update data models to match new schema:
  - `RangeSession` replaces `ShootingRecord` and `ShootingString`
  - New `DopeEntry`, `ChronoSession`, `GroupEntry` models
- Update ViewModels for new data flow
- Update session recording views:
  - Unified session creation flow
  - Dynamic sections for DOPE/Chrono/Groups
- Update session list and detail views
- Update analytics views for new API
- Test all flows end-to-end
- Handle unit preferences from API

**Deliverable**: iOS app fully functional with v2 backend

---

### Phase 14: Deployment & Launch
Final deployment and go-live.

- Provision new VM for v2
- Configure production environment
- Set up SSL/TLS certificates
- Configure production database
- Configure production MinIO
- Deploy application
- Run data import on production
- Smoke test all features
- Monitor for issues
- Decommission v1 (optional, can keep as archive)

**Deliverable**: v2 live in production

---

## Out of Scope (Intentional)

These items are explicitly not part of v2:

- **Ballistic Calculator**: Cannot compete with dedicated tools like Applied Ballistics. Focus is on data logging and analytics.
- **Offline/PWA Support**: Noted for future consideration, not v2.
- **Android App**: iOS only for now. React Native migration is a future consideration.
- **Social Features**: No sharing, no public profiles, no community features.
- **Import from Other Apps**: No import from Applied Ballistics, BallisticsARC, etc.

---

## Technical Decisions

### Backend Architecture
```
TrueDope.Api/
├── Controllers/          # API endpoints
├── Services/             # Business logic
├── Data/
│   ├── Entities/         # EF Core entities
│   └── ApplicationDbContext.cs
├── DTOs/                 # Request/response models
├── Migrations/           # EF migrations
└── Program.cs
```

### Frontend Architecture
```
src/
├── components/           # Reusable UI components
├── pages/                # Route pages
├── hooks/                # Custom React hooks
├── services/             # API client
├── stores/               # State management (Zustand or Context)
├── types/                # TypeScript types
└── utils/                # Helpers
```

### API Design Principles
- RESTful endpoints
- Consistent response wrapper: `{ success, data, error, message }`
- Pagination: `{ items, pagination: { currentPage, pageSize, totalItems, totalPages } }`
- JWT Bearer authentication
- Validation errors return structured error objects

### Testing Strategy
- Unit tests for critical business logic (velocity calculations, stats)
- Integration tests for API endpoints
- Manual testing for UI flows
- No e2e test framework initially (add later if needed)

---

## File Structure

This manifest lives in `TrueDope/.specs/`. Sub-phase documents will be created as work begins:

```
TrueDope/.specs/
├── 20251206.MANIFEST.md           # This file
├── phase-01-setup.md              # Detailed tasks for Phase 1
├── phase-02-auth.md               # Detailed tasks for Phase 2
├── ...
└── phase-14-deployment.md         # Detailed tasks for Phase 14
```

---

## Open Questions / Future Considerations

1. **Quick Entry Mode**: Minimal "just log DOPE fast" mode for range use?
2. **Offline Support**: PWA with local storage that syncs when online?
3. **Dark Mode**: User preference for dark theme?
4. **MinIO Alternatives**: Evaluate Garage or other S3-compatible storage if MinIO maintenance mode becomes an issue?
5. **React Native**: Consider for future Android support and potential iOS rewrite?

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-06 | Initial manifest created |
