# Phase 3: Core Data Model & API

**Created**: December 7, 2024
**Status**: Planning
**Parent**: [Project Manifest](./20251206.MANIFEST.md)

---

## Overview

Phase 3 implements the core domain model for TrueDope v2. This is the most critical phase as it establishes the **unified session-based architecture** that differentiates v2 from v1.

### Key Architectural Change

**v1 Problem**: Two separate, disconnected recording systems:
- `ShootingRecord` + `DistanceHold` for DOPE data
- `ShootingString` + `IndividualShot` + `GroupData` for velocity/groups

**v2 Solution**: Single `RangeSession` anchor with optional child data:
- `RangeSession` - The unified session (always exists)
- `DopeEntry[]` - Optional DOPE holds (if recording distance data)
- `ChronoSession` - Optional chrono data (if recording velocity)
- `VelocityReading[]` - Individual shots (child of ChronoSession)
- `GroupEntry[]` - Optional group measurements (independent of chrono)

This means a user can record any combination of data types in a single session: DOPE only, chrono only, groups only, or any combination.

---

## Entity Definitions

### 1. RangeSession (The Unified Anchor)

The core entity that represents a shooting session. All session-specific data hangs off this entity.

```csharp
public class RangeSession
{
    public int Id { get; set; }

    // Ownership
    public string UserId { get; set; } = string.Empty;
    public User User { get; set; } = null!;

    // Required: When and with what rifle
    public DateTime SessionDate { get; set; }
    public TimeSpan? SessionTime { get; set; }
    public int RifleSetupId { get; set; }
    public RifleSetup RifleSetup { get; set; } = null!;

    // Location (optional, either saved or manual)
    public int? SavedLocationId { get; set; }
    public SavedLocation? SavedLocation { get; set; }
    public decimal? Latitude { get; set; }    // decimal(10,8)
    public decimal? Longitude { get; set; }   // decimal(11,8)
    public string? LocationName { get; set; } // max 100 chars, for manual entry

    // Conditions (all optional - can auto-fetch or manual entry)
    public decimal? Temperature { get; set; }     // decimal(5,2), Fahrenheit
    public int? Humidity { get; set; }            // 0-100%
    public decimal? WindSpeed { get; set; }       // decimal(5,2), mph
    public int? WindDirection { get; set; }       // 0-359 degrees
    public decimal? Pressure { get; set; }        // decimal(5,2), inHg
    public decimal? DensityAltitude { get; set; } // decimal(7,1), feet

    // Notes and general info
    public string? Notes { get; set; }  // max 2000 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Child collections (optional - presence determines "session type")
    public ICollection<DopeEntry> DopeEntries { get; set; } = new List<DopeEntry>();
    public ChronoSession? ChronoSession { get; set; }
    public ICollection<GroupEntry> GroupEntries { get; set; } = new List<GroupEntry>();
    public ICollection<Image> Images { get; set; } = new List<Image>();

    // Computed property for convenience
    [NotMapped]
    public string WindDirectionCardinal => WindDirection switch
    {
        >= 0 and < 23 => "N",
        >= 23 and < 68 => "NE",
        >= 68 and < 113 => "E",
        >= 113 and < 158 => "SE",
        >= 158 and < 203 => "S",
        >= 203 and < 248 => "SW",
        >= 248 and < 293 => "W",
        >= 293 and < 338 => "NW",
        >= 338 => "N",
        _ => ""
    };

    // Computed: What types of data does this session contain?
    [NotMapped]
    public bool HasDopeData => DopeEntries.Any();

    [NotMapped]
    public bool HasChronoData => ChronoSession != null;

    [NotMapped]
    public bool HasGroupData => GroupEntries.Any();
}
```

**Validation Rules**:
- `SessionDate` required
- `RifleSetupId` required (must belong to user)
- `Temperature` range: -50 to 120
- `Humidity` range: 0 to 100
- `WindSpeed` range: 0 to 100
- `WindDirection` range: 0 to 359
- `Pressure` range: 20.00 to 35.00
- Either `SavedLocationId` OR (`Latitude` + `Longitude`) OR neither (no location)
- `Notes` max 2000 characters

---

### 2. DopeEntry (DOPE Holds)

Individual distance/holdover data points within a session.

```csharp
public class DopeEntry
{
    public int Id { get; set; }

    // Parent
    public int RangeSessionId { get; set; }
    public RangeSession RangeSession { get; set; } = null!;

    // The data
    public int Distance { get; set; }              // yards, 1-2500
    public decimal ElevationMils { get; set; }     // decimal(8,3), -50 to +50 MILs
    public decimal WindageMils { get; set; }       // decimal(8,3), -20 to +20 MILs
    public string? Notes { get; set; }             // max 500 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    // Computed conversions
    [NotMapped]
    public decimal ElevationInches => (ElevationMils * Distance * 3.6m) / 100m;

    [NotMapped]
    public decimal WindageInches => (WindageMils * Distance * 3.6m) / 100m;

    // MOA conversions (1 MOA = 0.2909 MIL)
    [NotMapped]
    public decimal ElevationMoa => ElevationMils / 0.2909m;

    [NotMapped]
    public decimal WindageMoa => WindageMils / 0.2909m;
}
```

**Validation Rules**:
- `Distance` range: 1 to 2500 yards
- `ElevationMils` range: -50 to +50
- `WindageMils` range: -20 to +20
- `Notes` max 500 characters
- Unique constraint: `(RangeSessionId, Distance)` - one entry per distance per session

---

### 3. ChronoSession (Chronograph Data Container)

Contains velocity data from a chronograph session. One-to-one with RangeSession.

```csharp
public class ChronoSession
{
    public int Id { get; set; }

    // Parent (one-to-one with RangeSession)
    public int RangeSessionId { get; set; }
    public RangeSession RangeSession { get; set; } = null!;

    // Ammunition used (required for chrono data)
    public int AmmunitionId { get; set; }
    public Ammunition Ammunition { get; set; } = null!;
    public int? AmmoLotId { get; set; }
    public AmmoLot? AmmoLot { get; set; }

    // Session conditions
    public decimal? BarrelTemperature { get; set; }  // decimal(5,1), 32-200°F

    // Computed stats (calculated from VelocityReadings, stored for query performance)
    public int NumberOfRounds { get; set; }          // count of readings
    public decimal? AverageVelocity { get; set; }    // decimal(6,1), fps
    public decimal? HighVelocity { get; set; }       // decimal(6,1), fps
    public decimal? LowVelocity { get; set; }        // decimal(6,1), fps
    public decimal? StandardDeviation { get; set; }  // decimal(6,2), fps
    public decimal? ExtremeSpread { get; set; }      // decimal(6,1), fps

    public string? Notes { get; set; }  // max 1000 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Child readings
    public ICollection<VelocityReading> VelocityReadings { get; set; } = new List<VelocityReading>();
}
```

**Validation Rules**:
- `AmmunitionId` required (must belong to user)
- `BarrelTemperature` range: 32 to 200
- `Notes` max 1000 characters

**Business Logic**:
- Stats (`AverageVelocity`, `HighVelocity`, `LowVelocity`, `StandardDeviation`, `ExtremeSpread`) are recalculated and persisted whenever `VelocityReadings` change
- `NumberOfRounds` is derived from count of `VelocityReadings`

---

### 4. VelocityReading (Individual Shot)

Single velocity measurement from a chronograph.

```csharp
public class VelocityReading
{
    public int Id { get; set; }

    // Parent
    public int ChronoSessionId { get; set; }
    public ChronoSession ChronoSession { get; set; } = null!;

    // The data
    public int ShotNumber { get; set; }     // 1-100, sequential
    public decimal Velocity { get; set; }   // decimal(6,1), fps, 500-5000

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}
```

**Validation Rules**:
- `ShotNumber` range: 1 to 100
- `Velocity` range: 500 to 5000 fps
- Unique constraint: `(ChronoSessionId, ShotNumber)`

---

### 5. GroupEntry (Group Measurement)

Target group measurement data. Independent of chrono data.

```csharp
public class GroupEntry
{
    public int Id { get; set; }

    // Parent
    public int RangeSessionId { get; set; }
    public RangeSession RangeSession { get; set; } = null!;

    // Ammunition (optional - may be same as chrono or different)
    public int? AmmunitionId { get; set; }
    public Ammunition? Ammunition { get; set; }
    public int? AmmoLotId { get; set; }
    public AmmoLot? AmmoLot { get; set; }

    // Group info
    public int GroupNumber { get; set; }        // 1-20, sequential within session
    public int Distance { get; set; }           // yards, 25-2500
    public int NumberOfShots { get; set; }      // 1-25

    // Measurements (optional - user may have one or both)
    public decimal? GroupSizeMoa { get; set; }    // decimal(6,3), 0.01-20 MOA
    public decimal? MeanRadiusMoa { get; set; }   // decimal(6,3), 0.01-10 MOA

    public string? Notes { get; set; }  // max 1000 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Images of this specific group
    public ICollection<Image> Images { get; set; } = new List<Image>();

    // Computed: Group size in inches
    [NotMapped]
    public decimal? GroupSizeInches => GroupSizeMoa.HasValue
        ? (GroupSizeMoa.Value * Distance * 1.047m) / 100m
        : null;
}
```

**Validation Rules**:
- `GroupNumber` range: 1 to 20
- `Distance` range: 25 to 2500
- `NumberOfShots` range: 1 to 25
- `GroupSizeMoa` range: 0.01 to 20
- `MeanRadiusMoa` range: 0.01 to 10
- At least one of `GroupSizeMoa` or `MeanRadiusMoa` should be provided
- `Notes` max 1000 characters

---

### 6. RifleSetup

Rifle/optic/barrel configuration. Simplified from v1 - **linked ammunition only** (no legacy manual fields).

```csharp
public class RifleSetup
{
    public int Id { get; set; }

    // Ownership
    public string UserId { get; set; } = string.Empty;
    public User User { get; set; } = null!;

    // Rifle info
    public string Name { get; set; } = string.Empty;        // max 100 chars, required
    public string? Manufacturer { get; set; }                // max 100 chars
    public string? Model { get; set; }                       // max 100 chars
    public string Caliber { get; set; } = string.Empty;     // max 50 chars, required
    public decimal? BarrelLength { get; set; }              // decimal(4,1), 1-50 inches
    public string? TwistRate { get; set; }                  // max 20 chars, e.g., "1:7"

    // Optic info
    public string? ScopeMake { get; set; }                  // max 100 chars
    public string? ScopeModel { get; set; }                 // max 100 chars
    public decimal? ScopeHeight { get; set; }               // decimal(4,2), 0-5 inches

    // Zero info
    public int ZeroDistance { get; set; }                   // yards, 25-1000
    public decimal? ZeroElevationClicks { get; set; }       // clicks from mechanical zero
    public decimal? ZeroWindageClicks { get; set; }

    // Ballistic data (for future calculator integration)
    public decimal? MuzzleVelocity { get; set; }           // decimal(6,1), fps, 500-5000
    public decimal? BallisticCoefficient { get; set; }     // decimal(5,4), 0.001-2.000
    public string? DragModel { get; set; }                 // "G1" or "G7", max 5 chars

    public string? Notes { get; set; }  // max 2000 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation
    public ICollection<RangeSession> RangeSessions { get; set; } = new List<RangeSession>();
    public ICollection<Image> Images { get; set; } = new List<Image>();
}
```

**Validation Rules**:
- `Name` required, max 100 characters
- `Caliber` required, max 50 characters
- `BarrelLength` range: 1 to 50 inches
- `ZeroDistance` range: 25 to 1000 yards
- `MuzzleVelocity` range: 500 to 5000 fps
- `BallisticCoefficient` range: 0.001 to 2.000
- `DragModel` must be "G1" or "G7" if provided
- `Notes` max 2000 characters

---

### 7. Ammunition

Ammunition type in user's library.

```csharp
public class Ammunition
{
    public int Id { get; set; }

    // Ownership
    public string UserId { get; set; } = string.Empty;
    public User User { get; set; } = null!;

    // Identification
    public string Manufacturer { get; set; } = string.Empty;  // max 100 chars, required
    public string Name { get; set; } = string.Empty;          // max 100 chars, required
    public string Caliber { get; set; } = string.Empty;       // max 50 chars, required
    public decimal Grain { get; set; }                        // decimal(6,1), 1-1000

    // Additional info
    public string? BulletType { get; set; }                   // max 50 chars, e.g., "OTM", "HPBT"
    public decimal? CostPerRound { get; set; }                // decimal(8,4), 0-100
    public decimal? BallisticCoefficient { get; set; }        // decimal(5,4)
    public string? DragModel { get; set; }                    // "G1" or "G7"
    public string? Notes { get; set; }                        // max 1000 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation
    public ICollection<AmmoLot> AmmoLots { get; set; } = new List<AmmoLot>();
    public ICollection<ChronoSession> ChronoSessions { get; set; } = new List<ChronoSession>();
    public ICollection<GroupEntry> GroupEntries { get; set; } = new List<GroupEntry>();

    // Computed
    [NotMapped]
    public string DisplayName => $"{Manufacturer} {Name} ({Caliber} - {Grain}gr)";
}
```

**Validation Rules**:
- `Manufacturer` required, max 100 characters
- `Name` required, max 100 characters
- `Caliber` required, max 50 characters
- `Grain` range: 1 to 1000
- `CostPerRound` range: 0 to 100
- `BallisticCoefficient` range: 0.001 to 2.000
- `DragModel` must be "G1" or "G7" if provided
- `Notes` max 1000 characters

---

### 8. AmmoLot

Specific batch/lot of an ammunition type.

```csharp
public class AmmoLot
{
    public int Id { get; set; }

    // Parent
    public int AmmunitionId { get; set; }
    public Ammunition Ammunition { get; set; } = null!;

    // Ownership
    public string UserId { get; set; } = string.Empty;
    public User User { get; set; } = null!;

    // Lot info
    public string LotNumber { get; set; } = string.Empty;  // max 50 chars, required
    public DateTime? PurchaseDate { get; set; }
    public int? InitialQuantity { get; set; }              // rounds purchased
    public decimal? PurchasePrice { get; set; }            // decimal(8,2), total price

    public string? Notes { get; set; }  // max 1000 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation
    public ICollection<ChronoSession> ChronoSessions { get; set; } = new List<ChronoSession>();
    public ICollection<GroupEntry> GroupEntries { get; set; } = new List<GroupEntry>();

    // Computed
    [NotMapped]
    public string DisplayName => $"{Ammunition?.Manufacturer} {Ammunition?.Name} - Lot: {LotNumber}";

    [NotMapped]
    public decimal? CostPerRound => (InitialQuantity.HasValue && PurchasePrice.HasValue && InitialQuantity > 0)
        ? PurchasePrice.Value / InitialQuantity.Value
        : null;
}
```

**Validation Rules**:
- `LotNumber` required, max 50 characters
- `InitialQuantity` range: 1 to 100000
- `PurchasePrice` range: 0 to 100000
- Unique constraint: `(AmmunitionId, LotNumber)` - no duplicate lot numbers per ammo

---

### 9. SavedLocation

User's saved shooting locations for quick selection.

```csharp
public class SavedLocation
{
    public int Id { get; set; }

    // Ownership
    public string UserId { get; set; } = string.Empty;
    public User User { get; set; } = null!;

    // Location data
    public string Name { get; set; } = string.Empty;      // max 100 chars, required
    public decimal Latitude { get; set; }                 // decimal(10,8)
    public decimal Longitude { get; set; }                // decimal(11,8)
    public decimal? Altitude { get; set; }                // decimal(7,1), feet
    public string? Description { get; set; }              // max 500 chars

    // Audit
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;

    // Navigation
    public ICollection<RangeSession> RangeSessions { get; set; } = new List<RangeSession>();
}
```

**Validation Rules**:
- `Name` required, max 100 characters
- `Latitude` range: -90 to 90
- `Longitude` range: -180 to 180
- `Altitude` range: -1000 to 30000 feet
- `Description` max 500 characters

---

### 10. Image

Polymorphic image entity that can belong to multiple parent types.

```csharp
public class Image
{
    public int Id { get; set; }

    // Ownership
    public string UserId { get; set; } = string.Empty;
    public User User { get; set; } = null!;

    // File info
    public string FileName { get; set; } = string.Empty;          // MinIO object key
    public string OriginalFileName { get; set; } = string.Empty;  // max 255 chars
    public string ContentType { get; set; } = string.Empty;       // max 100 chars
    public long FileSize { get; set; }                            // bytes
    public string? ThumbnailFileName { get; set; }                // MinIO key for thumbnail

    public string? Caption { get; set; }  // max 500 chars

    // Processing status
    public bool IsProcessed { get; set; } = false;

    // Polymorphic parents (only ONE should be set)
    public int? RifleSetupId { get; set; }
    public RifleSetup? RifleSetup { get; set; }

    public int? RangeSessionId { get; set; }
    public RangeSession? RangeSession { get; set; }

    public int? GroupEntryId { get; set; }
    public GroupEntry? GroupEntry { get; set; }

    // Audit
    public DateTime UploadedAt { get; set; } = DateTime.UtcNow;
}
```

**Validation Rules**:
- Exactly one of `RifleSetupId`, `RangeSessionId`, or `GroupEntryId` must be set
- `OriginalFileName` max 255 characters
- `ContentType` max 100 characters
- `Caption` max 500 characters
- Accepted content types: image/jpeg, image/png, image/gif, image/heic, image/webp

---

## Entity Relationships Diagram

```
User (root aggregate)
├── RifleSetups (1:N, cascade delete)
│   ├── RangeSessions (1:N, restrict delete)
│   └── Images (1:N, cascade delete)
│
├── Ammunition (1:N, cascade delete)
│   ├── AmmoLots (1:N, cascade delete)
│   ├── ChronoSessions (1:N, restrict delete)
│   └── GroupEntries (1:N, set null on delete)
│
├── AmmoLots (1:N, via Ammunition cascade)
│   ├── ChronoSessions (1:N, restrict delete)
│   └── GroupEntries (1:N, set null on delete)
│
├── SavedLocations (1:N, cascade delete)
│   └── RangeSessions (1:N, set null on delete)
│
├── RangeSessions (1:N, cascade delete)
│   ├── DopeEntries (1:N, cascade delete)
│   ├── ChronoSession (1:0..1, cascade delete)
│   │   └── VelocityReadings (1:N, cascade delete)
│   ├── GroupEntries (1:N, cascade delete)
│   │   └── Images (1:N, cascade delete)
│   └── Images (1:N, cascade delete)
│
└── Images (1:N, via parents)
```

---

## Delete Behaviors Summary

| Parent | Child | Behavior | Rationale |
|--------|-------|----------|-----------|
| User | RifleSetups | Cascade | User owns rifles |
| User | Ammunition | Cascade | User owns ammo library |
| User | SavedLocations | Cascade | User owns locations |
| User | RangeSessions | Cascade | User owns sessions |
| RifleSetup | RangeSessions | Restrict | Prevent orphaned sessions |
| RifleSetup | Images | Cascade | Images belong to rifle |
| Ammunition | AmmoLots | Cascade | Lots are part of ammo |
| Ammunition | ChronoSessions | Restrict | Prevent data loss |
| Ammunition | GroupEntries | SetNull | Keep groups, clear ammo ref |
| AmmoLot | ChronoSessions | Restrict | Prevent data loss |
| AmmoLot | GroupEntries | SetNull | Keep groups, clear lot ref |
| SavedLocation | RangeSessions | SetNull | Keep sessions, clear location |
| RangeSession | DopeEntries | Cascade | Part of session |
| RangeSession | ChronoSession | Cascade | Part of session |
| RangeSession | GroupEntries | Cascade | Part of session |
| RangeSession | Images | Cascade | Session images |
| ChronoSession | VelocityReadings | Cascade | Part of chrono session |
| GroupEntry | Images | Cascade | Group images |

---

## Database Schema Notes

### Indexes

```sql
-- Performance indexes
CREATE INDEX IX_RangeSessions_UserId ON RangeSessions(UserId);
CREATE INDEX IX_RangeSessions_SessionDate ON RangeSessions(SessionDate);
CREATE INDEX IX_RangeSessions_RifleSetupId ON RangeSessions(RifleSetupId);
CREATE INDEX IX_RifleSetups_UserId ON RifleSetups(UserId);
CREATE INDEX IX_Ammunition_UserId ON Ammunition(UserId);
CREATE INDEX IX_DopeEntries_RangeSessionId ON DopeEntries(RangeSessionId);
CREATE INDEX IX_ChronoSessions_AmmunitionId ON ChronoSessions(AmmunitionId);
CREATE INDEX IX_VelocityReadings_ChronoSessionId ON VelocityReadings(ChronoSessionId);
CREATE INDEX IX_GroupEntries_RangeSessionId ON GroupEntries(RangeSessionId);
CREATE INDEX IX_Images_UserId ON Images(UserId);

-- Unique constraints
CREATE UNIQUE INDEX UX_DopeEntries_Session_Distance ON DopeEntries(RangeSessionId, Distance);
CREATE UNIQUE INDEX UX_VelocityReadings_Session_Shot ON VelocityReadings(ChronoSessionId, ShotNumber);
CREATE UNIQUE INDEX UX_AmmoLots_Ammo_LotNumber ON AmmoLots(AmmunitionId, LotNumber);
```

### Decimal Precision

| Field | Type | Precision | Range |
|-------|------|-----------|-------|
| Latitude | decimal(10,8) | 8 decimal places | -90 to 90 |
| Longitude | decimal(11,8) | 8 decimal places | -180 to 180 |
| Temperature | decimal(5,2) | 2 decimal places | -50 to 120 |
| WindSpeed | decimal(5,2) | 2 decimal places | 0 to 100 |
| Pressure | decimal(5,2) | 2 decimal places | 20 to 35 |
| ElevationMils | decimal(8,3) | 3 decimal places | -50 to 50 |
| WindageMils | decimal(8,3) | 3 decimal places | -20 to 20 |
| Velocity | decimal(6,1) | 1 decimal place | 500 to 5000 |
| StandardDeviation | decimal(6,2) | 2 decimal places | 0 to 100 |
| GroupSizeMoa | decimal(6,3) | 3 decimal places | 0.01 to 20 |
| Grain | decimal(6,1) | 1 decimal place | 1 to 1000 |
| BallisticCoefficient | decimal(5,4) | 4 decimal places | 0.001 to 2 |
| CostPerRound | decimal(8,4) | 4 decimal places | 0 to 100 |

---

## REST API Endpoints

### Sessions API

#### `GET /api/sessions`
List user's range sessions with filtering and pagination.

**Query Parameters**:
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| page | int | 1 | Page number |
| pageSize | int | 20 | Items per page (max 100) |
| rifleId | int? | null | Filter by rifle |
| ammoId | int? | null | Filter by ammunition (chrono/groups) |
| hasDopeData | bool? | null | Filter sessions with DOPE data |
| hasChronoData | bool? | null | Filter sessions with chrono data |
| hasGroupData | bool? | null | Filter sessions with group data |
| fromDate | DateTime? | null | Start date filter |
| toDate | DateTime? | null | End date filter |
| sortBy | string | "sessionDate" | Sort field |
| sortDesc | bool | true | Sort descending |

**Response** (200):
```json
{
  "success": true,
  "items": [
    {
      "id": 1,
      "sessionDate": "2024-12-07",
      "sessionTime": "14:30:00",
      "rifle": {
        "id": 5,
        "name": "URGI"
      },
      "locationName": "Panquitch Valley Range",
      "temperature": 72.5,
      "hasDopeData": true,
      "hasChronoData": true,
      "hasGroupData": false,
      "dopeEntryCount": 8,
      "velocityReadingCount": 20,
      "groupEntryCount": 0,
      "createdAt": "2024-12-07T20:15:00Z"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "pageSize": 20,
    "totalItems": 45,
    "totalPages": 3
  }
}
```

---

#### `GET /api/sessions/{id}`
Get full session details including all child data.

**Response** (200):
```json
{
  "success": true,
  "data": {
    "id": 1,
    "sessionDate": "2024-12-07",
    "sessionTime": "14:30:00",
    "rifle": {
      "id": 5,
      "name": "URGI",
      "caliber": ".223 Rem"
    },
    "savedLocation": null,
    "latitude": 37.8234,
    "longitude": -112.4521,
    "locationName": "Panquitch Valley Range",
    "temperature": 72.5,
    "humidity": 35,
    "windSpeed": 8.5,
    "windDirection": 270,
    "windDirectionCardinal": "W",
    "pressure": 29.92,
    "densityAltitude": 7200,
    "notes": "Good conditions today",
    "dopeEntries": [
      {
        "id": 10,
        "distance": 100,
        "elevationMils": 0.3,
        "windageMils": 0.1,
        "elevationInches": 1.08,
        "windageInches": 0.36
      },
      {
        "id": 11,
        "distance": 200,
        "elevationMils": 1.2,
        "windageMils": 0.2
      }
    ],
    "chronoSession": {
      "id": 8,
      "ammunition": {
        "id": 3,
        "displayName": "Federal Gold Medal 77gr SMK"
      },
      "ammoLot": {
        "id": 12,
        "lotNumber": "ABC123"
      },
      "barrelTemperature": 95,
      "numberOfRounds": 10,
      "averageVelocity": 2620.5,
      "highVelocity": 2635,
      "lowVelocity": 2608,
      "standardDeviation": 8.2,
      "extremeSpread": 27,
      "velocityReadings": [
        { "shotNumber": 1, "velocity": 2618 },
        { "shotNumber": 2, "velocity": 2625 }
      ]
    },
    "groupEntries": [],
    "images": [
      {
        "id": 15,
        "thumbnailUrl": "/api/images/15/thumbnail",
        "caption": "Setup photo"
      }
    ],
    "createdAt": "2024-12-07T20:15:00Z",
    "updatedAt": "2024-12-07T20:15:00Z"
  }
}
```

---

#### `POST /api/sessions`
Create a new range session with optional child data.

**Request**:
```json
{
  "sessionDate": "2024-12-07",
  "sessionTime": "14:30:00",
  "rifleSetupId": 5,
  "savedLocationId": null,
  "latitude": 37.8234,
  "longitude": -112.4521,
  "locationName": "Panquitch Valley Range",
  "temperature": 72.5,
  "humidity": 35,
  "windSpeed": 8.5,
  "windDirection": 270,
  "pressure": 29.92,
  "densityAltitude": 7200,
  "notes": "Good conditions",
  "dopeEntries": [
    { "distance": 100, "elevationMils": 0.3, "windageMils": 0.1 },
    { "distance": 200, "elevationMils": 1.2, "windageMils": 0.2 }
  ],
  "chronoSession": {
    "ammunitionId": 3,
    "ammoLotId": 12,
    "barrelTemperature": 95,
    "velocityReadings": [
      { "shotNumber": 1, "velocity": 2618 },
      { "shotNumber": 2, "velocity": 2625 }
    ]
  },
  "groupEntries": []
}
```

**Response** (201):
```json
{
  "success": true,
  "data": { "id": 1 },
  "message": "Session created successfully"
}
```

---

#### `PUT /api/sessions/{id}`
Update an existing session. Supports partial updates.

**Request**: Same structure as POST, but all fields optional for partial update.

**Response** (200):
```json
{
  "success": true,
  "message": "Session updated successfully"
}
```

---

#### `DELETE /api/sessions/{id}`
Delete a session and all child data.

**Response** (200):
```json
{
  "success": true,
  "message": "Session deleted successfully"
}
```

---

### Rifles API

#### `GET /api/rifles`
List user's rifle setups.

**Query Parameters**:
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| page | int | 1 | Page number |
| pageSize | int | 20 | Items per page |
| search | string? | null | Search name/caliber |
| sortBy | string | "name" | Sort field |
| sortDesc | bool | false | Sort descending |

**Response** (200):
```json
{
  "success": true,
  "items": [
    {
      "id": 5,
      "name": "URGI",
      "manufacturer": "Geissele",
      "model": "Super Duty",
      "caliber": ".223 Rem",
      "zeroDistance": 100,
      "sessionCount": 12,
      "lastSessionDate": "2024-12-07",
      "createdAt": "2024-06-15T10:00:00Z"
    }
  ],
  "pagination": { ... }
}
```

---

#### `GET /api/rifles/{id}`
Get full rifle details.

**Response** (200):
```json
{
  "success": true,
  "data": {
    "id": 5,
    "name": "URGI",
    "manufacturer": "Geissele",
    "model": "Super Duty",
    "caliber": ".223 Rem",
    "barrelLength": 14.5,
    "twistRate": "1:7",
    "scopeMake": "Vortex",
    "scopeModel": "Razor Gen III 1-10x24",
    "scopeHeight": 1.93,
    "zeroDistance": 100,
    "zeroElevationClicks": 0,
    "zeroWindageClicks": 2,
    "muzzleVelocity": 2650,
    "ballisticCoefficient": 0.372,
    "dragModel": "G7",
    "notes": "Primary training rifle",
    "images": [...],
    "createdAt": "2024-06-15T10:00:00Z",
    "updatedAt": "2024-12-01T14:30:00Z"
  }
}
```

---

#### `POST /api/rifles`
Create a new rifle setup.

**Request**:
```json
{
  "name": "URGI",
  "manufacturer": "Geissele",
  "model": "Super Duty",
  "caliber": ".223 Rem",
  "barrelLength": 14.5,
  "twistRate": "1:7",
  "scopeMake": "Vortex",
  "scopeModel": "Razor Gen III 1-10x24",
  "scopeHeight": 1.93,
  "zeroDistance": 100,
  "muzzleVelocity": 2650,
  "notes": "Primary training rifle"
}
```

**Response** (201):
```json
{
  "success": true,
  "data": { "id": 5 },
  "message": "Rifle created successfully"
}
```

---

#### `PUT /api/rifles/{id}`
Update a rifle setup.

---

#### `DELETE /api/rifles/{id}`
Delete a rifle setup. Fails if rifle has sessions (restrict).

**Response** (400) if rifle has sessions:
```json
{
  "success": false,
  "error": {
    "code": "RIFLE_HAS_SESSIONS",
    "description": "Cannot delete rifle with existing sessions. Delete sessions first."
  }
}
```

---

### Ammunition API

#### `GET /api/ammo`
List user's ammunition library.

**Query Parameters**:
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| page | int | 1 | Page number |
| pageSize | int | 20 | Items per page |
| search | string? | null | Search manufacturer/name/caliber |
| caliber | string? | null | Filter by caliber |
| sortBy | string | "name" | Sort field |
| sortDesc | bool | false | Sort descending |

**Response** (200):
```json
{
  "success": true,
  "items": [
    {
      "id": 3,
      "manufacturer": "Federal",
      "name": "Gold Medal Match",
      "caliber": ".223 Rem",
      "grain": 77,
      "bulletType": "SMK",
      "costPerRound": 1.25,
      "lotCount": 3,
      "sessionCount": 8,
      "displayName": "Federal Gold Medal Match (.223 Rem - 77gr)"
    }
  ],
  "pagination": { ... }
}
```

---

#### `GET /api/ammo/{id}`
Get full ammunition details including lots.

**Response** (200):
```json
{
  "success": true,
  "data": {
    "id": 3,
    "manufacturer": "Federal",
    "name": "Gold Medal Match",
    "caliber": ".223 Rem",
    "grain": 77,
    "bulletType": "SMK",
    "costPerRound": 1.25,
    "ballisticCoefficient": 0.372,
    "dragModel": "G7",
    "notes": "Match ammo for competition",
    "lots": [
      {
        "id": 12,
        "lotNumber": "ABC123",
        "purchaseDate": "2024-06-01",
        "initialQuantity": 500,
        "purchasePrice": 625.00,
        "costPerRound": 1.25,
        "sessionCount": 3
      }
    ],
    "createdAt": "2024-05-01T10:00:00Z"
  }
}
```

---

#### `POST /api/ammo`
Create ammunition entry.

---

#### `PUT /api/ammo/{id}`
Update ammunition entry.

---

#### `DELETE /api/ammo/{id}`
Delete ammunition. Fails if ammo is used in sessions.

---

### Ammunition Lots API

#### `GET /api/ammo/{ammoId}/lots`
List lots for specific ammunition.

---

#### `POST /api/ammo/{ammoId}/lots`
Create a new lot.

**Request**:
```json
{
  "lotNumber": "ABC123",
  "purchaseDate": "2024-06-01",
  "initialQuantity": 500,
  "purchasePrice": 625.00,
  "notes": "Bulk purchase from Brownells"
}
```

---

#### `PUT /api/ammo/{ammoId}/lots/{lotId}`
Update a lot.

---

#### `DELETE /api/ammo/{ammoId}/lots/{lotId}`
Delete a lot. Fails if lot is used in sessions.

---

### Locations API

#### `GET /api/locations`
List user's saved locations.

---

#### `GET /api/locations/{id}`
Get location details.

---

#### `POST /api/locations`
Create saved location.

**Request**:
```json
{
  "name": "Panquitch Valley Range",
  "latitude": 37.8234,
  "longitude": -112.4521,
  "altitude": 6500,
  "description": "BLM land shooting area"
}
```

---

#### `PUT /api/locations/{id}`
Update location.

---

#### `DELETE /api/locations/{id}`
Delete location. Sessions using this location will have `savedLocationId` set to null.

---

### Images API

#### `POST /api/images/upload`
Upload an image (multipart/form-data).

**Form Fields**:
- `file` (required): The image file
- `parentType` (required): "rifle" | "session" | "group"
- `parentId` (required): ID of parent entity
- `caption` (optional): Image caption

**Response** (201):
```json
{
  "success": true,
  "data": {
    "id": 15,
    "url": "/api/images/15",
    "thumbnailUrl": "/api/images/15/thumbnail"
  },
  "message": "Image uploaded successfully"
}
```

---

#### `GET /api/images/{id}`
Get full-size image (returns image data with proper content-type).

---

#### `GET /api/images/{id}/thumbnail`
Get thumbnail image.

---

#### `PUT /api/images/{id}`
Update image caption.

---

#### `DELETE /api/images/{id}`
Delete image from storage and database.

---

## Service Layer Design

### Session Service

```csharp
public interface ISessionService
{
    Task<PaginatedResponse<SessionListDto>> GetSessionsAsync(string userId, SessionFilterDto filter);
    Task<SessionDetailDto?> GetSessionAsync(string userId, int sessionId);
    Task<int> CreateSessionAsync(string userId, CreateSessionDto dto);
    Task UpdateSessionAsync(string userId, int sessionId, UpdateSessionDto dto);
    Task DeleteSessionAsync(string userId, int sessionId);

    // DOPE operations
    Task AddDopeEntryAsync(string userId, int sessionId, CreateDopeEntryDto dto);
    Task UpdateDopeEntryAsync(string userId, int dopeEntryId, UpdateDopeEntryDto dto);
    Task DeleteDopeEntryAsync(string userId, int dopeEntryId);

    // Chrono operations
    Task AddChronoSessionAsync(string userId, int sessionId, CreateChronoSessionDto dto);
    Task UpdateChronoSessionAsync(string userId, int chronoSessionId, UpdateChronoSessionDto dto);
    Task DeleteChronoSessionAsync(string userId, int chronoSessionId);
    Task AddVelocityReadingAsync(string userId, int chronoSessionId, CreateVelocityReadingDto dto);
    Task DeleteVelocityReadingAsync(string userId, int readingId);

    // Group operations
    Task AddGroupEntryAsync(string userId, int sessionId, CreateGroupEntryDto dto);
    Task UpdateGroupEntryAsync(string userId, int groupEntryId, UpdateGroupEntryDto dto);
    Task DeleteGroupEntryAsync(string userId, int groupEntryId);
}
```

### Velocity Statistics Calculator

```csharp
public static class VelocityStatsCalculator
{
    public static VelocityStats Calculate(IEnumerable<decimal> velocities)
    {
        var list = velocities.ToList();
        if (!list.Any())
            return new VelocityStats();

        var count = list.Count;
        var average = list.Average();
        var high = list.Max();
        var low = list.Min();
        var extremeSpread = high - low;

        // Standard deviation calculation
        var sumOfSquares = list.Sum(v => (v - average) * (v - average));
        var variance = sumOfSquares / count;
        var standardDeviation = (decimal)Math.Sqrt((double)variance);

        return new VelocityStats
        {
            Count = count,
            Average = Math.Round(average, 1),
            High = Math.Round(high, 1),
            Low = Math.Round(low, 1),
            ExtremeSpread = Math.Round(extremeSpread, 1),
            StandardDeviation = Math.Round(standardDeviation, 2)
        };
    }
}
```

---

## Implementation Tasks

### Task 1: Create Entity Classes

**Goal**: Define all EF Core entity classes.

**Files to Create**:
- `backend/src/TrueDope.Api/Data/Entities/RangeSession.cs`
- `backend/src/TrueDope.Api/Data/Entities/DopeEntry.cs`
- `backend/src/TrueDope.Api/Data/Entities/ChronoSession.cs`
- `backend/src/TrueDope.Api/Data/Entities/VelocityReading.cs`
- `backend/src/TrueDope.Api/Data/Entities/GroupEntry.cs`
- `backend/src/TrueDope.Api/Data/Entities/RifleSetup.cs`
- `backend/src/TrueDope.Api/Data/Entities/Ammunition.cs`
- `backend/src/TrueDope.Api/Data/Entities/AmmoLot.cs`
- `backend/src/TrueDope.Api/Data/Entities/SavedLocation.cs`
- `backend/src/TrueDope.Api/Data/Entities/Image.cs`

**Acceptance Criteria**:
- [ ] All entity classes created with proper data annotations
- [ ] Navigation properties defined
- [ ] Computed properties implemented
- [ ] Code compiles without errors

---

### Task 2: Update ApplicationDbContext

**Goal**: Configure entity relationships and constraints in EF Core.

**File to Modify**:
- `backend/src/TrueDope.Api/Data/ApplicationDbContext.cs`

**Steps**:
1. Add DbSet properties for all entities
2. Configure relationships in `OnModelCreating`
3. Set up delete behaviors
4. Configure decimal precision
5. Add unique constraints/indexes

**Acceptance Criteria**:
- [ ] All DbSets defined
- [ ] Relationships configured correctly
- [ ] Delete behaviors match specification
- [ ] Decimal precision configured
- [ ] Indexes created

---

### Task 3: Create Initial Migration

**Goal**: Generate and apply EF migration for new schema.

**Command**:
```bash
cd backend
dotnet ef migrations add AddCoreEntities --project src/TrueDope.Api
dotnet ef database update --project src/TrueDope.Api
```

**Acceptance Criteria**:
- [ ] Migration generates without errors
- [ ] Database schema created correctly
- [ ] All tables have expected columns
- [ ] Constraints and indexes created

---

### Task 4: Create DTOs

**Goal**: Define request/response DTOs for all APIs.

**Files to Create**:
```
backend/src/TrueDope.Api/DTOs/
├── Sessions/
│   ├── SessionListDto.cs
│   ├── SessionDetailDto.cs
│   ├── CreateSessionDto.cs
│   ├── UpdateSessionDto.cs
│   ├── SessionFilterDto.cs
│   ├── DopeEntryDto.cs
│   ├── CreateDopeEntryDto.cs
│   ├── ChronoSessionDto.cs
│   ├── CreateChronoSessionDto.cs
│   ├── VelocityReadingDto.cs
│   ├── GroupEntryDto.cs
│   └── CreateGroupEntryDto.cs
├── Rifles/
│   ├── RifleListDto.cs
│   ├── RifleDetailDto.cs
│   ├── CreateRifleDto.cs
│   └── UpdateRifleDto.cs
├── Ammunition/
│   ├── AmmoListDto.cs
│   ├── AmmoDetailDto.cs
│   ├── CreateAmmoDto.cs
│   ├── UpdateAmmoDto.cs
│   ├── AmmoLotDto.cs
│   └── CreateAmmoLotDto.cs
├── Locations/
│   ├── LocationListDto.cs
│   ├── LocationDetailDto.cs
│   ├── CreateLocationDto.cs
│   └── UpdateLocationDto.cs
└── Images/
    ├── ImageDto.cs
    └── ImageUploadDto.cs
```

**Acceptance Criteria**:
- [ ] All DTOs created with proper validation attributes
- [ ] Request DTOs have required/optional fields correctly defined
- [ ] Response DTOs include computed/derived fields

---

### Task 5: Create Session Service

**Goal**: Implement business logic for session operations.

**Files to Create**:
- `backend/src/TrueDope.Api/Services/ISessionService.cs`
- `backend/src/TrueDope.Api/Services/SessionService.cs`
- `backend/src/TrueDope.Api/Services/VelocityStatsCalculator.cs`

**Acceptance Criteria**:
- [ ] All CRUD operations implemented
- [ ] Velocity stats calculation works correctly
- [ ] User ownership validated on all operations
- [ ] Proper error handling

---

### Task 6: Create Rifle Service

**Goal**: Implement business logic for rifle operations.

**Files to Create**:
- `backend/src/TrueDope.Api/Services/IRifleService.cs`
- `backend/src/TrueDope.Api/Services/RifleService.cs`

**Acceptance Criteria**:
- [ ] CRUD operations implemented
- [ ] Delete restriction when sessions exist
- [ ] Session count and last session date computed

---

### Task 7: Create Ammunition Service

**Goal**: Implement business logic for ammunition and lots.

**Files to Create**:
- `backend/src/TrueDope.Api/Services/IAmmoService.cs`
- `backend/src/TrueDope.Api/Services/AmmoService.cs`

**Acceptance Criteria**:
- [ ] Ammunition CRUD implemented
- [ ] Lot CRUD implemented (nested under ammo)
- [ ] Delete restrictions work correctly

---

### Task 8: Create Location Service

**Goal**: Implement business logic for saved locations.

**Files to Create**:
- `backend/src/TrueDope.Api/Services/ILocationService.cs`
- `backend/src/TrueDope.Api/Services/LocationService.cs`

**Acceptance Criteria**:
- [ ] CRUD operations implemented
- [ ] Sessions updated (nullified) when location deleted

---

### Task 9: Create Image Service

**Goal**: Implement image upload, storage, and retrieval.

**Files to Create**:
- `backend/src/TrueDope.Api/Services/IImageService.cs`
- `backend/src/TrueDope.Api/Services/ImageService.cs`
- `backend/src/TrueDope.Api/Services/IStorageService.cs`
- `backend/src/TrueDope.Api/Services/MinioStorageService.cs`

**Dependencies**:
```
Minio (MinIO SDK)
SixLabors.ImageSharp
```

**Acceptance Criteria**:
- [ ] Image upload to MinIO works
- [ ] HEIC conversion works (if ImageSharp supports, otherwise defer)
- [ ] Thumbnail generation works
- [ ] Image retrieval works
- [ ] Image deletion cleans up storage

---

### Task 10: Create Sessions Controller

**Goal**: Implement REST API for sessions.

**File to Create**:
- `backend/src/TrueDope.Api/Controllers/SessionsController.cs`

**Endpoints**:
- GET /api/sessions
- GET /api/sessions/{id}
- POST /api/sessions
- PUT /api/sessions/{id}
- DELETE /api/sessions/{id}
- POST /api/sessions/{id}/dope-entries
- PUT /api/sessions/{id}/dope-entries/{entryId}
- DELETE /api/sessions/{id}/dope-entries/{entryId}
- POST /api/sessions/{id}/chrono
- PUT /api/sessions/{id}/chrono
- DELETE /api/sessions/{id}/chrono
- POST /api/sessions/{id}/chrono/readings
- DELETE /api/sessions/{id}/chrono/readings/{readingId}
- POST /api/sessions/{id}/groups
- PUT /api/sessions/{id}/groups/{groupId}
- DELETE /api/sessions/{id}/groups/{groupId}

**Acceptance Criteria**:
- [ ] All endpoints implemented
- [ ] Authorization required on all endpoints
- [ ] Proper HTTP status codes returned
- [ ] Swagger documentation complete

---

### Task 11: Create Rifles Controller

**Goal**: Implement REST API for rifles.

**File to Create**:
- `backend/src/TrueDope.Api/Controllers/RiflesController.cs`

**Endpoints**:
- GET /api/rifles
- GET /api/rifles/{id}
- POST /api/rifles
- PUT /api/rifles/{id}
- DELETE /api/rifles/{id}

**Acceptance Criteria**:
- [ ] All endpoints implemented
- [ ] Delete returns proper error when sessions exist

---

### Task 12: Create Ammunition Controller

**Goal**: Implement REST API for ammunition and lots.

**File to Create**:
- `backend/src/TrueDope.Api/Controllers/AmmoController.cs`

**Endpoints**:
- GET /api/ammo
- GET /api/ammo/{id}
- POST /api/ammo
- PUT /api/ammo/{id}
- DELETE /api/ammo/{id}
- GET /api/ammo/{id}/lots
- POST /api/ammo/{id}/lots
- PUT /api/ammo/{id}/lots/{lotId}
- DELETE /api/ammo/{id}/lots/{lotId}

**Acceptance Criteria**:
- [ ] All endpoints implemented
- [ ] Lots correctly nested under ammo

---

### Task 13: Create Locations Controller

**Goal**: Implement REST API for saved locations.

**File to Create**:
- `backend/src/TrueDope.Api/Controllers/LocationsController.cs`

**Endpoints**:
- GET /api/locations
- GET /api/locations/{id}
- POST /api/locations
- PUT /api/locations/{id}
- DELETE /api/locations/{id}

**Acceptance Criteria**:
- [ ] All endpoints implemented

---

### Task 14: Create Images Controller

**Goal**: Implement REST API for image upload and retrieval.

**File to Create**:
- `backend/src/TrueDope.Api/Controllers/ImagesController.cs`

**Endpoints**:
- POST /api/images/upload
- GET /api/images/{id}
- GET /api/images/{id}/thumbnail
- PUT /api/images/{id}
- DELETE /api/images/{id}

**Acceptance Criteria**:
- [ ] File upload works with multipart/form-data
- [ ] Images served with correct content-type
- [ ] Thumbnails generated and served

---

### Task 15: Add Request Validation

**Goal**: Add comprehensive request validation.

**Options**:
1. DataAnnotations (simpler, already in DTOs)
2. FluentValidation (more powerful, separate classes)

**Recommendation**: Start with DataAnnotations, add FluentValidation if needed.

**Acceptance Criteria**:
- [ ] All DTOs have validation attributes
- [ ] Validation errors return structured response
- [ ] Custom validators for complex rules (e.g., exactly one parent for images)

---

### Task 16: Write Unit Tests

**Goal**: Add tests for critical business logic.

**Files to Create**:
```
backend/tests/TrueDope.Api.Tests/
├── Services/
│   ├── VelocityStatsCalculatorTests.cs
│   ├── SessionServiceTests.cs
│   └── AmmoServiceTests.cs
└── Controllers/
    ├── SessionsControllerTests.cs
    └── RiflesControllerTests.cs
```

**Test Coverage Priorities**:
1. Velocity statistics calculation (critical accuracy)
2. Session CRUD with nested data
3. Delete restrictions (rifle with sessions, ammo with sessions)
4. User ownership validation

**Acceptance Criteria**:
- [ ] VelocityStatsCalculator has 100% test coverage
- [ ] Critical business logic tested
- [ ] All tests pass

---

### Task 17: Register Services in DI

**Goal**: Configure dependency injection for all services.

**File to Modify**:
- `backend/src/TrueDope.Api/Program.cs`

**Steps**:
1. Register all services with scoped lifetime
2. Configure MinIO client
3. Register any validators

**Acceptance Criteria**:
- [ ] All services registered
- [ ] MinIO client configured from appsettings
- [ ] Application starts without DI errors

---

### Task 18: Update Swagger Documentation

**Goal**: Ensure all endpoints are documented in Swagger.

**Steps**:
1. Add XML documentation comments to controllers
2. Configure Swagger to use XML docs
3. Add operation descriptions
4. Define response types

**Acceptance Criteria**:
- [ ] All endpoints visible in Swagger UI
- [ ] Request/response schemas documented
- [ ] Try-it-out works for all endpoints

---

### Task 19: End-to-End Testing

**Goal**: Manually verify complete API functionality.

**Test Scenarios**:
1. Create rifle setup
2. Create ammunition with lot
3. Create saved location
4. Create session with DOPE data only
5. Create session with chrono data only
6. Create session with group data only
7. Create session with all data types
8. Update session (add/remove data)
9. Delete session
10. Upload image to session
11. Verify delete restrictions work
12. Test pagination and filtering

**Acceptance Criteria**:
- [ ] All test scenarios pass
- [ ] No errors in logs
- [ ] Data persists correctly

---

## File Structure After Phase 3

```
backend/src/TrueDope.Api/
├── Controllers/
│   ├── AuthController.cs         (existing)
│   ├── UsersController.cs        (existing)
│   ├── AdminController.cs        (existing)
│   ├── HealthController.cs       (existing)
│   ├── SessionsController.cs     NEW
│   ├── RiflesController.cs       NEW
│   ├── AmmoController.cs         NEW
│   ├── LocationsController.cs    NEW
│   └── ImagesController.cs       NEW
├── Data/
│   ├── ApplicationDbContext.cs   MODIFIED
│   ├── DbSeeder.cs              (existing)
│   └── Entities/
│       ├── User.cs               (existing)
│       ├── RangeSession.cs       NEW
│       ├── DopeEntry.cs          NEW
│       ├── ChronoSession.cs      NEW
│       ├── VelocityReading.cs    NEW
│       ├── GroupEntry.cs         NEW
│       ├── RifleSetup.cs         NEW
│       ├── Ammunition.cs         NEW
│       ├── AmmoLot.cs            NEW
│       ├── SavedLocation.cs      NEW
│       └── Image.cs              NEW
├── DTOs/
│   ├── ApiResponse.cs           (existing)
│   ├── Auth/                    (existing)
│   ├── Users/                   (existing)
│   ├── Admin/                   (existing)
│   ├── Sessions/                 NEW
│   ├── Rifles/                   NEW
│   ├── Ammunition/               NEW
│   ├── Locations/                NEW
│   └── Images/                   NEW
├── Services/
│   ├── IJwtService.cs           (existing)
│   ├── JwtService.cs            (existing)
│   ├── IEmailService.cs         (existing)
│   ├── EmailService.cs          (existing)
│   ├── ISessionService.cs        NEW
│   ├── SessionService.cs         NEW
│   ├── IRifleService.cs          NEW
│   ├── RifleService.cs           NEW
│   ├── IAmmoService.cs           NEW
│   ├── AmmoService.cs            NEW
│   ├── ILocationService.cs       NEW
│   ├── LocationService.cs        NEW
│   ├── IImageService.cs          NEW
│   ├── ImageService.cs           NEW
│   ├── IStorageService.cs        NEW
│   ├── MinioStorageService.cs    NEW
│   └── VelocityStatsCalculator.cs NEW
├── Migrations/
│   ├── (existing migrations)
│   └── YYYYMMDD_AddCoreEntities.cs NEW
└── Program.cs                    MODIFIED
```

---

## Acceptance Criteria (Phase Complete)

Phase 3 is complete when ALL of the following are true:

### Entities & Database
- [ ] All 10 entity classes created and configured
- [ ] ApplicationDbContext updated with relationships
- [ ] Migration created and applied
- [ ] Database schema matches specification
- [ ] Indexes and constraints created

### Services
- [ ] SessionService fully implemented
- [ ] RifleService fully implemented
- [ ] AmmoService fully implemented
- [ ] LocationService fully implemented
- [ ] ImageService fully implemented with MinIO
- [ ] VelocityStatsCalculator tested

### API Endpoints
- [ ] Sessions CRUD (including nested DOPE, chrono, groups)
- [ ] Rifles CRUD
- [ ] Ammunition CRUD (including lots)
- [ ] Locations CRUD
- [ ] Images upload/download/delete
- [ ] All endpoints return consistent response format
- [ ] All endpoints require authentication
- [ ] Swagger documentation complete

### Testing
- [ ] Unit tests for VelocityStatsCalculator
- [ ] Unit tests for critical service methods
- [ ] All tests pass
- [ ] Manual end-to-end testing complete

### Quality
- [ ] No compiler warnings
- [ ] Code follows existing patterns from Phase 1-2
- [ ] Error handling consistent
- [ ] Logging added for key operations

---

## Notes and Considerations

### Design Decisions

1. **No SessionType enum**: v1 had a `SessionType` enum. In v2, the "type" is derived from what child data exists. A session with only `DopeEntries` is a "DOPE session." A session with both `ChronoSession` and `GroupEntries` is a "combined" session.

2. **Linked ammunition only**: v1 supported both linked and legacy manual ammunition fields in RifleSetup. v2 simplifies to linked-only. Data import (Phase 12) will migrate legacy data.

3. **Image polymorphism**: Keeping the polymorphic image pattern from v1 (one Image table with nullable FKs to different parents). This is simpler than separate image tables per entity.

4. **ChronoSession 1:1 with RangeSession**: Instead of allowing multiple chrono sessions per range session, we have one. If users want to record multiple strings, they create separate sessions or add more readings to the same ChronoSession.

5. **GroupEntry independent of ChronoSession**: In v1, GroupData was nested under ShootingString. In v2, GroupEntry is directly under RangeSession. This allows recording groups without needing chrono data.

### Potential Improvements (Not This Phase)

1. **Bulk operations**: Add bulk create/update for velocity readings, DOPE entries
2. **Import/export**: CSV import for velocity data, export session data
3. **Computed aggregates**: Session summary statistics (total rounds, average SD across sessions)
4. **Caching**: Redis caching for frequently accessed data (rifle list, ammo list)

### Dependencies

This phase depends on:
- Phase 1 (project structure) ✅
- Phase 2 (authentication) ✅

This phase is required by:
- Phase 4 (Rifle & Ammo Management UI)
- Phase 5 (Session Recording UI)
- Phase 6 (Analytics)
- Phase 12 (Data Import)

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-07 | Initial Phase 3 specification created |
