# Phase 2: Authentication & User Management

**Created**: December 8, 2024
**Completed**: December 7, 2025
**Status**: Complete
**Parent**: [Project Manifest](./20251206.MANIFEST.md)

---

## Overview

This phase implements the complete authentication system for TrueDope v2, including ASP.NET Core Identity with PostgreSQL storage, JWT-based authentication for API access, and a React frontend with protected routes and auth UI. The implementation draws from proven patterns in v1 while making improvements for the new architecture.

---

## Database Entities

### User Entity (extends IdentityUser)

```csharp
public class User : IdentityUser
{
    // Profile information
    public string? FirstName { get; set; }
    public string? LastName { get; set; }

    // Account metadata
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? LastLoginAt { get; set; }

    // Admin flag (simple role approach)
    public bool IsAdmin { get; set; } = false;

    // Password reset (stored in User table, not Redis, for durability)
    public string? PasswordResetToken { get; set; }
    public DateTime? PasswordResetTokenExpiry { get; set; }

    // Future: Navigation properties will be added in Phase 3
    // public virtual ICollection<RifleSetup> RifleSetups { get; set; }
    // public virtual ICollection<RangeSession> RangeSessions { get; set; }
}
```

**Design Decisions**:
1. **Simple admin flag vs. full roles**: Using a boolean `IsAdmin` rather than AspNetRoles table. This app has two roles: user and admin. No need for complex role management.
2. **Password reset in DB vs. Redis**: Storing reset tokens in the database rather than Redis for durability. Reset tokens are infrequent and don't benefit from Redis performance.
3. **No timezone field for now**: Unit preferences (including timezone display) will be handled in Phase 9.

### EF Core Configuration

```csharp
// Data/ApplicationDbContext.cs
public class ApplicationDbContext : IdentityDbContext<User>
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options) { }

    protected override void OnModelCreating(ModelBuilder builder)
    {
        base.OnModelCreating(builder);

        // Rename Identity tables to remove "AspNet" prefix (cleaner schema)
        builder.Entity<User>().ToTable("Users");
        builder.Entity<IdentityUserClaim<string>>().ToTable("UserClaims");
        builder.Entity<IdentityUserLogin<string>>().ToTable("UserLogins");
        builder.Entity<IdentityUserToken<string>>().ToTable("UserTokens");

        // We're not using roles, but keep the tables in case we need them
        builder.Entity<IdentityRole>().ToTable("Roles");
        builder.Entity<IdentityRoleClaim<string>>().ToTable("RoleClaims");
        builder.Entity<IdentityUserRole<string>>().ToTable("UserRoles");

        // Configure User entity
        builder.Entity<User>(entity =>
        {
            entity.Property(u => u.FirstName).HasMaxLength(100);
            entity.Property(u => u.LastName).HasMaxLength(100);
            entity.Property(u => u.PasswordResetToken).HasMaxLength(256);

            entity.HasIndex(u => u.Email).IsUnique();
        });
    }
}
```

---

## Configuration

### JWT Settings

| Setting | Development | Production | Notes |
|---------|-------------|------------|-------|
| SecretKey | 32+ char string | Env variable | HMAC SHA256 |
| Issuer | TrueDope | TrueDope | |
| Audience | TrueDope | TrueDope | |
| AccessTokenExpiry | 15 minutes | 15 minutes | Short-lived |
| RefreshTokenExpiry | 7 days | 7 days | Stored in Redis |

### Password Requirements

| Requirement | Value |
|-------------|-------|
| MinimumLength | 8 |
| RequireDigit | true |
| RequireLowercase | true |
| RequireUppercase | true |
| RequireNonAlphanumeric | false |
| RequiredUniqueChars | 4 |

### Password Reset

| Setting | Value |
|---------|-------|
| Token Expiry | 1 hour |
| Token Length | 32 bytes (URL-safe base64) |
| Email From | noreply@truedope.io |

---

## API Endpoints

### Authentication Endpoints

#### POST /api/auth/register
Register a new user account.

**Request**:
```json
{
  "email": "user@example.com",
  "password": "SecurePass123",
  "confirmPassword": "SecurePass123",
  "firstName": "John",
  "lastName": "Doe"
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "userId": "guid",
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Doe"
  },
  "message": "Account created successfully"
}
```

**Errors**:
- 400: Validation errors (password requirements, email format)
- 409: Email already registered

---

#### POST /api/auth/login
Authenticate and receive JWT tokens.

**Request**:
```json
{
  "email": "user@example.com",
  "password": "SecurePass123"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbG...",
    "refreshToken": "base64...",
    "expiresIn": 900,
    "tokenType": "Bearer",
    "user": {
      "userId": "guid",
      "email": "user@example.com",
      "firstName": "John",
      "lastName": "Doe",
      "isAdmin": false
    }
  }
}
```

**Errors**:
- 401: Invalid credentials
- 400: Validation errors

---

#### POST /api/auth/refresh
Refresh access token using refresh token.

**Headers**: `Authorization: Bearer <expired-access-token>`

**Request**:
```json
{
  "refreshToken": "base64..."
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbG...",
    "refreshToken": "new-base64...",
    "expiresIn": 900,
    "tokenType": "Bearer"
  }
}
```

**Errors**:
- 401: Invalid/expired refresh token, invalid access token

---

#### POST /api/auth/logout
Logout and invalidate refresh token.

**Headers**: `Authorization: Bearer <access-token>`

**Request**:
```json
{
  "refreshToken": "base64..."
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

---

#### POST /api/auth/forgot-password
Request a password reset email.

**Request**:
```json
{
  "email": "user@example.com"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "If an account exists with this email, a reset link has been sent"
}
```

**Note**: Always returns 200 to prevent email enumeration.

---

#### POST /api/auth/reset-password
Reset password using token from email.

**Request**:
```json
{
  "token": "url-safe-token",
  "newPassword": "NewSecure123",
  "confirmPassword": "NewSecure123"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Password reset successfully"
}
```

**Errors**:
- 400: Invalid/expired token, password validation errors

---

### User Profile Endpoints

#### GET /api/users/me
Get current user's profile.

**Headers**: `Authorization: Bearer <access-token>`

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "userId": "guid",
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Doe",
    "isAdmin": false,
    "createdAt": "2024-12-08T10:00:00Z",
    "lastLoginAt": "2024-12-08T15:30:00Z"
  }
}
```

---

#### PUT /api/users/me
Update current user's profile.

**Headers**: `Authorization: Bearer <access-token>`

**Request**:
```json
{
  "firstName": "John",
  "lastName": "Smith"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "userId": "guid",
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Smith"
  },
  "message": "Profile updated successfully"
}
```

---

#### PUT /api/users/me/password
Change current user's password.

**Headers**: `Authorization: Bearer <access-token>`

**Request**:
```json
{
  "currentPassword": "OldPass123",
  "newPassword": "NewPass456",
  "confirmPassword": "NewPass456"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Password changed successfully"
}
```

**Errors**:
- 400: Current password incorrect, new password validation errors

---

### Admin Endpoints

#### GET /api/admin/users
List all users (admin only).

**Headers**: `Authorization: Bearer <admin-access-token>`

**Query Parameters**:
- `page` (int, default 1)
- `pageSize` (int, default 20, max 100)
- `search` (string, optional) - searches email, first name, last name
- `sortBy` (string, default "createdAt") - createdAt, email, lastLoginAt
- `sortDesc` (bool, default true)

**Response** (200 OK):
```json
{
  "success": true,
  "items": [
    {
      "userId": "guid",
      "email": "user@example.com",
      "firstName": "John",
      "lastName": "Doe",
      "isAdmin": false,
      "createdAt": "2024-12-08T10:00:00Z",
      "lastLoginAt": "2024-12-08T15:30:00Z"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "pageSize": 20,
    "totalItems": 45,
    "totalPages": 3
  }
}
```

---

#### GET /api/admin/users/{userId}
Get specific user details (admin only).

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "userId": "guid",
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Doe",
    "isAdmin": false,
    "createdAt": "2024-12-08T10:00:00Z",
    "lastLoginAt": "2024-12-08T15:30:00Z",
    "emailConfirmed": true,
    "lockoutEnd": null
  }
}
```

---

#### PUT /api/admin/users/{userId}
Update user (admin only).

**Request**:
```json
{
  "firstName": "John",
  "lastName": "Smith",
  "isAdmin": false
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "User updated successfully"
}
```

**Note**: Cannot demote yourself from admin.

---

#### POST /api/admin/users/{userId}/reset-password
Force password reset for user (admin only).

Generates a new password and returns it (one time). User must change on next login.

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "temporaryPassword": "RandomPass123!"
  },
  "message": "Password reset. User must change password on next login."
}
```

---

#### DELETE /api/admin/users/{userId}
Disable/delete user account (admin only).

**Note**: Soft delete - sets `LockoutEnd` to far future. Does not delete data.

**Response** (200 OK):
```json
{
  "success": true,
  "message": "User account disabled"
}
```

**Errors**:
- 400: Cannot disable yourself

---

## Frontend Structure

### New Files/Folders

```
frontend/src/
├── components/
│   └── auth/
│       ├── ProtectedRoute.tsx       # Route wrapper requiring auth
│       └── AdminRoute.tsx           # Route wrapper requiring admin
├── contexts/
│   └── AuthContext.tsx              # Auth state and methods
├── hooks/
│   └── useAuth.ts                   # Hook to access auth context
├── pages/
│   ├── auth/
│   │   ├── Login.tsx                # Login form
│   │   ├── Register.tsx             # Registration form
│   │   ├── ForgotPassword.tsx       # Request password reset
│   │   └── ResetPassword.tsx        # Reset password form
│   ├── settings/
│   │   ├── Settings.tsx             # Settings layout/nav
│   │   ├── Profile.tsx              # Edit profile
│   │   └── ChangePassword.tsx       # Change password
│   └── admin/
│       ├── Admin.tsx                # Admin layout/nav
│       └── Users.tsx                # User management
├── services/
│   ├── api.ts                       # Axios instance with interceptors
│   └── authService.ts               # Auth API calls
└── types/
    └── auth.ts                      # Auth-related TypeScript types
```

### Auth Context Design

```typescript
// contexts/AuthContext.tsx
interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  isAdmin: boolean;
}

interface AuthContextType extends AuthState {
  login: (email: string, password: string) => Promise<void>;
  register: (data: RegisterData) => Promise<void>;
  logout: () => Promise<void>;
  refreshToken: () => Promise<boolean>;
}

// Token storage: localStorage for refresh token, memory for access token
// Access token refreshed automatically via axios interceptor on 401
```

### Protected Route Pattern

```typescript
// components/auth/ProtectedRoute.tsx
const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { isAuthenticated, isLoading } = useAuth();
  const location = useLocation();

  if (isLoading) {
    return <LoadingSpinner />;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return <>{children}</>;
};
```

### Route Structure

```typescript
// App.tsx routes
<Routes>
  {/* Public routes */}
  <Route path="/login" element={<Login />} />
  <Route path="/register" element={<Register />} />
  <Route path="/forgot-password" element={<ForgotPassword />} />
  <Route path="/reset-password" element={<ResetPassword />} />

  {/* Protected routes */}
  <Route element={<ProtectedRoute><AppLayout /></ProtectedRoute>}>
    <Route path="/" element={<Dashboard />} />
    <Route path="/settings" element={<Settings />}>
      <Route index element={<Profile />} />
      <Route path="password" element={<ChangePassword />} />
    </Route>
  </Route>

  {/* Admin routes */}
  <Route element={<AdminRoute><AdminLayout /></AdminRoute>}>
    <Route path="/admin" element={<Admin />}>
      <Route index element={<AdminDashboard />} />
      <Route path="users" element={<Users />} />
    </Route>
  </Route>
</Routes>
```

---

## Tasks

### Task 1: Configure ASP.NET Core Identity

**Goal**: Set up Identity with PostgreSQL storage and custom User entity.

**Steps**:
1. Add NuGet package: `Microsoft.AspNetCore.Identity.EntityFrameworkCore`
2. Create `Data/Entities/User.cs` with custom fields
3. Create `Data/ApplicationDbContext.cs` extending `IdentityDbContext<User>`
4. Configure Identity in `Program.cs`:
   - Password requirements
   - Lockout settings
   - User validation options
5. Configure connection string in appsettings
6. Create and apply initial migration

**Files to Create/Modify**:
- `backend/src/TrueDope.Api/Data/Entities/User.cs`
- `backend/src/TrueDope.Api/Data/ApplicationDbContext.cs`
- `backend/src/TrueDope.Api/Program.cs` (add Identity services)
- `backend/src/TrueDope.Api/appsettings.json` (connection string)

**Acceptance Criteria**:
- [ ] Identity tables created in PostgreSQL
- [ ] Custom User fields (FirstName, LastName, etc.) in schema
- [ ] `dotnet ef migrations add InitialIdentity` succeeds
- [ ] Application starts and connects to database

---

### Task 2: Implement JWT Service

**Goal**: Create service for generating and validating JWT tokens.

**Steps**:
1. Create `JwtSettings` configuration class
2. Create `IJwtService` interface
3. Implement `JwtService`:
   - `GenerateAccessToken(User user)` - creates JWT with claims
   - `GenerateRefreshToken()` - creates random refresh token
   - `StoreRefreshTokenAsync(userId, token)` - stores in Redis
   - `ValidateRefreshTokenAsync(userId, token)` - checks Redis
   - `RevokeRefreshTokenAsync(userId, token)` - removes from Redis
4. Register services in DI container
5. Configure JWT authentication in `Program.cs`

**Files to Create**:
- `backend/src/TrueDope.Api/Services/IJwtService.cs`
- `backend/src/TrueDope.Api/Services/JwtService.cs`
- `backend/src/TrueDope.Api/Configuration/JwtSettings.cs`

**Acceptance Criteria**:
- [ ] Access tokens generated with correct claims
- [ ] Refresh tokens stored/retrieved from Redis
- [ ] Token expiration configured correctly
- [ ] JWT validation middleware working

---

### Task 3: Implement Auth Controller

**Goal**: Create API endpoints for login, register, refresh, logout.

**Steps**:
1. Create `DTOs/Auth/` folder with request/response DTOs
2. Implement `AuthController`:
   - `POST /api/auth/register`
   - `POST /api/auth/login`
   - `POST /api/auth/refresh`
   - `POST /api/auth/logout`
3. Add request validation with DataAnnotations
4. Add proper error handling and responses

**Files to Create**:
- `backend/src/TrueDope.Api/Controllers/AuthController.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/LoginRequest.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/LoginResponse.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/RegisterRequest.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/RegisterResponse.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/RefreshRequest.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/RefreshResponse.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/LogoutRequest.cs`

**Acceptance Criteria**:
- [ ] Registration creates user in database
- [ ] Login returns valid JWT tokens
- [ ] Refresh token rotation works
- [ ] Logout invalidates refresh token
- [ ] All endpoints return consistent API response format
- [ ] Swagger documentation shows all endpoints

---

### Task 4: Implement Password Reset Flow

**Goal**: Add forgot password and reset password functionality.

**Steps**:
1. Create email service interface and implementation
2. Configure SMTP settings (SMTP2GO)
3. Implement password reset endpoints:
   - `POST /api/auth/forgot-password`
   - `POST /api/auth/reset-password`
4. Create email template for password reset
5. Add token generation and validation

**Files to Create**:
- `backend/src/TrueDope.Api/Services/IEmailService.cs`
- `backend/src/TrueDope.Api/Services/EmailService.cs`
- `backend/src/TrueDope.Api/Configuration/SmtpSettings.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/ForgotPasswordRequest.cs`
- `backend/src/TrueDope.Api/DTOs/Auth/ResetPasswordRequest.cs`

**Configuration** (appsettings/env):
```json
{
  "Smtp": {
    "Host": "mail.smtp2go.com",
    "Port": 2525,
    "Username": "",
    "Password": "",
    "FromEmail": "noreply@truedope.io",
    "FromName": "TrueDope"
  }
}
```

**Acceptance Criteria**:
- [ ] Forgot password sends email with reset link
- [ ] Reset token expires after 1 hour
- [ ] Reset password validates token and updates password
- [ ] Invalid/expired tokens return proper errors
- [ ] Email enumeration prevented (always 200 response)

---

### Task 5: Implement User Profile Endpoints

**Goal**: Create endpoints for viewing and updating user profile.

**Steps**:
1. Create `UsersController` with:
   - `GET /api/users/me`
   - `PUT /api/users/me`
   - `PUT /api/users/me/password`
2. Add DTOs for profile operations
3. Implement password change logic

**Files to Create**:
- `backend/src/TrueDope.Api/Controllers/UsersController.cs`
- `backend/src/TrueDope.Api/DTOs/Users/UserProfileResponse.cs`
- `backend/src/TrueDope.Api/DTOs/Users/UpdateProfileRequest.cs`
- `backend/src/TrueDope.Api/DTOs/Users/ChangePasswordRequest.cs`

**Acceptance Criteria**:
- [ ] GET /api/users/me returns current user
- [ ] PUT /api/users/me updates profile
- [ ] Password change requires current password
- [ ] All endpoints require authentication

---

### Task 6: Implement Admin User Management

**Goal**: Create admin endpoints for managing users.

**Steps**:
1. Create admin authorization policy
2. Create `AdminController` with user management endpoints:
   - `GET /api/admin/users` (paginated list)
   - `GET /api/admin/users/{id}`
   - `PUT /api/admin/users/{id}`
   - `POST /api/admin/users/{id}/reset-password`
   - `DELETE /api/admin/users/{id}`
3. Add admin-specific DTOs
4. Implement search and pagination

**Files to Create**:
- `backend/src/TrueDope.Api/Controllers/AdminController.cs`
- `backend/src/TrueDope.Api/DTOs/Admin/UserListItemDto.cs`
- `backend/src/TrueDope.Api/DTOs/Admin/UserDetailDto.cs`
- `backend/src/TrueDope.Api/DTOs/Admin/UpdateUserRequest.cs`

**Acceptance Criteria**:
- [ ] Only admin users can access endpoints
- [ ] User list supports search and pagination
- [ ] Admin cannot demote themselves
- [ ] Admin cannot delete themselves
- [ ] Password reset generates temporary password

---

### Task 7: Create React Auth Context

**Goal**: Implement authentication state management in React.

**Steps**:
1. Create TypeScript types for auth
2. Create auth context with state and methods
3. Implement token storage strategy:
   - Access token in memory
   - Refresh token in localStorage
4. Create `useAuth` hook
5. Create axios instance with interceptors:
   - Add auth header
   - Handle 401 and auto-refresh

**Files to Create**:
- `frontend/src/types/auth.ts`
- `frontend/src/contexts/AuthContext.tsx`
- `frontend/src/hooks/useAuth.ts`
- `frontend/src/services/api.ts`
- `frontend/src/services/authService.ts`

**Acceptance Criteria**:
- [ ] Auth state persists across page refresh
- [ ] Tokens stored securely
- [ ] Auto-refresh on 401 works
- [ ] Logout clears all tokens

---

### Task 8: Create Protected Route Components

**Goal**: Implement route protection for authenticated and admin routes.

**Steps**:
1. Create `ProtectedRoute` component
2. Create `AdminRoute` component
3. Update App.tsx with route structure
4. Add loading state during auth check

**Files to Create**:
- `frontend/src/components/auth/ProtectedRoute.tsx`
- `frontend/src/components/auth/AdminRoute.tsx`

**Files to Modify**:
- `frontend/src/App.tsx`

**Acceptance Criteria**:
- [ ] Unauthenticated users redirected to login
- [ ] Non-admin users cannot access admin routes
- [ ] Redirect preserves intended destination
- [ ] Loading state shows during auth check

---

### Task 9: Create Login Page

**Goal**: Build the login UI with form validation.

**Steps**:
1. Create login form with email and password fields
2. Add client-side validation
3. Handle login errors (show messages)
4. Redirect to intended page after login
5. Add "Forgot password?" link
6. Add "Register" link

**Files to Create**:
- `frontend/src/pages/auth/Login.tsx`

**UI Requirements**:
- Clean, centered form layout
- Email and password inputs
- "Remember me" checkbox (optional)
- Submit button with loading state
- Error messages displayed clearly
- Links to forgot password and register

**Acceptance Criteria**:
- [ ] Form validates before submission
- [ ] Login errors displayed to user
- [ ] Successful login redirects appropriately
- [ ] Loading state during submission
- [ ] Responsive design

---

### Task 10: Create Registration Page

**Goal**: Build the registration UI with form validation.

**Steps**:
1. Create registration form with all fields
2. Add client-side validation matching server rules
3. Show password requirements
4. Handle registration errors
5. Redirect to login after successful registration

**Files to Create**:
- `frontend/src/pages/auth/Register.tsx`

**UI Requirements**:
- Email, password, confirm password fields
- First name, last name fields
- Password requirements indicator
- Submit button with loading state
- Link to login

**Acceptance Criteria**:
- [ ] Form validates all fields
- [ ] Password requirements shown
- [ ] Passwords must match
- [ ] Registration errors displayed
- [ ] Redirect to login on success

---

### Task 11: Create Password Reset Pages

**Goal**: Build forgot password and reset password flows.

**Steps**:
1. Create forgot password page (email input)
2. Create reset password page (token from URL, new password)
3. Handle success and error states
4. Add password requirements display

**Files to Create**:
- `frontend/src/pages/auth/ForgotPassword.tsx`
- `frontend/src/pages/auth/ResetPassword.tsx`

**UI Requirements**:
- Forgot: Email input with submit
- Forgot: Success message after submission
- Reset: Password and confirm fields
- Reset: Token from URL query parameter
- Reset: Success redirects to login

**Acceptance Criteria**:
- [ ] Forgot password shows success regardless of email existence
- [ ] Reset password validates token from URL
- [ ] Invalid token shows error message
- [ ] Successful reset redirects to login

---

### Task 12: Create User Settings Pages

**Goal**: Build settings UI for profile and password management.

**Steps**:
1. Create settings layout with navigation
2. Create profile edit form
3. Create password change form
4. Handle save operations

**Files to Create**:
- `frontend/src/pages/settings/Settings.tsx`
- `frontend/src/pages/settings/Profile.tsx`
- `frontend/src/pages/settings/ChangePassword.tsx`

**UI Requirements**:
- Settings layout with sidebar navigation
- Profile: First name, last name, email (read-only)
- Profile: Save button
- Password: Current password, new password, confirm
- Password: Requirements indicator
- Success/error messages

**Acceptance Criteria**:
- [ ] Profile loads current user data
- [ ] Profile updates save successfully
- [ ] Password change requires current password
- [ ] Error handling for all operations

---

### Task 13: Create Admin User Management Page

**Goal**: Build admin interface for managing users.

**Steps**:
1. Create admin layout
2. Create users list with search and pagination
3. Create user detail/edit modal or page
4. Implement disable user functionality
5. Implement admin password reset

**Files to Create**:
- `frontend/src/pages/admin/Admin.tsx`
- `frontend/src/pages/admin/Users.tsx`
- `frontend/src/components/admin/UserEditModal.tsx` (or inline)

**UI Requirements**:
- User table with columns: email, name, created, last login, admin, actions
- Search input
- Pagination controls
- Edit button opens modal/form
- Disable user confirmation dialog
- Reset password shows temporary password

**Acceptance Criteria**:
- [ ] User list loads with pagination
- [ ] Search filters results
- [ ] Edit updates user successfully
- [ ] Cannot disable yourself
- [ ] Reset password shows temporary password once

---

### Task 14: Create Initial Admin User Seeding

**Goal**: Seed an initial admin user for first-time setup.

**Steps**:
1. Create database seeder that runs on startup
2. Check if any users exist
3. If no users, create admin from environment variables
4. Log that admin was created

**Configuration**:
```
ADMIN_EMAIL=admin@truedope.io
ADMIN_PASSWORD=ChangeMe123!
ADMIN_FIRSTNAME=Admin
ADMIN_LASTNAME=User
```

**Files to Create**:
- `backend/src/TrueDope.Api/Data/DbSeeder.cs`

**Acceptance Criteria**:
- [ ] First run creates admin user
- [ ] Subsequent runs don't create duplicates
- [ ] Admin credentials from environment variables
- [ ] Logged when admin created

---

### Task 15: Write Unit Tests for Auth Logic

**Goal**: Add tests for critical authentication logic.

**Test Coverage**:
1. JWT token generation
2. Refresh token validation
3. Password reset token validation
4. User registration validation
5. Login validation

**Files to Create**:
- `backend/tests/TrueDope.Api.Tests/Services/JwtServiceTests.cs`
- `backend/tests/TrueDope.Api.Tests/Controllers/AuthControllerTests.cs`

**Acceptance Criteria**:
- [ ] JWT service tests pass
- [ ] Auth controller tests cover main flows
- [ ] All tests pass in CI

---

### Task 16: Update Documentation

**Goal**: Update project documentation for auth.

**Steps**:
1. Update CLAUDE.md with auth endpoints
2. Update README with auth setup
3. Document environment variables

**Files to Modify**:
- `TrueDope/CLAUDE.md`
- `TrueDope/README.md`
- `TrueDope/.env.example`

**Acceptance Criteria**:
- [ ] All auth endpoints documented
- [ ] Environment variables documented
- [ ] Setup instructions clear

---

## Environment Variables

Add to `.env.example`:

```bash
# JWT Configuration
JWT_SECRET_KEY=your-256-bit-secret-key-here-change-in-production
JWT_ISSUER=TrueDope
JWT_AUDIENCE=TrueDope
JWT_ACCESS_TOKEN_EXPIRY_MINUTES=15
JWT_REFRESH_TOKEN_EXPIRY_DAYS=7

# SMTP (SMTP2GO)
SMTP_HOST=mail.smtp2go.com
SMTP_PORT=2525
SMTP_USERNAME=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=noreply@truedope.io
SMTP_FROM_NAME=TrueDope

# Initial Admin (first run only)
ADMIN_EMAIL=admin@truedope.io
ADMIN_PASSWORD=ChangeMe123!
ADMIN_FIRSTNAME=Admin
ADMIN_LASTNAME=User
```

---

## File Structure After Phase 2

```
backend/src/TrueDope.Api/
├── Configuration/
│   ├── JwtSettings.cs
│   └── SmtpSettings.cs
├── Controllers/
│   ├── HealthController.cs          # (existing)
│   ├── AuthController.cs            # NEW
│   ├── UsersController.cs           # NEW
│   └── AdminController.cs           # NEW
├── Data/
│   ├── Entities/
│   │   └── User.cs                  # NEW
│   ├── ApplicationDbContext.cs      # NEW
│   └── DbSeeder.cs                  # NEW
├── DTOs/
│   ├── ApiResponse.cs               # (existing)
│   ├── Auth/
│   │   ├── LoginRequest.cs          # NEW
│   │   ├── LoginResponse.cs         # NEW
│   │   ├── RegisterRequest.cs       # NEW
│   │   ├── RegisterResponse.cs      # NEW
│   │   ├── RefreshRequest.cs        # NEW
│   │   ├── RefreshResponse.cs       # NEW
│   │   ├── LogoutRequest.cs         # NEW
│   │   ├── ForgotPasswordRequest.cs # NEW
│   │   └── ResetPasswordRequest.cs  # NEW
│   ├── Users/
│   │   ├── UserProfileResponse.cs   # NEW
│   │   ├── UpdateProfileRequest.cs  # NEW
│   │   └── ChangePasswordRequest.cs # NEW
│   └── Admin/
│       ├── UserListItemDto.cs       # NEW
│       ├── UserDetailDto.cs         # NEW
│       └── UpdateUserRequest.cs     # NEW
├── Migrations/
│   └── YYYYMMDD_InitialIdentity.cs  # NEW
├── Services/
│   ├── IJwtService.cs               # NEW
│   ├── JwtService.cs                # NEW
│   ├── IEmailService.cs             # NEW
│   └── EmailService.cs              # NEW
└── Program.cs                       # MODIFIED

frontend/src/
├── components/
│   └── auth/
│       ├── ProtectedRoute.tsx       # NEW
│       └── AdminRoute.tsx           # NEW
├── contexts/
│   └── AuthContext.tsx              # NEW
├── hooks/
│   └── useAuth.ts                   # NEW
├── pages/
│   ├── Home.tsx                     # (existing)
│   ├── auth/
│   │   ├── Login.tsx                # NEW
│   │   ├── Register.tsx             # NEW
│   │   ├── ForgotPassword.tsx       # NEW
│   │   └── ResetPassword.tsx        # NEW
│   ├── settings/
│   │   ├── Settings.tsx             # NEW
│   │   ├── Profile.tsx              # NEW
│   │   └── ChangePassword.tsx       # NEW
│   └── admin/
│       ├── Admin.tsx                # NEW
│       └── Users.tsx                # NEW
├── services/
│   ├── api.ts                       # NEW
│   └── authService.ts               # NEW
├── types/
│   └── auth.ts                      # NEW
└── App.tsx                          # MODIFIED
```

---

## Acceptance Criteria (Phase Complete)

Phase 2 is complete when ALL of the following are true:

### Backend
- [ ] Identity tables created and migrations applied
- [ ] User registration works with validation
- [ ] Login returns JWT access and refresh tokens
- [ ] Token refresh works correctly
- [ ] Logout invalidates refresh token
- [ ] Password reset email sends successfully
- [ ] Password reset completes successfully
- [ ] User profile endpoints work
- [ ] Admin user management endpoints work
- [ ] Admin-only endpoints reject non-admin users
- [ ] Initial admin user seeded on first run
- [ ] Unit tests pass

### Frontend
- [ ] Auth context manages state correctly
- [ ] Tokens stored and refreshed properly
- [ ] Protected routes redirect to login
- [ ] Admin routes reject non-admin users
- [ ] Login page works
- [ ] Registration page works
- [ ] Forgot password flow works
- [ ] Reset password flow works
- [ ] Settings pages work
- [ ] Admin user management works
- [ ] All pages are responsive

### Integration
- [ ] Full login → use app → logout flow works
- [ ] Token refresh happens automatically
- [ ] Auth persists across page refresh
- [ ] Password reset email-to-reset flow works

---

## Notes and Considerations

### Security Decisions

1. **Access token in memory**: Prevents XSS from stealing tokens. Refresh token in localStorage is acceptable because it's useless without the access token for initial validation.

2. **Short access token lifetime**: 15 minutes limits damage if token is compromised.

3. **Refresh token rotation**: New refresh token issued on each refresh, old one invalidated. Limits replay window.

4. **Password reset token in DB**: More durable than Redis. Acceptable since resets are infrequent.

### Trade-offs

1. **Simple admin flag vs. full roles**: Simpler code, but less flexible. Acceptable for this app's needs.

2. **Email service direct vs. queue**: Direct sending is simpler. Consider queue later if email volume increases.

3. **No email confirmation**: Auto-confirming email on registration. Could add later if spam becomes an issue.

### Future Considerations (Not This Phase)

- Two-factor authentication (2FA)
- OAuth/social login
- Account lockout after failed attempts
- Audit logging for admin actions
- Email verification flow

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-08 | Initial Phase 2 specification created |
