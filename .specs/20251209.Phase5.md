# Phase 5: Session Recording - Enhanced UX

**Created**: December 9, 2024
**Status**: Planning
**Parent**: [Project Manifest](./20251206.MANIFEST.md)
**Depends On**: Phase 4 (Frontend Foundation) ✅

---

## Overview

Phase 5 enhances the session recording experience with improved UX patterns. Phase 4 delivered working CRUD for sessions with DOPE, chrono, and group data. This phase focuses on:

1. **Weather Auto-Fetch** - Integration with OpenWeatherMap to populate conditions
2. **Session List Filters** - Filter by data type and rifle
3. **Session Creation Wizard** - Step-based creation flow with better guidance
4. **Read-Only Detail View Polish** - Enhanced detail view presentation

### What Already Exists (from Phase 4)

- Session list with search and date filters
- Session create page (basic form)
- Session edit page with Details, DOPE, Chrono, Groups tabs
- Session detail page with read-only tabs
- All CRUD operations working
- Pagination and loading states

### What This Phase Delivers

1. **Weather Integration** - "Fetch Weather" button that populates conditions from OpenWeatherMap
2. **Enhanced Filters** - Data type checkboxes, rifle dropdown in sessions list
3. **Wizard Creation Flow** - Multi-step session creation with data type selection
4. **Improved Detail View** - Better stats display, visual enhancements

---

## Design Decisions

### Weather Integration

**Decision: Backend weather endpoint + auto-fetch when location selected**

Flow:
1. User selects a saved location (with coordinates) OR enters GPS coordinates
2. Weather auto-fetches immediately when valid coordinates are available
3. Frontend calls backend weather endpoint with lat/long
4. Backend proxies to OpenWeatherMap API (handles API key securely)
5. Response populates temperature, humidity, pressure, wind speed, wind direction
6. User can manually adjust values after fetch
7. Manual "Refresh Weather" button available if user wants to re-fetch

Backend endpoint:
```
GET /api/weather?lat={latitude}&long={longitude}
```

Response:
```json
{
  "success": true,
  "data": {
    "temperature": 72.5,
    "humidity": 45,
    "pressure": 29.92,
    "windSpeed": 8.5,
    "windDirection": 270,
    "windDirectionCardinal": "W",
    "densityAltitude": 7200,
    "description": "Partly cloudy"
  }
}
```

Notes:
- Auto-fetches when location with coordinates is selected
- Manual "Refresh Weather" button for re-fetching
- Caches responses for 10 minutes (same coords = same response)
- Graceful error handling (API down, rate limited, invalid coords)
- Loading spinner in conditions section during fetch
- For past-date sessions, user may want to clear auto-fetched values (current weather not relevant)

### Session List Filters

**Decision: Expand filter UI with data type checkboxes and rifle dropdown**

Current filters:
- Search (text)
- Start date
- End date

New filters to add:
- Rifle dropdown (user's rifles)
- Data type checkboxes: Has DOPE, Has Chrono, Has Groups
- Clear filters button

Layout:
```
┌──────────────────────────────────────────────────────────────────────┐
│ [Search...________________] [Rifle: All ▾] [From: ____] [To: ____]  │
│ □ Has DOPE  □ Has Chrono  □ Has Groups               [Clear] [Apply]│
└──────────────────────────────────────────────────────────────────────┘
```

Notes:
- Filters are additive (AND logic)
- Clear button resets all filters
- Filters apply immediately or on "Apply" click (TBD based on UX testing)
- Filter state preserved in URL query params for bookmarking

### Session Creation Flow

**Decision: Simplified create page without data type checkboxes**

The current flow creates a minimal session then redirects to edit. This works well - the edit page with tabs already lets users choose what data to record. Data type checkboxes on the create page are redundant.

**Enhanced create page structure:**

1. **Basic Info** (required)
   - Date (defaults to today)
   - Time (optional)
   - Rifle (required, dropdown with "+ Add New")

2. **Location** (optional)
   - Saved locations dropdown
   - "Use GPS" button for current location
   - GPS coordinates displayed if acquired

3. **Conditions** (optional, collapsible)
   - Collapsed by default
   - Auto-expands and populates when weather fetched
   - Temperature, Humidity, Pressure, Wind Speed, Wind Direction, Density Altitude
   - "Refresh Weather" button for manual re-fetch

4. **Notes** (optional)
   - Textarea for session notes

5. **Helpful guidance text**
   - *"After creating, you can add DOPE, chrono, and group data."*

**Smart defaults:**
- Date defaults to today
- First rifle pre-selected (if user has rifles)
- Weather auto-fetches when location with coordinates selected

**Validation:**
- Rifle required (friendly error message)

**Submit flow:**
- Creates session with basic info + conditions
- Navigates to `/sessions/{id}/edit`
- Edit page shows all three tabs (DOPE, Chrono, Groups)
- Toast: "Session created. Add your data below."

### Detail View Enhancements

Current detail view is functional. Enhancements:

1. **Better stats cards**:
   - Longer distance with DOPE
   - Velocity SD (if chrono data)
   - Best group size
   - Conditions summary icon

2. **Conditions visual**:
   - Weather icon based on conditions
   - Compact display in header area

3. **Quick actions**:
   - "Add DOPE" button if no DOPE data
   - "Add Chrono" button if no chrono data
   - "Add Group" button if no group data
   - These navigate to edit page with relevant tab open

4. **Print/Export preview**:
   - Stub for future print/PDF export
   - "Share" or "Export" button (disabled, coming soon)

---

## Sub-Phases

### Phase 5.1: Backend Weather Endpoint

**Goal**: Create weather API endpoint with OpenWeatherMap integration.

**Tasks**:

1. Create WeatherController with GET endpoint:
   - Route: `/api/weather`
   - Query params: `lat`, `long`
   - Authorization required

2. Create WeatherService:
   - Inject HttpClient for OpenWeatherMap calls
   - API key from configuration/environment
   - Map OWM response to our DTO format
   - Calculate density altitude from temp/pressure/altitude
   - Handle errors gracefully

3. Create WeatherDto:
   ```csharp
   public class WeatherDto
   {
       public decimal Temperature { get; set; }     // Fahrenheit
       public int Humidity { get; set; }            // Percentage
       public decimal Pressure { get; set; }        // inHg
       public decimal WindSpeed { get; set; }       // mph
       public int WindDirection { get; set; }       // degrees
       public string WindDirectionCardinal { get; set; }  // N, NE, E, etc.
       public int? DensityAltitude { get; set; }    // feet
       public string Description { get; set; }      // e.g., "Partly cloudy"
   }
   ```

4. Configuration:
   - Add `OpenWeatherMap:ApiKey` to appsettings
   - Add to docker-compose environment

5. Caching:
   - Use IMemoryCache with 10-minute expiration
   - Cache key based on rounded lat/long (3 decimal places)

6. Unit conversion helpers:
   - OWM returns Kelvin → convert to Fahrenheit
   - OWM returns m/s → convert to mph
   - OWM returns hPa → convert to inHg

**Acceptance Criteria**:
- [ ] GET /api/weather returns weather data for valid coordinates
- [ ] Invalid coordinates return appropriate error
- [ ] Missing API key returns configuration error
- [ ] Responses are cached for 10 minutes
- [ ] All units match our standards (°F, mph, inHg)
- [ ] Wind direction includes cardinal direction (N, NE, E, etc.)

---

### Phase 5.2: Frontend Weather Integration

**Goal**: Add "Fetch Weather" button to session create/edit pages.

**Tasks**:

1. Create weather service:
   - `services/weather.service.ts`
   - `getWeather(lat: number, long: number): Promise<WeatherDto>`

2. Create weather types:
   - Add `WeatherDto` to types
   - Match backend structure

3. Add weather auto-fetch to SessionCreate:
   - Auto-fetches when location with coordinates is selected
   - "Refresh Weather" button to manually re-fetch
   - Loading spinner in conditions section during fetch
   - On success, populate all condition fields
   - On error, show toast notification (non-blocking)
   - Conditions section auto-expands when weather loads

4. Add weather auto-fetch to SessionEdit:
   - Same pattern as create
   - Auto-fetches when location changed to one with coordinates
   - "Refresh Weather" button available

5. GPS coordinate input:
   - Add "Use GPS" button that uses browser geolocation
   - Populate latitude/longitude fields
   - Triggers weather auto-fetch after GPS acquired
   - Error handling for geolocation denied/unavailable

6. Improve conditions section UX:
   - Collapsible section (collapsed by default)
   - Auto-expands when weather data loads
   - Visual indication when conditions populated
   - "Refresh Weather" button for manual re-fetch

**Acceptance Criteria**:
- [ ] Weather auto-fetches when location with coordinates selected
- [ ] "Refresh Weather" button available for manual re-fetch
- [ ] All condition fields populate from weather API
- [ ] Loading state shown during fetch
- [ ] Error toast shown on API failure (non-blocking)
- [ ] "Use GPS" button acquires browser location
- [ ] GPS coordinates trigger weather auto-fetch

---

### Phase 5.3: Enhanced Session List Filters

**Goal**: Add rifle dropdown and data type filter checkboxes to session list.

**Tasks**:

1. Add rifle filter dropdown:
   - Load user's rifles on page load
   - "All Rifles" as default option
   - Filter triggers on change

2. Add data type checkboxes:
   - [ ] Has DOPE
   - [ ] Has Chrono
   - [ ] Has Groups
   - Checkboxes are independent (OR within types, AND across filters)
   - Update filter state on change

3. Add "Clear Filters" button:
   - Resets search, date range, rifle, and data type filters
   - Only visible when filters are active

4. Update filter bar layout:
   - Row 1: Search input, Rifle dropdown, Date range
   - Row 2: Data type checkboxes, Clear button
   - Responsive: Stack on mobile

5. Apply filters to API call:
   - Map checkbox states to `hasDopeData`, `hasChronoData`, `hasGroupData`
   - Pass `rifleId` parameter

6. URL query params (optional enhancement):
   - Sync filter state with URL
   - Allows bookmarking/sharing filtered views
   - e.g., `/sessions?rifle=1&hasDopeData=true`

**Acceptance Criteria**:
- [ ] Rifle dropdown shows user's rifles with "All" option
- [ ] Filtering by rifle works correctly
- [ ] Data type checkboxes filter sessions
- [ ] Multiple checkboxes combine with AND logic
- [ ] Clear button resets all filters
- [ ] Filters persist across pagination
- [ ] Empty state shows when filters match nothing

---

### Phase 5.4: Enhanced Session Creation

**Goal**: Improve session creation flow with better organization and weather integration.

**Tasks**:

1. Reorganize SessionCreate layout into clear sections:
   - Section 1: "Basic Info" - Date, Time (optional), Rifle (required)
   - Section 2: "Location" - Location dropdown, GPS option
   - Section 3: "Conditions" - Collapsible section with weather fields
   - Section 4: "Notes" - Optional textarea
   - Helpful text: "After creating, you can add DOPE, chrono, and group data."

2. Improved location section:
   - Saved locations dropdown
   - "Use GPS" button inline
   - GPS coordinates displayed if acquired
   - Location name auto-populates from saved location

3. Collapsible conditions section:
   - Collapsed by default
   - "Show Conditions" expand button
   - Auto-expands when weather data loads
   - All condition fields (temp, humidity, pressure, wind, density altitude)

4. Form validation:
   - Date required (defaults to today)
   - Rifle required (defaults to first rifle if available)
   - Friendly error messages

5. Submit flow:
   - Creates session with basic info + conditions
   - Navigates to `/sessions/{id}/edit`
   - Edit page shows all three tabs (DOPE, Chrono, Groups)
   - Toast: "Session created. Add your data below."

6. Visual polish:
   - Card-based sections with subtle borders
   - Clear section headers
   - Responsive layout

**Acceptance Criteria**:
- [ ] New layout with clear sections (Basic Info, Location, Conditions, Notes)
- [ ] No data type checkboxes (removed - tabs on edit page handle this)
- [ ] Conditions section collapsible, auto-expands when weather loads
- [ ] Weather auto-fetches when location with coordinates selected
- [ ] GPS option works and populates coordinates
- [ ] After create, navigates to edit page with all tabs available
- [ ] Helpful guidance text displayed
- [ ] Validation messages clear and helpful

---

### Phase 5.5: Session Detail Enhancements

**Goal**: Polish the read-only session detail view.

**Tasks**:

1. Enhanced stats cards:
   - "Farthest DOPE" - Shows max distance with elevation value
   - "Velocity" - Average with SD in subtext (if chrono)
   - "Best Group" - Size in MOA at distance (if groups)
   - "Session Date" - With weather icon if conditions recorded

2. Conditions display improvements:
   - Compact inline display in header area
   - Weather icon (sun, cloud, rain based on description if available)
   - Temperature prominent, other values in tooltip or expandable

3. Quick action buttons:
   - "Edit Session" (existing)
   - "Add DOPE" / "Add Chrono" / "Add Groups" if respective tab is empty
   - These link to edit page with tab query param

4. Empty tab states:
   - "No DOPE entries yet. [Record DOPE →]" links to edit
   - Same pattern for Chrono and Groups

5. Tab URL sync:
   - URL reflects current tab: `/sessions/1#dope`
   - Deep linking to specific tab works

6. Print preview preparation:
   - "Export" button (disabled, tooltip: "Coming soon")
   - CSS print styles for clean printing (optional)

**Acceptance Criteria**:
- [ ] Stats cards show meaningful data
- [ ] Farthest distance displayed for DOPE
- [ ] Velocity SD displayed for chrono
- [ ] Best group size and distance displayed
- [ ] Quick action buttons for empty data types
- [ ] Clicking quick action opens edit with correct tab
- [ ] Tabs can be deep-linked via URL hash

---

### Phase 5.6: Polish & Testing

**Goal**: Final polish, edge cases, and end-to-end testing.

**Tasks**:

1. Loading states:
   - Weather fetch loading spinner
   - Condition fields disabled during fetch
   - Button states during API calls

2. Error handling:
   - Weather API failures (network, rate limit, invalid coords)
   - Geolocation permission denied
   - API errors during filter changes
   - Graceful degradation (features work without weather)

3. Mobile responsive:
   - Filter bar stacks properly
   - Create form sections work on mobile
   - Touch-friendly checkboxes and buttons

4. Edge cases:
   - Session with no location (weather disabled)
   - Session with location but no coords (legacy data)
   - Filter resulting in zero results
   - All data type checkboxes unchecked on create

5. End-to-end testing:
   - Create session with weather fetch flow
   - Filter sessions by all criteria
   - Edit session, add data of each type
   - View detail, navigate via quick actions
   - Delete session

6. Performance:
   - Weather cache working (repeat requests fast)
   - Filter changes don't cause excessive API calls
   - Debounce search input

**Acceptance Criteria**:
- [ ] All loading states implemented
- [ ] Error messages are user-friendly
- [ ] Mobile experience is functional
- [ ] Edge cases handled gracefully
- [ ] Full user flow works end-to-end
- [ ] No console errors in normal operation

---

## Technical Implementation Notes

### Weather API Configuration

Add to `appsettings.json`:
```json
{
  "OpenWeatherMap": {
    "ApiKey": "",
    "BaseUrl": "https://api.openweathermap.org/data/2.5/weather"
  }
}
```

Add to `docker-compose.yml`:
```yaml
environment:
  - OpenWeatherMap__ApiKey=${OPENWEATHERMAP_API_KEY}
```

### Density Altitude Calculation

```csharp
// Simplified density altitude calculation
// Inputs: temperature (°F), pressure (inHg), elevation (ft)
public static int CalculateDensityAltitude(decimal tempF, decimal pressureInHg, int elevationFt)
{
    // Convert to Rankine (°F + 459.67)
    var tempRankine = (double)(tempF + 459.67m);

    // Standard temperature at sea level in Rankine
    var stdTempRankine = 518.67;

    // Standard pressure at sea level in inHg
    var stdPressure = 29.92;

    // Pressure altitude
    var pressureAlt = (1 - Math.Pow((double)pressureInHg / stdPressure, 0.190284)) * 145366.45;

    // Density altitude = pressure altitude + (120 * (OAT - ISA))
    var isaTemp = stdTempRankine - (0.00356 * pressureAlt); // ISA temp at pressure alt
    var densityAlt = pressureAlt + (120 * (tempRankine - 459.67 - (isaTemp - 459.67)));

    return (int)Math.Round(densityAlt);
}
```

### Cardinal Direction Helper

```csharp
public static string DegreesToCardinal(int degrees)
{
    var directions = new[] { "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
                             "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW" };
    var index = (int)Math.Round(degrees / 22.5) % 16;
    return directions[index];
}
```

### Frontend Geolocation

```typescript
const useGeolocation = () => {
  const [location, setLocation] = useState<{ lat: number; long: number } | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const getLocation = () => {
    if (!navigator.geolocation) {
      setError('Geolocation not supported');
      return;
    }

    setLoading(true);
    setError(null);

    navigator.geolocation.getCurrentPosition(
      (position) => {
        setLocation({
          lat: position.coords.latitude,
          long: position.coords.longitude,
        });
        setLoading(false);
      },
      (err) => {
        setError(err.message);
        setLoading(false);
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  };

  return { location, error, loading, getLocation };
};
```

---

## Files to Create/Modify

### Backend

**New Files**:
- `Controllers/WeatherController.cs`
- `Services/WeatherService.cs`
- `DTOs/Weather/WeatherDto.cs`

**Modified Files**:
- `appsettings.json` - Add OpenWeatherMap config
- `Program.cs` - Register WeatherService
- `docker-compose.yml` - Add API key env var

### Frontend

**New Files**:
- `services/weather.service.ts`
- `types/weather.ts`
- `hooks/useGeolocation.ts`

**Modified Files**:
- `pages/sessions/SessionsList.tsx` - Enhanced filters
- `pages/sessions/SessionCreate.tsx` - Wizard/enhanced flow
- `pages/sessions/SessionDetail.tsx` - Enhanced display
- `pages/sessions/SessionEdit.tsx` - Weather fetch button
- `types/index.ts` - Export weather types

---

## Dependencies

This phase depends on:
- Phase 1 (project structure) ✅
- Phase 2 (authentication) ✅
- Phase 3 (core data model & API) ✅
- Phase 4 (frontend foundation) ✅

This phase is required by:
- Phase 6 (Analytics) - some filter patterns reusable
- Phase 8 (Location & Weather) - weather API already done here; Phase 8 focuses on map/pin-drop, advanced location features

---

## Resolved Decisions

1. **Weather fetch behavior**: Auto-fetch when location with coordinates selected ✅

2. **Data type checkboxes**: Removed - unnecessary since edit page tabs already handle this ✅

3. **Filter persistence**: Local component state (not URL params) - simpler for now ✅

4. **Filter apply behavior**: Immediate for dropdowns/checkboxes, debounced for search

5. **Wizard vs. enhanced single page**: Start with enhanced single page, evaluate wizard later

6. **Weather caching duration**: 10 minutes (conditions don't change rapidly)

7. **Density altitude**: Calculate on backend (more accurate formulas)

---

## Acceptance Criteria (Phase Complete)

Phase 5 is complete when ALL of the following are true:

### Weather Integration
- [ ] Backend weather endpoint working with OpenWeatherMap
- [ ] Weather auto-fetches when location with coordinates selected
- [ ] "Refresh Weather" button available for manual re-fetch
- [ ] All condition fields populate from weather API
- [ ] GPS location acquisition works and triggers auto-fetch
- [ ] Error handling for API failures (non-blocking)

### Session List Filters
- [ ] Rifle dropdown filter working
- [ ] Data type checkbox filters working
- [ ] Clear filters button working
- [ ] Filters combine correctly (AND logic)
- [ ] Empty state when no results match filters

### Session Creation
- [ ] Clear section layout (Basic Info, Location, Conditions, Notes)
- [ ] No data type checkboxes (removed - edit page tabs handle this)
- [ ] Collapsible conditions section, auto-expands on weather load
- [ ] Helpful guidance text displayed
- [ ] After create, navigates to edit page
- [ ] Improved visual organization

### Session Detail
- [ ] Enhanced stats cards with meaningful data
- [ ] Quick action buttons for empty data types
- [ ] Deep linking to tabs via URL

### Polish
- [ ] All loading states implemented
- [ ] Error handling throughout
- [ ] Mobile responsive
- [ ] No console errors

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-09 | Initial Phase 5 specification created |
| 2024-12-09 | Updated with resolved decisions: auto-fetch weather, local filter state |
| 2024-12-09 | Removed data type checkboxes from create flow - edit page tabs already handle this |
