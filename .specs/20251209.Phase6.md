# Phase 6: Analytics & DOPE Charts

**Created**: December 9, 2024
**Status**: Planning
**Parent**: [Project Manifest](./20251206.MANIFEST.md)
**Depends On**: Phase 5 (Session Recording - Enhanced UX) ✅

---

## Overview

Phase 6 implements the analytics and data visualization features of TrueDope. This phase transforms raw session data into actionable insights, enabling users to:

1. View DOPE charts aggregated across sessions for each rifle
2. Track velocity trends over time by ammunition
3. Compare ammunition performance (velocity and groups)
4. Compare lot-to-lot performance
5. Analyze shooting costs

### What Already Exists (from Phases 1-5)

- Complete session data model with DOPE, chrono, and group entries
- Session list with filtering by rifle, date, and data type
- Dashboard with basic stats cards
- Placeholder analytics pages in navigation

### What This Phase Delivers

1. **Analytics Dashboard** - Centralized hub with summary metrics and navigation
2. **DOPE Charts** - Aggregated elevation/windage data by distance per rifle
3. **Velocity Trends** - Time-series charts showing velocity consistency
4. **Ammunition Comparison** - Side-by-side velocity and group comparisons
5. **Lot Comparison** - Performance differences between lots of same ammo
6. **Cost Analysis** - Spending tracking and rounds fired summaries

---

## Charting Library Decision

### Recommendation: Recharts

**Rationale**:
- React-native library with declarative API
- Excellent TypeScript support
- Lightweight (small bundle impact)
- Composable components (LineChart, BarChart, ScatterChart, etc.)
- Good accessibility defaults
- Active maintenance and community

**Alternatives Considered**:
- **Chart.js/react-chartjs-2**: More features but heavier, imperative API
- **Victory**: Good but less popular, larger bundle
- **Nivo**: Beautiful but heavier, may be overkill
- **Visx**: Low-level, requires more code but maximum flexibility

**Installation**:
```bash
npm install recharts
```

**Types**:
```bash
npm install -D @types/recharts  # If not included
```

---

## Design Decisions

### Data Aggregation Strategy

**Decision: Backend aggregation endpoints**

For performance and to reduce data transfer, analytics queries will be handled by dedicated backend endpoints that perform aggregation in the database rather than fetching all raw data and aggregating client-side.

### Chart Styling

**Decision: Consistent with Tailwind color palette**

Charts will use colors from the Tailwind palette to maintain visual consistency:
- Primary data: `#3b82f6` (blue-500)
- Secondary data: `#10b981` (emerald-500)
- Tertiary data: `#f59e0b` (amber-500)
- Grid/axis: `#e5e7eb` (gray-200)
- Text: `#374151` (gray-700)

### Responsive Charts

**Decision: Container-based responsive sizing**

Use Recharts' `ResponsiveContainer` with parent div constraints for all charts. Charts will stack vertically on mobile.

### Data Freshness

**Decision: Fetch on mount, no caching initially**

Analytics data refreshes on page load. Consider React Query or SWR caching in future for performance optimization.

---

## Sub-Phases

### Phase 6.1: Analytics Infrastructure & Dashboard

**Goal**: Create analytics backend endpoints, frontend services, and the analytics dashboard hub.

#### Backend Work

**New Endpoints**:

```
GET /api/analytics/summary
GET /api/analytics/dope-chart?rifleId={id}
GET /api/analytics/velocity-trends?ammoId={id}&lotId={id?}&fromDate={date?}&toDate={date?}
GET /api/analytics/ammo-comparison?ammoIds={id1,id2,...}
GET /api/analytics/lot-comparison?ammoId={id}
GET /api/analytics/cost-summary?fromDate={date?}&toDate={date?}
```

**New Files**:
- `Controllers/AnalyticsController.cs`
- `Services/IAnalyticsService.cs`
- `Services/AnalyticsService.cs`
- `DTOs/Analytics/AnalyticsDtos.cs`

**Summary Endpoint Response** (`GET /api/analytics/summary`):
```json
{
  "success": true,
  "data": {
    "totalSessions": 45,
    "totalRoundsFired": 1250,
    "longestShot": {
      "distance": 1000,
      "rifleId": 5,
      "rifleName": "URGI",
      "sessionId": 12,
      "sessionDate": "2024-11-15"
    },
    "bestGroup": {
      "sizeMoa": 0.42,
      "distance": 100,
      "numberOfShots": 5,
      "ammoName": "Federal Gold Medal 77gr",
      "sessionId": 18,
      "sessionDate": "2024-10-22"
    },
    "lowestSdAmmo": {
      "ammoId": 3,
      "ammoName": "Hornady ELD-M 140gr",
      "averageSd": 5.2,
      "sessionCount": 8
    },
    "totalCost": {
      "amount": 1875.50,
      "period": "all-time"
    },
    "recentActivity": {
      "lastSessionDate": "2024-12-07",
      "sessionsLast30Days": 8,
      "roundsLast30Days": 320
    }
  }
}
```

**Service Interface**:
```csharp
public interface IAnalyticsService
{
    Task<AnalyticsSummaryDto> GetSummaryAsync(string userId);
    Task<DopeChartDataDto> GetDopeChartDataAsync(string userId, int rifleId);
    Task<VelocityTrendsDto> GetVelocityTrendsAsync(string userId, int ammoId, int? lotId, DateTime? fromDate, DateTime? toDate);
    Task<AmmoComparisonDto> GetAmmoComparisonAsync(string userId, int[] ammoIds);
    Task<LotComparisonDto> GetLotComparisonAsync(string userId, int ammoId);
    Task<CostSummaryDto> GetCostSummaryAsync(string userId, DateTime? fromDate, DateTime? toDate);
}
```

#### Frontend Work

**New Files**:
- `services/analytics.service.ts`
- `types/analytics.ts`
- `pages/analytics/AnalyticsDashboard.tsx` (update existing placeholder)

**Analytics Dashboard Layout**:
```
┌─────────────────────────────────────────────────────────────────────┐
│ Analytics Dashboard                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐        │
│ │ Sessions   │ │ Rounds     │ │ Longest    │ │ Best Group │        │
│ │ 45         │ │ 1,250      │ │ Shot       │ │ 0.42 MOA   │        │
│ │            │ │            │ │ 1000 yds   │ │ @100yds    │        │
│ └────────────┘ └────────────┘ └────────────┘ └────────────┘        │
│                                                                      │
│ ┌──────────────────────────────────────────────────────────────────┐│
│ │ Quick Links                                                       ││
│ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌──────────────┐ ││
│ │ │ DOPE Charts │ │ Velocity    │ │ Compare     │ │ Cost         │ ││
│ │ │ View rifle  │ │ Trends      │ │ Ammo        │ │ Analysis     │ ││
│ │ │ holdovers   │ │ Over time   │ │ Performance │ │ Spending     │ ││
│ │ └─────────────┘ └─────────────┘ └─────────────┘ └──────────────┘ ││
│ └──────────────────────────────────────────────────────────────────┘│
│                                                                      │
│ ┌──────────────────────────────┐ ┌────────────────────────────────┐ │
│ │ Best Velocity Consistency    │ │ Recent Trends                  │ │
│ │ Hornady ELD-M 140gr          │ │ [Small trend chart preview]    │ │
│ │ SD: 5.2 fps (8 sessions)     │ │ Last 30 days: 8 sessions       │ │
│ └──────────────────────────────┘ └────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**Acceptance Criteria**:
- [ ] Summary endpoint returns all aggregated metrics
- [ ] Dashboard displays summary stats in cards
- [ ] Quick links navigate to respective analytics pages
- [ ] Loading states for async data
- [ ] Empty states for users with no data
- [ ] Mobile responsive layout

---

### Phase 6.2: DOPE Charts

**Goal**: Display aggregated DOPE data by distance for each rifle with visualization.

#### Backend Work

**Endpoint**: `GET /api/analytics/dope-chart?rifleId={id}`

**Response**:
```json
{
  "success": true,
  "data": {
    "rifleId": 5,
    "rifleName": "URGI",
    "caliber": ".223 Rem",
    "zeroDistance": 100,
    "dataPoints": [
      {
        "distance": 100,
        "elevationMils": 0.0,
        "elevationMilsStdDev": 0.0,
        "windageMils": 0.0,
        "sessionCount": 3,
        "lastRecorded": "2024-12-01"
      },
      {
        "distance": 200,
        "elevationMils": 1.2,
        "elevationMilsStdDev": 0.08,
        "windageMils": 0.0,
        "sessionCount": 3,
        "lastRecorded": "2024-12-01"
      },
      {
        "distance": 300,
        "elevationMils": 2.4,
        "elevationMilsStdDev": 0.12,
        "windageMils": 0.0,
        "sessionCount": 2,
        "lastRecorded": "2024-11-15"
      }
    ],
    "interpolatedPoints": [
      {
        "distance": 250,
        "elevationMils": 1.8,
        "isInterpolated": true
      }
    ],
    "metadata": {
      "totalSessions": 5,
      "dateRange": {
        "from": "2024-06-15",
        "to": "2024-12-07"
      }
    }
  }
}
```

**Aggregation Logic**:
```csharp
public async Task<DopeChartDataDto> GetDopeChartDataAsync(string userId, int rifleId)
{
    // 1. Verify rifle belongs to user
    // 2. Get all DOPE entries for this rifle across all sessions
    // 3. Group by distance
    // 4. Calculate average elevation/windage and std dev per distance
    // 5. Sort by distance ascending
    // 6. Optionally interpolate missing distances (gaps > 100 yards)
    // 7. Return structured response
}
```

**Interpolation Rules** (from v1 DOPE chart logic):
- Only interpolate if gap between consecutive distances is 100-200 yards
- Linear interpolation for elevation
- Mark interpolated points clearly
- Don't extrapolate beyond recorded data

#### Frontend Work

**New Files**:
- `pages/analytics/DopeChart.tsx`
- `components/analytics/DopeChartGraph.tsx`
- `components/analytics/DopeDataTable.tsx`

**Page Layout**:
```
┌─────────────────────────────────────────────────────────────────────┐
│ DOPE Chart                                        [Export] [Print]  │
├─────────────────────────────────────────────────────────────────────┤
│ Rifle: [URGI ▾]  (dropdown to switch rifles)                        │
│ .223 Rem • Zero: 100 yards • 5 sessions                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │     ↑ Elevation (MIL)                                          │ │
│  │     │                                                          │ │
│  │  4.0│                                    ●                     │ │
│  │     │                               ●                          │ │
│  │  3.0│                          ○                               │ │
│  │     │                     ●                                    │ │
│  │  2.0│                ●                                         │ │
│  │     │           ○                                              │ │
│  │  1.0│      ●                                                   │ │
│  │     │                                                          │ │
│  │  0.0├──●───────────────────────────────────→ Distance (yds)    │ │
│  │     100   200   300   400   500   600   700                    │ │
│  │                                                                 │ │
│  │  ● Recorded  ○ Interpolated                                    │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Data Table                                                          │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Distance │ Elevation │ Windage │ Sessions │ Last Recorded      │ │
│  │ (yards)  │ (MIL)     │ (MIL)   │          │                    │ │
│  ├──────────┼───────────┼─────────┼──────────┼────────────────────┤ │
│  │ 100      │ 0.0       │ 0.0     │ 3        │ Dec 1, 2024        │ │
│  │ 200      │ 1.2 ±0.08 │ 0.0     │ 3        │ Dec 1, 2024        │ │
│  │ 250*     │ 1.8       │ -       │ interp.  │ -                  │ │
│  │ 300      │ 2.4 ±0.12 │ 0.0     │ 2        │ Nov 15, 2024       │ │
│  └────────────────────────────────────────────────────────────────┘ │
│  * Interpolated                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**Chart Component** (using Recharts):
```typescript
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Scatter } from 'recharts';

interface DopeChartGraphProps {
  dataPoints: DopeDataPoint[];
  interpolatedPoints: DopeDataPoint[];
  rifleName: string;
}

export function DopeChartGraph({ dataPoints, interpolatedPoints, rifleName }: DopeChartGraphProps) {
  // Combine and sort data for chart
  const chartData = [
    ...dataPoints.map(p => ({ ...p, isInterpolated: false })),
    ...interpolatedPoints.map(p => ({ ...p, isInterpolated: true })),
  ].sort((a, b) => a.distance - b.distance);

  return (
    <ResponsiveContainer width="100%" height={400}>
      <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
        <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
        <XAxis
          dataKey="distance"
          label={{ value: 'Distance (yards)', position: 'bottom', offset: 0 }}
        />
        <YAxis
          label={{ value: 'Elevation (MIL)', angle: -90, position: 'left' }}
        />
        <Tooltip content={<CustomTooltip />} />
        <Legend />
        <Line
          type="monotone"
          dataKey="elevationMils"
          name="Elevation"
          stroke="#3b82f6"
          strokeWidth={2}
          dot={({ payload }) => (
            payload.isInterpolated ?
              <circle r={4} stroke="#3b82f6" strokeWidth={2} fill="white" /> :
              <circle r={5} fill="#3b82f6" />
          )}
        />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

**Export/Print Functionality**:
- Export button generates CSV with distance, elevation, windage columns
- Print button opens print dialog with chart and table formatted for paper
- Use CSS `@media print` for print styling

**Acceptance Criteria**:
- [ ] Rifle dropdown shows user's rifles with DOPE data
- [ ] Chart displays elevation curve by distance
- [ ] Recorded vs interpolated points visually distinct
- [ ] Data table shows all values with std dev
- [ ] Empty state when rifle has no DOPE data
- [ ] Export to CSV works
- [ ] Print styling works
- [ ] Responsive chart sizing

---

### Phase 6.3: Velocity Trends

**Goal**: Time-series visualization of velocity data with SD/ES tracking.

#### Backend Work

**Endpoint**: `GET /api/analytics/velocity-trends?ammoId={id}&lotId={id?}&fromDate={date?}&toDate={date?}`

**Response**:
```json
{
  "success": true,
  "data": {
    "ammoId": 3,
    "ammoName": "Hornady ELD-M 140gr",
    "lotId": null,
    "lotNumber": null,
    "sessions": [
      {
        "sessionId": 10,
        "sessionDate": "2024-06-15",
        "averageVelocity": 2750.5,
        "standardDeviation": 8.2,
        "extremeSpread": 22,
        "roundsFired": 10,
        "conditions": {
          "temperature": 72,
          "densityAltitude": 7200
        }
      },
      {
        "sessionId": 15,
        "sessionDate": "2024-08-20",
        "averageVelocity": 2755.2,
        "standardDeviation": 6.5,
        "extremeSpread": 18,
        "roundsFired": 15,
        "conditions": {
          "temperature": 85,
          "densityAltitude": 8100
        }
      }
    ],
    "aggregates": {
      "overallAverageVelocity": 2752.8,
      "overallAverageSd": 7.4,
      "overallAverageEs": 20,
      "totalRoundsFired": 25,
      "sessionCount": 2,
      "velocityRange": {
        "high": 2755.2,
        "low": 2750.5
      }
    }
  }
}
```

**Query Filters**:
- `ammoId` (required): Filter to specific ammunition
- `lotId` (optional): Filter to specific lot
- `fromDate` (optional): Start date filter
- `toDate` (optional): End date filter

#### Frontend Work

**New Files**:
- `pages/analytics/VelocityTrends.tsx`
- `components/analytics/VelocityTrendChart.tsx`

**Page Layout**:
```
┌─────────────────────────────────────────────────────────────────────┐
│ Velocity Trends                                                      │
├─────────────────────────────────────────────────────────────────────┤
│ Ammunition: [Hornady ELD-M 140gr ▾]   Lot: [All Lots ▾]             │
│ Date Range: [From: ______] [To: ______]                              │
├─────────────────────────────────────────────────────────────────────┤
│ Summary: 25 rounds • 2 sessions • Avg: 2752.8 fps • SD: 7.4 fps     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Velocity Over Time                                              │ │
│  │     ↑ Velocity (fps)                                           │ │
│  │ 2780│                                                          │ │
│  │     │                     ●                                    │ │
│  │ 2760│                                                          │ │
│  │     │    ●                                                     │ │
│  │ 2740│                                                          │ │
│  │     │                                                          │ │
│  │ 2720├────────────────────────────────────────→ Date            │ │
│  │     Jun    Jul    Aug    Sep    Oct    Nov    Dec              │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Standard Deviation Trend                                        │ │
│  │     ↑ SD (fps)                                                 │ │
│  │  12 │                                                          │ │
│  │     │    ●                                                     │ │
│  │   8 │                                                          │ │
│  │     │                     ●                                    │ │
│  │   4 │                                                          │ │
│  │     │                                                          │ │
│  │   0 ├────────────────────────────────────────→ Date            │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Session Details                                                     │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Date       │ Avg Vel. │ SD   │ ES  │ Rounds │ Temp │ DA       │ │
│  ├────────────┼──────────┼──────┼─────┼────────┼──────┼──────────┤ │
│  │ Jun 15     │ 2750.5   │ 8.2  │ 22  │ 10     │ 72°F │ 7200 ft  │ │
│  │ Aug 20     │ 2755.2   │ 6.5  │ 18  │ 15     │ 85°F │ 8100 ft  │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**Acceptance Criteria**:
- [ ] Ammunition dropdown shows ammo with chrono data
- [ ] Optional lot filter
- [ ] Date range filter works
- [ ] Velocity trend chart shows average per session
- [ ] SD trend chart shows consistency over time
- [ ] Summary aggregates display correctly
- [ ] Session table shows details with conditions
- [ ] Links to individual sessions work
- [ ] Empty state for ammo with no chrono data

---

### Phase 6.4: Ammunition Comparison

**Goal**: Side-by-side comparison of velocity and group performance across ammunition types.

#### Backend Work

**Endpoint**: `GET /api/analytics/ammo-comparison?ammoIds={id1,id2,id3}`

**Response**:
```json
{
  "success": true,
  "data": {
    "ammunitions": [
      {
        "ammoId": 1,
        "ammoName": "Federal Gold Medal 77gr",
        "caliber": ".223 Rem",
        "velocity": {
          "averageVelocity": 2620.5,
          "averageSd": 8.2,
          "averageEs": 22,
          "sessionCount": 5,
          "totalRounds": 50
        },
        "groups": {
          "averageGroupSizeMoa": 0.85,
          "bestGroupSizeMoa": 0.42,
          "groupCount": 8,
          "averageDistance": 100
        }
      },
      {
        "ammoId": 2,
        "ammoName": "Hornady Black 75gr",
        "caliber": ".223 Rem",
        "velocity": {
          "averageVelocity": 2680.2,
          "averageSd": 12.5,
          "averageEs": 35,
          "sessionCount": 3,
          "totalRounds": 30
        },
        "groups": {
          "averageGroupSizeMoa": 1.25,
          "bestGroupSizeMoa": 0.95,
          "groupCount": 4,
          "averageDistance": 100
        }
      }
    ],
    "comparison": {
      "bestVelocityConsistency": 1,
      "bestGroupSize": 1,
      "mostDataPoints": 1
    }
  }
}
```

**Validation**:
- Limit to 5 ammunition types per comparison
- All ammunition must belong to user

#### Frontend Work

**New Files**:
- `pages/analytics/AmmoComparison.tsx`
- `components/analytics/ComparisonBarChart.tsx`

**Page Layout**:
```
┌─────────────────────────────────────────────────────────────────────┐
│ Ammunition Comparison                                                │
├─────────────────────────────────────────────────────────────────────┤
│ Select Ammunition (up to 5):                                         │
│ [Federal Gold Medal 77gr     ▾] [×]                                 │
│ [Hornady Black 75gr          ▾] [×]                                 │
│ [+ Add Ammunition]                                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Velocity Comparison                                                 │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  Federal GMM ████████████████████████████ 2620 fps             │ │
│  │  Hornady Blk █████████████████████████████████ 2680 fps        │ │
│  │                                                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Standard Deviation Comparison (lower is better)                     │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  Federal GMM ████████ 8.2 fps  ★                               │ │
│  │  Hornady Blk ████████████████ 12.5 fps                         │ │
│  │                                                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Group Size Comparison (lower is better)                             │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  Federal GMM ████████ 0.85 MOA  ★                              │ │
│  │  Hornady Blk ████████████████ 1.25 MOA                         │ │
│  │                                                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Detailed Comparison Table                                           │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ Metric            │ Federal GMM   │ Hornady Black │ Winner     ││
│  ├───────────────────┼───────────────┼───────────────┼────────────┤│
│  │ Avg Velocity      │ 2620.5 fps    │ 2680.2 fps    │ -          ││
│  │ Avg SD            │ 8.2 fps       │ 12.5 fps      │ Federal    ││
│  │ Avg ES            │ 22 fps        │ 35 fps        │ Federal    ││
│  │ Avg Group         │ 0.85 MOA      │ 1.25 MOA      │ Federal    ││
│  │ Best Group        │ 0.42 MOA      │ 0.95 MOA      │ Federal    ││
│  │ Sessions          │ 5             │ 3             │ -          ││
│  │ Total Rounds      │ 50            │ 30            │ -          ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

**Acceptance Criteria**:
- [ ] Can select up to 5 ammunition types
- [ ] Bar charts compare key metrics visually
- [ ] "Winner" indicators for relevant metrics
- [ ] Detailed table shows all comparison data
- [ ] Can remove ammunition from comparison
- [ ] Empty state when less than 2 selected
- [ ] Warning when comparing different calibers

---

### Phase 6.5: Lot Comparison

**Goal**: Compare performance between lots of the same ammunition.

#### Backend Work

**Endpoint**: `GET /api/analytics/lot-comparison?ammoId={id}`

**Response**:
```json
{
  "success": true,
  "data": {
    "ammoId": 3,
    "ammoName": "Hornady ELD-M 140gr",
    "lots": [
      {
        "lotId": 10,
        "lotNumber": "ABC123",
        "purchaseDate": "2024-01-15",
        "velocity": {
          "averageVelocity": 2750.5,
          "averageSd": 6.2,
          "averageEs": 18,
          "sessionCount": 3,
          "totalRounds": 30
        },
        "groups": {
          "averageGroupSizeMoa": 0.72,
          "bestGroupSizeMoa": 0.45,
          "groupCount": 4
        }
      },
      {
        "lotId": 12,
        "lotNumber": "DEF456",
        "purchaseDate": "2024-06-20",
        "velocity": {
          "averageVelocity": 2765.2,
          "averageSd": 8.8,
          "averageEs": 25,
          "sessionCount": 2,
          "totalRounds": 20
        },
        "groups": {
          "averageGroupSizeMoa": 0.88,
          "bestGroupSizeMoa": 0.62,
          "groupCount": 3
        }
      }
    ],
    "comparison": {
      "velocitySpread": 14.7,
      "bestLotForConsistency": 10,
      "bestLotForGroups": 10
    }
  }
}
```

#### Frontend Work

**New Files**:
- `pages/analytics/LotComparison.tsx`

**Page Layout**:
Similar to ammo comparison but focused on lots within one ammunition type. Uses same chart components.

```
┌─────────────────────────────────────────────────────────────────────┐
│ Lot Comparison                                                       │
├─────────────────────────────────────────────────────────────────────┤
│ Ammunition: [Hornady ELD-M 140gr ▾]                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Lot Performance Summary                                             │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Lot        │ Purchased  │ Avg Vel  │ SD   │ Avg Group │ Status │ │
│  ├────────────┼────────────┼──────────┼──────┼───────────┼────────┤ │
│  │ ABC123     │ Jan 2024   │ 2750 fps │ 6.2  │ 0.72 MOA  │ ★ Best │ │
│  │ DEF456     │ Jun 2024   │ 2765 fps │ 8.8  │ 0.88 MOA  │        │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  [Velocity chart comparing lots]                                     │
│  [SD chart comparing lots]                                           │
│  [Group size chart comparing lots]                                   │
│                                                                      │
│  Insight: Lot ABC123 shows 15 fps lower velocity but 30% better     │
│  consistency (SD) than DEF456.                                       │
└─────────────────────────────────────────────────────────────────────┘
```

**Acceptance Criteria**:
- [ ] Ammunition dropdown shows ammo with multiple lots
- [ ] All lots for selected ammo displayed
- [ ] Comparison charts for velocity, SD, groups
- [ ] "Best" lot indicators
- [ ] Insights text generated from data
- [ ] Empty state for ammo with single/no lots

---

### Phase 6.6: Cost Analysis

**Goal**: Track ammunition spending and rounds fired.

#### Backend Work

**Endpoint**: `GET /api/analytics/cost-summary?fromDate={date?}&toDate={date?}&rifleId={id?}`

**Response**:
```json
{
  "success": true,
  "data": {
    "period": {
      "from": "2024-01-01",
      "to": "2024-12-09"
    },
    "totals": {
      "totalRoundsFired": 1250,
      "totalCost": 1875.50,
      "averageCostPerRound": 1.50
    },
    "byAmmunition": [
      {
        "ammoId": 1,
        "ammoName": "Federal Gold Medal 77gr",
        "roundsFired": 500,
        "cost": 625.00,
        "costPerRound": 1.25
      },
      {
        "ammoId": 2,
        "ammoName": "Hornady ELD-M 140gr",
        "roundsFired": 750,
        "cost": 1250.50,
        "costPerRound": 1.67
      }
    ],
    "byRifle": [
      {
        "rifleId": 5,
        "rifleName": "URGI",
        "roundsFired": 800,
        "cost": 1000.00,
        "sessions": 15
      },
      {
        "rifleId": 8,
        "rifleName": "Bergara B-14 HMR",
        "roundsFired": 450,
        "cost": 875.50,
        "sessions": 10
      }
    ],
    "byMonth": [
      {
        "month": "2024-01",
        "roundsFired": 100,
        "cost": 150.00,
        "sessions": 2
      },
      {
        "month": "2024-02",
        "roundsFired": 150,
        "cost": 225.00,
        "sessions": 3
      }
    ]
  }
}
```

**Cost Calculation Logic**:
- Uses `AmmoLot.PurchasePrice / AmmoLot.InitialQuantity` for cost per round
- Falls back to `Ammunition.CostPerRound` if no lot data
- Aggregates based on chrono session rounds (actual shots recorded)

#### Frontend Work

**New Files**:
- `pages/analytics/CostAnalysis.tsx`
- `components/analytics/CostPieChart.tsx`
- `components/analytics/CostTimelineChart.tsx`

**Page Layout**:
```
┌─────────────────────────────────────────────────────────────────────┐
│ Cost Analysis                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ Period: [From: 2024-01-01] [To: 2024-12-09]  [This Year] [All Time] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                     │
│ │ Total Spent │ │ Rounds      │ │ Avg Cost    │                     │
│ │ $1,875.50   │ │ Fired       │ │ Per Round   │                     │
│ │             │ │ 1,250       │ │ $1.50       │                     │
│ └─────────────┘ └─────────────┘ └─────────────┘                     │
│                                                                      │
│ ┌────────────────────────────┐ ┌──────────────────────────────────┐ │
│ │ Cost by Ammunition         │ │ Spending Over Time               │ │
│ │                            │ │                                  │ │
│ │     [Pie Chart]            │ │   $300 │         ●              │ │
│ │                            │ │        │    ●         ●         │ │
│ │  ■ Federal GMM: $625       │ │   $200 │ ●                 ●    │ │
│ │  ■ Hornady ELD: $1,250     │ │        │                        │ │
│ │                            │ │   $100 │                        │ │
│ │                            │ │        └────────────────────→   │ │
│ │                            │ │        J F M A M J J A S O N D  │ │
│ └────────────────────────────┘ └──────────────────────────────────┘ │
│                                                                      │
│ Cost by Rifle                                                        │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Rifle              │ Rounds │ Sessions │ Cost   │ Cost/Session  │ │
│ ├────────────────────┼────────┼──────────┼────────┼───────────────┤ │
│ │ URGI               │ 800    │ 15       │ $1,000 │ $66.67        │ │
│ │ Bergara B-14 HMR   │ 450    │ 10       │ $875   │ $87.50        │ │
│ └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ Cost by Ammunition                                                   │
│ ┌─────────────────────────────────────────────────────────────────┐ │
│ │ Ammunition              │ Rounds │ Cost   │ Cost/Round          │ │
│ ├─────────────────────────┼────────┼────────┼─────────────────────┤ │
│ │ Federal Gold Medal 77gr │ 500    │ $625   │ $1.25               │ │
│ │ Hornady ELD-M 140gr     │ 750    │ $1,250 │ $1.67               │ │
│ └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**Acceptance Criteria**:
- [ ] Date range filter works
- [ ] Quick presets (This Year, All Time) work
- [ ] Summary cards show totals
- [ ] Pie chart shows cost distribution by ammo
- [ ] Timeline chart shows spending over months
- [ ] Tables breakdown by rifle and ammunition
- [ ] Handles missing cost data gracefully
- [ ] Empty state for no cost data

---

### Phase 6.7: Polish, Testing & Documentation

**Goal**: Final polish, unit tests for calculations, and end-to-end testing.

#### Backend Testing

**Test Files**:
- `tests/TrueDope.Api.Tests/Services/AnalyticsServiceTests.cs`

**Test Coverage for Calculations**:
```csharp
public class AnalyticsServiceTests
{
    // DOPE aggregation tests
    [Fact]
    public async Task GetDopeChartData_AggregatesCorrectly()
    {
        // Test that multiple sessions aggregate to correct averages
    }

    [Fact]
    public async Task GetDopeChartData_InterpolatesCorrectly()
    {
        // Test linear interpolation for gaps
    }

    // Velocity trend tests
    [Fact]
    public async Task GetVelocityTrends_CalculatesOverallAveragesCorrectly()
    {
        // Test weighted averages across sessions
    }

    // Cost calculation tests
    [Fact]
    public async Task GetCostSummary_UsesLotCostWhenAvailable()
    {
        // Test lot cost takes precedence
    }

    [Fact]
    public async Task GetCostSummary_FallsBackToAmmoCost()
    {
        // Test fallback to Ammunition.CostPerRound
    }
}
```

#### Frontend Polish

**Tasks**:

1. **Loading States**:
   - Skeleton loaders for all analytics pages
   - Chart placeholder during data load

2. **Error Handling**:
   - API error toasts
   - Empty state messaging
   - Graceful degradation for partial data

3. **Responsiveness**:
   - Charts stack on mobile
   - Tables scroll horizontally
   - Touch-friendly controls

4. **Accessibility**:
   - Chart color contrast
   - Alt text for chart images (if using image export)
   - Keyboard navigation

5. **Performance**:
   - Lazy load chart library
   - Memoize expensive calculations
   - Debounce filter changes

#### End-to-End Testing Scenarios

1. **DOPE Chart Flow**:
   - Create rifle with sessions containing DOPE data
   - Navigate to DOPE chart
   - Verify aggregation is correct
   - Test export functionality
   - Test print preview

2. **Velocity Trends Flow**:
   - Create ammo with multiple chrono sessions
   - View trends over time
   - Filter by lot
   - Verify calculations match manual check

3. **Comparison Flows**:
   - Create multiple ammo types with data
   - Compare up to 5
   - Verify winner indicators
   - Test lot comparison within one ammo

4. **Cost Analysis Flow**:
   - Create lots with purchase prices
   - Record sessions with chrono data
   - Verify cost calculations
   - Test date range filters

---

## Routes

```typescript
// Analytics routes (add to App.tsx)

/analytics                     → Analytics Dashboard
/analytics/dope                → DOPE Charts
/analytics/velocity            → Velocity Trends
/analytics/compare             → Ammunition Comparison
/analytics/lots                → Lot Comparison
/analytics/cost                → Cost Analysis
```

---

## Files to Create/Modify

### Backend

**New Files**:
```
TrueDope.Api/
├── Controllers/
│   └── AnalyticsController.cs              NEW
├── Services/
│   ├── IAnalyticsService.cs                NEW
│   └── AnalyticsService.cs                 NEW
└── DTOs/
    └── Analytics/
        ├── AnalyticsSummaryDto.cs          NEW
        ├── DopeChartDataDto.cs             NEW
        ├── VelocityTrendsDto.cs            NEW
        ├── AmmoComparisonDto.cs            NEW
        ├── LotComparisonDto.cs             NEW
        └── CostSummaryDto.cs               NEW
```

**Modified Files**:
- `Program.cs` - Register AnalyticsService

### Frontend

**New Files**:
```
frontend/src/
├── services/
│   └── analytics.service.ts                NEW
├── types/
│   └── analytics.ts                        NEW
├── pages/
│   └── analytics/
│       ├── AnalyticsDashboard.tsx          UPDATE (replace placeholder)
│       ├── DopeChart.tsx                   NEW
│       ├── VelocityTrends.tsx              NEW
│       ├── AmmoComparison.tsx              NEW
│       ├── LotComparison.tsx               NEW
│       └── CostAnalysis.tsx                NEW
├── components/
│   └── analytics/
│       ├── DopeChartGraph.tsx              NEW
│       ├── DopeDataTable.tsx               NEW
│       ├── VelocityTrendChart.tsx          NEW
│       ├── ComparisonBarChart.tsx          NEW
│       ├── CostPieChart.tsx                NEW
│       ├── CostTimelineChart.tsx           NEW
│       └── index.ts                        NEW
└── lib/
    └── chart-utils.ts                      NEW (chart helpers)
```

**Modified Files**:
- `App.tsx` - Add analytics routes
- `components/layout/Header.tsx` - Update Analytics dropdown links

### Dependencies

```bash
# Frontend
npm install recharts

# No new backend dependencies required
```

---

## Open Questions

1. **MOA vs MIL Display**: Should DOPE charts show MIL (default) with MOA toggle, or respect user preferences (future Phase 9)?
   - **Recommendation**: Show MIL only for now. Phase 9 will add unit preferences.

2. **Data Retention**: How far back should analytics queries go by default?
   - **Recommendation**: Default to all-time. User can filter with date range.

3. **Chart Export Format**: Support PNG export in addition to CSV?
   - **Recommendation**: Start with CSV only. PNG export adds complexity (html2canvas or similar).

4. **Comparative Insights**: Auto-generate insight text (e.g., "Lot ABC is 30% more consistent")?
   - **Recommendation**: Yes, but keep simple. Avoid complex natural language generation.

5. **Offline Calculation**: Cache analytics results client-side?
   - **Recommendation**: No caching initially. Consider React Query in future.

---

## Dependencies

This phase depends on:
- Phase 1 (project structure) ✅
- Phase 2 (authentication) ✅
- Phase 3 (core data model & API) ✅
- Phase 4 (frontend foundation) ✅
- Phase 5 (session recording) ✅

This phase is required by:
- Phase 9 (User Preferences) - unit preferences affect display
- Phase 11 (Polish) - may surface analytics issues

---

## Acceptance Criteria (Phase Complete)

Phase 6 is complete when ALL of the following are true:

### Analytics Dashboard
- [ ] Summary endpoint returns aggregated metrics
- [ ] Dashboard displays stats cards
- [ ] Quick links to all analytics pages
- [ ] Mobile responsive

### DOPE Charts
- [ ] Rifle dropdown with DOPE data
- [ ] Elevation chart by distance
- [ ] Recorded vs interpolated points differentiated
- [ ] Data table with all values
- [ ] CSV export works
- [ ] Print styling works

### Velocity Trends
- [ ] Ammunition filter works
- [ ] Lot filter works
- [ ] Date range filter works
- [ ] Velocity trend chart displays
- [ ] SD trend chart displays
- [ ] Session details table

### Ammunition Comparison
- [ ] Can select up to 5 ammunition types
- [ ] Comparison bar charts display
- [ ] Winner indicators shown
- [ ] Detailed comparison table

### Lot Comparison
- [ ] Ammunition dropdown works
- [ ] All lots compared
- [ ] Charts compare key metrics
- [ ] Best lot indicated

### Cost Analysis
- [ ] Date range filter works
- [ ] Summary totals correct
- [ ] Pie chart by ammunition
- [ ] Timeline chart by month
- [ ] Breakdown tables

### Quality
- [ ] Unit tests for aggregation logic
- [ ] Loading states throughout
- [ ] Error handling with toasts
- [ ] Mobile responsive charts
- [ ] No console errors

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-09 | Initial Phase 6 specification created |
