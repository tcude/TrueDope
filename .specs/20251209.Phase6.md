# Phase 6: Analytics & DOPE Charts

**Created**: December 9, 2024
**Status**: Planning
**Parent**: [Project Manifest](./20251206.MANIFEST.md)
**Depends On**: Phase 5 (Session Recording - Enhanced UX) âœ…

---

## Overview

Phase 6 implements the analytics and data visualization features of TrueDope. This phase transforms raw session data into actionable insights, enabling users to:

1. View DOPE charts aggregated across sessions for each rifle
2. Track velocity trends over time by ammunition
3. Compare ammunition performance (velocity and groups)
4. Compare lot-to-lot performance
5. Analyze shooting costs

### What Already Exists (from Phases 1-5)

- Complete session data model with DOPE, chrono, and group entries
- Session list with filtering by rifle, date, and data type
- Dashboard with basic stats cards
- Placeholder analytics pages in navigation

### What This Phase Delivers

1. **Analytics Dashboard** - Centralized hub with summary metrics and navigation
2. **DOPE Charts** - Aggregated elevation/windage data by distance per rifle
3. **Velocity Trends** - Time-series charts showing velocity consistency
4. **Ammunition Comparison** - Side-by-side velocity and group comparisons
5. **Lot Comparison** - Performance differences between lots of same ammo
6. **Cost Analysis** - Spending tracking and rounds fired summaries

---

## Charting Library Decision

### Recommendation: Recharts

**Rationale**:
- React-native library with declarative API
- Excellent TypeScript support
- Lightweight (small bundle impact)
- Composable components (LineChart, BarChart, ScatterChart, etc.)
- Good accessibility defaults
- Active maintenance and community

**Alternatives Considered**:
- **Chart.js/react-chartjs-2**: More features but heavier, imperative API
- **Victory**: Good but less popular, larger bundle
- **Nivo**: Beautiful but heavier, may be overkill
- **Visx**: Low-level, requires more code but maximum flexibility

**Installation**:
```bash
npm install recharts
```

**Types**:
```bash
npm install -D @types/recharts  # If not included
```

---

## Design Decisions

### Data Aggregation Strategy

**Decision: Backend aggregation endpoints**

For performance and to reduce data transfer, analytics queries will be handled by dedicated backend endpoints that perform aggregation in the database rather than fetching all raw data and aggregating client-side.

### Chart Styling

**Decision: Consistent with Tailwind color palette**

Charts will use colors from the Tailwind palette to maintain visual consistency:
- Primary data: `#3b82f6` (blue-500)
- Secondary data: `#10b981` (emerald-500)
- Tertiary data: `#f59e0b` (amber-500)
- Grid/axis: `#e5e7eb` (gray-200)
- Text: `#374151` (gray-700)

### Responsive Charts

**Decision: Container-based responsive sizing**

Use Recharts' `ResponsiveContainer` with parent div constraints for all charts. Charts will stack vertically on mobile.

### Data Freshness

**Decision: Fetch on mount, no caching initially**

Analytics data refreshes on page load. Consider React Query or SWR caching in future for performance optimization.

---

## Sub-Phases

### Phase 6.1: Analytics Infrastructure & Dashboard

**Goal**: Create analytics backend endpoints, frontend services, and the analytics dashboard hub.

#### Backend Work

**New Endpoints**:

```
GET /api/analytics/summary
GET /api/analytics/dope-chart?rifleId={id}
GET /api/analytics/velocity-trends?ammoId={id}&lotId={id?}&fromDate={date?}&toDate={date?}
GET /api/analytics/ammo-comparison?ammoIds={id1,id2,...}
GET /api/analytics/lot-comparison?ammoId={id}
GET /api/analytics/cost-summary?fromDate={date?}&toDate={date?}
```

**New Files**:
- `Controllers/AnalyticsController.cs`
- `Services/IAnalyticsService.cs`
- `Services/AnalyticsService.cs`
- `DTOs/Analytics/AnalyticsDtos.cs`

**Summary Endpoint Response** (`GET /api/analytics/summary`):
```json
{
  "success": true,
  "data": {
    "totalSessions": 45,
    "totalRoundsFired": 1250,
    "longestShot": {
      "distance": 1000,
      "rifleId": 5,
      "rifleName": "URGI",
      "sessionId": 12,
      "sessionDate": "2024-11-15"
    },
    "bestGroup": {
      "sizeMoa": 0.42,
      "distance": 100,
      "numberOfShots": 5,
      "ammoName": "Federal Gold Medal 77gr",
      "sessionId": 18,
      "sessionDate": "2024-10-22"
    },
    "lowestSdAmmo": {
      "ammoId": 3,
      "ammoName": "Hornady ELD-M 140gr",
      "averageSd": 5.2,
      "sessionCount": 8
    },
    "totalCost": {
      "amount": 1875.50,
      "period": "all-time"
    },
    "recentActivity": {
      "lastSessionDate": "2024-12-07",
      "sessionsLast30Days": 8,
      "roundsLast30Days": 320
    }
  }
}
```

**Service Interface**:
```csharp
public interface IAnalyticsService
{
    Task<AnalyticsSummaryDto> GetSummaryAsync(string userId);
    Task<DopeChartDataDto> GetDopeChartDataAsync(string userId, int rifleId);
    Task<VelocityTrendsDto> GetVelocityTrendsAsync(string userId, int ammoId, int? lotId, DateTime? fromDate, DateTime? toDate);
    Task<AmmoComparisonDto> GetAmmoComparisonAsync(string userId, int[] ammoIds);
    Task<LotComparisonDto> GetLotComparisonAsync(string userId, int ammoId);
    Task<CostSummaryDto> GetCostSummaryAsync(string userId, DateTime? fromDate, DateTime? toDate);
}
```

#### Frontend Work

**New Files**:
- `services/analytics.service.ts`
- `types/analytics.ts`
- `pages/analytics/AnalyticsDashboard.tsx` (update existing placeholder)

**Analytics Dashboard Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Analytics Dashboard                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ Sessions   â”‚ â”‚ Rounds     â”‚ â”‚ Longest    â”‚ â”‚ Best Group â”‚        â”‚
â”‚ â”‚ 45         â”‚ â”‚ 1,250      â”‚ â”‚ Shot       â”‚ â”‚ 0.42 MOA   â”‚        â”‚
â”‚ â”‚            â”‚ â”‚            â”‚ â”‚ 1000 yds   â”‚ â”‚ @100yds    â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Quick Links                                                       â”‚â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚ â”‚ â”‚ DOPE Charts â”‚ â”‚ Velocity    â”‚ â”‚ Compare     â”‚ â”‚ Cost         â”‚ â”‚â”‚
â”‚ â”‚ â”‚ View rifle  â”‚ â”‚ Trends      â”‚ â”‚ Ammo        â”‚ â”‚ Analysis     â”‚ â”‚â”‚
â”‚ â”‚ â”‚ holdovers   â”‚ â”‚ Over time   â”‚ â”‚ Performance â”‚ â”‚ Spending     â”‚ â”‚â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Best Velocity Consistency    â”‚ â”‚ Recent Trends                  â”‚ â”‚
â”‚ â”‚ Hornady ELD-M 140gr          â”‚ â”‚ [Small trend chart preview]    â”‚ â”‚
â”‚ â”‚ SD: 5.2 fps (8 sessions)     â”‚ â”‚ Last 30 days: 8 sessions       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Acceptance Criteria**:
- [ ] Summary endpoint returns all aggregated metrics
- [ ] Dashboard displays summary stats in cards
- [ ] Quick links navigate to respective analytics pages
- [ ] Loading states for async data
- [ ] Empty states for users with no data
- [ ] Mobile responsive layout

---

### Phase 6.2: DOPE Charts

**Goal**: Display aggregated DOPE data by distance for each rifle with visualization and condition-based filtering (replicating v1 functionality).

#### Design Decision: Chart + Detailed Table (Option C)

The DOPE chart page will feature:
1. **Line chart visualization** at the top for quick visual reference of the elevation curve
2. **Detailed data table** below as the primary data view with std dev, session counts, and data source badges
3. **Comprehensive filters** matching v1 functionality (date range, months, temperature, humidity, pressure)
4. **50-yard intervals** with Direct/Interpolated/No Data indicators

This approach provides both visual insight and precise data for export/print.

#### Backend Work

**Endpoint**: `GET /api/analytics/dope-chart`

**Query Parameters**:
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| rifleId | int | Yes | Rifle to generate chart for |
| fromDate | DateTime? | No | Start date filter |
| toDate | DateTime? | No | End date filter |
| months | int[]? | No | Filter by months (1-12) |
| minTemp | decimal? | No | Minimum temperature (Â°F) |
| maxTemp | decimal? | No | Maximum temperature (Â°F) |
| minHumidity | int? | No | Minimum humidity (%) |
| maxHumidity | int? | No | Maximum humidity (%) |
| minPressure | decimal? | No | Minimum pressure (inHg) |
| maxPressure | decimal? | No | Maximum pressure (inHg) |
| intervalYards | int | No | Distance interval (default: 50) |

**Response**:
```json
{
  "success": true,
  "data": {
    "rifleId": 5,
    "rifleName": "URGI",
    "caliber": "5.56",
    "zeroDistance": 100,
    "ammunition": {
      "name": "AAC 77g OTM",
      "bulletWeight": 77.0
    },
    "muzzleVelocity": 2700,
    "appliedFilters": {
      "dateRange": { "from": null, "to": null },
      "months": [2, 5, 7],
      "temperature": { "min": 58.0, "max": 93.0 },
      "humidity": { "min": 25, "max": 42 },
      "pressure": { "min": 28.00, "max": 30.24 }
    },
    "dataPoints": [
      {
        "distance": 100,
        "elevationMils": 0.0,
        "elevationMilsStdDev": 0.0,
        "windageMils": 0.0,
        "windageMilsStdDev": 0.0,
        "sessionCount": 3,
        "dataSource": "direct"
      },
      {
        "distance": 150,
        "elevationMils": 0.0,
        "elevationMilsStdDev": 0.0,
        "windageMils": 0.0,
        "windageMilsStdDev": 0.0,
        "sessionCount": 0,
        "dataSource": "no_data"
      },
      {
        "distance": 400,
        "elevationMils": 2.050,
        "elevationMilsStdDev": 0.354,
        "windageMils": 0.0,
        "windageMilsStdDev": 0.0,
        "sessionCount": 2,
        "dataSource": "direct"
      },
      {
        "distance": 450,
        "elevationMils": 2.800,
        "elevationMilsStdDev": 0.0,
        "windageMils": -0.025,
        "windageMilsStdDev": 0.0,
        "sessionCount": 0,
        "dataSource": "interpolated"
      }
    ],
    "metadata": {
      "totalSessionsMatched": 5,
      "totalSessionsAll": 12,
      "distanceRange": { "min": 100, "max": 1000 },
      "conditionsRange": {
        "temperature": { "min": 58.0, "max": 93.0 },
        "humidity": { "min": 25, "max": 42 },
        "pressure": { "min": 28.00, "max": 30.24 }
      }
    }
  }
}
```

**Data Source Values**:
- `direct` - Based on actual recorded DOPE data
- `interpolated` - Calculated from nearby distances (linear interpolation)
- `no_data` - No data available for this distance

**Aggregation Logic**:
```csharp
public async Task<DopeChartDataDto> GetDopeChartDataAsync(string userId, DopeChartFilterDto filter)
{
    // 1. Verify rifle belongs to user
    // 2. Get all sessions for this rifle
    // 3. Apply filters:
    //    - Date range (fromDate, toDate)
    //    - Month filter (e.g., only Feb, May, Jul)
    //    - Temperature range
    //    - Humidity range
    //    - Pressure range
    // 4. Get DOPE entries from filtered sessions
    // 5. Generate distance intervals (e.g., 100, 150, 200, ... up to max recorded)
    // 6. For each interval:
    //    - If direct data exists: aggregate (avg, std dev)
    //    - If no direct but adjacent data: interpolate
    //    - If no data nearby: mark as no_data
    // 7. Return structured response with metadata
}
```

**Interpolation Rules** (from v1 DOPE chart logic):
- Only interpolate if adjacent distances (within 100 yards) have direct data
- Linear interpolation for elevation and windage
- Mark interpolated points with `dataSource: "interpolated"`
- Don't extrapolate beyond recorded data range

#### Frontend Work

**New Files**:
- `pages/analytics/DopeChart.tsx`
- `components/analytics/DopeChartGraph.tsx`
- `components/analytics/DopeDataTable.tsx`
- `components/analytics/DopeChartFilters.tsx`

**Page Layout** (matching v1 structure):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DOPE Charts                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Select Rifle Setup                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Rifle Setup                                                      â”‚ â”‚
â”‚ â”‚ [URGI - 5.56 (AAC 77g OTM)                              â–¾]      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rifle Setup Details                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Rifle: URGI              â”‚ Ammunition: AAC 77g OTM              â”‚ â”‚
â”‚ â”‚ Caliber: 5.56            â”‚ Bullet Weight: 77.0 grains           â”‚ â”‚
â”‚ â”‚ Zero Distance: 100 yards â”‚ Muzzle Velocity: 2700 fps            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¼ Filters                                              [Collapse]   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Start Date          â”‚ End Date                                  â”‚ â”‚
â”‚ â”‚ [mm/dd/yyyy    ğŸ“…]  â”‚ [mm/dd/yyyy    ğŸ“…]                       â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ Months                                                           â”‚ â”‚
â”‚ â”‚ â—‹Jan â˜‘Feb â—‹Mar â—‹Apr â˜‘May â—‹Jun â˜‘Jul â—‹Aug â—‹Sep â—‹Oct â—‹Nov â—‹Dec   â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ Min Temperature (Â°F)  â”‚ Max Temperature (Â°F)                    â”‚ â”‚
â”‚ â”‚ [58.0              ]  â”‚ [93.0              ]                    â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ Min Humidity (%)      â”‚ Max Humidity (%)                        â”‚ â”‚
â”‚ â”‚ [25                ]  â”‚ [42                ]                    â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ Min Pressure (inHg)   â”‚ Max Pressure (inHg)                     â”‚ â”‚
â”‚ â”‚ [28.00             ]  â”‚ [30.24             ]                    â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ [ğŸ” Apply Filters]  [âœ• Clear All Filters]                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Elevation Chart                                                 â”‚ â”‚
â”‚  â”‚     â†‘ Elevation (MIL)                                          â”‚ â”‚
â”‚  â”‚     â”‚                                                          â”‚ â”‚
â”‚  â”‚ 12.0â”‚                                              â—           â”‚ â”‚
â”‚  â”‚     â”‚                                         â—                â”‚ â”‚
â”‚  â”‚  8.0â”‚                                    â—                     â”‚ â”‚
â”‚  â”‚     â”‚                               â—‹                          â”‚ â”‚
â”‚  â”‚  4.0â”‚                          â—                               â”‚ â”‚
â”‚  â”‚     â”‚                     â—‹                                    â”‚ â”‚
â”‚  â”‚  0.0â”œâ”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Distance (yds)    â”‚ â”‚
â”‚  â”‚     100   200   300   400   500   600   700   800   900  1000  â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  â— Direct  â—‹ Interpolated                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DOPE Chart (50-yard intervals)                      [ğŸ“¥ Export CSV] â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Distance â”‚ Elevation â”‚ Elev    â”‚ Windage â”‚ Wind    â”‚ Sessions â”‚ â”‚
â”‚ â”‚ (yards)  â”‚ (MILs)    â”‚ Std Dev â”‚ (MILs)  â”‚ Std Dev â”‚          â”‚ â”‚
â”‚ â”‚          â”‚           â”‚         â”‚         â”‚         â”‚ Data Src â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ 100      â”‚ 0.000     â”‚ 0.000   â”‚ 0.000   â”‚ 0.000   â”‚ 0        â”‚ â”‚
â”‚ â”‚          â”‚           â”‚         â”‚         â”‚         â”‚ [No Data]â”‚ â”‚
â”‚ â”‚ 150      â”‚ 0.000     â”‚ 0.000   â”‚ 0.000   â”‚ 0.000   â”‚ 0        â”‚ â”‚
â”‚ â”‚          â”‚           â”‚         â”‚         â”‚         â”‚ [No Data]â”‚ â”‚
â”‚ â”‚ 400      â”‚ 2.050     â”‚ 0.354   â”‚ 0.000   â”‚ 0.000   â”‚ 2        â”‚ â”‚
â”‚ â”‚          â”‚           â”‚         â”‚         â”‚         â”‚ [Direct] â”‚ â”‚
â”‚ â”‚ 450      â”‚ 2.800     â”‚ 0.000   â”‚ -0.025  â”‚ 0.000   â”‚ -        â”‚ â”‚
â”‚ â”‚          â”‚           â”‚         â”‚         â”‚         â”‚ [Interp] â”‚ â”‚
â”‚ â”‚ 500      â”‚ 3.550     â”‚ 0.370   â”‚ -0.050  â”‚ 0.100   â”‚ 4        â”‚ â”‚
â”‚ â”‚          â”‚           â”‚         â”‚         â”‚         â”‚ [Direct] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚ Legend:                                                              â”‚
â”‚ [Direct] - Based on actual shooting data                            â”‚
â”‚ [Interp] - Calculated from nearby distances                         â”‚
â”‚ [No Data] - No data available for this distance                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Source Badges**:
- `Direct` - Green badge (#22c55e)
- `Interpolated` - Yellow/amber badge (#f59e0b)
- `No Data` - Red badge (#ef4444)

**Chart Component** (using Recharts):
```typescript
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

interface DopeChartGraphProps {
  dataPoints: DopeDataPoint[];
}

export function DopeChartGraph({ dataPoints }: DopeChartGraphProps) {
  // Filter to only show points with data (direct or interpolated)
  const chartData = dataPoints.filter(p => p.dataSource !== 'no_data');

  return (
    <ResponsiveContainer width="100%" height={350}>
      <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
        <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
        <XAxis
          dataKey="distance"
          label={{ value: 'Distance (yards)', position: 'bottom', offset: 0 }}
        />
        <YAxis
          label={{ value: 'Elevation (MIL)', angle: -90, position: 'left' }}
        />
        <Tooltip content={<DopeTooltip />} />
        <Legend />
        <Line
          type="monotone"
          dataKey="elevationMils"
          name="Elevation"
          stroke="#3b82f6"
          strokeWidth={2}
          dot={({ payload, cx, cy }) => {
            if (payload.dataSource === 'interpolated') {
              return <circle cx={cx} cy={cy} r={4} stroke="#f59e0b" strokeWidth={2} fill="white" />;
            }
            return <circle cx={cx} cy={cy} r={5} fill="#3b82f6" />;
          }}
        />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

**Export/Print Functionality**:
- Export button generates CSV with all columns: Distance, Elevation, Elev Std Dev, Windage, Wind Std Dev, Sessions, Data Source
- Print button opens print dialog with table formatted for paper (chart optional in print)
- Use CSS `@media print` for print styling

**Acceptance Criteria**:
- [ ] Rifle dropdown shows user's rifles with DOPE data
- [ ] Rifle details section shows caliber, zero, ammo, muzzle velocity
- [ ] Filters panel is collapsible
- [ ] Date range filter works
- [ ] Month checkboxes filter works
- [ ] Temperature range filter works
- [ ] Humidity range filter works
- [ ] Pressure range filter works
- [ ] "Apply Filters" refreshes data
- [ ] "Clear All Filters" resets to defaults
- [ ] Chart displays elevation curve (direct + interpolated points only)
- [ ] Chart visually distinguishes direct vs interpolated points
- [ ] Data table shows 50-yard intervals from 100 to max distance
- [ ] Data source badges (Direct/Interpolated/No Data) render correctly
- [ ] Standard deviation columns show values
- [ ] Session count shows for direct data
- [ ] Export to CSV works with all columns
- [ ] Empty state when rifle has no DOPE data
- [ ] Empty state when filters match no sessions
- [ ] Responsive layout (filters stack on mobile)

---

### Phase 6.3: Velocity Trends

**Goal**: Time-series visualization of velocity data with SD/ES tracking, plus environmental correlation analysis.

#### Design Decision: Include Temperature/DA Correlation Chart

In addition to the time-series velocity trend, we'll include a secondary scatter plot showing velocity vs temperature/density altitude. This helps users understand how environmental conditions affect their loads. If it proves not useful during implementation, it can be removed.

#### Backend Work

**Endpoint**: `GET /api/analytics/velocity-trends?ammoId={id}&lotId={id?}&fromDate={date?}&toDate={date?}`

**Response**:
```json
{
  "success": true,
  "data": {
    "ammoId": 3,
    "ammoName": "Hornady ELD-M 140gr",
    "caliber": "6.5 Creedmoor",
    "lotId": null,
    "lotNumber": null,
    "sessions": [
      {
        "sessionId": 10,
        "sessionDate": "2024-06-15",
        "averageVelocity": 2750.5,
        "standardDeviation": 8.2,
        "extremeSpread": 22,
        "roundsFired": 10,
        "conditions": {
          "temperature": 72,
          "humidity": 35,
          "pressure": 29.92,
          "densityAltitude": 7200
        }
      },
      {
        "sessionId": 15,
        "sessionDate": "2024-08-20",
        "averageVelocity": 2755.2,
        "standardDeviation": 6.5,
        "extremeSpread": 18,
        "roundsFired": 15,
        "conditions": {
          "temperature": 85,
          "humidity": 28,
          "pressure": 29.85,
          "densityAltitude": 8100
        }
      },
      {
        "sessionId": 22,
        "sessionDate": "2024-10-10",
        "averageVelocity": 2742.0,
        "standardDeviation": 7.1,
        "extremeSpread": 20,
        "roundsFired": 12,
        "conditions": {
          "temperature": 55,
          "humidity": 45,
          "pressure": 30.10,
          "densityAltitude": 6800
        }
      }
    ],
    "aggregates": {
      "overallAverageVelocity": 2749.2,
      "overallAverageSd": 7.3,
      "overallAverageEs": 20,
      "totalRoundsFired": 37,
      "sessionCount": 3,
      "velocityRange": {
        "high": 2755.2,
        "low": 2742.0
      }
    },
    "correlation": {
      "temperatureCorrelation": 0.85,
      "densityAltitudeCorrelation": 0.78,
      "velocityPerDegreeF": 0.45,
      "velocityPer1000ftDA": -3.2
    }
  }
}
```

**Query Filters**:
- `ammoId` (required): Filter to specific ammunition
- `lotId` (optional): Filter to specific lot
- `fromDate` (optional): Start date filter
- `toDate` (optional): End date filter

**Correlation Calculation** (backend):
```csharp
// Calculate Pearson correlation coefficient between velocity and temperature
// Calculate approximate fps change per degree F
// Calculate approximate fps change per 1000ft density altitude
// Only calculate if 3+ sessions with conditions data
```

#### Frontend Work

**New Files**:
- `pages/analytics/VelocityTrends.tsx`
- `components/analytics/VelocityTrendChart.tsx`
- `components/analytics/VelocityCorrelationChart.tsx`

**Page Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Velocity Trends                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ammunition: [Hornady ELD-M 140gr â–¾]   Lot: [All Lots â–¾]             â”‚
â”‚ Date Range: [From: ______] [To: ______]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Summary: 37 rounds â€¢ 3 sessions â€¢ Avg: 2749.2 fps â€¢ SD: 7.3 fps     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Velocity Over Time                                              â”‚ â”‚
â”‚  â”‚     â†‘ Velocity (fps)                                           â”‚ â”‚
â”‚  â”‚ 2760â”‚                     â—                                    â”‚ â”‚
â”‚  â”‚     â”‚    â—                                                     â”‚ â”‚
â”‚  â”‚ 2750â”‚                                                          â”‚ â”‚
â”‚  â”‚     â”‚                               â—                          â”‚ â”‚
â”‚  â”‚ 2740â”‚                                                          â”‚ â”‚
â”‚  â”‚     â”‚                                                          â”‚ â”‚
â”‚  â”‚ 2730â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Date            â”‚ â”‚
â”‚  â”‚     Jun    Jul    Aug    Sep    Oct    Nov    Dec              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Standard Deviation Trend                                        â”‚ â”‚
â”‚  â”‚     â†‘ SD (fps)                                                 â”‚ â”‚
â”‚  â”‚  10 â”‚    â—                                                     â”‚ â”‚
â”‚  â”‚     â”‚                               â—                          â”‚ â”‚
â”‚  â”‚   6 â”‚                     â—                                    â”‚ â”‚
â”‚  â”‚     â”‚                                                          â”‚ â”‚
â”‚  â”‚   2 â”‚                                                          â”‚ â”‚
â”‚  â”‚     â”‚                                                          â”‚ â”‚
â”‚  â”‚   0 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Date            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Environmental Correlation                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Velocity vs Temperature         â”‚ â”‚ Velocity vs Density Altitude â”‚â”‚
â”‚ â”‚     â†‘ Velocity (fps)            â”‚ â”‚     â†‘ Velocity (fps)         â”‚â”‚
â”‚ â”‚ 2760â”‚           â—               â”‚ â”‚ 2760â”‚    â—                   â”‚â”‚
â”‚ â”‚     â”‚       â—                   â”‚ â”‚     â”‚        â—               â”‚â”‚
â”‚ â”‚ 2750â”‚                           â”‚ â”‚ 2750â”‚                        â”‚â”‚
â”‚ â”‚     â”‚   â—                       â”‚ â”‚     â”‚             â—          â”‚â”‚
â”‚ â”‚ 2740â”‚                           â”‚ â”‚ 2740â”‚                        â”‚â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Temp (Â°F)â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ DA (ft)  â”‚â”‚
â”‚ â”‚      50   60   70   80   90     â”‚ â”‚      6500  7000  7500  8000  â”‚â”‚
â”‚ â”‚                                 â”‚ â”‚                              â”‚â”‚
â”‚ â”‚ Trend: +0.45 fps per Â°F         â”‚ â”‚ Trend: -3.2 fps per 1000ft   â”‚â”‚
â”‚ â”‚ Correlation: Strong (r=0.85)    â”‚ â”‚ Correlation: Moderate (r=0.78)â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Session Details                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Date       â”‚ Avg Vel. â”‚ SD   â”‚ ES  â”‚ Rounds â”‚ Temp â”‚ DA       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Jun 15     â”‚ 2750.5   â”‚ 8.2  â”‚ 22  â”‚ 10     â”‚ 72Â°F â”‚ 7200 ft  â”‚ â”‚
â”‚  â”‚ Aug 20     â”‚ 2755.2   â”‚ 6.5  â”‚ 18  â”‚ 15     â”‚ 85Â°F â”‚ 8100 ft  â”‚ â”‚
â”‚  â”‚ Oct 10     â”‚ 2742.0   â”‚ 7.1  â”‚ 20  â”‚ 12     â”‚ 55Â°F â”‚ 6800 ft  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  Click a row to view session details                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Correlation Chart Component**:
```typescript
import { ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';

interface VelocityCorrelationChartProps {
  sessions: VelocitySession[];
  xKey: 'temperature' | 'densityAltitude';
  xLabel: string;
  trendLine?: { slope: number; intercept: number };
  correlation?: number;
}

export function VelocityCorrelationChart({ sessions, xKey, xLabel, trendLine, correlation }: VelocityCorrelationChartProps) {
  const data = sessions
    .filter(s => s.conditions?.[xKey] != null)
    .map(s => ({
      x: s.conditions[xKey],
      velocity: s.averageVelocity,
      date: s.sessionDate
    }));

  return (
    <div>
      <ResponsiveContainer width="100%" height={250}>
        <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="x" name={xLabel} label={{ value: xLabel, position: 'bottom' }} />
          <YAxis dataKey="velocity" name="Velocity" label={{ value: 'Velocity (fps)', angle: -90, position: 'left' }} />
          <Tooltip cursor={{ strokeDasharray: '3 3' }} />
          <Scatter data={data} fill="#3b82f6" />
          {trendLine && (
            <ReferenceLine
              segment={calculateTrendLineSegment(data, trendLine)}
              stroke="#ef4444"
              strokeDasharray="5 5"
            />
          )}
        </ScatterChart>
      </ResponsiveContainer>
      {correlation != null && (
        <p className="text-sm text-gray-600 mt-2">
          Correlation: {getCorrelationStrength(correlation)} (r={correlation.toFixed(2)})
        </p>
      )}
    </div>
  );
}

function getCorrelationStrength(r: number): string {
  const abs = Math.abs(r);
  if (abs >= 0.8) return 'Strong';
  if (abs >= 0.5) return 'Moderate';
  if (abs >= 0.3) return 'Weak';
  return 'Very weak';
}
```

**Acceptance Criteria**:
- [ ] Ammunition dropdown shows ammo with chrono data
- [ ] Optional lot filter
- [ ] Date range filter works
- [ ] Velocity trend chart shows average per session over time
- [ ] SD trend chart shows consistency over time
- [ ] Summary aggregates display correctly
- [ ] Environmental correlation section shows:
  - [ ] Velocity vs Temperature scatter plot
  - [ ] Velocity vs Density Altitude scatter plot
  - [ ] Trend line on each scatter plot (if enough data)
  - [ ] Correlation strength indicator
  - [ ] fps per degree / fps per 1000ft metrics
- [ ] Correlation section hidden if insufficient data (< 3 sessions with conditions)
- [ ] Session table shows details with conditions
- [ ] Clicking session row navigates to session detail
- [ ] Empty state for ammo with no chrono data

---

### Phase 6.4: Ammunition Comparison

**Goal**: Side-by-side comparison of velocity and group performance across ammunition types.

#### Backend Work

**Endpoint**: `GET /api/analytics/ammo-comparison?ammoIds={id1,id2,id3}`

**Response**:
```json
{
  "success": true,
  "data": {
    "ammunitions": [
      {
        "ammoId": 1,
        "ammoName": "Federal Gold Medal 77gr",
        "caliber": ".223 Rem",
        "velocity": {
          "averageVelocity": 2620.5,
          "averageSd": 8.2,
          "averageEs": 22,
          "sessionCount": 5,
          "totalRounds": 50
        },
        "groups": {
          "averageGroupSizeMoa": 0.85,
          "bestGroupSizeMoa": 0.42,
          "groupCount": 8,
          "averageDistance": 100
        }
      },
      {
        "ammoId": 2,
        "ammoName": "Hornady Black 75gr",
        "caliber": ".223 Rem",
        "velocity": {
          "averageVelocity": 2680.2,
          "averageSd": 12.5,
          "averageEs": 35,
          "sessionCount": 3,
          "totalRounds": 30
        },
        "groups": {
          "averageGroupSizeMoa": 1.25,
          "bestGroupSizeMoa": 0.95,
          "groupCount": 4,
          "averageDistance": 100
        }
      }
    ],
    "comparison": {
      "bestVelocityConsistency": 1,
      "bestGroupSize": 1,
      "mostDataPoints": 1
    }
  }
}
```

**Validation**:
- Limit to 5 ammunition types per comparison
- All ammunition must belong to user

#### Frontend Work

**New Files**:
- `pages/analytics/AmmoComparison.tsx`
- `components/analytics/ComparisonBarChart.tsx`

**Page Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ammunition Comparison                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Select Ammunition (up to 5):                                         â”‚
â”‚ [Federal Gold Medal 77gr     â–¾] [Ã—]                                 â”‚
â”‚ [Hornady Black 75gr          â–¾] [Ã—]                                 â”‚
â”‚ [+ Add Ammunition]                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Velocity Comparison                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  Federal GMM â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2620 fps             â”‚ â”‚
â”‚  â”‚  Hornady Blk â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2680 fps        â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  Standard Deviation Comparison (lower is better)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  Federal GMM â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 8.2 fps  â˜…                               â”‚ â”‚
â”‚  â”‚  Hornady Blk â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 12.5 fps                         â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  Group Size Comparison (lower is better)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  Federal GMM â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 0.85 MOA  â˜…                              â”‚ â”‚
â”‚  â”‚  Hornady Blk â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1.25 MOA                         â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  Detailed Comparison Table                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Metric            â”‚ Federal GMM   â”‚ Hornady Black â”‚ Winner     â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ Avg Velocity      â”‚ 2620.5 fps    â”‚ 2680.2 fps    â”‚ -          â”‚â”‚
â”‚  â”‚ Avg SD            â”‚ 8.2 fps       â”‚ 12.5 fps      â”‚ Federal    â”‚â”‚
â”‚  â”‚ Avg ES            â”‚ 22 fps        â”‚ 35 fps        â”‚ Federal    â”‚â”‚
â”‚  â”‚ Avg Group         â”‚ 0.85 MOA      â”‚ 1.25 MOA      â”‚ Federal    â”‚â”‚
â”‚  â”‚ Best Group        â”‚ 0.42 MOA      â”‚ 0.95 MOA      â”‚ Federal    â”‚â”‚
â”‚  â”‚ Sessions          â”‚ 5             â”‚ 3             â”‚ -          â”‚â”‚
â”‚  â”‚ Total Rounds      â”‚ 50            â”‚ 30            â”‚ -          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Acceptance Criteria**:
- [ ] Can select up to 5 ammunition types
- [ ] Bar charts compare key metrics visually
- [ ] "Winner" indicators for relevant metrics
- [ ] Detailed table shows all comparison data
- [ ] Can remove ammunition from comparison
- [ ] Empty state when less than 2 selected
- [ ] Warning when comparing different calibers

---

### Phase 6.5: Lot Comparison

**Goal**: Compare performance between lots of the same ammunition.

#### Backend Work

**Endpoint**: `GET /api/analytics/lot-comparison?ammoId={id}`

**Response**:
```json
{
  "success": true,
  "data": {
    "ammoId": 3,
    "ammoName": "Hornady ELD-M 140gr",
    "lots": [
      {
        "lotId": 10,
        "lotNumber": "ABC123",
        "purchaseDate": "2024-01-15",
        "velocity": {
          "averageVelocity": 2750.5,
          "averageSd": 6.2,
          "averageEs": 18,
          "sessionCount": 3,
          "totalRounds": 30
        },
        "groups": {
          "averageGroupSizeMoa": 0.72,
          "bestGroupSizeMoa": 0.45,
          "groupCount": 4
        }
      },
      {
        "lotId": 12,
        "lotNumber": "DEF456",
        "purchaseDate": "2024-06-20",
        "velocity": {
          "averageVelocity": 2765.2,
          "averageSd": 8.8,
          "averageEs": 25,
          "sessionCount": 2,
          "totalRounds": 20
        },
        "groups": {
          "averageGroupSizeMoa": 0.88,
          "bestGroupSizeMoa": 0.62,
          "groupCount": 3
        }
      }
    ],
    "comparison": {
      "velocitySpread": 14.7,
      "bestLotForConsistency": 10,
      "bestLotForGroups": 10
    }
  }
}
```

#### Frontend Work

**New Files**:
- `pages/analytics/LotComparison.tsx`

**Page Layout**:
Similar to ammo comparison but focused on lots within one ammunition type. Uses same chart components.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lot Comparison                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ammunition: [Hornady ELD-M 140gr â–¾]                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Lot Performance Summary                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Lot        â”‚ Purchased  â”‚ Avg Vel  â”‚ SD   â”‚ Avg Group â”‚ Status â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ABC123     â”‚ Jan 2024   â”‚ 2750 fps â”‚ 6.2  â”‚ 0.72 MOA  â”‚ â˜… Best â”‚ â”‚
â”‚  â”‚ DEF456     â”‚ Jun 2024   â”‚ 2765 fps â”‚ 8.8  â”‚ 0.88 MOA  â”‚        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  [Velocity chart comparing lots]                                     â”‚
â”‚  [SD chart comparing lots]                                           â”‚
â”‚  [Group size chart comparing lots]                                   â”‚
â”‚                                                                      â”‚
â”‚  Insight: Lot ABC123 shows 15 fps lower velocity but 30% better     â”‚
â”‚  consistency (SD) than DEF456.                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Acceptance Criteria**:
- [ ] Ammunition dropdown shows ammo with multiple lots
- [ ] All lots for selected ammo displayed
- [ ] Comparison charts for velocity, SD, groups
- [ ] "Best" lot indicators
- [ ] Insights text generated from data
- [ ] Empty state for ammo with single/no lots

---

### Phase 6.6: Cost Analysis

**Goal**: Track ammunition spending and rounds fired.

#### Backend Work

**Endpoint**: `GET /api/analytics/cost-summary?fromDate={date?}&toDate={date?}&rifleId={id?}`

**Response**:
```json
{
  "success": true,
  "data": {
    "period": {
      "from": "2024-01-01",
      "to": "2024-12-09"
    },
    "totals": {
      "totalRoundsFired": 1250,
      "totalCost": 1875.50,
      "averageCostPerRound": 1.50
    },
    "byAmmunition": [
      {
        "ammoId": 1,
        "ammoName": "Federal Gold Medal 77gr",
        "roundsFired": 500,
        "cost": 625.00,
        "costPerRound": 1.25
      },
      {
        "ammoId": 2,
        "ammoName": "Hornady ELD-M 140gr",
        "roundsFired": 750,
        "cost": 1250.50,
        "costPerRound": 1.67
      }
    ],
    "byRifle": [
      {
        "rifleId": 5,
        "rifleName": "URGI",
        "roundsFired": 800,
        "cost": 1000.00,
        "sessions": 15
      },
      {
        "rifleId": 8,
        "rifleName": "Bergara B-14 HMR",
        "roundsFired": 450,
        "cost": 875.50,
        "sessions": 10
      }
    ],
    "byMonth": [
      {
        "month": "2024-01",
        "roundsFired": 100,
        "cost": 150.00,
        "sessions": 2
      },
      {
        "month": "2024-02",
        "roundsFired": 150,
        "cost": 225.00,
        "sessions": 3
      }
    ]
  }
}
```

**Cost Calculation Logic**:
- Uses `AmmoLot.PurchasePrice / AmmoLot.InitialQuantity` for cost per round
- Falls back to `Ammunition.CostPerRound` if no lot data
- Aggregates based on chrono session rounds (actual shots recorded)

#### Frontend Work

**New Files**:
- `pages/analytics/CostAnalysis.tsx`
- `components/analytics/CostPieChart.tsx`
- `components/analytics/CostTimelineChart.tsx`

**Page Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cost Analysis                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Period: [From: 2024-01-01] [To: 2024-12-09]  [This Year] [All Time] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚ Total Spent â”‚ â”‚ Rounds      â”‚ â”‚ Avg Cost    â”‚                     â”‚
â”‚ â”‚ $1,875.50   â”‚ â”‚ Fired       â”‚ â”‚ Per Round   â”‚                     â”‚
â”‚ â”‚             â”‚ â”‚ 1,250       â”‚ â”‚ $1.50       â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Cost by Ammunition         â”‚ â”‚ Spending Over Time               â”‚ â”‚
â”‚ â”‚                            â”‚ â”‚                                  â”‚ â”‚
â”‚ â”‚     [Pie Chart]            â”‚ â”‚   $300 â”‚         â—              â”‚ â”‚
â”‚ â”‚                            â”‚ â”‚        â”‚    â—         â—         â”‚ â”‚
â”‚ â”‚  â–  Federal GMM: $625       â”‚ â”‚   $200 â”‚ â—                 â—    â”‚ â”‚
â”‚ â”‚  â–  Hornady ELD: $1,250     â”‚ â”‚        â”‚                        â”‚ â”‚
â”‚ â”‚                            â”‚ â”‚   $100 â”‚                        â”‚ â”‚
â”‚ â”‚                            â”‚ â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ â”‚
â”‚ â”‚                            â”‚ â”‚        J F M A M J J A S O N D  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚ Cost by Rifle                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Rifle              â”‚ Rounds â”‚ Sessions â”‚ Cost   â”‚ Cost/Session  â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ URGI               â”‚ 800    â”‚ 15       â”‚ $1,000 â”‚ $66.67        â”‚ â”‚
â”‚ â”‚ Bergara B-14 HMR   â”‚ 450    â”‚ 10       â”‚ $875   â”‚ $87.50        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚ Cost by Ammunition                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Ammunition              â”‚ Rounds â”‚ Cost   â”‚ Cost/Round          â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Federal Gold Medal 77gr â”‚ 500    â”‚ $625   â”‚ $1.25               â”‚ â”‚
â”‚ â”‚ Hornady ELD-M 140gr     â”‚ 750    â”‚ $1,250 â”‚ $1.67               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Acceptance Criteria**:
- [ ] Date range filter works
- [ ] Quick presets (This Year, All Time) work
- [ ] Summary cards show totals
- [ ] Pie chart shows cost distribution by ammo
- [ ] Timeline chart shows spending over months
- [ ] Tables breakdown by rifle and ammunition
- [ ] Handles missing cost data gracefully
- [ ] Empty state for no cost data

---

### Phase 6.7: Polish, Testing & Documentation

**Goal**: Final polish, unit tests for calculations, and end-to-end testing.

#### Backend Testing

**Test Files**:
- `tests/TrueDope.Api.Tests/Services/AnalyticsServiceTests.cs`

**Test Coverage for Calculations**:
```csharp
public class AnalyticsServiceTests
{
    // DOPE aggregation tests
    [Fact]
    public async Task GetDopeChartData_AggregatesCorrectly()
    {
        // Test that multiple sessions aggregate to correct averages
    }

    [Fact]
    public async Task GetDopeChartData_InterpolatesCorrectly()
    {
        // Test linear interpolation for gaps
    }

    // Velocity trend tests
    [Fact]
    public async Task GetVelocityTrends_CalculatesOverallAveragesCorrectly()
    {
        // Test weighted averages across sessions
    }

    // Cost calculation tests
    [Fact]
    public async Task GetCostSummary_UsesLotCostWhenAvailable()
    {
        // Test lot cost takes precedence
    }

    [Fact]
    public async Task GetCostSummary_FallsBackToAmmoCost()
    {
        // Test fallback to Ammunition.CostPerRound
    }
}
```

#### Frontend Polish

**Tasks**:

1. **Loading States**:
   - Skeleton loaders for all analytics pages
   - Chart placeholder during data load

2. **Error Handling**:
   - API error toasts
   - Empty state messaging
   - Graceful degradation for partial data

3. **Responsiveness**:
   - Charts stack on mobile
   - Tables scroll horizontally
   - Touch-friendly controls

4. **Accessibility**:
   - Chart color contrast
   - Alt text for chart images (if using image export)
   - Keyboard navigation

5. **Performance**:
   - Lazy load chart library
   - Memoize expensive calculations
   - Debounce filter changes

#### End-to-End Testing Scenarios

1. **DOPE Chart Flow**:
   - Create rifle with sessions containing DOPE data
   - Navigate to DOPE chart
   - Verify aggregation is correct
   - Test export functionality
   - Test print preview

2. **Velocity Trends Flow**:
   - Create ammo with multiple chrono sessions
   - View trends over time
   - Filter by lot
   - Verify calculations match manual check

3. **Comparison Flows**:
   - Create multiple ammo types with data
   - Compare up to 5
   - Verify winner indicators
   - Test lot comparison within one ammo

4. **Cost Analysis Flow**:
   - Create lots with purchase prices
   - Record sessions with chrono data
   - Verify cost calculations
   - Test date range filters

---

## Routes

```typescript
// Analytics routes (add to App.tsx)

/analytics                     â†’ Analytics Dashboard
/analytics/dope                â†’ DOPE Charts
/analytics/velocity            â†’ Velocity Trends
/analytics/compare             â†’ Ammunition Comparison
/analytics/lots                â†’ Lot Comparison
/analytics/cost                â†’ Cost Analysis
```

---

## Files to Create/Modify

### Backend

**New Files**:
```
TrueDope.Api/
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ AnalyticsController.cs              NEW
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IAnalyticsService.cs                NEW
â”‚   â””â”€â”€ AnalyticsService.cs                 NEW
â””â”€â”€ DTOs/
    â””â”€â”€ Analytics/
        â”œâ”€â”€ AnalyticsSummaryDto.cs          NEW
        â”œâ”€â”€ DopeChartDataDto.cs             NEW
        â”œâ”€â”€ VelocityTrendsDto.cs            NEW
        â”œâ”€â”€ AmmoComparisonDto.cs            NEW
        â”œâ”€â”€ LotComparisonDto.cs             NEW
        â””â”€â”€ CostSummaryDto.cs               NEW
```

**Modified Files**:
- `Program.cs` - Register AnalyticsService

### Frontend

**New Files**:
```
frontend/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ analytics.service.ts                NEW
â”œâ”€â”€ types/
â”‚   â””â”€â”€ analytics.ts                        NEW
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ analytics/
â”‚       â”œâ”€â”€ AnalyticsDashboard.tsx          UPDATE (replace placeholder)
â”‚       â”œâ”€â”€ DopeChart.tsx                   NEW
â”‚       â”œâ”€â”€ VelocityTrends.tsx              NEW
â”‚       â”œâ”€â”€ AmmoComparison.tsx              NEW
â”‚       â”œâ”€â”€ LotComparison.tsx               NEW
â”‚       â””â”€â”€ CostAnalysis.tsx                NEW
â”œâ”€â”€ components/
â”‚   â””â”€â”€ analytics/
â”‚       â”œâ”€â”€ DopeChartGraph.tsx              NEW
â”‚       â”œâ”€â”€ DopeDataTable.tsx               NEW
â”‚       â”œâ”€â”€ VelocityTrendChart.tsx          NEW
â”‚       â”œâ”€â”€ ComparisonBarChart.tsx          NEW
â”‚       â”œâ”€â”€ CostPieChart.tsx                NEW
â”‚       â”œâ”€â”€ CostTimelineChart.tsx           NEW
â”‚       â””â”€â”€ index.ts                        NEW
â””â”€â”€ lib/
    â””â”€â”€ chart-utils.ts                      NEW (chart helpers)
```

**Modified Files**:
- `App.tsx` - Add analytics routes
- `components/layout/Header.tsx` - Update Analytics dropdown links

### Dependencies

```bash
# Frontend
npm install recharts

# No new backend dependencies required
```

---

## Resolved Design Decisions

The following questions were resolved before implementation:

1. **MOA vs MIL Display**: Show MIL only for now. The backend already has MOA conversion logic (`ElevationMils / 0.2909m`). Phase 9 (User Preferences) will add unit toggle.

2. **Temperature/DA Correlation**: Include secondary scatter plots showing velocity vs temperature and velocity vs density altitude on the Velocity Trends page. This helps users understand environmental effects on their loads. Can be removed if it doesn't prove useful.

3. **Cost Data - Missing Values**: Show "N/A" for cost metrics when cost data is not populated. This is honest about data gaps and encourages users to add cost info to their lots.

4. **Comparison Limit**: Limit ammunition comparison to 5 types maximum.

5. **DOPE Chart Presentation**: Option C - Chart + Detailed Table. Line chart visualization at top for quick visual reference, detailed data table below as primary view with std dev, session counts, and Direct/Interpolated/No Data badges. Includes comprehensive condition-based filters (date range, months, temperature, humidity, pressure) matching v1 functionality.

## Open Questions

1. **Data Retention**: How far back should analytics queries go by default?
   - **Recommendation**: Default to all-time. User can filter with date range.

2. **Chart Export Format**: Support PNG export in addition to CSV?
   - **Recommendation**: Start with CSV only. PNG export adds complexity (html2canvas or similar).

3. **Comparative Insights**: Auto-generate insight text (e.g., "Lot ABC is 30% more consistent")?
   - **Recommendation**: Yes, but keep simple. Avoid complex natural language generation.

4. **Offline Calculation**: Cache analytics results client-side?
   - **Recommendation**: No caching initially. Consider React Query in future.

---

## Dependencies

This phase depends on:
- Phase 1 (project structure) âœ…
- Phase 2 (authentication) âœ…
- Phase 3 (core data model & API) âœ…
- Phase 4 (frontend foundation) âœ…
- Phase 5 (session recording) âœ…

This phase is required by:
- Phase 9 (User Preferences) - unit preferences affect display
- Phase 11 (Polish) - may surface analytics issues

---

## Acceptance Criteria (Phase Complete)

Phase 6 is complete when ALL of the following are true:

### Analytics Dashboard
- [ ] Summary endpoint returns aggregated metrics
- [ ] Dashboard displays stats cards (Sessions, Rounds, Longest Shot, Best Group)
- [ ] Quick links to all analytics pages
- [ ] Best velocity consistency card
- [ ] Mobile responsive

### DOPE Charts
- [ ] Rifle dropdown shows rifles with DOPE data
- [ ] Rifle details section (caliber, zero, ammo, muzzle velocity)
- [ ] Collapsible filters panel
- [ ] Date range filter works
- [ ] Month checkbox filter works
- [ ] Temperature range filter works
- [ ] Humidity range filter works
- [ ] Pressure range filter works
- [ ] Elevation line chart displays (direct + interpolated points)
- [ ] Chart visually distinguishes direct vs interpolated points
- [ ] Data table shows 50-yard intervals
- [ ] Data source badges (Direct/Interpolated/No Data) render correctly
- [ ] Standard deviation columns display
- [ ] Session count displays for direct data
- [ ] CSV export works with all columns
- [ ] Empty states for no data / no matching filters

### Velocity Trends
- [ ] Ammunition dropdown shows ammo with chrono data
- [ ] Optional lot filter works
- [ ] Date range filter works
- [ ] Velocity over time chart displays
- [ ] SD trend chart displays
- [ ] Environmental correlation section:
  - [ ] Velocity vs Temperature scatter plot
  - [ ] Velocity vs Density Altitude scatter plot
  - [ ] Trend lines displayed
  - [ ] Correlation strength indicators
  - [ ] Hidden if < 3 sessions with conditions data
- [ ] Summary aggregates display correctly
- [ ] Session details table with clickable rows
- [ ] Empty state for ammo with no chrono data

### Ammunition Comparison
- [ ] Can select up to 5 ammunition types
- [ ] Comparison bar charts display
- [ ] Winner indicators shown
- [ ] Detailed comparison table
- [ ] Warning when comparing different calibers

### Lot Comparison
- [ ] Ammunition dropdown shows ammo with multiple lots
- [ ] All lots compared
- [ ] Charts compare velocity, SD, groups
- [ ] Best lot indicated
- [ ] Insights text generated

### Cost Analysis
- [ ] Date range filter works
- [ ] Quick presets (This Year, All Time) work
- [ ] Summary totals correct
- [ ] Pie chart by ammunition
- [ ] Timeline chart by month
- [ ] Breakdown tables by rifle and ammunition
- [ ] "N/A" displayed for missing cost data

### Quality
- [ ] Unit tests for aggregation logic (DOPE, velocity, cost)
- [ ] Unit tests for interpolation
- [ ] Unit tests for correlation calculation
- [ ] Loading states throughout
- [ ] Error handling with toasts
- [ ] Mobile responsive charts (stack vertically)
- [ ] No console errors

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-09 | Initial Phase 6 specification created |
| 2024-12-09 | Updated DOPE Charts (6.2) with v1-style filtering, 50-yard intervals, and Data Source badges |
| 2024-12-09 | Updated Velocity Trends (6.3) to include temperature/DA correlation scatter plots |
| 2024-12-09 | Resolved design decisions: MIL only, Option C for DOPE charts, N/A for missing costs, 5 ammo comparison limit |
