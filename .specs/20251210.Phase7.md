# Phase 7: Image Handling & Storage

**Created**: December 10, 2024
**Status**: Completed
**Reference**: [20251206.MANIFEST.md](./20251206.MANIFEST.md)

---

## Overview

Phase 7 implements the complete image handling pipeline for TrueDope v2, including upload, processing, storage, and retrieval. Images can be attached to Range Sessions (target photos, group shots) and Rifle Setups (glamour shots).

---

## Data Model

### Image Entity

```csharp
public class Image
{
    public int Id { get; set; }

    // Ownership (at most one will be set)
    public int? RangeSessionId { get; set; }
    public RangeSession? RangeSession { get; set; }

    public int? RifleSetupId { get; set; }
    public RifleSetup? RifleSetup { get; set; }

    // Storage info
    public string FileName { get; set; }           // Original filename
    public string StorageKey { get; set; }         // MinIO object key (full-size)
    public string ThumbnailKey { get; set; }       // MinIO object key (thumbnail)
    public string ContentType { get; set; }        // MIME type (image/jpeg, image/png)
    public long FileSizeBytes { get; set; }        // Original file size

    // Metadata
    public string? Caption { get; set; }           // Optional user caption
    public int DisplayOrder { get; set; }          // For ordering in galleries
    public DateTime UploadedAt { get; set; }

    // Audit
    public string UserId { get; set; }             // Owner for authorization
    public ApplicationUser User { get; set; }
}
```

### Constraints

- An image must belong to either a RangeSession OR a RifleSetup (not both, not neither)
- Maximum 10 images per entity (RangeSession or RifleSetup)
- Maximum file size: 20MB
- Supported formats: HEIC, JPEG, PNG

### Entity Relationships

```
ApplicationUser
    └── Image[] (all images owned by user)

RangeSession
    └── Image[] (session photos)

RifleSetup
    └── Image[] (rifle photos)
```

---

## MinIO Storage Structure

### Bucket Configuration

- **Bucket name**: `truedope-images` (from env: `MINIO_BUCKET`)
- **Access**: Private (no public access)

### Object Key Naming Convention

```
{userId}/{entityType}/{entityId}/{imageId}_{size}.{ext}

Examples:
- users/abc123/sessions/42/1_full.jpg
- users/abc123/sessions/42/1_thumb.jpg
- users/abc123/rifles/5/3_full.jpg
- users/abc123/rifles/5/3_thumb.jpg
```

### Size Variants

| Variant | Max Dimensions | Quality | Use Case |
|---------|---------------|---------|----------|
| `full` | Original (up to 4096px longest edge) | 85% | Detail view |
| `thumb` | 300x300 | 80% | Galleries, lists |

---

## API Endpoints

### Upload

```
POST /api/images/upload
Content-Type: multipart/form-data

Form fields:
- file: The image file (required)
- rangeSessionId: int (optional, mutually exclusive with rifleSetupId)
- rifleSetupId: int (optional, mutually exclusive with rangeSessionId)
- caption: string (optional)

Response: ImageDto
```

### Bulk Upload

```
POST /api/images/upload/bulk
Content-Type: multipart/form-data

Form fields:
- files: Multiple image files (required, max 10)
- rangeSessionId: int (optional)
- rifleSetupId: int (optional)

Response: ImageDto[]
```

### Get Image URL (Pre-signed)

```
GET /api/images/{id}

Response:
{
    "success": true,
    "data": {
        "id": 1,
        "fileName": "target.jpg",
        "caption": "100 yard group",
        "fullUrl": "https://minio.../signed-url-for-full",
        "thumbnailUrl": "https://minio.../signed-url-for-thumb",
        "uploadedAt": "2024-12-10T14:30:00Z"
    }
}
```

### List Images for Entity

```
GET /api/sessions/{sessionId}/images
GET /api/rifles/{rifleId}/images

Response: ImageDto[]
```

### Update Image

```
PUT /api/images/{id}

Body:
{
    "caption": "Updated caption",
    "displayOrder": 2
}

Response: ImageDto
```

### Delete Image

```
DELETE /api/images/{id}

Response: { "success": true }
```

### Bulk Delete

```
DELETE /api/images/bulk

Body:
{
    "imageIds": [1, 2, 3]
}

Response: { "success": true, "data": { "deletedCount": 3 } }
```

### Reorder Images

```
PUT /api/images/reorder

Body:
{
    "rangeSessionId": 42,  // or rifleSetupId
    "imageIds": [3, 1, 2]  // new order
}

Response: { "success": true }
```

---

## Image Processing Pipeline

### Upload Flow

```
1. Receive file via multipart upload
2. Validate:
   - File size ≤ 20MB
   - Content type is HEIC, JPEG, or PNG
   - User owns the target entity
   - Entity has < 10 images
3. Generate unique storage keys
4. Process image:
   a. If HEIC: Convert to JPEG using ImageSharp
   b. Resize full image if > 4096px on longest edge
   c. Generate 300x300 thumbnail (maintain aspect ratio, crop to square)
5. Upload both variants to MinIO
6. Create Image record in database
7. Return ImageDto with pre-signed URLs
```

### HEIC Conversion

- Use SixLabors.ImageSharp with SixLabors.ImageSharp.Formats.Heic (or Magick.NET as fallback)
- Convert to JPEG at 85% quality
- Preserve orientation from EXIF

### Thumbnail Generation

- 300x300 pixels
- Maintain aspect ratio
- Center-crop to square
- JPEG at 80% quality

---

## Pre-signed URLs

### Configuration

- **Expiration**: 1 hour
- **Method**: GET only

### Implementation

```csharp
public async Task<string> GetPreSignedUrlAsync(string objectKey)
{
    return await _minioClient.PresignedGetObjectAsync(new PresignedGetObjectArgs()
        .WithBucket(_bucketName)
        .WithObject(objectKey)
        .WithExpiry(3600)); // 1 hour
}
```

### Frontend Handling

- Cache URLs in memory with expiry tracking
- Request fresh URLs when needed
- Handle 403 errors by refreshing URLs

---

## Frontend Components

### ImageUpload Component

```typescript
interface ImageUploadProps {
    entityType: 'session' | 'rifle';
    entityId: number;
    maxImages?: number;        // default 10
    onUploadComplete?: (images: Image[]) => void;
}
```

Features:
- Drag-and-drop zone
- File picker button
- Multiple file selection
- Upload progress indicator
- Preview before upload
- Error handling (size, format, count limits)

### ImageGallery Component

```typescript
interface ImageGalleryProps {
    images: Image[];
    editable?: boolean;        // show delete, reorder controls
    onDelete?: (id: number) => void;
    onReorder?: (ids: number[]) => void;
}
```

Features:
- Thumbnail grid layout
- Click to open lightbox/modal
- Full-size image viewing
- Caption display
- Drag-to-reorder (if editable)
- Delete button (if editable)

### ImageLightbox Component

```typescript
interface ImageLightboxProps {
    images: Image[];
    initialIndex: number;
    onClose: () => void;
}
```

Features:
- Full-screen overlay
- Previous/next navigation
- Keyboard navigation (arrows, escape)
- Pinch-to-zoom on mobile
- Caption display

---

## Integration Points

### RangeSession

- Add `Images` navigation property
- Update session detail page to show image gallery
- Update session form to include image upload
- Include image count in session list

### RifleSetup

- Add `Images` navigation property
- Update rifle detail page to show image gallery
- Update rifle form to include image upload
- Show primary image as thumbnail in rifle list

---

## Error Handling

### Validation Errors

| Error | HTTP Status | Message |
|-------|-------------|---------|
| File too large | 400 | "File size exceeds 20MB limit" |
| Invalid format | 400 | "Unsupported image format. Use JPEG, PNG, or HEIC" |
| Too many images | 400 | "Maximum of 10 images per {entity}" |
| Entity not found | 404 | "{Entity} not found" |
| Not authorized | 403 | "You don't have permission to add images to this {entity}" |

### Processing Errors

- If HEIC conversion fails: Return error, don't create partial record
- If thumbnail generation fails: Still save full image, log warning
- If MinIO unavailable: Return 503 with retry guidance

---

## Testing Plan

### Unit Tests

1. **Image validation**
   - Test file size validation
   - Test content type validation
   - Test ownership validation (must have exactly one parent)

2. **Image processing**
   - Test HEIC detection
   - Test JPEG/PNG passthrough
   - Test thumbnail generation dimensions
   - Test large image resizing

3. **Storage key generation**
   - Test key format
   - Test uniqueness

### Integration Tests

1. **Upload endpoint**
   - Successful JPEG upload
   - Successful PNG upload
   - Successful HEIC upload with conversion
   - Reject oversized file
   - Reject invalid format
   - Reject when at image limit

2. **Retrieval endpoint**
   - Get image with valid pre-signed URLs
   - 404 for non-existent image
   - 403 for unauthorized access

3. **Delete endpoint**
   - Successful delete removes DB record and MinIO objects
   - Bulk delete

4. **List endpoint**
   - List images for session
   - List images for rifle
   - Empty list for entity with no images

---

## Implementation Phases

### Phase 7.1: MinIO Configuration & Image Entity
- [ ] Add ImageSharp NuGet packages
- [ ] Add MinIO SDK NuGet package
- [ ] Create MinIO service with bucket initialization
- [ ] Create Image entity
- [ ] Create EF migration
- [ ] Add navigation properties to RangeSession and RifleSetup

### Phase 7.2: Image Upload Endpoint
- [ ] Create ImageService with upload logic
- [ ] Create ImagesController
- [ ] Implement validation
- [ ] Implement single file upload endpoint
- [ ] Create ImageDto and mapping

### Phase 7.3: HEIC Conversion & Thumbnail Generation
- [ ] Implement HEIC detection
- [ ] Implement HEIC to JPEG conversion
- [ ] Implement thumbnail generation
- [ ] Implement large image resizing

### Phase 7.4: Image Retrieval & Pre-signed URLs
- [ ] Implement pre-signed URL generation
- [ ] Implement GET /api/images/{id}
- [ ] Implement list endpoints for sessions and rifles
- [ ] Add images to session/rifle detail responses

### Phase 7.5: Image Update & Delete
- [ ] Implement PUT /api/images/{id}
- [ ] Implement DELETE /api/images/{id}
- [ ] Implement bulk delete
- [ ] Implement reorder endpoint

### Phase 7.6: Frontend Image Upload Component
- [ ] Create ImageUpload component
- [ ] Implement drag-and-drop
- [ ] Implement progress indicator
- [ ] Implement error handling

### Phase 7.7: Frontend Image Gallery & Lightbox
- [ ] Create ImageGallery component
- [ ] Create ImageLightbox component
- [ ] Implement keyboard navigation

### Phase 7.8: Integration with Sessions & Rifles
- [ ] Add image upload to session form
- [ ] Add image gallery to session detail
- [ ] Add image upload to rifle form
- [ ] Add image gallery to rifle detail
- [ ] Add image count/thumbnail to list views

---

## Configuration

### Environment Variables

```env
# Already configured in docker-compose.yml
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=truedope-images
MINIO_USE_SSL=false
```

### appsettings.json

```json
{
  "MinIO": {
    "Endpoint": "localhost:9000",
    "AccessKey": "minioadmin",
    "SecretKey": "minioadmin",
    "BucketName": "truedope-images",
    "UseSSL": false
  },
  "ImageProcessing": {
    "MaxFileSizeBytes": 20971520,
    "MaxImagesPerEntity": 10,
    "ThumbnailSize": 300,
    "FullImageMaxDimension": 4096,
    "JpegQuality": 85,
    "ThumbnailQuality": 80,
    "PreSignedUrlExpirySeconds": 3600
  }
}
```

---

## Dependencies

### Backend NuGet Packages

```xml
<PackageReference Include="Minio" Version="6.0.3" />
<PackageReference Include="SixLabors.ImageSharp" Version="3.1.5" />
```

Note: HEIC support in ImageSharp requires additional consideration - may need Magick.NET for full HEIC support.

### Frontend npm Packages

```json
{
  "react-dropzone": "^14.2.3"
}
```

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-10 | Initial Phase 7 specification created |
