# Phase 8: Location & Weather Services

**Created**: December 13, 2024
**Status**: Planning
**Reference**: [20251206.MANIFEST.md](./20251206.MANIFEST.md)

---

## Overview

Phase 8 enhances the existing location and weather infrastructure with interactive map components for visual location selection. The backend location CRUD, weather API integration, and session form integration are **already complete**. This phase focuses on adding map-based UI features.

---

## Current State Assessment

### Already Implemented

#### Backend - Location Services (100% Complete)
- `SavedLocation` entity with lat/lon/altitude/name/description
- `ILocationService` / `LocationService` with full CRUD
- `LocationsController` with all endpoints
- DTOs: `LocationListDto`, `LocationDetailDto`, `CreateLocationDto`, `UpdateLocationDto`

#### Backend - Weather Services (100% Complete)
- `WeatherService` with OpenWeatherMap integration
- Memory caching with configurable TTL (10 minutes default)
- Unit conversions: Kelvin→Fahrenheit, hPa→inHg, m/s→mph
- Density altitude calculation from pressure/temperature/elevation
- `WeatherController` with GET endpoint
- DTOs: `WeatherDto`, `WeatherRequestDto`

#### Frontend - Location Management (100% Complete)
- Types: `LocationListDto`, `LocationDetailDto`, `CreateLocationDto`, `UpdateLocationDto`
- Service: `locations.service.ts` with full CRUD
- Pages: `LocationsList`, `LocationCreate`, `LocationEdit`, `LocationDetail`, `LocationForm`
- Search, filtering, responsive design

#### Frontend - Weather Integration (100% Complete)
- Types: `WeatherDto`, `WeatherRequestParams`
- Service: `weather.service.ts`
- Hook: `useGeolocation.ts` for GPS capture

#### Frontend - Session Integration (100% Complete)
- `SessionCreate.tsx`: Location dropdown, GPS button, weather auto-fetch
- `SessionEdit.tsx`: Location selection, manual weather fields
- Weather fields populate form automatically
- Conditions tracking badge

---

## What's Missing (Phase 8 Scope)

### 1. Interactive Map Component
**Priority: High**

A location picker component with map visualization for:
- Selecting coordinates visually (pin drop)
- Displaying saved locations on a map
- Previewing location on detail/edit pages

### 2. Map Search/Geocoding
**Priority: Medium**

Allow users to search for addresses/places:
- Search box with autocomplete
- Results list with click-to-select
- Reverse geocoding (coordinates → place name)

### 3. Elevation Lookup Service
**Priority: Medium**

Auto-populate elevation from coordinates:
- Integration with elevation API (Open-Elevation or similar)
- Fallback to manual entry
- Display elevation on map
- Auto-fetch with 500ms debounce after marker drag
- Cache results by rounded coordinates (reused ranges benefit all users)

### 4. OpenWeatherMap API Key Configuration Verification
**Priority: High**

Ensure API key is properly configured:
- Add API key to development environment
- Verify weather fetch works end-to-end
- Add graceful degradation when API unavailable

### 5. Location Detail Map Preview
**Priority: Low**

Show map preview on location detail page:
- Static or interactive map showing the location
- Zoom controls
- Satellite/terrain toggle

### 6. Weather API Configuration Guidance
**Priority: Low**

Documentation and UI improvements:
- Better error messages when API key missing
- Setup instructions in docs
- Settings page indicator for weather status

### 7. Shared/Pre-seeded Locations
**Priority: High**

Admin-managed database of popular shooting locations:
- Separate `SharedLocation` table from user's `SavedLocation`
- Admin UI to add/edit/delete shared locations
- Users see shared locations as suggestions
- Users can copy shared location to their personal saved locations
- Location combobox shows: user's locations → shared locations → geocoding results

---

## Technical Decisions

### Map Library: Leaflet + React Leaflet

**Choice**: Leaflet (with React Leaflet wrapper)

**Rationale**:
- Free and open source (no API key required for maps)
- Well-maintained with active community
- Lightweight (~40KB gzipped)
- Good React integration via react-leaflet
- Uses OpenStreetMap tiles (free)
- Mobile-friendly with touch support

**Alternatives Considered**:
- Mapbox: Better styling but requires API key and has usage limits
- Google Maps: Requires API key, expensive at scale
- OpenLayers: More powerful but larger and more complex

### Geocoding: Nominatim (OpenStreetMap)

**Choice**: Nominatim via OpenStreetMap

**Rationale**:
- Free with usage policy (1 request/second)
- No API key required
- Same data source as Leaflet tiles
- Supports both forward and reverse geocoding

**Usage Policy Compliance**:
- Cache results
- Debounce search requests (300ms minimum)
- Include appropriate User-Agent header

### Elevation API: Open-Elevation

**Choice**: Open-Elevation API (https://open-elevation.com)

**Rationale**:
- Free and open source
- No API key required
- Simple REST API
- Adequate accuracy for ballistics use (~30m resolution)

**Alternative**: Use OpenWeatherMap (already integrated) but it doesn't provide elevation.

---

## Data Model

### Existing: SavedLocation (User's Personal Locations)

No changes required:

```csharp
public class SavedLocation
{
    public int Id { get; set; }
    public string UserId { get; set; }
    public string Name { get; set; }              // Max 100 chars
    public decimal Latitude { get; set; }         // -90 to 90
    public decimal Longitude { get; set; }        // -180 to 180
    public decimal? Altitude { get; set; }        // Feet, -1000 to 30000
    public string? Description { get; set; }      // Max 500 chars
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### New: SharedLocation (Admin Pre-seeded Locations)

```csharp
public class SharedLocation
{
    public int Id { get; set; }

    // Location info
    public string Name { get; set; }              // Max 100 chars, e.g., "Peacemaker National Training Center"
    public decimal Latitude { get; set; }         // -90 to 90
    public decimal Longitude { get; set; }        // -180 to 180
    public decimal? Altitude { get; set; }        // Feet, -1000 to 30000
    public string? Description { get; set; }      // Max 500 chars

    // Additional metadata for discovery
    public string? City { get; set; }             // Max 100 chars
    public string? State { get; set; }            // Max 50 chars (or region for non-US)
    public string? Country { get; set; }          // Max 50 chars, default "USA"
    public string? Website { get; set; }          // Max 255 chars
    public string? PhoneNumber { get; set; }      // Max 20 chars

    // Admin fields
    public bool IsActive { get; set; }            // Soft delete / hide from users
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public string CreatedByUserId { get; set; }   // Admin who added it
}
```

### Elevation Cache (Optional - for performance)

```csharp
public class ElevationCache
{
    public int Id { get; set; }
    public decimal Latitude { get; set; }         // Rounded to 3 decimal places (~110m)
    public decimal Longitude { get; set; }        // Rounded to 3 decimal places
    public decimal Elevation { get; set; }        // Feet
    public DateTime CachedAt { get; set; }
}
```

---

## API Endpoints

### Existing Endpoints (No Changes)

```
GET    /api/locations           - List user's locations
GET    /api/locations/{id}      - Get location detail
POST   /api/locations           - Create location
PUT    /api/locations/{id}      - Update location
DELETE /api/locations/{id}      - Delete location
GET    /api/weather             - Get weather for coordinates
```

### New Endpoints

#### Geocoding (Optional - can be client-side)

If we want to proxy geocoding through our API for rate limiting:

```
GET /api/geocoding/search?q={query}

Response:
{
    "success": true,
    "data": [
        {
            "displayName": "Shooting Range, 123 Main St, Springfield, IL",
            "latitude": 39.7817,
            "longitude": -89.6501,
            "type": "amenity"
        }
    ]
}
```

```
GET /api/geocoding/reverse?lat={lat}&lon={lon}

Response:
{
    "success": true,
    "data": {
        "displayName": "123 Main St, Springfield, IL 62701",
        "city": "Springfield",
        "state": "Illinois",
        "country": "United States"
    }
}
```

#### Elevation Lookup

```
GET /api/elevation?lat={lat}&lon={lon}

Response:
{
    "success": true,
    "data": {
        "elevation": 587.5,  // feet
        "source": "open-elevation"  // or "cache"
    }
}
```

### Shared Locations Endpoints

#### List Shared Locations (All Users)

```
GET /api/shared-locations?search={query}&state={state}

Response:
{
    "success": true,
    "data": [
        {
            "id": 1,
            "name": "Peacemaker National Training Center",
            "latitude": 39.1234,
            "longitude": -81.5678,
            "altitude": 850,
            "description": "Premier long-range facility",
            "city": "Glengary",
            "state": "WV",
            "country": "USA",
            "website": "https://peacemakernational.com",
            "phoneNumber": "304-555-1234"
        }
    ]
}
```

#### Copy Shared Location to Personal (All Users)

```
POST /api/shared-locations/{id}/copy

Response:
{
    "success": true,
    "data": {
        "id": 42,  // New SavedLocation ID
        "name": "Peacemaker National Training Center",
        ...
    }
}
```

#### Admin: Create Shared Location

```
POST /api/admin/shared-locations
Authorization: Bearer {admin-token}

Body:
{
    "name": "Peacemaker National Training Center",
    "latitude": 39.1234,
    "longitude": -81.5678,
    "altitude": 850,
    "description": "Premier long-range facility",
    "city": "Glengary",
    "state": "WV",
    "country": "USA",
    "website": "https://peacemakernational.com",
    "phoneNumber": "304-555-1234"
}

Response: SharedLocationDto
```

#### Admin: Update Shared Location

```
PUT /api/admin/shared-locations/{id}
Authorization: Bearer {admin-token}

Body: (all fields optional)
{
    "name": "Updated Name",
    "isActive": false
}

Response: SharedLocationDto
```

#### Admin: Delete Shared Location

```
DELETE /api/admin/shared-locations/{id}
Authorization: Bearer {admin-token}

Response: { "success": true }
```

#### Admin: List All Shared Locations (includes inactive)

```
GET /api/admin/shared-locations?includeInactive=true
Authorization: Bearer {admin-token}

Response: SharedLocationDto[] (includes isActive field)
```

---

## Frontend Components

### LocationPicker Component

```typescript
interface LocationPickerProps {
    value?: { latitude: number; longitude: number };
    onChange: (coords: { latitude: number; longitude: number }) => void;
    initialCenter?: { lat: number; lng: number };
    initialZoom?: number;
    showSearch?: boolean;
    showCurrentLocation?: boolean;
    height?: string;
}
```

Features:
- Interactive map with click-to-place marker
- Draggable marker
- Current location button (uses browser geolocation)
- Search box with autocomplete (if showSearch=true)
- Coordinates display
- Mobile-friendly touch gestures

### LocationMap Component

```typescript
interface LocationMapProps {
    locations?: SavedLocation[];
    selectedId?: number;
    onSelect?: (location: SavedLocation) => void;
    center?: { lat: number; lng: number };
    zoom?: number;
    height?: string;
    interactive?: boolean;  // false for static preview
}
```

Features:
- Display multiple location markers
- Popup on marker click with location name
- Cluster markers when zoomed out (if many locations)
- Highlight selected location

### LocationPreview Component

```typescript
interface LocationPreviewProps {
    latitude: number;
    longitude: number;
    name?: string;
    height?: string;
}
```

Features:
- Small static map showing single location
- Centered marker
- Non-interactive (for detail views)

### LocationCombobox Component

```typescript
interface LocationComboboxProps {
    value?: {
        type: 'saved' | 'shared' | 'custom';
        id?: number;
        coordinates?: { latitude: number; longitude: number };
    };
    onChange: (selection: LocationSelection) => void;
    placeholder?: string;
    showGpsButton?: boolean;
    allowCustom?: boolean;  // Allow geocoding search results
}

interface LocationSelection {
    type: 'saved' | 'shared' | 'custom';
    id?: number;
    name: string;
    latitude: number;
    longitude: number;
    altitude?: number;
}
```

Features:
- Searchable dropdown with typeahead
- Grouped results:
  1. "Your Locations" - user's SavedLocations
  2. "Popular Ranges" - SharedLocations
  3. "Search Results" - geocoding results (if allowCustom)
- GPS button to use current location
- Shows location details on selection (coordinates, altitude)
- "Save to My Locations" action for shared/custom selections

---

## Page Integrations

### Location Create/Edit Form

Update `LocationForm.tsx`:
1. Add `LocationPicker` component above coordinate inputs
2. Sync map selection with form fields
3. Add "Use Current Location" button
4. Add "Look Up Elevation" button (fetches and populates altitude field)
5. Optional: Search box for finding locations by name

### Location Detail Page

Update `LocationDetail.tsx`:
1. Add `LocationPreview` map showing the location
2. Display coordinates with copy-to-clipboard
3. Show elevation if available
4. "Get Directions" link (opens in Google Maps/Apple Maps)

### Location List Page

Update `LocationsList.tsx`:
1. Add optional map view toggle (list vs map)
2. Map view shows all locations with markers
3. Click marker to see location card
4. Click card to navigate to detail

### Session Create Page

Update `SessionCreate.tsx`:
1. Add small map preview when location selected
2. Map shows selected saved location OR GPS coordinates
3. Keep existing dropdown + GPS functionality

---

## Implementation Phases

### Phase 8.1: Dependencies & Map Setup
- [ ] Install react-leaflet, leaflet, and marker clustering packages
- [ ] Add Leaflet CSS to project
- [ ] Create basic map wrapper component
- [ ] Test map renders correctly

### Phase 8.2: LocationPicker Component
- [ ] Create LocationPicker component with interactive map
- [ ] Implement click-to-place marker
- [ ] Implement draggable marker
- [ ] Add current location button (integrate useGeolocation hook)
- [ ] Display coordinates below map
- [ ] Style map controls

### Phase 8.3: Location Form Integration
- [ ] Add LocationPicker to LocationForm
- [ ] Sync map selection with form state
- [ ] Test create/edit flow with map
- [ ] Handle edge cases (invalid coordinates, etc.)

### Phase 8.4: Geocoding Service
- [ ] Create backend geocoding proxy endpoints
- [ ] Create frontend geocoding service
- [ ] Implement search debouncing (300ms)
- [ ] Add SearchBox component to LocationPicker
- [ ] Add reverse geocoding for place name display

### Phase 8.5: Elevation Service
- [ ] Create backend elevation endpoint with caching
- [ ] Create ElevationCache entity and migration
- [ ] Auto-fetch elevation on marker placement (500ms debounce)
- [ ] Auto-populate altitude field in form
- [ ] Handle API errors gracefully

### Phase 8.6: Shared Locations Backend
- [ ] Create SharedLocation entity
- [ ] Create EF migration
- [ ] Create ISharedLocationService / SharedLocationService
- [ ] Create SharedLocationsController (public endpoints)
- [ ] Create admin endpoints in AdminController
- [ ] Create DTOs for shared locations

### Phase 8.7: Shared Locations Frontend
- [ ] Create shared locations types
- [ ] Create shared locations service
- [ ] Create admin shared locations page (list, create, edit)
- [ ] Add to admin navigation

### Phase 8.8: LocationCombobox Component
- [ ] Create LocationCombobox component
- [ ] Implement grouped search results (saved → shared → geocoding)
- [ ] Add GPS button integration
- [ ] Add "Save to My Locations" action
- [ ] Replace location dropdown in SessionCreate with LocationCombobox

### Phase 8.9: Location Preview Components
- [ ] Create LocationPreview component
- [ ] Add to LocationDetail page
- [ ] Add small preview to SessionCreate when location selected

### Phase 8.10: Map View for Location List
- [ ] Create LocationMap component
- [ ] Add list/map toggle to LocationsList
- [ ] Implement marker clustering
- [ ] Marker click shows location popup/card
- [ ] Include both saved and shared locations on map

### Phase 8.11: Weather Configuration Verification
- [ ] Verify OpenWeatherMap API key is set
- [ ] Test weather fetch end-to-end
- [ ] Add helpful error messages when API unavailable

### Phase 8.12: Testing
- [ ] Write unit tests for geocoding service
- [ ] Write unit tests for elevation service
- [ ] Write unit tests for shared location service
- [ ] Write integration tests for new endpoints
- [ ] Test all map interactions on mobile
- [ ] Test geolocation permissions handling
- [ ] Verify offline/error states
- [ ] Performance check with marker clustering

---

## Dependencies

### Frontend npm Packages

```json
{
    "leaflet": "^1.9.4",
    "react-leaflet": "^4.2.1",
    "@types/leaflet": "^1.9.8",
    "react-leaflet-cluster": "^2.1.0"
}
```

### Backend NuGet Packages

No additional packages required. HTTP client already available for geocoding and elevation API calls.

---

## Configuration

### Leaflet Tile Provider

Using OpenStreetMap tiles (free, no API key):

```typescript
const TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const ATTRIBUTION = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
```

### Default Map Settings

```typescript
const MAP_DEFAULTS = {
    center: { lat: 39.8283, lng: -98.5795 },  // Center of US
    zoom: 4,
    minZoom: 2,
    maxZoom: 18
};
```

### Nominatim (Geocoding) Settings

```typescript
const NOMINATIM_BASE = 'https://nominatim.openstreetmap.org';
const SEARCH_DEBOUNCE_MS = 300;
const USER_AGENT = 'TrueDope/2.0 (ballistics-logging-app)';
```

### Open-Elevation Settings

```typescript
const ELEVATION_API = 'https://api.open-elevation.com/api/v1/lookup';
```

---

## Error Handling

### Map Errors

| Error | Handling |
|-------|----------|
| Tiles fail to load | Show placeholder with retry button |
| Geolocation denied | Show message, allow manual input |
| Geolocation unavailable | Show message, allow manual input |
| Geocoding rate limited | Queue requests, show loading state |
| Elevation API unavailable | Allow manual altitude entry |

### Weather Errors

| Error | Handling |
|-------|----------|
| API key not configured | Show info message with setup link |
| API request failed | Show error toast, allow manual entry |
| API rate limited | Queue requests, show loading state |

---

## Testing Plan

### Unit Tests

1. **LocationPicker**
   - Renders map with initial center
   - Updates coordinates on marker drag
   - Triggers onChange callback correctly
   - Handles missing geolocation API

2. **Geocoding Service**
   - Parses Nominatim response correctly
   - Handles empty results
   - Handles API errors

3. **Elevation Service**
   - Parses elevation response correctly
   - Converts meters to feet
   - Handles API errors

### Integration Tests

1. **Location Form with Map**
   - Creating location via map picker
   - Editing location updates map
   - Coordinates sync between map and inputs

2. **GPS Integration**
   - GPS button requests location
   - Success populates form
   - Error shows appropriate message

3. **Weather Integration**
   - Weather fetches for selected location
   - Weather fetches for GPS coordinates
   - Error handling when API unavailable

### Manual Testing

1. **Mobile Touch**
   - Pinch to zoom works
   - Tap to place marker works
   - Drag marker works
   - No viewport issues

2. **Cross-browser**
   - Chrome, Firefox, Safari
   - iOS Safari, Chrome Android

---

## Accessibility Considerations

- Map is supplementary; form inputs remain primary method
- Keyboard navigation for map controls
- Screen reader announcements for coordinate changes
- Skip link to bypass map for keyboard users
- Alt text for static map images

---

## Performance Considerations

- Lazy load map components (code splitting)
- Debounce geocoding searches (300ms)
- Cache geocoding results
- Use marker clustering for 10+ locations
- Optimize tile loading with appropriate max zoom

---

## Security Considerations

- No sensitive data in map tiles
- Geocoding requests don't include auth tokens
- Rate limiting on proxy endpoints (if implemented)
- Validate coordinates server-side

---

## Future Enhancements (Out of Scope)

- Offline map tiles (PWA feature)
- Custom map markers per location type
- Draw shooting lanes/ranges on map
- Integration with Google Maps/Apple Maps for navigation
- Weather forecast (multi-day)
- Weather history for past sessions

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-13 | Initial Phase 8 specification created |
| 2024-12-13 | Added SharedLocation feature for admin pre-seeded popular ranges |
| 2024-12-13 | Added LocationCombobox component spec |
| 2024-12-13 | Added ElevationCache entity for performance |
| 2024-12-13 | Expanded implementation phases to 12 sub-phases |
