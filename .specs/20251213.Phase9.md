# Phase 9: User Preferences & Settings

**Created**: December 13, 2024
**Status**: In Progress
**Dependencies**: Phase 2 (Auth), Phase 3 (Core Data Model)

---

## Overview

This phase implements user preferences and settings, including unit preferences (with display conversion), profile management, password changes, and dark mode theming. The system stores all data in canonical units (yards, Fahrenheit, etc.) and converts for display based on user preferences.

---

## Scope

### In Scope
- **Unit Preferences**: Distance (yards/meters), Adjustment (MIL/MOA), Temperature (F/C), Pressure (inHg/hPa), Velocity (fps/m/s)
- **Unit Conversion Utilities**: Backend and frontend helpers for display conversion
- **Profile Settings**: Update first name, last name, email
- **Password Change**: Requires current password verification
- **Dark Mode**: Theme toggle with system preference detection
- **Settings UI**: Tabbed settings page in React frontend

### Out of Scope (Deferred)
- Notification preferences (no notifications exist yet)
- Data export/import
- Account deletion
- Two-factor authentication

---

## Technical Design

### 1. Data Model

#### New Entity: `UserPreferences`

```csharp
// TrueDope.Api/Data/Entities/UserPreferences.cs
public class UserPreferences
{
    [Key]
    public string UserId { get; set; } = null!;

    // Navigation
    [ForeignKey(nameof(UserId))]
    public User User { get; set; } = null!;

    // Unit Preferences (stored as enum values)
    public DistanceUnit DistanceUnit { get; set; } = DistanceUnit.Yards;
    public AdjustmentUnit AdjustmentUnit { get; set; } = AdjustmentUnit.MIL;
    public TemperatureUnit TemperatureUnit { get; set; } = TemperatureUnit.Fahrenheit;
    public PressureUnit PressureUnit { get; set; } = PressureUnit.InHg;
    public VelocityUnit VelocityUnit { get; set; } = VelocityUnit.FPS;

    // Theme
    public ThemePreference Theme { get; set; } = ThemePreference.System;

    // Timestamps
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

#### Enums

```csharp
// TrueDope.Api/Data/Entities/Enums/UnitEnums.cs
public enum DistanceUnit
{
    Yards = 0,
    Meters = 1
}

public enum AdjustmentUnit
{
    MIL = 0,
    MOA = 1
}

public enum TemperatureUnit
{
    Fahrenheit = 0,
    Celsius = 1
}

public enum PressureUnit
{
    InHg = 0,
    HPa = 1
}

public enum VelocityUnit
{
    FPS = 0,      // feet per second
    MPS = 1       // meters per second
}

public enum ThemePreference
{
    System = 0,
    Light = 1,
    Dark = 2
}
```

#### User Entity Update

Add navigation property to existing `User` entity:

```csharp
// Add to User.cs
public UserPreferences? Preferences { get; set; }
```

#### DbContext Configuration

```csharp
// In ApplicationDbContext.cs OnModelCreating
modelBuilder.Entity<UserPreferences>(entity =>
{
    entity.HasKey(e => e.UserId);

    entity.HasOne(e => e.User)
        .WithOne(u => u.Preferences)
        .HasForeignKey<UserPreferences>(e => e.UserId)
        .OnDelete(DeleteBehavior.Cascade);
});
```

---

### 2. API Endpoints

#### Preferences Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/users/me/preferences` | Get current user's preferences |
| PUT | `/api/users/me/preferences` | Update preferences |

#### DTOs

```csharp
// Request
public class UpdatePreferencesRequest
{
    public DistanceUnit? DistanceUnit { get; set; }
    public AdjustmentUnit? AdjustmentUnit { get; set; }
    public TemperatureUnit? TemperatureUnit { get; set; }
    public PressureUnit? PressureUnit { get; set; }
    public VelocityUnit? VelocityUnit { get; set; }
    public ThemePreference? Theme { get; set; }
}

// Response
public class UserPreferencesResponse
{
    public string DistanceUnit { get; set; } = null!;      // "yards" | "meters"
    public string AdjustmentUnit { get; set; } = null!;    // "mil" | "moa"
    public string TemperatureUnit { get; set; } = null!;   // "fahrenheit" | "celsius"
    public string PressureUnit { get; set; } = null!;      // "inhg" | "hpa"
    public string VelocityUnit { get; set; } = null!;      // "fps" | "mps"
    public string Theme { get; set; } = null!;             // "system" | "light" | "dark"
}
```

#### Existing Profile Endpoints (Already Implemented)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/users/me` | Get current user profile |
| PUT | `/api/users/me` | Update profile (firstName, lastName) |
| PUT | `/api/users/me/password` | Change password |

---

### 3. Unit Conversion Utilities

#### Backend Conversion Service

```csharp
// TrueDope.Api/Services/UnitConversionService.cs
public interface IUnitConversionService
{
    // Distance: canonical = yards
    double ConvertDistance(double yards, DistanceUnit targetUnit);
    double ConvertDistanceToCanonical(double value, DistanceUnit sourceUnit);
    string FormatDistance(double yards, DistanceUnit unit);

    // Temperature: canonical = Fahrenheit
    double ConvertTemperature(double fahrenheit, TemperatureUnit targetUnit);
    double ConvertTemperatureToCanonical(double value, TemperatureUnit sourceUnit);
    string FormatTemperature(double fahrenheit, TemperatureUnit unit);

    // Pressure: canonical = inHg
    double ConvertPressure(double inHg, PressureUnit targetUnit);
    double ConvertPressureToCanonical(double value, PressureUnit sourceUnit);
    string FormatPressure(double inHg, PressureUnit unit);

    // Velocity: canonical = fps
    double ConvertVelocity(double fps, VelocityUnit targetUnit);
    double ConvertVelocityToCanonical(double value, VelocityUnit sourceUnit);
    string FormatVelocity(double fps, VelocityUnit unit);

    // Adjustment: canonical = MIL
    double ConvertAdjustment(double mils, AdjustmentUnit targetUnit);
    double ConvertAdjustmentToCanonical(double value, AdjustmentUnit sourceUnit);
    string FormatAdjustment(double mils, AdjustmentUnit unit);
}
```

#### Conversion Constants

```
Distance:
  1 yard = 0.9144 meters
  1 meter = 1.09361 yards

Temperature:
  C = (F - 32) × 5/9
  F = C × 9/5 + 32

Pressure:
  1 inHg = 33.8639 hPa
  1 hPa = 0.02953 inHg

Velocity:
  1 fps = 0.3048 m/s
  1 m/s = 3.28084 fps

Adjustment:
  1 MIL = 3.438 MOA
  1 MOA = 0.2909 MIL
```

#### Frontend Conversion Utilities

```typescript
// frontend/src/utils/unitConversion.ts
export type DistanceUnit = 'yards' | 'meters';
export type AdjustmentUnit = 'mil' | 'moa';
export type TemperatureUnit = 'fahrenheit' | 'celsius';
export type PressureUnit = 'inhg' | 'hpa';
export type VelocityUnit = 'fps' | 'mps';

export const convertDistance = (yards: number, unit: DistanceUnit): number => { ... };
export const formatDistance = (yards: number, unit: DistanceUnit): string => { ... };

// Similar for other units...

// Hook for easy access with user preferences
export const useUnitConversion = () => {
  const preferences = usePreferencesStore(state => state.preferences);

  return {
    formatDistance: (yards: number) => formatDistance(yards, preferences.distanceUnit),
    formatTemperature: (f: number) => formatTemperature(f, preferences.temperatureUnit),
    // ... etc
  };
};
```

---

### 4. Frontend Implementation

#### New Zustand Store: Preferences

```typescript
// frontend/src/stores/preferences.store.ts
interface PreferencesState {
  preferences: UserPreferences;
  isLoading: boolean;
  error: string | null;

  fetchPreferences: () => Promise<void>;
  updatePreferences: (updates: Partial<UserPreferences>) => Promise<boolean>;
  setTheme: (theme: ThemePreference) => void;
}

// Persisted to localStorage
```

#### Theme Implementation

```typescript
// frontend/src/hooks/useTheme.ts
export const useTheme = () => {
  const { preferences, setTheme } = usePreferencesStore();

  useEffect(() => {
    const theme = preferences.theme;
    const isDark =
      theme === 'dark' ||
      (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

    document.documentElement.classList.toggle('dark', isDark);
  }, [preferences.theme]);

  return { theme: preferences.theme, setTheme };
};
```

#### Tailwind Dark Mode Configuration

```javascript
// tailwind.config.js
module.exports = {
  darkMode: 'class',
  // ...
}
```

#### Settings Page Structure

```
/settings
├── Profile Tab
│   ├── First Name (editable)
│   ├── Last Name (editable)
│   ├── Email (read-only, display only)
│   └── Save Button
│
├── Security Tab
│   ├── Current Password
│   ├── New Password
│   ├── Confirm New Password
│   └── Change Password Button
│
├── Units Tab
│   ├── Distance: Yards / Meters
│   ├── Adjustment: MIL / MOA
│   ├── Temperature: Fahrenheit / Celsius
│   ├── Pressure: inHg / hPa
│   ├── Velocity: fps / m/s
│   └── Save Button (or auto-save on change)
│
└── Appearance Tab
    ├── Theme: System / Light / Dark
    └── (Auto-saves on change)
```

---

### 5. Dark Mode Color Scheme

#### Design Tokens

```css
/* Light Mode (default) */
:root {
  --color-bg-primary: #ffffff;
  --color-bg-secondary: #f9fafb;
  --color-bg-tertiary: #f3f4f6;
  --color-text-primary: #111827;
  --color-text-secondary: #6b7280;
  --color-border: #e5e7eb;
  --color-accent: #2563eb;        /* Blue-600 */
  --color-accent-hover: #1d4ed8;  /* Blue-700 */
}

/* Dark Mode */
.dark {
  --color-bg-primary: #111827;    /* Gray-900 */
  --color-bg-secondary: #1f2937;  /* Gray-800 */
  --color-bg-tertiary: #374151;   /* Gray-700 */
  --color-text-primary: #f9fafb;  /* Gray-50 */
  --color-text-secondary: #9ca3af; /* Gray-400 */
  --color-border: #374151;        /* Gray-700 */
  --color-accent: #3b82f6;        /* Blue-500 */
  --color-accent-hover: #60a5fa;  /* Blue-400 */
}
```

#### Component Updates Required

All existing components need dark mode variants. Key areas:
- Layout (sidebar, header, main content area)
- Cards and containers
- Forms (inputs, selects, buttons)
- Tables
- Modals
- Navigation

---

## Implementation Tasks

### Backend Tasks

- [ ] **B1**: Create `UserPreferences` entity and unit enums
- [ ] **B2**: Update `User` entity with navigation property
- [ ] **B3**: Add DbContext configuration and create migration
- [ ] **B4**: Implement `IUnitConversionService` with all conversions
- [ ] **B5**: Create `PreferencesService` for CRUD operations
- [ ] **B6**: Add preferences endpoints to `UsersController`
- [ ] **B7**: Write unit tests for conversion service
- [ ] **B8**: Write integration tests for preferences endpoints
- [ ] **B9**: Auto-create default preferences on user registration

### Frontend Tasks

- [ ] **F1**: Create preferences Zustand store with persistence
- [ ] **F2**: Create unit conversion utilities and hook
- [ ] **F3**: Implement theme hook and dark mode toggle logic
- [ ] **F4**: Configure Tailwind for dark mode (`darkMode: 'class'`)
- [ ] **F5**: Define CSS custom properties for theme colors
- [ ] **F6**: Refactor Settings page with tabbed interface
- [ ] **F7**: Implement Profile tab (already partially exists)
- [ ] **F8**: Implement Security tab (password change)
- [ ] **F9**: Implement Units tab with preference selectors
- [ ] **F10**: Implement Appearance tab with theme selector
- [ ] **F11**: Update all existing components with dark mode classes
- [ ] **F12**: Add preferences loading to app initialization
- [ ] **F13**: Write tests for unit conversion utilities

---

## API Response Examples

### GET /api/users/me/preferences

```json
{
  "success": true,
  "data": {
    "distanceUnit": "yards",
    "adjustmentUnit": "mil",
    "temperatureUnit": "fahrenheit",
    "pressureUnit": "inhg",
    "velocityUnit": "fps",
    "theme": "system"
  }
}
```

### PUT /api/users/me/preferences

**Request:**
```json
{
  "distanceUnit": "meters",
  "theme": "dark"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "distanceUnit": "meters",
    "adjustmentUnit": "mil",
    "temperatureUnit": "fahrenheit",
    "pressureUnit": "inhg",
    "velocityUnit": "fps",
    "theme": "dark"
  },
  "message": "Preferences updated successfully"
}
```

---

## Testing Strategy

### Backend Tests

1. **Unit Tests (UnitConversionServiceTests)**
   - Test all conversion functions with known values
   - Test edge cases (0, negative values, large numbers)
   - Test round-trip conversions (canonical → converted → canonical)

2. **Integration Tests (PreferencesEndpointTests)**
   - GET preferences returns defaults for new user
   - PUT preferences updates successfully
   - PUT preferences with partial update preserves other values
   - Unauthorized access returns 401

### Frontend Tests

1. **Unit Conversion Tests**
   - Test all conversion functions
   - Test formatting functions (decimal places, units)

2. **Component Tests (optional)**
   - Settings page renders all tabs
   - Theme toggle updates correctly
   - Form validation works

---

## Migration Notes

### Database Migration

```bash
dotnet ef migrations add AddUserPreferences
dotnet ef database update
```

### Existing Users

Existing users will not have a `UserPreferences` record. The API should:
1. Return default values if no preferences exist
2. Create preferences record on first update (upsert pattern)

---

## Dependencies

- **Tailwind CSS**: Already installed, needs dark mode configuration
- **No new packages required**

---

## Acceptance Criteria

1. ✅ User can view and update unit preferences
2. ✅ Unit preferences are persisted and loaded on login
3. ✅ Dark mode toggle works with system preference detection
4. ✅ Theme preference persists across sessions
5. ✅ Profile can be updated (first name, last name)
6. ✅ Password can be changed (requires current password)
7. ✅ All unit conversions are accurate (within floating-point tolerance)
8. ✅ Settings page is responsive and works on mobile
9. ✅ All existing components render correctly in dark mode

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-13 | Initial spec created |
