# Phase 12: Data Import from V1 - Specification

**Created**: December 14, 2024
**Status**: Planning
**Phase**: 12 of 15

---

## Overview

This phase covers migrating data from the v1 BallisticsApp to the v2 TrueDope application. The v1 system has two parallel, disconnected recording systems (`ShootingRecord` for DOPE, `ShootingString` for velocity/groups), while v2 unifies these under a session-first architecture with `RangeSession` as the anchor.

**Key Insight**: Both systems use PostgreSQL. We'll use a JSON export/import approach - export data from v1 production, transfer files locally, then import into v2. This is safer (no direct prod DB access from dev) and allows inspection of intermediate data.

---

## Feasibility Assessment

### Can We Migrate? **YES**

The data models are conceptually compatible with these mappings:

| V1 Entity | V2 Entity | Notes |
|-----------|-----------|-------|
| `ShootingRecord` | `RangeSession` + `DopeEntry[]` | DOPE sessions become RangeSessions with DopeEntries |
| `ShootingString` | `RangeSession` + `ChronoSession` + `VelocityReading[]` + `GroupEntry[]` | Velocity/group sessions become RangeSessions with child data |
| `DistanceHold` | `DopeEntry` | 1:1 mapping, field names differ |
| `IndividualShot` | `VelocityReading` | 1:1 mapping, field names differ |
| `GroupData` | `GroupEntry` | Now direct child of RangeSession, not nested under ChronoSession |
| `RifleSetup` | `RifleSetup` | Mostly 1:1, dual ammo system simplified |
| `Ammunition` | `Ammunition` | Mostly 1:1 |
| `AmmoLot` | `AmmoLot` | Mostly 1:1 |
| `SavedLocation` | `SavedLocation` | 1:1 |
| `Image` | `Image` | Polymorphic parent changes (adds GroupEntry option) |
| `GroupImage` | `Image` | Merged into unified Image entity |
| `User` | `User` | Identity-based, needs careful handling |

### Challenges

1. **User Identity Migration** - ASP.NET Core Identity users have hashed passwords, security stamps, etc. Need to either migrate users directly or require password resets.

2. **Session Unification** - V1's separate ShootingRecord and ShootingString must become unified RangeSessions. Logic needed to detect if records should merge (same date/rifle/location).

3. **Image Storage** - Both use MinIO. Need to either migrate files or ensure v2 points to same bucket.

4. **Dual Ammo System** - V1 RifleSetup has both linked (`AmmunitionId`) and legacy manual (`AmmoManufacturer`, `AmmoName`, `BulletWeight`) fields. V2 drops legacy fields.

5. **ID Preservation** - Should IDs be preserved or regenerated? Preserved simplifies references but may conflict with existing v2 data.

---

## Migration Strategy: JSON Export/Import

We'll use a two-phase approach:

### Phase 1: Export (runs on production server)
```bash
# SSH into production server
ssh prod-server

# Run export script against v1 database
cd /path/to/BallisticsApp
./scripts/export-v1-data.sh --output /tmp/v1-export/

# Creates JSON files:
#   /tmp/v1-export/users.json
#   /tmp/v1-export/rifles.json
#   /tmp/v1-export/ammunition.json
#   /tmp/v1-export/ammo-lots.json
#   /tmp/v1-export/locations.json
#   /tmp/v1-export/shooting-records.json  (with nested DistanceHolds)
#   /tmp/v1-export/shooting-strings.json  (with nested IndividualShots, GroupData)
#   /tmp/v1-export/images.json
```

### Phase 2: Transfer & Import (runs locally)
```bash
# Copy export files to local machine
scp -r prod-server:/tmp/v1-export ./v1-export/

# Run import against local v2 database
cd TrueDope/backend
dotnet run --project src/TrueDope.Migration -- import ./v1-export/ --dry-run  # Preview
dotnet run --project src/TrueDope.Migration -- import ./v1-export/            # Execute

# Copy images from production MinIO to local MinIO (if needed)
mc cp --recursive prod-minio/ballistics-images local-minio/truedope-images
```

**Why this approach:**
- **Safer** - No direct connection from local dev to production database
- **Debuggable** - Can inspect JSON files before import
- **Portable** - JSON files can be versioned, shared, re-run
- **Simpler networking** - No need to expose prod DB or set up SSH tunnels
- **Idempotent** - Can re-run import multiple times during testing

---

## Data Model Mapping Details

### 1. User Migration

**V1 User Fields:**
```
Id, UserName, Email, PasswordHash, SecurityStamp, FirstName?, LastName?,
CreatedAt, LastLoginTime, TimeZoneId, HasCompletedSetupWizard, SetupWizardState
```

**V2 User Fields:**
```
Id, UserName, Email, PasswordHash, SecurityStamp, FirstName, LastName,
IsAdmin, CreatedAt, LastLoginAt, PasswordResetToken?, PasswordResetTokenExpiry?
```

**Mapping:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve (GUID) |
| `UserName` | `UserName` | Direct |
| `Email` | `Email` | Direct |
| `PasswordHash` | `PasswordHash` | Direct (Identity v3 compatible) |
| `SecurityStamp` | `SecurityStamp` | Direct |
| `FirstName` | `FirstName` | Default to "" if null |
| `LastName` | `LastName` | Default to "" if null |
| - | `IsAdmin` | Set based on v1 role claims |
| `CreatedAt` | `CreatedAt` | Direct |
| `LastLoginTime` | `LastLoginAt` | Direct |
| `TimeZoneId` | - | Dropped (not used in v2) |
| `HasCompletedSetupWizard` | - | Dropped |
| `SetupWizardState` | - | Dropped |

**Decision**: Attempt to preserve passwords (both use ASP.NET Core Identity). If it doesn't work due to version differences, users will need to reset passwords - that's acceptable.

---

### 2. RifleSetup Migration

**V1 RifleSetup Fields:**
```
Id, UserId, Name, Manufacturer, Model, Caliber, ZeroDistance, BarrelLength,
MuzzleVelocity, BallisticCoefficient, ScopeHeight,
AmmunitionId?, AmmoLotId?, AmmoManufacturer?, AmmoName?, BulletWeight?,
CreatedDate, ModifiedDate
```

**V2 RifleSetup Fields:**
```
Id, UserId, Name, Manufacturer, Model, Caliber, BarrelLength, TwistRate?,
ScopeMake?, ScopeModel?, ScopeHeight?, ZeroDistance, ZeroElevationClicks?,
ZeroWindageClicks?, MuzzleVelocity?, BallisticCoefficient?, DragModel?,
Notes?, CreatedAt, UpdatedAt
```

**Mapping:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `UserId` | `UserId` | Direct |
| `Name` | `Name` | Direct |
| `Manufacturer` | `Manufacturer` | Direct |
| `Model` | `Model` | Direct |
| `Caliber` | `Caliber` | Direct |
| `ZeroDistance` | `ZeroDistance` | Direct |
| `BarrelLength` | `BarrelLength` | Direct |
| `MuzzleVelocity` | `MuzzleVelocity` | Direct |
| `BallisticCoefficient` | `BallisticCoefficient` | Direct |
| `ScopeHeight` | `ScopeHeight` | Direct |
| - | `TwistRate` | Null (new field) |
| - | `ScopeMake` | Null (new field) |
| - | `ScopeModel` | Null (new field) |
| - | `DragModel` | Default to "G1" |
| - | `Notes` | Null |
| `AmmunitionId` | - | Dropped (not on RifleSetup in v2) |
| `AmmoLotId` | - | Dropped |
| `AmmoManufacturer` | - | Dropped (legacy field) |
| `AmmoName` | - | Dropped (legacy field) |
| `BulletWeight` | - | Dropped (legacy field) |
| `CreatedDate` | `CreatedAt` | Direct |
| `ModifiedDate` | `UpdatedAt` | Direct |

**Decision**: V2 removes the dual ammunition system from RifleSetup. Legacy manual ammo fields (`AmmoManufacturer`, `AmmoName`, `BulletWeight`) will be dropped - they're not worth migrating since you're the only real user and this simplifies the migration.

---

### 3. Ammunition Migration

**V1 Ammunition Fields:**
```
Id, CreatedBy (UserId), Name, Grain, Caliber, Manufacturer, CostPerRound?,
Notes?, CreatedAt, UpdatedAt
```

**V2 Ammunition Fields:**
```
Id, UserId, Manufacturer, Name, Caliber, Grain, BulletType?, CostPerRound?,
BallisticCoefficient?, DragModel?, Notes?, CreatedAt, UpdatedAt
```

**Mapping:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `CreatedBy` | `UserId` | Rename |
| `Manufacturer` | `Manufacturer` | Direct |
| `Name` | `Name` | Direct |
| `Caliber` | `Caliber` | Direct |
| `Grain` | `Grain` | Direct |
| `CostPerRound` | `CostPerRound` | Direct |
| `Notes` | `Notes` | Direct |
| - | `BulletType` | Null (new field) |
| - | `BallisticCoefficient` | Null (new field) |
| - | `DragModel` | Null (new field) |
| `CreatedAt` | `CreatedAt` | Direct |
| `UpdatedAt` | `UpdatedAt` | Direct |

---

### 4. AmmoLot Migration

**V1 AmmoLot Fields:**
```
Id, AmmunitionId, UserId, LotNumber, AcquisitionDate?, FirstUsed?, LastUsed?, CreatedAt
```

**V2 AmmoLot Fields:**
```
Id, AmmunitionId, UserId, LotNumber, PurchaseDate?, InitialQuantity?,
PurchasePrice?, Notes?, CreatedAt, UpdatedAt
```

**Mapping:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `AmmunitionId` | `AmmunitionId` | Direct |
| `UserId` | `UserId` | Direct |
| `LotNumber` | `LotNumber` | Direct |
| `AcquisitionDate` | `PurchaseDate` | Rename |
| - | `InitialQuantity` | Null (new field) |
| - | `PurchasePrice` | Null (new field) |
| - | `Notes` | Null (new field) |
| `FirstUsed` | - | Dropped (computed from sessions in v2) |
| `LastUsed` | - | Dropped (computed from sessions in v2) |
| `CreatedAt` | `CreatedAt` | Direct |
| - | `UpdatedAt` | Set to CreatedAt |

---

### 5. SavedLocation Migration

**V1 SavedLocation Fields:**
```
Id, UserId, Name, Latitude, Longitude, Description?, CreatedDate, ModifiedDate
```

**V2 SavedLocation Fields:**
```
Id, UserId, Name, Latitude, Longitude, Altitude?, Description?, CreatedAt, UpdatedAt
```

**Mapping:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `UserId` | `UserId` | Direct |
| `Name` | `Name` | Direct |
| `Latitude` | `Latitude` | Direct |
| `Longitude` | `Longitude` | Direct |
| - | `Altitude` | Null (new field) |
| `Description` | `Description` | Direct |
| `CreatedDate` | `CreatedAt` | Rename |
| `ModifiedDate` | `UpdatedAt` | Rename |

---

### 6. ShootingRecord → RangeSession + DopeEntry[] Migration

This is the core DOPE data migration.

**V1 ShootingRecord Fields:**
```
Id, UserId, RifleSetupId, DateTime, Temperature?, Humidity?, WindSpeed?,
WindDirection?, Pressure?, Notes?, Latitude?, Longitude?, LocationName?,
SavedLocationId?, CreatedDate, ModifiedDate
+ Children: DistanceHold[], Image[]
```

**V2 RangeSession Fields:**
```
Id, UserId, RifleSetupId, SessionDate, SessionTime?, SavedLocationId?,
Latitude?, Longitude?, LocationName?, Temperature?, Humidity?, WindSpeed?,
WindDirection?, Pressure?, DensityAltitude?, Notes?, CreatedAt, UpdatedAt
+ Children: DopeEntry[], ChronoSession?, GroupEntry[], Image[]
```

**Mapping ShootingRecord → RangeSession:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `UserId` | `UserId` | Direct |
| `RifleSetupId` | `RifleSetupId` | Direct |
| `DateTime` | `SessionDate` | Extract date portion |
| `DateTime` | `SessionTime` | Extract time portion |
| `Temperature` | `Temperature` | Direct |
| `Humidity` | `Humidity` | Direct |
| `WindSpeed` | `WindSpeed` | Direct |
| `WindDirection` | `WindDirection` | Direct |
| `Pressure` | `Pressure` | Direct |
| - | `DensityAltitude` | Null (new field) |
| `Notes` | `Notes` | Direct |
| `Latitude` | `Latitude` | Direct |
| `Longitude` | `Longitude` | Direct |
| `LocationName` | `LocationName` | Direct |
| `SavedLocationId` | `SavedLocationId` | Direct |
| `CreatedDate` | `CreatedAt` | Rename |
| `ModifiedDate` | `UpdatedAt` | Rename |

**V1 DistanceHold → V2 DopeEntry:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `ShootingRecordId` | `RangeSessionId` | Rename |
| `Distance` | `Distance` | Direct |
| `ElevationAdjustment` | `ElevationMils` | Rename |
| `WindageAdjustment` | `WindageMils` | Rename |
| - | `Notes` | Null (new field) |
| - | `CreatedAt` | Set to parent's CreatedAt |

---

### 7. ShootingString → RangeSession + ChronoSession + GroupEntry[] Migration

This is the velocity/group data migration. **Key complexity**: In v1, GroupData is nested under ShootingString. In v2, GroupEntry is a direct child of RangeSession.

**V1 ShootingString Fields:**
```
Id, UserId, AmmunitionId, AmmoLotId?, RifleSetupId?, Date, Time?,
SessionType (enum: Velocity=1, Group=2, Combined=3), BarrelTemperature?,
NumberOfRounds, AverageVelocity?, HighVelocity?, LowVelocity?,
StandardDeviation?, ExtremeSpread?, Notes?, CreatedAt, UpdatedAt
+ Children: IndividualShot[], GroupData[]
```

**Migration Logic:**

Each `ShootingString` becomes a `RangeSession` with optional `ChronoSession` and `GroupEntry[]`:

```
ShootingString (SessionType = Velocity)
  → RangeSession
    → ChronoSession (with velocity stats)
      → VelocityReading[] (from IndividualShot[])

ShootingString (SessionType = Group)
  → RangeSession
    → GroupEntry[] (from GroupData[])

ShootingString (SessionType = Combined)
  → RangeSession
    → ChronoSession (with velocity stats)
      → VelocityReading[] (from IndividualShot[])
    → GroupEntry[] (from GroupData[])
```

**Mapping ShootingString → RangeSession:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Generate new ID (avoid collision with ShootingRecord IDs) |
| `UserId` | `UserId` | Direct |
| `RifleSetupId` | `RifleSetupId` | Direct (may be null in v1) |
| `Date` | `SessionDate` | Direct |
| `Time` | `SessionTime` | Direct |
| - | `SavedLocationId` | Null (v1 didn't track location for strings) |
| - | `Temperature` | Null |
| - | `Humidity` | Null |
| - | `WindSpeed` | Null |
| - | `WindDirection` | Null |
| - | `Pressure` | Null |
| `Notes` | `Notes` | Direct |
| `CreatedAt` | `CreatedAt` | Direct |
| `UpdatedAt` | `UpdatedAt` | Direct |

**Mapping ShootingString → ChronoSession (if SessionType includes Velocity):**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| - | `Id` | Generate new |
| - | `RangeSessionId` | Link to created RangeSession |
| `AmmunitionId` | `AmmunitionId` | Direct |
| `AmmoLotId` | `AmmoLotId` | Direct |
| `BarrelTemperature` | `BarrelTemperature` | Direct |
| `NumberOfRounds` | `NumberOfRounds` | Direct |
| `AverageVelocity` | `AverageVelocity` | Direct |
| `HighVelocity` | `HighVelocity` | Direct |
| `LowVelocity` | `LowVelocity` | Direct |
| `StandardDeviation` | `StandardDeviation` | Direct |
| `ExtremeSpread` | `ExtremeSpread` | Direct |
| `Notes` | `Notes` | Null (parent has notes) |

**Mapping IndividualShot → VelocityReading:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `ShootingStringId` | `ChronoSessionId` | Map to new ChronoSession ID |
| `ShotNumber` | `ShotNumber` | Direct |
| `Velocity` | `Velocity` | Direct |
| `CreatedAt` | `CreatedAt` | Direct |

**Mapping GroupData → GroupEntry:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `ShootingStringId` | `RangeSessionId` | Map to new RangeSession ID |
| - | `AmmunitionId` | Copy from parent ShootingString |
| - | `AmmoLotId` | Copy from parent ShootingString |
| `GroupNumber` | `GroupNumber` | Direct |
| `Distance` | `Distance` | Direct |
| `NumberOfShots` | `NumberOfShots` | Direct |
| `MeanRadiusMOA` | `MeanRadiusMoa` | Direct |
| `TotalMOAMOA` | `GroupSizeMoa` | Rename (total MOA = group size) |
| `Notes` | `Notes` | Direct |
| `CreatedAt` | `CreatedAt` | Direct |
| `UpdatedAt` | `UpdatedAt` | Direct |

---

### 8. Image Migration

**V1 has two image types:**
1. `Image` - attached to RifleSetup or ShootingRecord
2. `GroupImage` - attached to GroupData

**V2 has unified Image:**
- Can attach to RifleSetup, RangeSession, or GroupEntry

**Mapping Image → Image:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| `Id` | `Id` | Preserve |
| `UserId` | `UserId` | Direct |
| `FileName` | `FileName` | Direct |
| `OriginalFileName` | `OriginalFileName` | Direct |
| `ContentType` | `ContentType` | Direct |
| `FileSize` | `FileSize` | Direct |
| `ThumbnailFileName` | `ThumbnailFileName` | Direct |
| `Caption` | `Caption` | Direct |
| `IsProcessed` | `IsProcessed` | Direct |
| `UploadDate` | `UploadedAt` | Rename |
| `RifleSetupId` | `RifleSetupId` | Direct |
| `ShootingRecordId` | `RangeSessionId` | Map to new RangeSession ID |
| - | `GroupEntryId` | Null (unless from GroupImage) |
| - | `DisplayOrder` | Default 0 |

**Mapping GroupImage → Image:**
| V1 Field | V2 Field | Transform |
|----------|----------|-----------|
| - | `Id` | Generate new |
| - | `UserId` | Get from parent GroupData's ShootingString |
| `ImagePath` | `FileName` | Direct |
| - | `OriginalFileName` | Copy from ImagePath |
| - | `ContentType` | Infer from extension |
| - | `FileSize` | Query MinIO or estimate |
| `ThumbnailPath` | `ThumbnailFileName` | Direct |
| - | `Caption` | Null |
| - | `IsProcessed` | True |
| `UploadedAt` | `UploadedAt` | Direct |
| - | `RifleSetupId` | Null |
| - | `RangeSessionId` | Null |
| `GroupDataId` | `GroupEntryId` | Map to new GroupEntry ID |
| - | `DisplayOrder` | Default 0 |

---

## ID Collision Strategy

V1 has separate ID sequences for `ShootingRecord` and `ShootingString`. V2 unifies them into `RangeSession`. To avoid collisions:

**Option A: ID Offset**
- ShootingRecord IDs: Keep as-is (1, 2, 3...)
- ShootingString IDs: Add offset of 1,000,000 (1000001, 1000002...)

**Option B: New IDs**
- Generate new sequential IDs for all RangeSessions
- Maintain mapping table for reference

**Recommendation**: Option A (ID Offset) - Simpler and preserves original IDs for debugging.

---

## MinIO Image Migration

Both v1 and v2 use MinIO for image storage. Options:

### Option 1: Shared Bucket (Recommended for Same Server)
- Point v2 to same MinIO bucket as v1
- No file migration needed
- Image filenames (UUIDs) remain valid

### Option 2: Copy Files (Separate Servers)
- Use MinIO client (`mc`) to copy all objects
- `mc cp --recursive v1-minio/ballistics-images v2-minio/truedope-images`

### Option 3: Re-upload via API
- Download each image from v1 MinIO
- Upload to v2 via ImageService
- Slowest but ensures proper v2 processing

**Recommendation**: Option 1 if same server, Option 2 if separate.

---

## Implementation Plan

### Phase 12.1: Export Script (runs on v1 production)

Create a .NET CLI tool or script that runs against the v1 database and exports JSON files.

**Option A: Add export endpoint to v1 BallisticsApp** (simpler)
```csharp
// Add to BallisticsApp - a simple controller or Razor page
[Authorize(Roles = "Admin")]
public class DataExportController : Controller
{
    [HttpGet("/admin/export")]
    public async Task<IActionResult> ExportAll()
    {
        var export = new V1Export
        {
            Users = await _context.Users.ToListAsync(),
            Rifles = await _context.RifleSetups.ToListAsync(),
            // ... etc
        };

        return Json(export);
    }
}
```

**Option B: Standalone export script** (more flexible)
```
BallisticsApp/
└── scripts/
    └── export-v1-data/
        ├── export-v1-data.csproj
        ├── Program.cs
        └── appsettings.json
```

**Recommended: Option B** - A standalone console app that can be run on the server without modifying the running v1 application.

---

### Phase 12.2: Export Script Implementation

**Project structure:**
```
BallisticsApp/scripts/export-v1-data/
├── export-v1-data.csproj
├── Program.cs
├── ExportModels/
│   └── V1ExportData.cs
└── appsettings.json
```

**Program.cs:**
```csharp
using System.Text.Json;
using Microsoft.EntityFrameworkCore;

// Connect to v1 database (read-only)
var connectionString = config["ConnectionString"];
var outputDir = args.Length > 0 ? args[0] : "./v1-export";

Directory.CreateDirectory(outputDir);

using var context = new V1ReadOnlyDbContext(connectionString);

// Export each entity type to separate JSON file
Console.WriteLine("Exporting users...");
var users = await context.Users.AsNoTracking().ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/users.json",
    JsonSerializer.Serialize(users, jsonOptions));

Console.WriteLine("Exporting rifles...");
var rifles = await context.RifleSetups.AsNoTracking().ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/rifles.json",
    JsonSerializer.Serialize(rifles, jsonOptions));

Console.WriteLine("Exporting ammunition...");
var ammo = await context.Ammunition.AsNoTracking().ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/ammunition.json",
    JsonSerializer.Serialize(ammo, jsonOptions));

Console.WriteLine("Exporting ammo lots...");
var lots = await context.AmmoLots.AsNoTracking().ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/ammo-lots.json",
    JsonSerializer.Serialize(lots, jsonOptions));

Console.WriteLine("Exporting locations...");
var locations = await context.SavedLocations.AsNoTracking().ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/locations.json",
    JsonSerializer.Serialize(locations, jsonOptions));

Console.WriteLine("Exporting shooting records (DOPE)...");
var records = await context.ShootingRecords
    .AsNoTracking()
    .Include(r => r.DistanceHolds)
    .ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/shooting-records.json",
    JsonSerializer.Serialize(records, jsonOptions));

Console.WriteLine("Exporting shooting strings (Chrono/Groups)...");
var strings = await context.ShootingStrings
    .AsNoTracking()
    .Include(s => s.IndividualShots)
    .Include(s => s.GroupData)
        .ThenInclude(g => g.GroupImages)
    .ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/shooting-strings.json",
    JsonSerializer.Serialize(strings, jsonOptions));

Console.WriteLine("Exporting images...");
var images = await context.Images.AsNoTracking().ToListAsync();
var groupImages = await context.GroupImages.AsNoTracking().ToListAsync();
await File.WriteAllTextAsync($"{outputDir}/images.json",
    JsonSerializer.Serialize(new { Images = images, GroupImages = groupImages }, jsonOptions));

Console.WriteLine($"Export complete! Files written to: {outputDir}");
```

---

### Phase 12.3: Import Tool Setup (runs locally against v2)

**Create CLI tool**: `TrueDope.Migration/` project

```
TrueDope/
├── backend/
│   └── src/
│       ├── TrueDope.Api/
│       └── TrueDope.Migration/     # NEW
│           ├── TrueDope.Migration.csproj
│           ├── Program.cs
│           ├── appsettings.json
│           ├── Commands/
│           │   ├── ImportCommand.cs
│           │   └── VerifyCommand.cs
│           ├── Services/
│           │   ├── JsonDataReader.cs
│           │   ├── ImportOrchestrator.cs
│           │   └── MigrationVerifier.cs
│           ├── Mappers/
│           │   ├── UserMapper.cs
│           │   ├── RifleMapper.cs
│           │   ├── AmmoMapper.cs
│           │   ├── LocationMapper.cs
│           │   ├── SessionMapper.cs
│           │   └── ImageMapper.cs
│           └── Models/
│               ├── V1ExportModels.cs
│               ├── ImportOptions.cs
│               ├── ImportResult.cs
│               └── VerificationReport.cs
```

**Configuration (appsettings.json):**
```json
{
  "ConnectionStrings": {
    "V2Database": "Host=localhost;Port=5432;Database=truedope;Username=postgres;Password=..."
  },
  "Migration": {
    "ShootingStringIdOffset": 1000000,
    "CreatePlaceholderRifles": true
  }
}
```

---

### Phase 12.4: Import Tool Implementation

**JsonDataReader.cs** - Reads the exported JSON files:
```csharp
public class JsonDataReader
{
    private readonly string _exportDir;

    public async Task<List<V1User>> ReadUsersAsync()
        => await ReadJsonFileAsync<List<V1User>>("users.json");

    public async Task<List<V1RifleSetup>> ReadRiflesAsync()
        => await ReadJsonFileAsync<List<V1RifleSetup>>("rifles.json");

    public async Task<List<V1ShootingRecord>> ReadShootingRecordsAsync()
        => await ReadJsonFileAsync<List<V1ShootingRecord>>("shooting-records.json");

    // ... etc for each entity type

    private async Task<T> ReadJsonFileAsync<T>(string filename)
    {
        var path = Path.Combine(_exportDir, filename);
        var json = await File.ReadAllTextAsync(path);
        return JsonSerializer.Deserialize<T>(json, _jsonOptions)!;
    }
}
```

**ImportOrchestrator.cs** - Coordinates the import in FK-safe order:
```csharp
public class ImportOrchestrator
{
    public async Task<ImportResult> RunImportAsync(string exportDir, ImportOptions options)
    {
        var reader = new JsonDataReader(exportDir);
        var result = new ImportResult();

        // 1. Import Users
        if (options.ImportUsers)
        {
            var v1Users = await reader.ReadUsersAsync();
            result.Users = await ImportUsersAsync(v1Users, options.DryRun);
        }

        // 2. Import Reference Data (order matters for FKs)
        result.Locations = await ImportLocationsAsync(reader, options.DryRun);
        result.Ammunition = await ImportAmmunitionAsync(reader, options.DryRun);
        result.AmmoLots = await ImportAmmoLotsAsync(reader, options.DryRun);
        result.Rifles = await ImportRiflesAsync(reader, options.DryRun);

        // 3. Create placeholder rifles for null-rifle sessions
        if (options.CreatePlaceholderRifles)
        {
            result.PlaceholderRifles = await CreatePlaceholderRiflesAsync(reader, options.DryRun);
        }

        // 4. Import Session Data
        result.DopeSessions = await ImportShootingRecordsAsync(reader, options.DryRun);
        result.ChronoSessions = await ImportShootingStringsAsync(reader, options.DryRun);

        // 5. Import Images (metadata only - files stay in MinIO)
        result.Images = await ImportImagesAsync(reader, options.DryRun);

        return result;
    }
}
```

---

### Phase 12.5: CLI Commands

```bash
# Preview what would be imported (no database changes)
dotnet run --project src/TrueDope.Migration -- import ./v1-export --dry-run

# Full import
dotnet run --project src/TrueDope.Migration -- import ./v1-export

# Import specific entity types only
dotnet run --project src/TrueDope.Migration -- import ./v1-export --users-only
dotnet run --project src/TrueDope.Migration -- import ./v1-export --reference-only
dotnet run --project src/TrueDope.Migration -- import ./v1-export --sessions-only

# Verify import integrity (compare counts, spot-check records)
dotnet run --project src/TrueDope.Migration -- verify ./v1-export
```

---

### Phase 12.6: Verification

After import, verify data integrity:

```csharp
public class MigrationVerifier
{
    public async Task<VerificationReport> VerifyAsync(string exportDir)
    {
        var reader = new JsonDataReader(exportDir);
        var report = new VerificationReport();

        // Count comparisons
        var v1Users = await reader.ReadUsersAsync();
        var v2Users = await _v2Context.Users.CountAsync();
        report.AddCheck("Users", v1Users.Count, v2Users);

        var v1Rifles = await reader.ReadRiflesAsync();
        var v2Rifles = await _v2Context.RifleSetups.CountAsync();
        report.AddCheck("Rifles", v1Rifles.Count, v2Rifles);

        // Note: v2 may have more rifles due to placeholder rifles

        var v1Records = await reader.ReadShootingRecordsAsync();
        var v1Strings = await reader.ReadShootingStringsAsync();
        var v2Sessions = await _v2Context.RangeSessions.CountAsync();
        report.AddCheck("RangeSessions", v1Records.Count + v1Strings.Count, v2Sessions);

        // ... etc

        return report;
    }
}
```

---

## Migration Order (Foreign Key Dependencies)

Must migrate in this order to satisfy FK constraints:

1. **Users** (no dependencies)
2. **SavedLocations** (depends on Users)
3. **Ammunition** (depends on Users)
4. **AmmoLots** (depends on Ammunition, Users)
5. **RifleSetups** (depends on Users)
6. **RangeSessions from ShootingRecords** (depends on Users, RifleSetups, SavedLocations)
7. **DopeEntries** (depends on RangeSessions)
8. **RangeSessions from ShootingStrings** (depends on Users, RifleSetups)
9. **ChronoSessions** (depends on RangeSessions, Ammunition, AmmoLots)
10. **VelocityReadings** (depends on ChronoSessions)
11. **GroupEntries** (depends on RangeSessions, Ammunition, AmmoLots)
12. **Images** (depends on Users, RifleSetups, RangeSessions, GroupEntries)

---

## Edge Cases & Special Handling

### 1. Null RifleSetupId in ShootingString
V1 allows `ShootingString.RifleSetupId` to be null. V2's `RangeSession.RifleSetupId` is required.

**Decision**: Create a single "Unknown/Migrated Rifle" placeholder per user. Any ShootingString records with null RifleSetupId will be assigned to this placeholder rifle.

```csharp
// During import, for each user with null-rifle sessions:
var placeholderRifle = new RifleSetup
{
    UserId = userId,
    Name = "Unknown (Migrated)",
    Manufacturer = "Unknown",
    Model = "Unknown",
    Caliber = "Unknown",
    ZeroDistance = 100,
    Notes = "Placeholder rifle created during v1→v2 migration for sessions that had no rifle assigned.",
    CreatedAt = DateTime.UtcNow
};
```

### 2. Duplicate Detection (Same-Day Sessions)
A user might have a ShootingRecord and ShootingString on the same date with the same rifle.

**Decision**: Keep them as separate RangeSessions. This is simpler, preserves original data structure, and the user can manually consolidate later if desired. The ID offset strategy ensures no collisions.

### 3. Legacy Manual Ammo on RifleSetup
V1 RifleSetup has manual ammo fields (`AmmoManufacturer`, `AmmoName`, `BulletWeight`).

**Decision**: Drop these fields entirely. Since you're the only real user with data, this simplifies the migration. If any rifle only had manual ammo (no linked `AmmunitionId`), those fields are simply not migrated.

### 4. Missing Timestamps
Some v1 records might have null `ModifiedDate` or other optional timestamps.

**Solution**: Use `CreatedDate` as fallback for `UpdatedAt`.

---

## Rollback Strategy

If migration fails or produces bad data:

1. **Pre-Migration Backup**: Export v2 database before migration
2. **Transaction-Based**: Run migration in transaction where possible
3. **Post-Migration Verification**: Run verifier before committing
4. **Quick Restore**: Script to restore from backup

```bash
# Backup before migration
./scripts/export-database.sh > pre-migration-backup.sql

# Run migration
dotnet run -- migrate --full

# If issues found
./scripts/import-database.sh < pre-migration-backup.sql
```

---

## File Changes Summary

### New Files - Export Script (in v1 BallisticsApp)
```
BallisticsApp/scripts/export-v1-data/
├── export-v1-data.csproj
├── Program.cs
├── V1ReadOnlyDbContext.cs
└── appsettings.json
```

### New Files - Import Tool (in v2 TrueDope)
```
TrueDope/backend/src/TrueDope.Migration/
├── TrueDope.Migration.csproj
├── Program.cs
├── appsettings.json
├── Commands/
│   ├── ImportCommand.cs
│   └── VerifyCommand.cs
├── Services/
│   ├── JsonDataReader.cs
│   ├── ImportOrchestrator.cs
│   └── MigrationVerifier.cs
├── Mappers/
│   ├── UserMapper.cs
│   ├── RifleMapper.cs
│   ├── AmmoMapper.cs
│   ├── LocationMapper.cs
│   ├── SessionMapper.cs
│   └── ImageMapper.cs
└── Models/
    ├── V1ExportModels.cs      # POCOs matching v1 JSON structure
    ├── ImportOptions.cs
    ├── ImportResult.cs
    └── VerificationReport.cs
```

---

## Decisions Made

| # | Question | Decision |
|---|----------|----------|
| 1 | Migrate users with passwords? | **Try to preserve** - If Identity versions don't match, users reset passwords (acceptable) |
| 2 | ID collision strategy? | **Offset** - Add 1,000,000 to ShootingString IDs when creating RangeSessions |
| 3 | Merge same-day sessions? | **Keep Separate** - Simpler, preserves original structure, user can consolidate later |
| 4 | Handle null RifleSetupId? | **Placeholder Rifle** - Create "Unknown (Migrated)" rifle per user |
| 5 | MinIO strategy? | **Copy files** - Use `mc cp` to copy from prod MinIO to local MinIO |
| 6 | Legacy manual ammo? | **Drop** - Since you're the only real user, just drop these fields |
| 7 | Migration approach? | **Export/Import** - JSON export on prod, transfer files, import locally |

---

## Success Criteria

Migration is complete when:

- [ ] All v1 users exist in v2 (with preserved IDs)
- [ ] All v1 rifles exist in v2 (with preserved IDs)
- [ ] All v1 ammunition/lots exist in v2 (with preserved IDs)
- [ ] All v1 saved locations exist in v2 (with preserved IDs)
- [ ] All v1 ShootingRecords exist as v2 RangeSessions with DopeEntries
- [ ] All v1 ShootingStrings exist as v2 RangeSessions with ChronoSessions/GroupEntries
- [ ] All v1 velocity data preserved (IndividualShot → VelocityReading)
- [ ] All v1 group data preserved (GroupData → GroupEntry)
- [ ] All images accessible (either via shared MinIO or migrated)
- [ ] v2 application functions normally with migrated data
- [ ] DOPE charts show correct data from v1 records
- [ ] Velocity statistics calculate correctly from v1 data
- [ ] No orphaned records or broken references

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-14 | Initial specification created |
| 2024-12-14 | Updated to use Export/Import approach instead of dual-DB connection |
| 2024-12-14 | Finalized decisions: keep sessions separate, placeholder rifles, drop legacy ammo fields |
