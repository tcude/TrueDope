# Better Sorting in Sessions Page

**Date**: December 15, 2025
**Status**: Proposed
**Affects**: TrueDope v2 (frontend + backend)

## Problem Statement

When multiple shooting sessions occur on the same day, the sessions list page doesn't provide clear ordering. Currently:
- Sessions are sorted by `SessionDate` only (descending)
- The `SessionTime` field exists in the database and DTOs but is **never used**
- Sessions on the same date appear in arbitrary order (database row order)
- Users cannot determine which session came first/last on a given day

## Current Implementation

### Database Schema
The field already exists:
```csharp
// RangeSession.cs
public DateTime SessionDate { get; set; }  // Required
public TimeSpan? SessionTime { get; set; }  // Optional - EXISTS BUT UNUSED
```

### Backend Sorting (SessionService.cs)
```csharp
query = filter.SortBy.ToLowerInvariant() switch
{
    "sessiondate" => filter.SortDesc
        ? query.OrderByDescending(s => s.SessionDate)
        : query.OrderBy(s => s.SessionDate),
    // ... other options
    _ => query.OrderByDescending(s => s.SessionDate)
};
// NOTE: No secondary sort by SessionTime
```

### Frontend State
- **Types**: `sessionTime: string | null` exists in all DTOs ✅
- **Create Form**: Only date picker, no time input ❌
- **Edit Form**: Only date picker, no time input ❌
- **List Display**: Shows date only, no time ❌
- **Detail Display**: Shows date only, no time ❌

## Proposed Solution

### 1. Add Optional Time Input to Session Forms

**SessionCreate.tsx** - Add time picker below date picker:
```tsx
<div>
  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
    Time (optional)
  </label>
  <input
    type="time"
    value={formData.sessionTime || ''}
    onChange={(e) => setFormData((prev) => ({
      ...prev,
      sessionTime: e.target.value || undefined
    }))}
    className="..."
  />
</div>
```

**SessionEdit.tsx** - Same pattern for edit form.

### 2. Update Backend Sorting Logic

**SessionService.cs** - Add secondary sort by time:
```csharp
"sessiondate" => filter.SortDesc
    ? query.OrderByDescending(s => s.SessionDate)
            .ThenByDescending(s => s.SessionTime ?? TimeSpan.Zero)
    : query.OrderBy(s => s.SessionDate)
            .ThenBy(s => s.SessionTime ?? TimeSpan.Zero),
```

This ensures:
- Primary sort: By date (existing behavior)
- Secondary sort: By time when dates match
- Sessions without time sort to beginning of day (00:00)

### 3. Display Time in Sessions List

**SessionsList.tsx** - Conditionally show time if present:
```tsx
<td className="px-4 py-4 whitespace-nowrap">
  <Link to={`/sessions/${session.id}`} className="...">
    {new Date(session.sessionDate).toLocaleDateString()}
    {session.sessionTime && (
      <span className="text-gray-500 dark:text-gray-400 ml-2 text-sm">
        {formatTime(session.sessionTime)}
      </span>
    )}
  </Link>
</td>
```

Helper function:
```typescript
const formatTime = (time: string): string => {
  // Convert "HH:mm:ss" to "H:MM AM/PM"
  const [hours, minutes] = time.split(':').map(Number);
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const displayHours = hours % 12 || 12;
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
};
```

### 4. Display Time in Session Detail

**SessionDetail.tsx** - Show time alongside date:
```tsx
<h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
  {new Date(session.sessionDate).toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })}
  {session.sessionTime && (
    <span className="text-gray-600 dark:text-gray-400 ml-2">
      at {formatTime(session.sessionTime)}
    </span>
  )}
</h1>
```

## Files to Modify

### Backend
| File | Changes |
|------|---------|
| `TrueDope.Api/Services/SessionService.cs` | Add `.ThenBy(SessionTime)` secondary sort |

### Frontend
| File | Changes |
|------|---------|
| `src/pages/sessions/SessionCreate.tsx` | Add optional time input field |
| `src/pages/sessions/SessionEdit.tsx` | Add optional time input field |
| `src/pages/sessions/SessionsList.tsx` | Display time when present, add `formatTime` helper |
| `src/pages/sessions/SessionDetail.tsx` | Display time when present |
| `src/utils/formatters.ts` (new or existing) | Optional: Centralized `formatTime` function |

## UX Considerations

1. **Time is optional** - Users shouldn't be forced to enter a time, especially for historical data
2. **Sensible defaults** - Sessions without time sort to the start of the day (00:00)
3. **Subtle display** - Time should be visually secondary to date (smaller, lighter color)
4. **12-hour format** - Use AM/PM for US users (could be locale-aware later)

## Migration Notes

- No database migration needed - `SessionTime` column already exists
- Existing sessions will have `null` time values (acceptable)
- No data backfill required

## Testing Checklist

- [ ] Create session without time - should work as before
- [ ] Create session with time - time should be saved
- [ ] Edit session to add time - should update
- [ ] Edit session to remove time - should clear to null
- [ ] List page shows time only when present
- [ ] List page sorts correctly: date desc, then time desc
- [ ] Multiple sessions on same day appear in correct time order
- [ ] Sessions without time appear at top of same-day group (when sorted desc)
- [ ] Detail page shows time only when present

## Future Enhancements (Out of Scope)

- Sort direction toggle in the UI
- Group sessions by date visually
- Time zone handling improvements
- Relative time display ("2 hours ago")
