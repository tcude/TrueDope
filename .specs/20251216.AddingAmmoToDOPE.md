# Adding Ammunition Info to DOPE Sessions in Sessions List

**Date**: December 16, 2025
**Status**: Proposed
**Affects**: TrueDope v2 Backend & Frontend (SessionService.cs, SessionsList.tsx)

## Problem Statement

Looking at the sessions list page, sessions with only DOPE data show a dash (`-`) in the Ammunition column, even though DOPE entries can have ammunition associated with them. The Chrono sessions correctly display ammunition (e.g., "AAC 77g OTM" with "5.56" below), but DOPE-only sessions do not.

**Screenshot observation:**
- Chrono sessions: Show "AAC 77g OTM" / "5.56"
- DOPE sessions (7/13/2025, 5/25/2025): Show `-`

## Root Cause Analysis

**Current backend logic (SessionService.cs lines 107-110):**
```csharp
AmmunitionName = s.ChronoSession != null
    ? s.ChronoSession.Ammunition.Manufacturer + " " + s.ChronoSession.Ammunition.Name
    : s.DopeEntries
        .Where(d => d.Ammunition != null)
        .Select(d => d.Ammunition!.Manufacturer + " " + d.Ammunition!.Name)
        .FirstOrDefault(),
```

**Issues identified:**
1. The DOPE fallback logic exists but only works if DOPE entries have ammunition linked
2. DOPE entries have an **optional** `AmmunitionId` field - users may not be linking ammo when creating DOPE entries
3. Group entries also have optional ammunition but aren't included in the fallback chain
4. No UI encouragement to select ammunition when creating DOPE/Group entries

## Proposed Solution

### Phase 1: Session-Level Ammunition (Recommended)

Add optional `AmmunitionId` and `AmmoLotId` fields directly on the `RangeSession` entity. This allows users to specify the primary ammunition for a session once, rather than requiring it on every individual entry.

**Benefits:**
- Single place to set ammunition for the session
- Works for DOPE-only, Group-only, or mixed sessions
- Doesn't require changing existing DOPE/Group entry workflows
- Clear priority chain: Session > Chrono > DOPE > Groups

### Phase 2: Update Priority Chain

Update the backend to check ammunition in this order:
1. Session-level ammunition (new)
2. Chrono session ammunition (existing)
3. First DOPE entry with ammunition (existing)
4. First Group entry with ammunition (new)

## Files to Modify

### Backend Changes

| File | Changes |
|------|---------|
| `backend/src/TrueDope.Api/Data/Entities/RangeSession.cs` | Add `AmmunitionId`, `Ammunition`, `AmmoLotId`, `AmmoLot` properties |
| `backend/src/TrueDope.Api/Data/AppDbContext.cs` | Configure FK relationship with Restrict delete behavior |
| `backend/src/TrueDope.Api/DTOs/Sessions/SessionDtos.cs` | Add `ammunitionId`, `ammoLotId` to `CreateSessionDto` and `UpdateSessionDto` |
| `backend/src/TrueDope.Api/Services/SessionService.cs` | Update `AmmunitionName` projection logic, map new fields |
| New Migration | `dotnet ef migrations add AddSessionLevelAmmunition` |

### Frontend Changes

| File | Changes |
|------|---------|
| `frontend/src/types/sessions.ts` | Add `ammunitionId`, `ammoLotId` to create/update DTOs |
| `frontend/src/pages/sessions/SessionCreate.tsx` | Add ammunition dropdown to session creation form |
| `frontend/src/pages/sessions/SessionEdit.tsx` | Add ammunition dropdown to session edit form |

## Implementation Details

### 1. Entity Changes (RangeSession.cs)

```csharp
public class RangeSession
{
    // ... existing properties ...

    // Session-level ammunition (optional)
    public int? AmmunitionId { get; set; }
    public Ammunition? Ammunition { get; set; }

    public int? AmmoLotId { get; set; }
    public AmmoLot? AmmoLot { get; set; }
}
```

### 2. DbContext Configuration (AppDbContext.cs)

```csharp
modelBuilder.Entity<RangeSession>()
    .HasOne(rs => rs.Ammunition)
    .WithMany()
    .HasForeignKey(rs => rs.AmmunitionId)
    .OnDelete(DeleteBehavior.Restrict);

modelBuilder.Entity<RangeSession>()
    .HasOne(rs => rs.AmmoLot)
    .WithMany()
    .HasForeignKey(rs => rs.AmmoLotId)
    .OnDelete(DeleteBehavior.Restrict);
```

### 3. Updated AmmunitionName Logic (SessionService.cs)

```csharp
AmmunitionName =
    // 1. Session-level ammo (explicit user choice)
    s.Ammunition != null
        ? s.Ammunition.Manufacturer + " " + s.Ammunition.Name
    // 2. Chrono session ammo (required for chrono)
    : s.ChronoSession != null
        ? s.ChronoSession.Ammunition.Manufacturer + " " + s.ChronoSession.Ammunition.Name
    // 3. First DOPE entry with ammo
    : s.DopeEntries
        .Where(d => d.Ammunition != null)
        .Select(d => d.Ammunition!.Manufacturer + " " + d.Ammunition!.Name)
        .FirstOrDefault()
    // 4. First Group entry with ammo
    ?? s.GroupEntries
        .Where(g => g.Ammunition != null)
        .Select(g => g.Ammunition!.Manufacturer + " " + g.Ammunition!.Name)
        .FirstOrDefault(),
```

### 4. DTO Changes (SessionDtos.cs)

```csharp
public class CreateSessionDto
{
    // ... existing properties ...

    public int? AmmunitionId { get; set; }
    public int? AmmoLotId { get; set; }
}

public class UpdateSessionDto
{
    // ... existing properties ...

    public int? AmmunitionId { get; set; }
    public int? AmmoLotId { get; set; }
}
```

### 5. Frontend Type Changes (sessions.ts)

```typescript
export interface CreateSessionDto {
  // ... existing properties ...
  ammunitionId?: number;
  ammoLotId?: number;
}

export interface UpdateSessionDto {
  // ... existing properties ...
  ammunitionId?: number;
  ammoLotId?: number;
}
```

### 6. Session Form UI Changes

Add ammunition selector to SessionCreate.tsx and SessionEdit.tsx between Rifle and Location fields:

```tsx
<div className="space-y-1">
  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
    Ammunition (optional)
  </label>
  <Select
    value={formData.ammunitionId?.toString() || ''}
    onChange={(value) => setFormData(prev => ({
      ...prev,
      ammunitionId: value ? parseInt(value) : undefined
    }))}
    options={[
      { value: '', label: 'Select ammunition...' },
      ...ammunition.map(a => ({
        value: a.id.toString(),
        label: a.displayName
      }))
    ]}
    placeholder="Select ammunition..."
  />
  <p className="text-xs text-gray-500 dark:text-gray-400">
    Primary ammunition used in this session
  </p>
</div>
```

## Migration Script

```csharp
public partial class AddSessionLevelAmmunition : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<int>(
            name: "AmmunitionId",
            table: "RangeSessions",
            type: "integer",
            nullable: true);

        migrationBuilder.AddColumn<int>(
            name: "AmmoLotId",
            table: "RangeSessions",
            type: "integer",
            nullable: true);

        migrationBuilder.CreateIndex(
            name: "IX_RangeSessions_AmmunitionId",
            table: "RangeSessions",
            column: "AmmunitionId");

        migrationBuilder.CreateIndex(
            name: "IX_RangeSessions_AmmoLotId",
            table: "RangeSessions",
            column: "AmmoLotId");

        migrationBuilder.AddForeignKey(
            name: "FK_RangeSessions_Ammunition_AmmunitionId",
            table: "RangeSessions",
            column: "AmmunitionId",
            principalTable: "Ammunition",
            principalColumn: "Id",
            onDelete: ReferentialAction.Restrict);

        migrationBuilder.AddForeignKey(
            name: "FK_RangeSessions_AmmoLots_AmmoLotId",
            table: "RangeSessions",
            column: "AmmoLotId",
            principalTable: "AmmoLots",
            principalColumn: "Id",
            onDelete: ReferentialAction.Restrict);
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropForeignKey(
            name: "FK_RangeSessions_Ammunition_AmmunitionId",
            table: "RangeSessions");

        migrationBuilder.DropForeignKey(
            name: "FK_RangeSessions_AmmoLots_AmmoLotId",
            table: "RangeSessions");

        migrationBuilder.DropIndex(
            name: "IX_RangeSessions_AmmunitionId",
            table: "RangeSessions");

        migrationBuilder.DropIndex(
            name: "IX_RangeSessions_AmmoLotId",
            table: "RangeSessions");

        migrationBuilder.DropColumn(
            name: "AmmunitionId",
            table: "RangeSessions");

        migrationBuilder.DropColumn(
            name: "AmmoLotId",
            table: "RangeSessions");
    }
}
```

## Testing Checklist

### Backend Tests
- [ ] Migration runs successfully (up and down)
- [ ] Creating session with ammunitionId saves correctly
- [ ] Updating session ammunitionId works
- [ ] Session-level ammo appears in list DTO
- [ ] Priority chain: Session > Chrono > DOPE > Groups
- [ ] Null ammunition still returns null (no crash)
- [ ] Restrict delete prevents deleting ammunition with linked sessions

### Frontend Tests
- [ ] Session create form shows ammunition dropdown
- [ ] Session edit form shows ammunition dropdown
- [ ] Ammunition dropdown populated from user's ammo inventory
- [ ] Selecting ammunition saves with session
- [ ] Sessions list shows ammunition for DOPE-only sessions
- [ ] Sessions list shows ammunition for Group-only sessions
- [ ] Existing sessions without ammunition still work (shows `-`)

### Integration Tests
- [ ] Create DOPE-only session with session-level ammo -> shows in list
- [ ] Create Group-only session with session-level ammo -> shows in list
- [ ] Create mixed session (DOPE + Groups) with session-level ammo -> shows in list
- [ ] Edit existing DOPE session to add ammunition -> shows in list

## Alternative Approaches Considered

### Alternative A: Require Ammunition on DOPE/Group Entries
- Make `AmmunitionId` required on DopeEntry and GroupEntry
- **Rejected**: Breaking change, requires data migration, more friction for users

### Alternative B: Rifle-Level Default Ammunition
- Add default ammunition to RifleSetup
- Auto-populate sessions based on rifle's default
- **Rejected**: Users often shoot different ammo with same rifle, less flexible

### Alternative C: Improve Existing Fallback Only
- Just add GroupEntries to the fallback chain
- **Rejected**: Doesn't solve the root issue - entries may not have ammo linked

## Estimated Effort

| Task | Effort |
|------|--------|
| Backend entity + migration | 1 hour |
| Backend DTO + service changes | 1 hour |
| Frontend type changes | 30 min |
| Session create/edit form updates | 2 hours |
| Testing | 2 hours |
| **Total** | **6-7 hours** |

## Open Questions

1. **Should we backfill existing sessions?** Could offer a bulk edit or prompt users to update old DOPE sessions.

2. **Lot selection UI?** When ammunition is selected, should we show a secondary dropdown for lot selection? (Currently optional)

3. **Pre-fill from rifle?** Should we suggest the last ammunition used with this rifle as a default?
