# Phase 13.10: Settings Feature Implementation

**Created**: December 22, 2024
**Status**: Planning
**Parent**: [20251217.Phase13.iOSOverhaul.md](./20251217.Phase13.iOSOverhaul.md)

---

## Overview

Phase 13.10 implements the Settings feature for the TrueDope iOS app. This includes:
- **Profile Management**: View/edit user profile, change password
- **Locations Management**: CRUD for saved locations, browse/copy shared locations
- **About Screen**: App info, version, support links
- **Logout**: Already implemented in current SettingsView.swift

---

## Current State Analysis

### What Exists

| Component | Status | Notes |
|-----------|--------|-------|
| `SettingsView.swift` | Partial | Shell with placeholders, logout works |
| `ProfileViewModel.swift` | Complete | Full profile/preferences logic, needs views |
| `LocationsViewModel.swift` | Complete | CRUD, shared locations, pagination |
| `UserService.swift` | Complete | Profile API calls, preferences caching |
| `LocationService.swift` | Complete | All location endpoints |
| `User.swift` model | Complete | UserProfile, UpdateProfileRequest, ChangePasswordRequest |
| `UserPreferences.swift` model | Complete | All unit enums, theme |
| `SavedLocation.swift` model | Complete | LocationListItem, LocationDetail, CRUD requests |
| `SharedLocation.swift` model | Complete | SharedLocationListItem, CopyLocationResult |
| `AboutPlaceholderView` | Partial | Basic structure, needs polish |

### What Needs Implementation

| Component | Type | Priority |
|-----------|------|----------|
| `ProfileView.swift` | View | High |
| `ProfileEditView.swift` | View | High |
| `ChangePasswordView.swift` | View | High |
| `LocationsListView.swift` | View | High |
| `LocationDetailView.swift` | View | High |
| `LocationFormView.swift` | View | High |
| `SharedLocationsBrowserView.swift` | View | Medium |
| `SharedLocationDetailView.swift` | View | Medium |
| `AboutView.swift` | View | Low (polish existing) |
| Update `SettingsView.swift` | Refactor | High |

---

## File Structure

```
TrueDope-iOS/TrueDope-iOS/Features/Settings/
â”œâ”€â”€ SettingsView.swift                    # Main settings (update existing)
â”œâ”€â”€ ProfileView.swift                     # NEW: Profile display
â”œâ”€â”€ ProfileEditView.swift                 # NEW: Edit profile form
â”œâ”€â”€ ChangePasswordView.swift              # NEW: Password change form
â”œâ”€â”€ AboutView.swift                       # NEW: Replace placeholder
â”œâ”€â”€ Locations/
â”‚   â”œâ”€â”€ LocationsListView.swift           # NEW: My locations list
â”‚   â”œâ”€â”€ LocationDetailView.swift          # NEW: Location detail
â”‚   â”œâ”€â”€ LocationFormView.swift            # NEW: Create/edit location
â”‚   â”œâ”€â”€ SharedLocationsBrowserView.swift  # NEW: Browse shared locations
â”‚   â””â”€â”€ SharedLocationDetailView.swift    # NEW: Shared location detail
â””â”€â”€ Components/
    â”œâ”€â”€ LocationCard.swift                # NEW: Location list card
    â”œâ”€â”€ SharedLocationCard.swift          # NEW: Shared location card
    â””â”€â”€ CoordinateInputView.swift         # NEW: Lat/lon input with GPS
```

---

## Implementation Details

### 1. ProfileView.swift

**Purpose**: Display user profile information with navigation to edit and change password.

**UI Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Profile Header                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚Avatarâ”‚  John Doe                        â”‚
â”‚  â”‚ Icon â”‚  john@example.com                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Account Information                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  First Name          John              >   â”‚
â”‚  Last Name           Doe               >   â”‚
â”‚  Email               john@example.com      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Security                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Change Password                       >   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Account Details                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Member Since        Dec 15, 2024          â”‚
â”‚  Last Login          Dec 22, 2024 10:30 AM â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation**:
```swift
struct ProfileView: View {
    @StateObject private var viewModel = ProfileViewModel()
    @State private var showEditSheet = false
    @State private var showPasswordSheet = false

    var body: some View {
        List {
            // Profile header section
            Section {
                HStack(spacing: 16) {
                    // Avatar circle with initials or icon
                    Circle()
                        .fill(Color.accentColor.opacity(0.2))
                        .frame(width: 60, height: 60)
                        .overlay {
                            Text(viewModel.profile?.initials ?? "?")
                                .font(.title2)
                                .fontWeight(.semibold)
                                .foregroundColor(.accentColor)
                        }

                    VStack(alignment: .leading, spacing: 4) {
                        Text(viewModel.displayName)
                            .font(.title3)
                            .fontWeight(.semibold)
                        Text(viewModel.email)
                            .font(.subheadline)
                            .foregroundStyle(.secondary)
                    }
                }
                .padding(.vertical, 8)
            }

            // Account info section
            Section("Account Information") {
                NavigationLink {
                    ProfileEditView(viewModel: viewModel)
                } label: {
                    LabeledContent("First Name", value: viewModel.profile?.firstName ?? "Not set")
                }

                NavigationLink {
                    ProfileEditView(viewModel: viewModel)
                } label: {
                    LabeledContent("Last Name", value: viewModel.profile?.lastName ?? "Not set")
                }

                LabeledContent("Email", value: viewModel.email)
            }

            // Security section
            Section("Security") {
                NavigationLink {
                    ChangePasswordView(viewModel: viewModel)
                } label: {
                    Label("Change Password", systemImage: "lock")
                }
            }

            // Account details section
            Section("Account Details") {
                if let memberSince = viewModel.memberSince {
                    LabeledContent("Member Since", value: memberSince)
                }
                if let lastLogin = viewModel.lastLogin {
                    LabeledContent("Last Login", value: lastLogin)
                }
                if viewModel.isAdmin {
                    LabeledContent("Role", value: "Administrator")
                }
            }
        }
        .navigationTitle("Profile")
        .navigationBarTitleDisplayMode(.inline)
        .task {
            await viewModel.loadProfile()
        }
        .refreshable {
            await viewModel.loadProfile()
        }
        .overlay {
            if viewModel.isLoading && viewModel.profile == nil {
                ProgressView()
            }
        }
        .alert("Error", isPresented: .constant(viewModel.error != nil)) {
            Button("OK") { viewModel.clearError() }
        } message: {
            Text(viewModel.error ?? "")
        }
    }
}
```

**Add to User.swift model**:
```swift
extension UserProfile {
    /// User initials for avatar
    var initials: String {
        let first = firstName?.prefix(1) ?? ""
        let last = lastName?.prefix(1) ?? ""
        let combined = "\(first)\(last)"
        return combined.isEmpty ? "?" : combined.uppercased()
    }
}
```

---

### 2. ProfileEditView.swift

**Purpose**: Edit first name and last name with validation and save.

**UI Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Cancel]      Edit Profile       [Save]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  First Name                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ John                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                            â”‚
â”‚  Last Name                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Doe                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation**:
```swift
struct ProfileEditView: View {
    @ObservedObject var viewModel: ProfileViewModel
    @Environment(\.dismiss) private var dismiss

    @State private var firstName: String = ""
    @State private var lastName: String = ""

    private var hasChanges: Bool {
        firstName != (viewModel.profile?.firstName ?? "") ||
        lastName != (viewModel.profile?.lastName ?? "")
    }

    private var canSave: Bool {
        hasChanges && !viewModel.isSaving
    }

    var body: some View {
        Form {
            Section {
                TextField("First Name", text: $firstName)
                    .textContentType(.givenName)
                    .autocorrectionDisabled()

                TextField("Last Name", text: $lastName)
                    .textContentType(.familyName)
                    .autocorrectionDisabled()
            } footer: {
                Text("Your name is displayed throughout the app and may be visible to other users.")
            }
        }
        .navigationTitle("Edit Profile")
        .navigationBarTitleDisplayMode(.inline)
        .navigationBarBackButtonHidden(viewModel.isSaving)
        .toolbar {
            ToolbarItem(placement: .confirmationAction) {
                if viewModel.isSaving {
                    ProgressView()
                } else {
                    Button("Save") {
                        Task {
                            await saveProfile()
                        }
                    }
                    .disabled(!canSave)
                }
            }
        }
        .onAppear {
            firstName = viewModel.profile?.firstName ?? ""
            lastName = viewModel.profile?.lastName ?? ""
        }
        .alert("Error", isPresented: .constant(viewModel.error != nil)) {
            Button("OK") { viewModel.clearError() }
        } message: {
            Text(viewModel.error ?? "")
        }
        .onChange(of: viewModel.showSuccess) { _, showSuccess in
            if showSuccess {
                dismiss()
            }
        }
    }

    private func saveProfile() async {
        let result = await viewModel.updateName(
            firstName: firstName.isEmpty ? nil : firstName,
            lastName: lastName.isEmpty ? nil : lastName
        )
        if result != nil {
            dismiss()
        }
    }
}
```

---

### 3. ChangePasswordView.swift

**Purpose**: Change user password with current password verification.

**UI Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Change Password                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Current Password                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                      ðŸ‘   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                            â”‚
â”‚  New Password                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                      ðŸ‘   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  âœ“ At least 8 characters                   â”‚
â”‚  âœ“ Contains uppercase letter               â”‚
â”‚  âœ“ Contains lowercase letter               â”‚
â”‚  âœ“ Contains number                         â”‚
â”‚                                            â”‚
â”‚  Confirm New Password                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                      ðŸ‘   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  âœ“ Passwords match                         â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          Change Password           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation**:
```swift
struct ChangePasswordView: View {
    @ObservedObject var viewModel: ProfileViewModel
    @Environment(\.dismiss) private var dismiss

    @State private var currentPassword = ""
    @State private var newPassword = ""
    @State private var confirmPassword = ""
    @State private var showCurrentPassword = false
    @State private var showNewPassword = false
    @State private var showConfirmPassword = false

    // Validation
    private var hasMinLength: Bool { newPassword.count >= 8 }
    private var hasUppercase: Bool { newPassword.range(of: "[A-Z]", options: .regularExpression) != nil }
    private var hasLowercase: Bool { newPassword.range(of: "[a-z]", options: .regularExpression) != nil }
    private var hasNumber: Bool { newPassword.range(of: "[0-9]", options: .regularExpression) != nil }
    private var passwordsMatch: Bool { !confirmPassword.isEmpty && newPassword == confirmPassword }

    private var isValid: Bool {
        !currentPassword.isEmpty &&
        hasMinLength && hasUppercase && hasLowercase && hasNumber &&
        passwordsMatch
    }

    var body: some View {
        Form {
            Section {
                HStack {
                    Group {
                        if showCurrentPassword {
                            TextField("Current Password", text: $currentPassword)
                        } else {
                            SecureField("Current Password", text: $currentPassword)
                        }
                    }
                    .textContentType(.password)

                    Button {
                        showCurrentPassword.toggle()
                    } label: {
                        Image(systemName: showCurrentPassword ? "eye.slash" : "eye")
                            .foregroundColor(.secondary)
                    }
                    .buttonStyle(.plain)
                }
            } header: {
                Text("Current Password")
            }

            Section {
                HStack {
                    Group {
                        if showNewPassword {
                            TextField("New Password", text: $newPassword)
                        } else {
                            SecureField("New Password", text: $newPassword)
                        }
                    }
                    .textContentType(.newPassword)

                    Button {
                        showNewPassword.toggle()
                    } label: {
                        Image(systemName: showNewPassword ? "eye.slash" : "eye")
                            .foregroundColor(.secondary)
                    }
                    .buttonStyle(.plain)
                }

                // Password requirements
                VStack(alignment: .leading, spacing: 4) {
                    RequirementRow(text: "At least 8 characters", met: hasMinLength)
                    RequirementRow(text: "Contains uppercase letter", met: hasUppercase)
                    RequirementRow(text: "Contains lowercase letter", met: hasLowercase)
                    RequirementRow(text: "Contains number", met: hasNumber)
                }
                .font(.caption)
                .padding(.vertical, 4)
            } header: {
                Text("New Password")
            }

            Section {
                HStack {
                    Group {
                        if showConfirmPassword {
                            TextField("Confirm Password", text: $confirmPassword)
                        } else {
                            SecureField("Confirm Password", text: $confirmPassword)
                        }
                    }
                    .textContentType(.newPassword)

                    Button {
                        showConfirmPassword.toggle()
                    } label: {
                        Image(systemName: showConfirmPassword ? "eye.slash" : "eye")
                            .foregroundColor(.secondary)
                    }
                    .buttonStyle(.plain)
                }

                if !confirmPassword.isEmpty {
                    RequirementRow(text: "Passwords match", met: passwordsMatch)
                        .font(.caption)
                }
            } header: {
                Text("Confirm New Password")
            }

            Section {
                Button {
                    Task {
                        await changePassword()
                    }
                } label: {
                    HStack {
                        Spacer()
                        if viewModel.isChangingPassword {
                            ProgressView()
                        } else {
                            Text("Change Password")
                        }
                        Spacer()
                    }
                }
                .disabled(!isValid || viewModel.isChangingPassword)
            }
        }
        .navigationTitle("Change Password")
        .navigationBarTitleDisplayMode(.inline)
        .alert("Error", isPresented: .constant(viewModel.error != nil)) {
            Button("OK") { viewModel.clearError() }
        } message: {
            Text(viewModel.error ?? "")
        }
        .onChange(of: viewModel.showSuccess) { _, showSuccess in
            if showSuccess {
                dismiss()
            }
        }
    }

    private func changePassword() async {
        let request = ChangePasswordRequest(
            currentPassword: currentPassword,
            newPassword: newPassword,
            confirmNewPassword: confirmPassword
        )
        let success = await viewModel.changePassword(request)
        if success {
            dismiss()
        }
    }
}

// Helper view for password requirements
struct RequirementRow: View {
    let text: String
    let met: Bool

    var body: some View {
        HStack(spacing: 6) {
            Image(systemName: met ? "checkmark.circle.fill" : "circle")
                .foregroundColor(met ? .green : .secondary)
                .font(.caption)
            Text(text)
                .foregroundColor(met ? .primary : .secondary)
        }
    }
}
```

---

### 4. LocationsListView.swift

**Purpose**: Display user's saved locations with CRUD operations and navigation to shared locations.

**UI Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Locations                            [+]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ” Search locations...                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [My Locations]  [Shared Locations]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ðŸ“ Ben Avery Shooting Facility     â”‚    â”‚
â”‚  â”‚    33.7749Â°N 112.1234Â°W            â”‚    â”‚
â”‚  â”‚    1,234 ft â€¢ 12 sessions          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ðŸ“ Rio Salado Sportsmans Club      â”‚    â”‚
â”‚  â”‚    33.4567Â°N 111.9876Â°W            â”‚    â”‚
â”‚  â”‚    1,180 ft â€¢ 5 sessions           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                            â”‚
â”‚  [Empty State if no locations]             â”‚
â”‚  No saved locations yet.                   â”‚
â”‚  Tap + to add your first location.         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation**:
```swift
struct LocationsListView: View {
    @StateObject private var viewModel = LocationsViewModel()
    @State private var showCreateSheet = false
    @State private var locationToDelete: LocationListItem?

    var body: some View {
        List {
            // Tab picker
            Picker("Location Type", selection: $viewModel.selectedTab) {
                ForEach(LocationTab.allCases) { tab in
                    Text(tab.title).tag(tab)
                }
            }
            .pickerStyle(.segmented)
            .listRowBackground(Color.clear)
            .listRowInsets(EdgeInsets())
            .padding(.horizontal)
            .padding(.vertical, 8)

            // Content based on tab
            switch viewModel.selectedTab {
            case .myLocations:
                myLocationsContent
            case .sharedLocations:
                sharedLocationsContent
            }
        }
        .listStyle(.insetGrouped)
        .navigationTitle("Locations")
        .navigationBarTitleDisplayMode(.inline)
        .searchable(text: $viewModel.searchText, prompt: "Search locations...")
        .toolbar {
            ToolbarItem(placement: .primaryAction) {
                if viewModel.selectedTab == .myLocations {
                    Button {
                        showCreateSheet = true
                    } label: {
                        Image(systemName: "plus")
                    }
                }
            }
        }
        .sheet(isPresented: $showCreateSheet) {
            NavigationStack {
                LocationFormView(viewModel: viewModel, mode: .create)
            }
        }
        .task {
            await viewModel.loadLocations()
        }
        .refreshable {
            await viewModel.refresh()
        }
        .onChange(of: viewModel.selectedTab) { _, newTab in
            Task {
                await viewModel.switchTab(to: newTab)
            }
        }
        .alert("Delete Location", isPresented: .constant(locationToDelete != nil)) {
            Button("Cancel", role: .cancel) {
                locationToDelete = nil
            }
            Button("Delete", role: .destructive) {
                if let location = locationToDelete {
                    Task {
                        await viewModel.deleteLocation(id: location.id)
                    }
                }
                locationToDelete = nil
            }
        } message: {
            if let location = locationToDelete {
                if location.hasBeenUsed {
                    Text("'\(location.name)' has been used in \(location.sessionCount) session(s). Are you sure you want to delete it?")
                } else {
                    Text("Are you sure you want to delete '\(location.name)'?")
                }
            }
        }
        .alert("Error", isPresented: .constant(viewModel.error != nil)) {
            Button("OK") { viewModel.clearError() }
        } message: {
            Text(viewModel.error ?? "")
        }
    }

    // MARK: - My Locations Content

    @ViewBuilder
    private var myLocationsContent: some View {
        if viewModel.isLoading && viewModel.locations.isEmpty {
            Section {
                HStack {
                    Spacer()
                    ProgressView()
                    Spacer()
                }
            }
        } else if viewModel.filteredLocations.isEmpty {
            Section {
                ContentUnavailableView(
                    "No Locations",
                    systemImage: "mappin.slash",
                    description: Text(viewModel.searchText.isEmpty
                        ? "Tap + to add your first location"
                        : "No locations match your search")
                )
            }
        } else {
            Section {
                ForEach(viewModel.filteredLocations) { location in
                    NavigationLink {
                        LocationDetailView(
                            viewModel: viewModel,
                            locationId: location.id
                        )
                    } label: {
                        LocationCard(location: location)
                    }
                    .swipeActions(edge: .trailing, allowsFullSwipe: false) {
                        Button(role: .destructive) {
                            locationToDelete = location
                        } label: {
                            Label("Delete", systemImage: "trash")
                        }
                    }
                }

                // Load more
                if viewModel.hasMorePages {
                    HStack {
                        Spacer()
                        ProgressView()
                        Spacer()
                    }
                    .onAppear {
                        Task {
                            await viewModel.loadMore()
                        }
                    }
                }
            }
        }
    }

    // MARK: - Shared Locations Content

    @ViewBuilder
    private var sharedLocationsContent: some View {
        if viewModel.isLoading && viewModel.sharedLocations.isEmpty {
            Section {
                HStack {
                    Spacer()
                    ProgressView()
                    Spacer()
                }
            }
        } else if viewModel.filteredSharedLocations.isEmpty {
            Section {
                ContentUnavailableView(
                    "No Shared Locations",
                    systemImage: "mappin.slash",
                    description: Text(viewModel.searchText.isEmpty
                        ? "No shared locations available"
                        : "No locations match your search")
                )
            }
        } else {
            Section {
                ForEach(viewModel.filteredSharedLocations) { location in
                    NavigationLink {
                        SharedLocationDetailView(
                            viewModel: viewModel,
                            location: location
                        )
                    } label: {
                        SharedLocationCard(location: location)
                    }
                }
            }
        }
    }
}
```

---

### 5. LocationCard.swift

**Purpose**: Reusable card component for displaying a saved location in lists.

```swift
struct LocationCard: View {
    let location: LocationListItem

    var body: some View {
        VStack(alignment: .leading, spacing: 6) {
            HStack {
                Image(systemName: "mappin.circle.fill")
                    .foregroundColor(.accentColor)

                Text(location.name)
                    .font(.headline)
                    .lineLimit(1)
            }

            Text(location.formattedCoordinates)
                .font(.caption)
                .foregroundStyle(.secondary)
                .fontDesign(.monospaced)

            HStack(spacing: 12) {
                if let altitude = location.formattedAltitude {
                    Label(altitude, systemImage: "mountain.2")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }

                if location.sessionCount > 0 {
                    Label("\(location.sessionCount) session\(location.sessionCount == 1 ? "" : "s")",
                          systemImage: "list.bullet.clipboard")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
            }

            if let description = location.description, !description.isEmpty {
                Text(description)
                    .font(.caption)
                    .foregroundStyle(.tertiary)
                    .lineLimit(2)
            }
        }
        .padding(.vertical, 4)
    }
}
```

---

### 6. SharedLocationCard.swift

**Purpose**: Reusable card component for displaying a shared location.

```swift
struct SharedLocationCard: View {
    let location: SharedLocationListItem

    var body: some View {
        VStack(alignment: .leading, spacing: 6) {
            HStack {
                Image(systemName: "mappin.circle.fill")
                    .foregroundColor(.orange)

                Text(location.name)
                    .font(.headline)
                    .lineLimit(1)
            }

            if let shortLocation = location.shortLocationString {
                Text(shortLocation)
                    .font(.subheadline)
                    .foregroundStyle(.secondary)
            }

            Text(location.formattedCoordinates)
                .font(.caption)
                .foregroundStyle(.tertiary)
                .fontDesign(.monospaced)

            HStack(spacing: 12) {
                if let altitude = location.formattedAltitude {
                    Label(altitude, systemImage: "mountain.2")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }

                if location.hasWebsite {
                    Image(systemName: "globe")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }

                if location.hasPhone {
                    Image(systemName: "phone")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
            }
        }
        .padding(.vertical, 4)
    }
}
```

---

### 7. LocationDetailView.swift

**Purpose**: Display full location details with edit and delete options.

**UI Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Back]    Ben Avery          [Edit] [â€¢â€¢â€¢] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         [Map Preview]              â”‚    â”‚
â”‚  â”‚         ðŸ“                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location Details                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Coordinates     33.7749Â°N 112.1234Â°W      â”‚
â”‚  Altitude        1,234 ft                  â”‚
â”‚  Sessions        12                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Description                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Main shooting range with multiple bays.   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Actions                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Open in Maps                          >   â”‚
â”‚  Copy Coordinates                      >   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```swift
struct LocationDetailView: View {
    @ObservedObject var viewModel: LocationsViewModel
    let locationId: Int

    @Environment(\.dismiss) private var dismiss
    @State private var showEditSheet = false
    @State private var showDeleteConfirmation = false

    private var location: LocationDetail? {
        viewModel.selectedLocation
    }

    var body: some View {
        Group {
            if viewModel.isLoading && location == nil {
                ProgressView()
            } else if let location = location {
                locationContent(location)
            } else {
                ContentUnavailableView(
                    "Location Not Found",
                    systemImage: "mappin.slash",
                    description: Text("This location could not be loaded")
                )
            }
        }
        .navigationTitle(location?.name ?? "Location")
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .primaryAction) {
                Menu {
                    Button {
                        showEditSheet = true
                    } label: {
                        Label("Edit", systemImage: "pencil")
                    }

                    Divider()

                    Button(role: .destructive) {
                        showDeleteConfirmation = true
                    } label: {
                        Label("Delete", systemImage: "trash")
                    }
                } label: {
                    Image(systemName: "ellipsis.circle")
                }
            }
        }
        .task {
            await viewModel.selectLocation(id: locationId)
        }
        .sheet(isPresented: $showEditSheet) {
            if let location = location {
                NavigationStack {
                    LocationFormView(
                        viewModel: viewModel,
                        mode: .edit(location)
                    )
                }
            }
        }
        .alert("Delete Location", isPresented: $showDeleteConfirmation) {
            Button("Cancel", role: .cancel) {}
            Button("Delete", role: .destructive) {
                Task {
                    await viewModel.deleteLocation(id: locationId)
                    dismiss()
                }
            }
        } message: {
            Text("Are you sure you want to delete this location? This action cannot be undone.")
        }
    }

    @ViewBuilder
    private func locationContent(_ location: LocationDetail) -> some View {
        List {
            // Map preview section
            Section {
                MapPreviewView(
                    latitude: NSDecimalNumber(decimal: location.latitude).doubleValue,
                    longitude: NSDecimalNumber(decimal: location.longitude).doubleValue
                )
                .frame(height: 200)
                .listRowInsets(EdgeInsets())
            }

            // Details section
            Section("Location Details") {
                LabeledContent("Coordinates") {
                    Text(location.formattedCoordinates)
                        .fontDesign(.monospaced)
                        .font(.caption)
                }

                if let altitude = location.formattedAltitude {
                    LabeledContent("Altitude", value: altitude)
                }
            }

            // Description section
            if let description = location.description, !description.isEmpty {
                Section("Description") {
                    Text(description)
                        .font(.body)
                }
            }

            // Actions section
            Section("Actions") {
                Button {
                    openInMaps(location)
                } label: {
                    Label("Open in Maps", systemImage: "map")
                }

                Button {
                    copyCoordinates(location)
                } label: {
                    Label("Copy Coordinates", systemImage: "doc.on.doc")
                }
            }

            // Metadata section
            Section {
                LabeledContent("Created") {
                    Text(location.createdAt, style: .date)
                }
                LabeledContent("Updated") {
                    Text(location.updatedAt, style: .date)
                }
            }
        }
    }

    private func openInMaps(_ location: LocationDetail) {
        let lat = NSDecimalNumber(decimal: location.latitude).doubleValue
        let lon = NSDecimalNumber(decimal: location.longitude).doubleValue
        let url = URL(string: "maps://?ll=\(lat),\(lon)&q=\(location.name.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? "")")!
        UIApplication.shared.open(url)
    }

    private func copyCoordinates(_ location: LocationDetail) {
        UIPasteboard.general.string = location.formattedCoordinates
        // Could add haptic feedback here
    }
}

// Simple map preview using MapKit
import MapKit

struct MapPreviewView: View {
    let latitude: Double
    let longitude: Double

    var body: some View {
        Map(initialPosition: .region(MKCoordinateRegion(
            center: CLLocationCoordinate2D(latitude: latitude, longitude: longitude),
            span: MKCoordinateSpan(latitudeDelta: 0.05, longitudeDelta: 0.05)
        ))) {
            Marker("", coordinate: CLLocationCoordinate2D(latitude: latitude, longitude: longitude))
        }
        .mapStyle(.standard)
        .disabled(true) // Static preview
    }
}
```

---

### 8. LocationFormView.swift

**Purpose**: Create or edit a location with GPS capture support.

```swift
enum LocationFormMode {
    case create
    case edit(LocationDetail)

    var title: String {
        switch self {
        case .create: return "New Location"
        case .edit: return "Edit Location"
        }
    }

    var buttonTitle: String {
        switch self {
        case .create: return "Create"
        case .edit: return "Save"
        }
    }
}

struct LocationFormView: View {
    @ObservedObject var viewModel: LocationsViewModel
    let mode: LocationFormMode

    @Environment(\.dismiss) private var dismiss
    @StateObject private var locationManager = LocationManager()

    @State private var name = ""
    @State private var latitude = ""
    @State private var longitude = ""
    @State private var altitude = ""
    @State private var description = ""

    private var isValid: Bool {
        !name.trimmingCharacters(in: .whitespaces).isEmpty &&
        Double(latitude) != nil &&
        Double(longitude) != nil
    }

    var body: some View {
        Form {
            Section {
                TextField("Location Name", text: $name)
                    .autocorrectionDisabled()
            } header: {
                Text("Name")
            } footer: {
                Text("Give this location a memorable name")
            }

            Section {
                HStack {
                    VStack(alignment: .leading) {
                        TextField("Latitude", text: $latitude)
                            .keyboardType(.decimalPad)
                        TextField("Longitude", text: $longitude)
                            .keyboardType(.decimalPad)
                    }

                    Button {
                        useCurrentLocation()
                    } label: {
                        Image(systemName: "location.fill")
                            .font(.title2)
                    }
                    .buttonStyle(.bordered)
                    .disabled(locationManager.isLoading)
                }

                if locationManager.isLoading {
                    HStack {
                        ProgressView()
                        Text("Getting location...")
                            .foregroundStyle(.secondary)
                    }
                }

                if let error = locationManager.error {
                    Text(error)
                        .foregroundColor(.red)
                        .font(.caption)
                }
            } header: {
                Text("Coordinates")
            } footer: {
                Text("Enter coordinates manually or tap the location button to use GPS")
            }

            Section("Altitude (Optional)") {
                TextField("Altitude (feet)", text: $altitude)
                    .keyboardType(.numberPad)
            }

            Section("Description (Optional)") {
                TextField("Description", text: $description, axis: .vertical)
                    .lineLimit(3...6)
            }
        }
        .navigationTitle(mode.title)
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .cancellationAction) {
                Button("Cancel") {
                    dismiss()
                }
            }

            ToolbarItem(placement: .confirmationAction) {
                if viewModel.isSaving {
                    ProgressView()
                } else {
                    Button(mode.buttonTitle) {
                        Task {
                            await save()
                        }
                    }
                    .disabled(!isValid)
                }
            }
        }
        .onAppear {
            populateFields()
        }
        .alert("Error", isPresented: .constant(viewModel.error != nil)) {
            Button("OK") { viewModel.clearError() }
        } message: {
            Text(viewModel.error ?? "")
        }
    }

    private func populateFields() {
        switch mode {
        case .create:
            break
        case .edit(let location):
            name = location.name
            latitude = "\(location.latitude)"
            longitude = "\(location.longitude)"
            if let alt = location.altitude {
                altitude = "\(alt)"
            }
            description = location.description ?? ""
        }
    }

    private func useCurrentLocation() {
        locationManager.requestLocation { coordinate in
            latitude = String(format: "%.6f", coordinate.latitude)
            longitude = String(format: "%.6f", coordinate.longitude)
        }
    }

    private func save() async {
        guard let lat = Decimal(string: latitude),
              let lon = Decimal(string: longitude) else { return }

        let alt = altitude.isEmpty ? nil : Decimal(string: altitude)
        let desc = description.isEmpty ? nil : description

        switch mode {
        case .create:
            let request = CreateLocationRequest(
                name: name.trimmingCharacters(in: .whitespaces),
                latitude: lat,
                longitude: lon,
                altitude: alt,
                description: desc
            )
            let result = await viewModel.createLocation(request)
            if result != nil {
                dismiss()
            }

        case .edit(let location):
            let request = UpdateLocationRequest(
                name: name.trimmingCharacters(in: .whitespaces),
                latitude: lat,
                longitude: lon,
                altitude: alt,
                description: desc
            )
            let result = await viewModel.updateLocation(id: location.id, request)
            if result != nil {
                dismiss()
            }
        }
    }
}

// MARK: - Location Manager

import CoreLocation

@MainActor
class LocationManager: NSObject, ObservableObject, CLLocationManagerDelegate {
    private let manager = CLLocationManager()

    @Published var isLoading = false
    @Published var error: String?

    private var completion: ((CLLocationCoordinate2D) -> Void)?

    override init() {
        super.init()
        manager.delegate = self
        manager.desiredAccuracy = kCLLocationAccuracyBest
    }

    func requestLocation(completion: @escaping (CLLocationCoordinate2D) -> Void) {
        self.completion = completion
        isLoading = true
        error = nil

        switch manager.authorizationStatus {
        case .notDetermined:
            manager.requestWhenInUseAuthorization()
        case .authorizedWhenInUse, .authorizedAlways:
            manager.requestLocation()
        case .denied, .restricted:
            error = "Location access denied. Please enable in Settings."
            isLoading = false
        @unknown default:
            error = "Unknown location authorization status"
            isLoading = false
        }
    }

    nonisolated func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {
        Task { @MainActor in
            guard let location = locations.first else { return }
            isLoading = false
            completion?(location.coordinate)
            completion = nil
        }
    }

    nonisolated func locationManager(_ manager: CLLocationManager, didFailWithError error: Error) {
        Task { @MainActor in
            isLoading = false
            self.error = error.localizedDescription
            completion = nil
        }
    }

    nonisolated func locationManagerDidChangeAuthorization(_ manager: CLLocationManager) {
        Task { @MainActor in
            if manager.authorizationStatus == .authorizedWhenInUse ||
               manager.authorizationStatus == .authorizedAlways {
                if completion != nil {
                    manager.requestLocation()
                }
            }
        }
    }
}
```

---

### 9. SharedLocationDetailView.swift

**Purpose**: Display shared location details with copy-to-my-locations action.

```swift
struct SharedLocationDetailView: View {
    @ObservedObject var viewModel: LocationsViewModel
    let location: SharedLocationListItem

    @State private var showCopyConfirmation = false
    @State private var copiedSuccessfully = false

    var body: some View {
        List {
            // Map preview
            Section {
                MapPreviewView(
                    latitude: NSDecimalNumber(decimal: location.latitude).doubleValue,
                    longitude: NSDecimalNumber(decimal: location.longitude).doubleValue
                )
                .frame(height: 200)
                .listRowInsets(EdgeInsets())
            }

            // Location info
            Section("Location") {
                LabeledContent("Name", value: location.name)

                if let city = location.city {
                    LabeledContent("City", value: city)
                }
                if let state = location.state {
                    LabeledContent("State", value: state)
                }
                LabeledContent("Country", value: location.country)
            }

            // Coordinates
            Section("Coordinates") {
                LabeledContent("Position") {
                    Text(location.formattedCoordinates)
                        .fontDesign(.monospaced)
                        .font(.caption)
                }

                if let altitude = location.formattedAltitude {
                    LabeledContent("Altitude", value: altitude)
                }
            }

            // Contact info
            if location.hasWebsite || location.hasPhone {
                Section("Contact") {
                    if let website = location.website, !website.isEmpty {
                        Link(destination: URL(string: website)!) {
                            LabeledContent("Website") {
                                Text(website)
                                    .lineLimit(1)
                            }
                        }
                    }

                    if let phone = location.phoneNumber, !phone.isEmpty {
                        Link(destination: URL(string: "tel:\(phone)")!) {
                            LabeledContent("Phone", value: phone)
                        }
                    }
                }
            }

            // Description
            if let description = location.description, !description.isEmpty {
                Section("Description") {
                    Text(description)
                }
            }

            // Actions
            Section {
                Button {
                    showCopyConfirmation = true
                } label: {
                    HStack {
                        Label("Copy to My Locations", systemImage: "plus.circle")
                        Spacer()
                        if viewModel.isCopying {
                            ProgressView()
                        }
                    }
                }
                .disabled(viewModel.isCopying)

                Button {
                    openInMaps()
                } label: {
                    Label("Open in Maps", systemImage: "map")
                }
            }
        }
        .navigationTitle(location.name)
        .navigationBarTitleDisplayMode(.inline)
        .alert("Copy Location", isPresented: $showCopyConfirmation) {
            Button("Cancel", role: .cancel) {}
            Button("Copy") {
                Task {
                    await copyLocation()
                }
            }
        } message: {
            Text("Add '\(location.name)' to your saved locations?")
        }
        .alert("Location Copied", isPresented: $copiedSuccessfully) {
            Button("OK") {}
        } message: {
            Text("'\(location.name)' has been added to your saved locations.")
        }
        .alert("Error", isPresented: .constant(viewModel.error != nil)) {
            Button("OK") { viewModel.clearError() }
        } message: {
            Text(viewModel.error ?? "")
        }
    }

    private func copyLocation() async {
        let result = await viewModel.copySharedLocation(id: location.id)
        if result != nil {
            copiedSuccessfully = true
        }
    }

    private func openInMaps() {
        let lat = NSDecimalNumber(decimal: location.latitude).doubleValue
        let lon = NSDecimalNumber(decimal: location.longitude).doubleValue
        let url = URL(string: "maps://?ll=\(lat),\(lon)&q=\(location.name.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? "")")!
        UIApplication.shared.open(url)
    }
}
```

---

### 10. AboutView.swift

**Purpose**: App information, version, and support links.

```swift
struct AboutView: View {
    var body: some View {
        List {
            // App header
            Section {
                VStack(spacing: 16) {
                    Image(systemName: "scope")
                        .font(.system(size: 60))
                        .foregroundColor(.accentColor)

                    Text("TrueDope")
                        .font(.title)
                        .fontWeight(.bold)

                    Text("Precision Shooting Data Logger")
                        .font(.subheadline)
                        .foregroundStyle(.secondary)

                    Text("Version \(Config.fullVersion)")
                        .font(.caption)
                        .foregroundStyle(.tertiary)
                        .padding(.top, 4)
                }
                .frame(maxWidth: .infinity)
                .padding(.vertical, 24)
            }

            // Links
            Section("Links") {
                Link(destination: URL(string: "https://truedope.io")!) {
                    Label("Website", systemImage: "globe")
                }

                Link(destination: URL(string: "https://truedope.io/privacy")!) {
                    Label("Privacy Policy", systemImage: "hand.raised")
                }

                Link(destination: URL(string: "https://truedope.io/terms")!) {
                    Label("Terms of Service", systemImage: "doc.text")
                }
            }

            // Support
            Section("Support") {
                Link(destination: URL(string: "mailto:support@truedope.io")!) {
                    Label("Contact Support", systemImage: "envelope")
                }

                Link(destination: URL(string: "https://truedope.io/faq")!) {
                    Label("FAQ", systemImage: "questionmark.circle")
                }
            }

            // Technical info
            Section("Technical") {
                LabeledContent("App Version", value: Config.appVersion)
                LabeledContent("Build", value: Config.buildNumber)
                LabeledContent("API Version", value: "v2")

                #if DEBUG
                LabeledContent("Environment", value: Config.environment.rawValue)
                LabeledContent("API URL", value: Config.apiBaseURL)
                #endif
            }

            // Copyright
            Section {
                Text("2024 TrueDope. All rights reserved.")
                    .font(.caption)
                    .foregroundStyle(.tertiary)
                    .frame(maxWidth: .infinity, alignment: .center)
            }
        }
        .navigationTitle("About")
        .navigationBarTitleDisplayMode(.inline)
    }
}
```

---

### 11. Updated SettingsView.swift

Replace the placeholder views with navigation to the real views:

```swift
import SwiftUI

struct SettingsView: View {
    @EnvironmentObject var appState: AppState
    @State private var showLogoutConfirmation = false
    @State private var isLoggingOut = false

    var body: some View {
        NavigationStack {
            List {
                // Profile Section
                Section {
                    NavigationLink {
                        ProfileView()
                    } label: {
                        HStack(spacing: 12) {
                            Circle()
                                .fill(Color.accentColor.opacity(0.2))
                                .frame(width: 50, height: 50)
                                .overlay {
                                    if let user = appState.currentUser {
                                        Text(user.initials)
                                            .font(.headline)
                                            .foregroundColor(.accentColor)
                                    } else {
                                        Image(systemName: "person.fill")
                                            .foregroundColor(.accentColor)
                                    }
                                }

                            VStack(alignment: .leading) {
                                if let user = appState.currentUser {
                                    Text(user.displayName)
                                        .font(.headline)
                                    Text(user.email)
                                        .font(.caption)
                                        .foregroundStyle(.secondary)
                                } else {
                                    Text("Profile")
                                        .font(.headline)
                                    Text("View and edit your profile")
                                        .font(.caption)
                                        .foregroundStyle(.secondary)
                                }
                            }
                        }
                        .padding(.vertical, 4)
                    }
                }

                // Preferences Section (Phase 13.11)
                Section("Preferences") {
                    NavigationLink {
                        PreferencesPlaceholderView()
                    } label: {
                        Label("Units & Display", systemImage: "ruler")
                    }
                }

                // Data Section
                Section("Data") {
                    NavigationLink {
                        LocationsListView()
                    } label: {
                        Label("Saved Locations", systemImage: "mappin.and.ellipse")
                    }

                    NavigationLink {
                        AmmunitionPlaceholderView()
                    } label: {
                        Label("Ammunition", systemImage: "cylinder")
                    }
                }

                // About Section
                Section("About") {
                    NavigationLink {
                        AboutView()
                    } label: {
                        Label("About TrueDope", systemImage: "info.circle")
                    }

                    HStack {
                        Label("Version", systemImage: "number")
                        Spacer()
                        Text(Config.fullVersion)
                            .foregroundStyle(.secondary)
                    }
                }

                // Logout Section
                Section {
                    Button(role: .destructive) {
                        showLogoutConfirmation = true
                    } label: {
                        HStack {
                            Label("Sign Out", systemImage: "rectangle.portrait.and.arrow.right")
                            if isLoggingOut {
                                Spacer()
                                ProgressView()
                            }
                        }
                    }
                    .disabled(isLoggingOut)
                }
            }
            .navigationTitle("Settings")
            .alert("Sign Out", isPresented: $showLogoutConfirmation) {
                Button("Cancel", role: .cancel) {}
                Button("Sign Out", role: .destructive) {
                    performLogout()
                }
            } message: {
                Text("Are you sure you want to sign out?")
            }
        }
    }

    private func performLogout() {
        isLoggingOut = true
        Task {
            await AuthService.shared.logout()
            await MainActor.run {
                isLoggingOut = false
                appState.didLogout()
            }
        }
    }
}

// Keep placeholders for features not in this phase
struct PreferencesPlaceholderView: View {
    var body: some View {
        ContentUnavailableView(
            "Preferences",
            systemImage: "slider.horizontal.3",
            description: Text("Unit preferences will be implemented in Phase 13.11")
        )
        .navigationTitle("Preferences")
        .navigationBarTitleDisplayMode(.inline)
    }
}

struct AmmunitionPlaceholderView: View {
    var body: some View {
        ContentUnavailableView(
            "Ammunition",
            systemImage: "cylinder",
            description: Text("Ammunition management is available in the Rifles tab")
        )
        .navigationTitle("Ammunition")
        .navigationBarTitleDisplayMode(.inline)
    }
}
```

---

## Model Updates Required

### Add to User.swift

```swift
extension UserProfile {
    /// User initials for avatar display
    var initials: String {
        let first = firstName?.prefix(1) ?? ""
        let last = lastName?.prefix(1) ?? ""
        let combined = "\(first)\(last)"
        return combined.isEmpty ? "?" : combined.uppercased()
    }
}
```

### Add to Config.swift (if not present)

```swift
extension Config {
    /// App version string
    static var appVersion: String {
        Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0"
    }

    /// Build number
    static var buildNumber: String {
        Bundle.main.infoDictionary?["CFBundleVersion"] as? String ?? "1"
    }

    /// Full version string
    static var fullVersion: String {
        "\(appVersion) (\(buildNumber))"
    }
}
```

---

## Implementation Checklist

### Phase 13.10.1: Profile Feature
- [ ] Add `initials` computed property to `UserProfile`
- [ ] Create `ProfileView.swift`
- [ ] Create `ProfileEditView.swift`
- [ ] Create `ChangePasswordView.swift` with `RequirementRow` component
- [ ] Update `SettingsView.swift` to use `ProfileView`
- [ ] Test profile loading, editing, and password change

### Phase 13.10.2: Locations Feature
- [ ] Create `Features/Settings/Locations/` directory
- [ ] Create `LocationCard.swift`
- [ ] Create `SharedLocationCard.swift`
- [ ] Create `LocationsListView.swift`
- [ ] Create `LocationDetailView.swift` with `MapPreviewView`
- [ ] Create `LocationFormView.swift` with `LocationManager`
- [ ] Create `SharedLocationDetailView.swift`
- [ ] Update `SettingsView.swift` to use `LocationsListView`
- [ ] Test CRUD operations for locations
- [ ] Test shared locations browsing and copying
- [ ] Test GPS location capture

### Phase 13.10.3: About & Polish
- [ ] Create `AboutView.swift` (replace placeholder)
- [ ] Add version info to `Config.swift` if missing
- [ ] Update `SettingsView.swift` to use `AboutView`
- [ ] Remove unused placeholder views
- [ ] Test all navigation flows
- [ ] Verify dark mode appearance
- [ ] Test accessibility (VoiceOver)

---

## API Endpoints Used

| Feature | Endpoint | Method |
|---------|----------|--------|
| Get Profile | `/api/users/me` | GET |
| Update Profile | `/api/users/me` | PUT |
| Change Password | `/api/users/me/password` | PUT |
| List Locations | `/api/locations` | GET |
| Get Location | `/api/locations/{id}` | GET |
| Create Location | `/api/locations` | POST |
| Update Location | `/api/locations/{id}` | PUT |
| Delete Location | `/api/locations/{id}` | DELETE |
| List Shared Locations | `/api/shared-locations` | GET |
| Copy Shared Location | `/api/shared-locations/{id}/copy` | POST |

---

## Dependencies

### Existing (no changes needed)
- `ProfileViewModel.swift` - Complete
- `LocationsViewModel.swift` - Complete
- `UserService.swift` - Complete
- `LocationService.swift` - Complete
- All model files - Complete

### New iOS Frameworks
- `MapKit` - For map preview in location detail
- `CoreLocation` - For GPS location capture

---

## Testing Requirements

### Unit Tests
- [ ] `ProfileViewModelTests` - Already exists, verify coverage
- [ ] `LocationsViewModelTests` - Create if not exists
- [ ] `LocationManagerTests` - Test authorization and location fetching

### Manual Testing
- [ ] Profile view loads correctly
- [ ] Profile edit saves changes
- [ ] Password change with validation works
- [ ] Locations list with pagination
- [ ] Location create with GPS
- [ ] Location edit flow
- [ ] Location delete with confirmation
- [ ] Shared locations browsing
- [ ] Copy shared location to my locations
- [ ] Map preview displays correctly
- [ ] Open in Maps works
- [ ] Dark mode appearance
- [ ] Error handling for all API failures

---

## Success Criteria

- [ ] User can view and edit their profile (name)
- [ ] User can change their password with proper validation
- [ ] User can view their saved locations list
- [ ] User can create new locations (manual or GPS)
- [ ] User can edit existing locations
- [ ] User can delete locations (with warning if used in sessions)
- [ ] User can browse shared locations
- [ ] User can copy shared locations to their saved locations
- [ ] User can view About screen with app info
- [ ] All error states handled gracefully
- [ ] Loading states shown appropriately
- [ ] Navigation flows work correctly
- [ ] Dark mode displays properly

---

## Notes

1. **Preferences (Phase 13.11)**: The PreferencesView is NOT part of this phase. Keep the placeholder for now.

2. **Ammunition in Settings**: The Ammunition navigation in Settings can link to the Ammunition feature from Phase 13.7 (if completed) or remain a placeholder directing users to the Rifles tab.

3. **Map Preview**: Uses native MapKit. The map is non-interactive (disabled) - just a static preview. Users can tap "Open in Maps" for full functionality.

4. **GPS Permissions**: The app needs `NSLocationWhenInUseUsageDescription` in Info.plist. This should already exist from session creation GPS support.

5. **Error Handling**: All views should handle loading, error, and empty states consistently using the patterns established in other features.

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-22 | Initial Phase 13.10 specification created |
