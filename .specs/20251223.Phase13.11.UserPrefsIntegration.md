# Phase 13.11: User Preferences Integration

**Created**: December 23, 2024
**Status**: Complete
**Parent**: [20251217.Phase13.iOSOverhaul.md](./20251217.Phase13.iOSOverhaul.md)

---

## Overview

Implement user preferences throughout the iOS app, allowing users to customize display units and app theme. This phase focuses on creating the PreferencesView UI and wiring preferences to all display components.

### Scope

| Preference | Options | Implementation |
|------------|---------|----------------|
| **Distance** | Yards / Meters | Full conversion support |
| **Adjustments** | MIL / MOA | Primary/secondary swap (both always shown) |
| **Temperature** | °F / °C | Full conversion support |
| **Pressure** | inHg / hPa | Full conversion support |
| **Theme** | System / Light / Dark | Color scheme override |

### Out of Scope (Keep Current Behavior)

| Item | Current | Reason |
|------|---------|--------|
| Velocity | fps only | Limited international demand |
| Density Altitude | feet only | Standard in ballistics |
| Wind Speed | mph only | Simplify scope |

---

## Current State Analysis

### Infrastructure (Already Complete)

| Component | Location | Status |
|-----------|----------|--------|
| `UserPreferences` model | `Models/UserPreferences.swift` | Complete - all enums defined |
| `UserService` | `Core/Services/UserService.swift` | Complete - CRUD, caching, format methods |
| `ProfileViewModel` | `ViewModels/ProfileViewModel.swift` | Complete - loads/updates preferences |
| API endpoints | `Core/Network/APIEndpoints.swift` | Complete |

### UserService Format Methods (Lines 178-238)

```swift
func formatDistance(_ yards: Int) -> String
func formatTemperature(_ fahrenheit: Decimal) -> String
func formatPressure(_ inHg: Decimal) -> String
func formatVelocity(_ fps: Decimal) -> String  // Keep but won't use conversion
func formatAdjustment(_ mils: Decimal, isElevation: Bool) -> String
```

### Views Requiring Updates

| View | File | Hardcoded Values |
|------|------|------------------|
| `ConditionsSection` | `Features/Sessions/Components/ConditionsSection.swift` | Temperature (°F), Pressure (inHg) |
| `ConditionsBadge` | Same file | Temperature (°F) |
| `DopeEntryRow` | `Features/Sessions/Components/DopeEntryRow.swift` | Distance (yd), shows both MIL/MOA |
| `DopeEntryCompactRow` | Same file | Distance (yd) |
| `GroupEntryRow` | `Features/Sessions/Components/GroupEntryRow.swift` | Distance (yd) |
| `GroupEntryCompactRow` | Same file | Distance (yd) |
| `SessionDetailView` | `Features/Sessions/SessionDetailView.swift` | Distance in delete confirmation |

---

## Architecture

### Preference Distribution Strategy

Use `@EnvironmentObject` pattern to distribute preferences throughout the view hierarchy:

```
TrueDope_iOSApp
└── AppState (@Published preferences: UserPreferences)
    └── MainTabView
        └── .environmentObject(appState)
            └── All child views have access via @EnvironmentObject
```

**Benefits:**
- Single source of truth
- Automatic view updates when preferences change
- No prop drilling
- Clean, SwiftUI-native approach

### AppState Changes

Add to `AppState.swift`:

```swift
/// User display preferences
@Published var preferences: UserPreferences = .default

/// Load preferences on authentication
func loadPreferences() async {
    do {
        preferences = try await UserService.shared.getPreferences()
    } catch {
        // Keep defaults on error
    }
}

/// Update a preference and sync to server
func updatePreference<T>(_ keyPath: WritableKeyPath<UserPreferences, T>, to value: T) async {
    preferences[keyPath: keyPath] = value
    // Sync to server...
}
```

### Theme Application

Apply theme at app root using `preferredColorScheme`:

```swift
@main
struct TrueDope_iOSApp: App {
    @StateObject private var appState = AppState.shared

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(appState)
                .preferredColorScheme(appState.colorScheme)
        }
    }
}

// In AppState
var colorScheme: ColorScheme? {
    switch preferences.theme {
    case .system: return nil
    case .light: return .light
    case .dark: return .dark
    }
}
```

---

## Implementation Tasks

### Task 1: Create UnitFormatter Utility

Create a dedicated utility for consistent unit formatting across the app.

**File**: `TrueDope-iOS/TrueDope-iOS/Core/Utilities/UnitFormatter.swift`

```swift
import Foundation

/// Centralized unit formatting based on user preferences
struct UnitFormatter {
    let preferences: UserPreferences

    // MARK: - Distance

    func formatDistance(_ yards: Int) -> String {
        switch preferences.distanceUnit {
        case .yards:
            return "\(yards) yd"
        case .meters:
            let meters = Int(Double(yards) * 0.9144)
            return "\(meters) m"
        }
    }

    func distanceAbbreviation() -> String {
        preferences.distanceUnit.abbreviation
    }

    // MARK: - Temperature

    func formatTemperature(_ fahrenheit: Decimal) -> String {
        let f = NSDecimalNumber(decimal: fahrenheit).doubleValue
        switch preferences.temperatureUnit {
        case .fahrenheit:
            return String(format: "%.0f°F", f)
        case .celsius:
            let c = (f - 32) * 5 / 9
            return String(format: "%.0f°C", c)
        }
    }

    // MARK: - Pressure

    func formatPressure(_ inHg: Decimal) -> String {
        let p = NSDecimalNumber(decimal: inHg).doubleValue
        switch preferences.pressureUnit {
        case .inhg:
            return String(format: "%.2f inHg", p)
        case .hpa:
            let hpa = p * 33.8639
            return String(format: "%.0f hPa", hpa)
        }
    }

    // MARK: - Adjustments (MIL/MOA)

    /// Format adjustment value in user's preferred unit
    /// Returns (primaryValue, secondaryValue) tuple
    func formatAdjustmentPair(
        mils: Decimal,
        moa: Decimal?,
        isElevation: Bool
    ) -> (primary: String, secondary: String?) {
        let milValue = NSDecimalNumber(decimal: mils).doubleValue
        let moaValue = moa.map { NSDecimalNumber(decimal: $0).doubleValue }

        let milFormatted = formatMilValue(milValue, isElevation: isElevation)
        let moaFormatted = moaValue.map { formatMoaValue($0, isElevation: isElevation) }

        switch preferences.adjustmentUnit {
        case .mil:
            return (milFormatted, moaFormatted)
        case .moa:
            // Swap: MOA is primary, MIL is secondary
            return (moaFormatted ?? formatMoaFromMil(milValue, isElevation: isElevation), milFormatted)
        }
    }

    private func formatMilValue(_ value: Double, isElevation: Bool) -> String {
        let sign = value >= 0 ? (isElevation ? "+" : "R ") : (isElevation ? "" : "L ")
        return String(format: "%@%.1f MIL", sign, isElevation ? value : abs(value))
    }

    private func formatMoaValue(_ value: Double, isElevation: Bool) -> String {
        let sign = value >= 0 ? (isElevation ? "+" : "R ") : (isElevation ? "" : "L ")
        return String(format: "%@%.1f MOA", sign, isElevation ? value : abs(value))
    }

    private func formatMoaFromMil(_ milValue: Double, isElevation: Bool) -> String {
        let moa = milValue * 3.438
        return formatMoaValue(moa, isElevation: isElevation)
    }
}
```

### Task 2: Update AppState

**File**: `TrueDope-iOS/TrueDope-iOS/App/AppState.swift`

Add:
- `@Published var preferences: UserPreferences = .default`
- `var colorScheme: ColorScheme?` computed property
- `loadPreferences()` async method
- `updatePreferences()` method for individual updates
- Call `loadPreferences()` after successful login

### Task 3: Create PreferencesView

**File**: `TrueDope-iOS/TrueDope-iOS/Features/Settings/PreferencesView.swift`

UI Structure:
```
NavigationStack
└── List
    ├── Section "Units"
    │   ├── Picker: Distance (Yards / Meters)
    │   ├── Picker: Adjustments (MIL / MOA)
    │   ├── Picker: Temperature (°F / °C)
    │   └── Picker: Pressure (inHg / hPa)
    │
    ├── Section "Appearance"
    │   └── Picker: Theme (System / Light / Dark)
    │
    └── Section "Preview" (optional)
        └── Sample formatted values showing current settings
```

Features:
- Segmented picker style for binary choices
- Instant save on change (no save button needed)
- Loading indicator during save
- Error handling with retry
- Preview section showing formatted examples

### Task 4: Update TrueDope_iOSApp Entry Point

**File**: `TrueDope-iOS/TrueDope-iOS/App/TrueDope_iOSApp.swift`

- Apply `.preferredColorScheme(appState.colorScheme)` to root view
- Ensure `appState` is passed as environment object

### Task 5: Update SettingsView

**File**: `TrueDope-iOS/TrueDope-iOS/Features/Settings/SettingsView.swift`

- Replace `PreferencesPlaceholderView()` with `PreferencesView()`
- Remove the placeholder struct

### Task 6: Update Display Components

#### 6a. ConditionsSection.swift

Replace hardcoded:
- `"\(Int(...))°F"` → `formatter.formatTemperature(temp)`
- `"%.2f inHg"` → `formatter.formatPressure(pressure)`

Keep unchanged:
- Wind speed (mph)
- Density altitude (ft)
- Humidity (%)

#### 6b. DopeEntryRow.swift & DopeEntryCompactRow.swift

Replace:
- `"\(entry.distance) yd"` → `formatter.formatDistance(entry.distance)`
- `"yd"` → `formatter.distanceAbbreviation()`

Update adjustment display:
- Use `formatter.formatAdjustmentPair()` to determine primary/secondary
- Swap which value is prominent based on preference

#### 6c. GroupEntryRow.swift & GroupEntryCompactRow.swift

Replace:
- `"\(entry.distance) yd"` → `formatter.formatDistance(entry.distance)`

#### 6d. SessionDetailView.swift

Update delete confirmation text:
- `"Delete the \(entry.distance) yd DOPE entry?"` → Use formatter

### Task 7: Create UnitFormatter Environment Key (Optional Enhancement)

For cleaner access in views:

```swift
struct UnitFormatterKey: EnvironmentKey {
    static let defaultValue = UnitFormatter(preferences: .default)
}

extension EnvironmentValues {
    var unitFormatter: UnitFormatter {
        get { self[UnitFormatterKey.self] }
        set { self[UnitFormatterKey.self] = newValue }
    }
}

// Usage in views:
@Environment(\.unitFormatter) var formatter
```

### Task 8: Write Unit Tests

**File**: `TrueDope-iOS/TrueDope-iOSTests/Utilities/UnitFormatterTests.swift`

Test cases:
- Distance conversion (yards to meters and back)
- Temperature conversion (°F to °C)
- Pressure conversion (inHg to hPa)
- Adjustment formatting (MIL primary vs MOA primary)
- Edge cases (zero values, negative windage, large distances)

---

## UI Design: PreferencesView

```
┌─────────────────────────────────────────────────┐
│ ←  Preferences                                  │
├─────────────────────────────────────────────────┤
│                                                 │
│ UNITS                                           │
│ ┌─────────────────────────────────────────────┐ │
│ │ Distance         [Yards] [Meters]           │ │
│ ├─────────────────────────────────────────────┤ │
│ │ Adjustments      [MIL] [MOA]                │ │
│ ├─────────────────────────────────────────────┤ │
│ │ Temperature      [°F] [°C]                  │ │
│ ├─────────────────────────────────────────────┤ │
│ │ Pressure         [inHg] [hPa]               │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ APPEARANCE                                      │
│ ┌─────────────────────────────────────────────┐ │
│ │ Theme            [System] [Light] [Dark]    │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ PREVIEW                                         │
│ ┌─────────────────────────────────────────────┐ │
│ │ 400 yd  →  366 m                            │ │
│ │ 72°F    →  22°C                             │ │
│ │ 29.92 inHg → 1013 hPa                       │ │
│ │ +2.5 MIL  (8.6 MOA)                         │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## Implementation Order

1. **UnitFormatter utility** - Foundation for all formatting
2. **AppState updates** - Add preferences property and theme support
3. **TrueDope_iOSApp** - Wire up color scheme
4. **PreferencesView** - User-facing settings UI
5. **SettingsView** - Replace placeholder
6. **Display components** - Update all views to use formatter
7. **Unit tests** - Verify conversions

---

## Testing Checklist

### Manual Testing

- [ ] PreferencesView loads current preferences
- [ ] Changing a preference saves immediately
- [ ] Theme changes apply instantly to entire app
- [ ] Distance displays update throughout app when changed
- [ ] Temperature displays update in conditions sections
- [ ] Pressure displays update in conditions sections
- [ ] DOPE entries show correct primary/secondary adjustment
- [ ] Group entries show correct distance unit
- [ ] Delete confirmations show correct units
- [ ] Preferences persist after app restart
- [ ] Preferences sync correctly with backend

### Unit Tests

- [ ] UnitFormatterTests - all conversion methods
- [ ] Edge cases: zero, negative, large values
- [ ] Adjustment pair formatting for both MIL and MOA primary

---

## Rollback Plan

If issues arise:
1. Revert AppState changes (remove preferences property)
2. Keep PreferencesView but disconnect saves
3. Views fall back to hardcoded values (no crashes)

---

## Success Criteria

- [ ] Users can change all 5 preference settings
- [ ] Theme applies immediately and persists
- [ ] All distance values in app respect distance preference
- [ ] All temperature values respect temperature preference
- [ ] All pressure values respect pressure preference
- [ ] Adjustment display swaps primary/secondary based on preference
- [ ] Preferences sync to backend API
- [ ] Unit tests pass for all conversions

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-23 | Initial Phase 13.11 specification created |
| 2024-12-23 | Implementation complete - all tasks finished |
