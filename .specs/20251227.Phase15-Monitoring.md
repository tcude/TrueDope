# Phase 15: Monitoring and Observability with Grafana

**Date:** 2025-12-27
**Status:** In Progress (Phase 15a complete)
**Goal:** Add comprehensive application and infrastructure monitoring to TrueDope using Prometheus metrics, visualized in the existing Grafana instance on `monitoring01.tcudelocal.net`.

---

## Environment Strategy

**Single Docker Compose File:** Prometheus and exporters run in all environments, configured via `.env` variables. This keeps deployment simple while allowing environment-specific tuning.

| Environment | Retention | Grafana | Notes |
|-------------|-----------|---------|-------|
| **Development** | 30 days, 10GB | Not connected | Data stays local, useful for debugging |
| **Production** | 365 days, 50GB | Connected to `docker-external01:9090` | Long-term metrics storage |

**Configuration via `.env`:**
```bash
# Dev defaults (in .env.example)
PROMETHEUS_RETENTION_TIME=30d
PROMETHEUS_RETENTION_SIZE=10GB

# Prod settings (set in prod .env)
PROMETHEUS_RETENTION_TIME=365d
PROMETHEUS_RETENTION_SIZE=50GB
```

The monitoring stack overhead is minimal, and having Prometheus locally can help debug performance issues during development.

---

## Overview

### Current State
- **Logging:** Structured file logging with Splunk integration (see `20251227.AddingLogging.md`)
- **Monitoring:** Grafana + InfluxDB running on `monitoring01.tcudelocal.net:3000`
- **Gap:** No application metrics, no visibility into request rates, latencies, or error rates

### Target State
- Prometheus metrics exposed from TrueDope backend
- Infrastructure exporters for PostgreSQL, Redis, and Docker
- Grafana dashboards showing application health, performance, and business metrics
- Long-term metric retention (1+ year)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│  docker-external01 (TrueDope host)                                  │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │  TrueDope       │  │  PostgreSQL     │  │  Redis          │      │
│  │  Backend        │  │                 │  │                 │      │
│  │  :80/metrics    │  │  :5432          │  │  :6379          │      │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘      │
│           │                    │                    │               │
│           │           ┌────────┴────────┐  ┌───────┴────────┐       │
│           │           │ postgres-       │  │ redis-         │       │
│           │           │ exporter :9187  │  │ exporter :9121 │       │
│           │           └────────┬────────┘  └───────┬────────┘       │
│           │                    │                   │                │
│  ┌────────┴────────────────────┴───────────────────┴───────────┐    │
│  │                     Prometheus :9090                         │    │
│  │                     (scrapes all targets)                    │    │
│  └──────────────────────────────┬──────────────────────────────┘    │
│                                 │                                   │
└─────────────────────────────────┼───────────────────────────────────┘
                                  │ :9090 exposed
                                  │
┌─────────────────────────────────┼───────────────────────────────────┐
│  monitoring01.tcudelocal.net    │                                   │
│                                 ▼                                   │
│  ┌─────────────────┐    ┌─────────────────┐                         │
│  │    Grafana      │◄───│   InfluxDB      │ (existing, for infra)   │
│  │    :3000        │    │   :8086         │                         │
│  │                 │◄─────────────────────┘                         │
│  │                 │◄─── Prometheus data source                     │
│  └─────────────────┘     (docker-external01:9090)                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Implementation Phases

### Phase 15a: Backend Prometheus Metrics
Add native .NET metrics to the TrueDope backend.

### Phase 15b: Prometheus + Exporters
Deploy Prometheus and database/cache exporters to the TrueDope stack.

### Phase 15c: Grafana Integration
Configure Grafana data source and import dashboards.

### Phase 15d: Custom Business Metrics
Add TrueDope-specific counters and gauges.

---

## Phase 15a: Backend Prometheus Metrics

### Step 1: Add NuGet Package

**File:** `TrueDope/backend/src/TrueDope.Api/TrueDope.Api.csproj`

```xml
<PackageReference Include="prometheus-net.AspNetCore" Version="8.2.1" />
```

### Step 2: Configure Metrics Middleware

**File:** `TrueDope/backend/src/TrueDope.Api/Program.cs`

Add after the existing middleware configuration:

```csharp
using Prometheus;

// ... existing code ...

// Add after app.UseAuthorization()
app.UseHttpMetrics(options =>
{
    options.AddCustomLabel("host", context => context.Request.Host.Host);
});

// Add before app.MapControllers()
app.MapMetrics();  // Exposes GET /metrics
```

### Step 3: Verify Metrics Endpoint

After deploying, verify metrics are exposed:

```bash
curl http://localhost:8080/metrics
```

Expected output includes:
```
# HELP http_requests_received_total Total number of HTTP requests received
# TYPE http_requests_received_total counter
http_requests_received_total{code="200",method="GET",controller="Rifles",action="GetAll"} 42

# HELP http_request_duration_seconds Duration of HTTP requests in seconds
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{code="200",method="GET",controller="Rifles",action="GetAll",le="0.1"} 40
```

### Metrics Automatically Provided

| Metric | Type | Description |
|--------|------|-------------|
| `http_requests_received_total` | Counter | Total requests by method, controller, action, status code |
| `http_request_duration_seconds` | Histogram | Request latency distribution |
| `http_requests_in_progress` | Gauge | Currently executing requests |
| `dotnet_total_memory_bytes` | Gauge | Total .NET memory allocated |
| `dotnet_collection_count_total` | Counter | GC collection counts by generation |
| `process_cpu_seconds_total` | Counter | Total CPU time consumed |
| `process_working_set_bytes` | Gauge | Process memory usage |

---

## Phase 15b: Prometheus + Exporters

### Step 1: Create Prometheus Configuration

**File:** `TrueDope/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # TrueDope Backend
  - job_name: 'truedope-backend'
    static_configs:
      - targets: ['backend:80']
    metrics_path: /metrics
    scrape_interval: 10s

  # PostgreSQL Exporter
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

### Step 2: Update Docker Compose

**File:** `TrueDope/docker-compose.yml`

Add these services:

```yaml
  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:latest
    container_name: truedope-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=365d'
      - '--storage.tsdb.retention.size=50GB'
      - '--web.enable-lifecycle'
    networks:
      - truedope-network
    restart: unless-stopped

  # PostgreSQL Exporter
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: truedope-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${DB_USER:-truedope}:${DB_PASSWORD:-truedope}@db:5432/${DB_NAME:-truedope}?sslmode=disable"
    networks:
      - truedope-network
    depends_on:
      - db
    restart: unless-stopped

  # Redis Exporter
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: truedope-redis-exporter
    environment:
      REDIS_ADDR: "redis://redis:6379"
    networks:
      - truedope-network
    depends_on:
      - redis
    restart: unless-stopped
```

Add to the `volumes` section at the bottom:

```yaml
volumes:
  postgres_data:
  minio_data:
  redis_data:
  prometheus_data:  # Add this line
```

### Prometheus Retention Configuration

The configuration above sets:
- `--storage.tsdb.retention.time=365d` - Keep metrics for 1 year
- `--storage.tsdb.retention.size=50GB` - Cap storage at 50GB (whichever limit hits first)

Adjust these values based on your storage capacity.

---

## Phase 15c: Grafana Integration

### Step 1: Add Prometheus Data Source

On `monitoring01.tcudelocal.net:3000`:

1. Navigate to **Configuration → Data Sources → Add data source**
2. Select **Prometheus**
3. Configure:
   - **Name:** `TrueDope Prometheus`
   - **URL:** `http://docker-external01:9090`
   - **Access:** Server (default)
   - **Scrape interval:** `15s`
4. Click **Save & Test**

### Step 2: Import Pre-built Dashboards

| Dashboard | Grafana ID | Purpose |
|-----------|------------|---------|
| ASP.NET Core | `10915` | Application metrics (requests, latency, errors) |
| .NET Runtime | `13532` | GC, thread pool, memory |
| PostgreSQL | `9628` | Database connections, query performance |
| Redis | `763` | Memory usage, commands, connections |

To import:
1. **Dashboards → Import**
2. Enter the Grafana ID
3. Select `TrueDope Prometheus` as the data source
4. Click **Import**

### Step 3: Create TrueDope Overview Dashboard

Create a custom dashboard with these panels:

#### Row 1: Key Metrics (Stat panels)

**Request Rate (requests/sec)**
```promql
sum(rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

**Average Latency (ms)**
```promql
histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le)) * 1000
```

**Error Rate (%)**
```promql
sum(rate(http_requests_received_total{job="truedope-backend",code=~"5.."}[5m])) / sum(rate(http_requests_received_total{job="truedope-backend"}[5m])) * 100
```

**Requests In Progress**
```promql
sum(http_requests_in_progress{job="truedope-backend"})
```

#### Row 2: Request Rate Over Time (Time series)

**Requests by Status Code**
```promql
sum by (code) (rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

**Requests by Endpoint**
```promql
sum by (controller) (rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

#### Row 3: Latency (Time series)

**Response Time Percentiles**
```promql
histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))
histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))
```

#### Row 4: Infrastructure (Gauge/Time series)

**PostgreSQL Connections**
```promql
pg_stat_activity_count{job="postgres"}
```

**Redis Memory**
```promql
redis_memory_used_bytes{job="redis"}
```

**Process Memory**
```promql
process_working_set_bytes{job="truedope-backend"}
```

---

## Phase 15d: Custom Business Metrics

### Step 1: Create Metrics Service

**File:** `TrueDope/backend/src/TrueDope.Api/Services/MetricsService.cs`

```csharp
using Prometheus;

namespace TrueDope.Api.Services;

public static class TrueDopeMetrics
{
    private static readonly Counter SessionsCreated = Metrics
        .CreateCounter(
            "truedope_sessions_created_total",
            "Total number of shooting sessions created",
            new CounterConfiguration
            {
                LabelNames = new[] { "session_type" }
            });

    private static readonly Counter DopeEntriesLogged = Metrics
        .CreateCounter(
            "truedope_dope_entries_total",
            "Total number of DOPE entries logged");

    private static readonly Counter ChronoSessionsLogged = Metrics
        .CreateCounter(
            "truedope_chrono_sessions_total",
            "Total number of chronograph sessions logged");

    private static readonly Counter GroupsLogged = Metrics
        .CreateCounter(
            "truedope_groups_total",
            "Total number of shot groups logged");

    private static readonly Gauge ActiveUsers = Metrics
        .CreateGauge(
            "truedope_active_users",
            "Number of users active in the last 15 minutes");

    private static readonly Histogram ApiResponseTime = Metrics
        .CreateHistogram(
            "truedope_api_duration_seconds",
            "API endpoint response time",
            new HistogramConfiguration
            {
                LabelNames = new[] { "endpoint", "method" },
                Buckets = new[] { .005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10 }
            });

    // Public methods to increment counters
    public static void RecordSessionCreated(string sessionType) =>
        SessionsCreated.WithLabels(sessionType).Inc();

    public static void RecordDopeEntry() =>
        DopeEntriesLogged.Inc();

    public static void RecordChronoSession() =>
        ChronoSessionsLogged.Inc();

    public static void RecordGroup() =>
        GroupsLogged.Inc();

    public static void SetActiveUsers(int count) =>
        ActiveUsers.Set(count);

    public static IDisposable TimeEndpoint(string endpoint, string method) =>
        ApiResponseTime.WithLabels(endpoint, method).NewTimer();
}
```

### Step 2: Instrument Controllers

**Example in SessionsController.cs:**

```csharp
[HttpPost]
public async Task<ActionResult<ApiResponse<SessionDto>>> CreateSession(CreateSessionRequest request)
{
    // ... existing code ...

    var session = await _sessionService.CreateAsync(request, userId);

    // Record metric
    TrueDopeMetrics.RecordSessionCreated("range");

    return Ok(ApiResponse<SessionDto>.Ok(session));
}

[HttpPost("{sessionId}/dope")]
public async Task<ActionResult<ApiResponse<DopeEntryDto>>> AddDopeEntry(...)
{
    // ... existing code ...

    TrueDopeMetrics.RecordDopeEntry();

    return Ok(ApiResponse<DopeEntryDto>.Ok(entry));
}
```

### Step 3: Business Metrics Dashboard Panels

**Sessions Created Over Time**
```promql
sum(rate(truedope_sessions_created_total[1h])) * 3600
```

**DOPE Entries by Day**
```promql
sum(increase(truedope_dope_entries_total[24h]))
```

**Activity by Session Type**
```promql
sum by (session_type) (rate(truedope_sessions_created_total[24h]))
```

---

## Deployment Steps

### On Development Machine

```bash
cd /Users/tcude/projects/BallisticApp_WebApp_and_iOS_App/TrueDope

# 1. Add the NuGet package
cd backend
dotnet add src/TrueDope.Api package prometheus-net.AspNetCore

# 2. Update Program.cs with metrics middleware (manual edit)

# 3. Create prometheus.yml (manual)

# 4. Update docker-compose.yml (manual edit)

# 5. Commit changes
git add -A
git commit -m "Add Prometheus metrics and monitoring infrastructure"
```

### On Production VM (docker-external01)

```bash
cd /home/tcude/docker/TrueDope

# Pull latest changes
git pull

# Update .env with prod retention settings (one-time)
# PROMETHEUS_RETENTION_TIME=365d
# PROMETHEUS_RETENTION_SIZE=50GB

# Rebuild and restart
docker compose down
docker compose build backend
docker compose up -d

# Verify Prometheus is running
curl http://localhost:9090/api/v1/status/config

# Verify metrics endpoint
curl http://localhost:8080/metrics

# Check all targets are UP
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'
```

### On Monitoring VM (monitoring01)

1. Open Grafana at `http://monitoring01.tcudelocal.net:3000`
2. Add Prometheus data source pointing to `http://docker-external01:9090`
3. Import dashboards (IDs: 10915, 13532, 9628, 763)
4. Create custom TrueDope overview dashboard

---

## Verification Checklist

- [ ] Backend `/metrics` endpoint returns Prometheus metrics
- [ ] Prometheus UI accessible at `docker-external01:9090`
- [ ] Prometheus shows all targets as "UP" in Status → Targets
- [ ] Grafana can query Prometheus data source successfully
- [ ] ASP.NET Core dashboard shows request metrics
- [ ] PostgreSQL dashboard shows database metrics
- [ ] Redis dashboard shows cache metrics
- [ ] Custom business metrics appear in Prometheus

---

## Files Changed/Created

| File | Change | Status |
|------|--------|--------|
| `TrueDope/backend/src/TrueDope.Api/TrueDope.Api.csproj` | Add prometheus-net.AspNetCore package | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Program.cs` | Add metrics middleware and endpoint | ✅ Done |
| `TrueDope/prometheus.yml` | New - Prometheus scrape configuration | ✅ Done |
| `TrueDope/docker-compose.yml` | Add prometheus, postgres-exporter, redis-exporter services | ✅ Done |
| `TrueDope/.env.example` | Add PROMETHEUS_RETENTION_TIME/SIZE variables | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Services/MetricsService.cs` | New - Custom business metrics (Phase 15d) | Pending |
| Various controllers | Add metric recording calls (Phase 15d) | Pending |

---

## Future Enhancements

1. **Alerting** - Configure Prometheus alerting rules and Grafana alert notifications
2. **SLO Tracking** - Define and track Service Level Objectives (e.g., p99 < 500ms)
3. **Distributed Tracing** - Add OpenTelemetry for request tracing across services
4. **Log-Metric Correlation** - Link Splunk logs with Prometheus metrics via correlation ID
5. **iOS App Metrics** - Add client-side metrics reporting from the iOS app

---

## Estimated Effort

| Phase | Tasks | Time |
|-------|-------|------|
| 15a | Backend Prometheus metrics | 30 min |
| 15b | Prometheus + exporters deployment | 1 hour |
| 15c | Grafana data source + dashboards | 1 hour |
| 15d | Custom business metrics | 2-3 hours |
| **Total** | | **~5 hours** |

---

## References

- [prometheus-net Documentation](https://github.com/prometheus-net/prometheus-net)
- [Prometheus Configuration](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)
- [Grafana Prometheus Data Source](https://grafana.com/docs/grafana/latest/datasources/prometheus/)
- [PostgreSQL Exporter](https://github.com/prometheus-community/postgres_exporter)
- [Redis Exporter](https://github.com/oliver006/redis_exporter)
