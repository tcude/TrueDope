# Bugs and Features - December 30, 2025

Items organized from easiest to hardest to implement.

---

## 1. ✅ Summary Cards - Make Functional
**Difficulty:** Easy | **Type:** iOS Feature | **Status:** COMPLETED (2024-12-30)

Make the Summary cards on the home screen functional/tappable.

**Requirements:**
- Sessions card → navigates to Sessions tab ✅
- Rounds Fired card → navigates to Analytics tab ✅
- Longest Shot card → navigates to session with longest shot ✅
- Best Group card → navigates to session with best group ✅

**Implementation Notes:**
- Added `onTap` callbacks to `StatCard` and `AchievementCard` components
- Created `CardButtonStyle` for subtle press feedback (scale + opacity)
- Achievement cards only interactive when data exists
- Wired up navigation in `DashboardView`

---

## 2. ✅ Velocity Analytics - Multi-Rifle Filter
**Difficulty:** Easy-Medium | **Type:** iOS + Webapp Feature | **Status:** COMPLETED (2024-12-30)

Velocity trends and analytics were designed assuming one rifle per ammo type. However, the same ammo (e.g., 77g OTM) produces very different velocities from different barrel lengths (14.5" vs 10.3").

**Decision:** Add rifle filtering to velocity-related analytics views.

**Implementation Notes:**

Backend:
- Added `rifleId` parameter to velocity-trends, ammo-comparison, and lot-comparison endpoints
- Filter chrono sessions by `RifleSetupId` when rifleId is provided

Webapp:
- Added rifle dropdown filter to VelocityTrends, AmmoComparison, and LotComparison pages (inline with existing filters)
- Fixed array parameter serialization for ammo-comparison endpoint

iOS:
- Added global rifle filter in Analytics tab header that persists across child views
- Wired rifle filter to VelocityTrendsView, AmmoComparisonView, and LotComparisonView via @Binding
- Auto-selects rifle if user has only one

**Files Modified:**
- Backend: AnalyticsDtos.cs, AnalyticsController.cs, IAnalyticsService.cs, AnalyticsService.cs
- Webapp: analytics.ts, analytics.service.ts, VelocityTrends.tsx, AmmoComparison.tsx, LotComparison.tsx
- iOS: APIEndpoints.swift, AnalyticsService.swift, AnalyticsView.swift, VelocityTrendsView.swift, AmmoComparisonView.swift, LotComparisonView.swift, AnalyticsViewModel.swift

---

## 3. ✅ Group Measurement - Duplicate Thumbnails Bug
**Difficulty:** Medium | **Type:** iOS Bug Fix | **Status:** COMPLETED (2024-12-31)

**Reproducibility:** All groups (confirmed)

Creating a group spawns two thumbnails afterward that are both just a pic of the target.

**Expected Behavior:**
- One thumbnail: original pic of the target
- Second thumbnail: overlay with bullet holes, POA, and measurement widget

**Root Cause:** The `generateAnnotatedImage()` function used hardcoded pixel sizes (20px radius, 3px lines, 16pt font) but images are high-resolution (4096x3072px). A 40px circle on a 4096px image is ~1% of the width - invisible.

**Fix Applied:**
- Circle markers now use **caliber-scaled sizing** based on `pixelsPerInch` and `bulletDiameter`
- Formula: `holeRadiusPixels = (bulletDiameter / 2) × pixelsPerInch`
- Other UI elements (crosshair, line width, font) scale proportionally to image size
- A .308 caliber hole now renders at the correct physical size relative to the target

**Files Modified:**
- `TrueDope-iOS/TrueDope-iOS/Features/GroupMeasurement/ViewModels/QuickMeasureGroupViewModel.swift`
- `TrueDope-iOS/TrueDope-iOS/Features/GroupMeasurement/ViewModels/GroupMeasurementViewModel.swift`

---

## 4. ✅ Group Measurement Tool - Pinch to Zoom + Caliber-Scaled Markers
**Difficulty:** Medium | **Type:** iOS Feature | **Status:** COMPLETED (2024-12-31)

The group measurement tool should allow the user to pinch to zoom when establishing bullet holes or POA.

Additionally, the current green circles for the bullet markers are a bit large. Like Ballistic X, let users select caliber FIRST (after setting 1" reference), then scale the green impact circles to match actual bullet diameter. This prevents overcrowding on tight groups.

**Implementation Notes:**
- **Pinch to Zoom:** Added `MagnificationGesture` with 1x-5x zoom limits, `DragGesture` for panning when zoomed, and double-tap to reset zoom
- **Caliber-Scaled Markers:** Reordered flow to select caliber BEFORE hole marking (capture → group info → calibration → caliber → mark holes → review)
- **Marker Sizing:** Hole markers now scale to actual bullet diameter using `bulletDiameter × pixelsPerInch × displayScale`, with 20pt minimum for visibility
- **Coordinate Handling:** Used `onTapGesture` with proper coordinate transformation through zoom/pan transforms via Canvas API overlays

**Files Modified:**
- `QuickMeasureGroupFlow.swift` - Added zoom gestures, Canvas-based overlays, coordinate transformation
- `QuickMeasureGroupViewModel.swift` - Reordered Step enum, added `bulletDiameterInImagePixels` computed property
- `ZoomableImageView.swift` - Added zoom/pan gesture support with double-tap reset

---

## 5. ✅ Group Measurement - Overlay Widget & Export
**Difficulty:** Medium-Hard | **Type:** iOS Feature | **Status:** COMPLETED (2024-12-31)

The measurement tool allows the user to place a stats widget on top of their group pic (similar to Ballistic X).

**Requirements:**
- ✅ Widget overlay showing measurements
- ✅ Image with overlay saved to the group
- ✅ User can export this image

**Widget Stats (Customizable):**
- ✅ Group size (inches)
- ✅ MOA equivalent
- ✅ Mean radius
- ✅ Shot count
- ✅ Distance
- ✅ Date/time stamp
- ✅ Rifle/ammo info (configurable)

**Configuration Approach:** Default + Override
- ✅ Per-export override available when exporting (tap "Customize" to toggle stats)

**Implementation Notes:**
- Added new `widgetOverlay` step after review in QuickMeasureGroupFlow
- Created `GroupStatsWidget.swift` with configurable stats display (compact/detailed/custom)
- Widget is draggable (drag gesture) and resizable (pinch gesture + slider)
- `WidgetOverlayStepView.swift` handles the interactive placement UI
- `generateCompositeImage()` renders the widget onto the high-res image at proper scale
- Export via ShareSheet (iOS share menu) with save to Photos option
- Review step now shows "Add Widget & Export" button with "Skip" option

**Files Created:**
- `TrueDope-iOS/TrueDope-iOS/Features/GroupMeasurement/Views/GroupStatsWidget.swift`
- `TrueDope-iOS/TrueDope-iOS/Features/GroupMeasurement/Views/WidgetOverlayStepView.swift`

**Files Modified:**
- `QuickMeasureGroupViewModel.swift` - Added widget state, composite image generation
- `QuickMeasureGroupFlow.swift` - Added widgetOverlay step, updated review step

--- Post Version 7 Release ---

## 6. ✅ Home Page Stale Data After Tab Switch
**Difficulty:** Easy | **Type:** iOS Bug Fix | **Status:** COMPLETED (2026-01-01)

**Symptoms:**
- Creating/deleting sessions and returning to Home tab shows stale data
- Summary widgets (Best Group, Sessions count, etc.) don't update
- Recent Sessions list shows deleted sessions or missing new sessions
- Session type badges (DOPE, Chrono, Groups) not visible on recent sessions
- Force-quitting and reopening the app resolves the issue

**Root Cause:** The `DashboardView` uses a `@StateObject` view model that only loads data once (via `.task` with `hasLoadedInitialData` guard). When users switch to other tabs, make changes (create/delete sessions), and return to Home, the dashboard data was never refreshed.

**Fix Applied:**
- Added `.onChange(of: selectedTab)` modifier to `DashboardView`
- When returning to Home tab from another tab, automatically calls `viewModel.refresh()`
- This refreshes both summary stats and recent sessions from the API

**Files Modified:**
- `TrueDope-iOS/TrueDope-iOS/Features/Dashboard/DashboardView.swift`

---

## 7. ✅ Ammunition Edit Returns Empty Response
**Difficulty:** Easy | **Type:** iOS + Backend Bug Fix | **Status:** COMPLETED (2026-01-01)

**Symptoms:**
- Editing ammunition in iOS app shows "Server returned an empty response" error
- The update actually succeeds on the server (HTTP 200), but iOS app can't parse response
- Creating new ammunition works fine

**Root Cause:** Contract mismatch between iOS app and backend API:
- Backend `PUT /api/ammunition/{id}` returned `ApiResponse.Ok("message")` with no data payload
- iOS `AmmunitionService.updateAmmunition()` expected `AmmoDetail` object in response
- iOS `APIClient.requestData<T>()` throws `emptyResponse` when `data` field is null

**Fix Applied:**
- Changed `UpdateAmmoAsync` to return `AmmoDetailDto?` instead of `bool`
- Controller now returns `ApiResponse<AmmoDetailDto>.Ok(updatedAmmo)` with full ammunition data
- iOS app now receives the updated object as expected

**Files Modified:**
- `TrueDope/backend/src/TrueDope.Api/Services/IAmmoService.cs` - Changed return type
- `TrueDope/backend/src/TrueDope.Api/Services/AmmoService.cs` - Return AmmoDetailDto after update
- `TrueDope/backend/src/TrueDope.Api/Controllers/AmmunitionController.cs` - Return data in response

---

## 8. ✅ Clearing Optional Fields on Edit Does Nothing
**Difficulty:** Easy | **Type:** iOS Bug Fix | **Status:** COMPLETED (2026-01-01)

**Symptoms:**
- User can add notes to ammunition (e.g., "Test Test Test") successfully
- User can modify notes (e.g., change to "Test") successfully
- User cannot clear notes entirely - after saving, the old value remains
- Same issue affects all edit forms with optional string fields (rifles, locations, ammo lots)

**Root Cause:** The iOS app sent `nil` for empty optional fields, but the backend interprets `nil` as "don't change this field" (partial update semantics). The backend couldn't distinguish between "field not sent" and "user wants to clear field".

**Fix Applied:**
- For **create**: Continue sending `nil` for empty optional fields (no value to store)
- For **edit**: Send empty string `""` instead of `nil` to explicitly clear the field
- Backend already handles empty strings correctly (updates the field to empty/null)

**Files Modified:**
- `TrueDope-iOS/TrueDope-iOS/Features/Gear/AmmunitionFormView.swift` - notes, bulletType
- `TrueDope-iOS/TrueDope-iOS/Features/Gear/LotFormView.swift` - notes
- `TrueDope-iOS/TrueDope-iOS/Features/Rifles/RifleFormView.swift` - manufacturer, model, twistRate, scopeMake, scopeModel, notes
- `TrueDope-iOS/TrueDope-iOS/Features/Settings/Locations/LocationFormView.swift` - description

---

## 9. ✅ Pin Drop for New Locations
**Difficulty:** Medium-Hard | **Type:** iOS Feature | **Status:** COMPLETED (2026-01-01)

Instead of "Shared Locations" being an option in the sessions page, add an option for users to drop a pin on locations they've shot at previously but aren't currently at.

**Approach:** Integrated (matching webapp pattern)

The webapp's `LocationCombobox` provides a unified location picker with multiple sources. iOS now mirrors this:

**Session Creation - Location Picker Options:**
1. **My Locations** - user's saved locations
2. **Current Location** - GPS button for immediate location
3. **Search/Drop Pin** - opens MapKit view for:
   - Geocoding search (type address/place name)
   - Tap-to-place pin anywhere on map
   - After confirming, prompt: "Save this location for future use?"

**Implementation Notes:**

New Files Created:
- `TrueDope-iOS/TrueDope-iOS/Features/Settings/Locations/MapLocationPickerView.swift` - Full-screen interactive map with tap-to-place pin, search bar with inline dropdown, GPS button, coordinate/elevation display
- `TrueDope-iOS/TrueDope-iOS/Features/Settings/Locations/MapLocationPickerViewModel.swift` - ViewModel handling pin placement, geocoding search (300ms debounce), elevation fetch (500ms debounce), GPS location

Files Modified:
- `LocationPicker.swift` - Added `.custom` location type, "Search / Drop Pin" button, `handleMapSelection()` for saving locations
- `LocationFormView.swift` - Added "Pick on Map" button in coordinates section
- `Weather.swift` - Added extension properties for `GeocodingSearchResult` and `ElevationResult` (latitudeDouble, longitudeDouble, primaryName, elevationDouble)
- `SessionCreateView.swift` / `SessionEditView.swift` - Added `.custom` case to location type icon switch

Key Features:
- Uses existing WeatherService for geocoding (search, reverse geocode, elevation)
- Backend endpoints already existed: `/api/geocoding/search`, `/api/geocoding/reverse`, `/api/geocoding/elevation`
- MapKit integration with `Map`, `MapReader`, `MapCameraPosition`
- Initial map centers on GPS location with USA fallback
- Elevation always displayed in feet
- "Save this location" toggle with name field (always prompted)

**Additional Change:** Hidden shared locations feature from UI (button removed from LocationPicker, tab removed from LocationsListView). Underlying code retained for potential future use.

---

## 9.5. ✅ Analytics Filtering Improvements
**Difficulty:** Medium | **Type:** iOS Feature | **Status:** COMPLETED (2024-12-30)

The rifle filter in the Analytics tab cascades to velocity-related views.

**Implementation:**
- Global rifle filter dropdown in Analytics tab header
- Filter cascades to: VelocityTrendsView, AmmoComparisonView, LotComparisonView
- Overview widgets intentionally show all-rifle data (by design)
- Note displayed when filter active: "Velocity Trends, Ammo Comparison, and Lot Comparison will only show data from this rifle."

**Files:** AnalyticsView.swift, AnalyticsViewModel.swift, VelocityTrendsView.swift, AmmoComparisonView.swift, LotComparisonView.swift

---

## 10. Computer Vision Auto-Measure Group Size
**Status:** Moved to dedicated spec → `.specs/todo/ComputerVision - ON DECK/`

---

## 11. Data Value for Manufacturers
**Status:** Moved to dedicated spec → `.specs/todo/ManufacturerData/`

---

## Priority Summary

| # | Item | Difficulty | Type | Status |
|---|------|------------|------|--------|
| 1 | ✅ Summary Cards - Make Functional | Easy | Feature | Done |
| 2 | ✅ Velocity Analytics - Multi-Rifle Filter | Easy-Medium | Feature | Done |
| 3 | ✅ Duplicate Thumbnails Bug | Medium | Bug Fix | Done |
| 4 | ✅ Pinch to Zoom + Caliber Markers | Medium | Feature | Done |
| 5 | ✅ Overlay Widget & Export | Medium-Hard | Feature | Done |
| 6 | ✅ Home Page Stale Data Fix | Easy | Bug Fix | Done |
| 7 | ✅ Ammo Edit Empty Response | Easy | Bug Fix | Done |
| 8 | ✅ Clearing Optional Fields on Edit | Easy | Bug Fix | Done |
| 9 | ✅ Pin Drop Locations | Medium-Hard | Feature | Done |
| 9.5 | ✅ Analytics Filtering Improvements | Medium | Feature | Done |
| 10 | Computer Vision Auto-Measure | Hard | Feature | Moved to `.specs/todo/` |
| 11 | Manufacturer Data | Hard (non-tech) | Strategic | Moved to `.specs/todo/` |

---
