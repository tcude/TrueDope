# Bugs and Features - December 30, 2025

Items organized from easiest to hardest to implement.

---

## 1. ✅ Summary Cards - Make Functional
**Difficulty:** Easy | **Type:** iOS Feature | **Status:** COMPLETED (2024-12-30)

Make the Summary cards on the home screen functional/tappable.

**Requirements:**
- Sessions card → navigates to Sessions tab ✅
- Rounds Fired card → navigates to Analytics tab ✅
- Longest Shot card → navigates to session with longest shot ✅
- Best Group card → navigates to session with best group ✅

**Implementation Notes:**
- Added `onTap` callbacks to `StatCard` and `AchievementCard` components
- Created `CardButtonStyle` for subtle press feedback (scale + opacity)
- Achievement cards only interactive when data exists
- Wired up navigation in `DashboardView`

---

## 2. ✅ Velocity Analytics - Multi-Rifle Filter
**Difficulty:** Easy-Medium | **Type:** iOS + Webapp Feature | **Status:** COMPLETED (2024-12-30)

Velocity trends and analytics were designed assuming one rifle per ammo type. However, the same ammo (e.g., 77g OTM) produces very different velocities from different barrel lengths (14.5" vs 10.3").

**Decision:** Add rifle filtering to velocity-related analytics views.

**Implementation Notes:**

Backend:
- Added `rifleId` parameter to velocity-trends, ammo-comparison, and lot-comparison endpoints
- Filter chrono sessions by `RifleSetupId` when rifleId is provided

Webapp:
- Added rifle dropdown filter to VelocityTrends, AmmoComparison, and LotComparison pages (inline with existing filters)
- Fixed array parameter serialization for ammo-comparison endpoint

iOS:
- Added global rifle filter in Analytics tab header that persists across child views
- Wired rifle filter to VelocityTrendsView, AmmoComparisonView, and LotComparisonView via @Binding
- Auto-selects rifle if user has only one

**Files Modified:**
- Backend: AnalyticsDtos.cs, AnalyticsController.cs, IAnalyticsService.cs, AnalyticsService.cs
- Webapp: analytics.ts, analytics.service.ts, VelocityTrends.tsx, AmmoComparison.tsx, LotComparison.tsx
- iOS: APIEndpoints.swift, AnalyticsService.swift, AnalyticsView.swift, VelocityTrendsView.swift, AmmoComparisonView.swift, LotComparisonView.swift, AnalyticsViewModel.swift

---

## 3. ✅ Group Measurement - Duplicate Thumbnails Bug
**Difficulty:** Medium | **Type:** iOS Bug Fix | **Status:** COMPLETED (2024-12-31)

**Reproducibility:** All groups (confirmed)

Creating a group spawns two thumbnails afterward that are both just a pic of the target.

**Expected Behavior:**
- One thumbnail: original pic of the target
- Second thumbnail: overlay with bullet holes, POA, and measurement widget

**Root Cause:** The `generateAnnotatedImage()` function used hardcoded pixel sizes (20px radius, 3px lines, 16pt font) but images are high-resolution (4096x3072px). A 40px circle on a 4096px image is ~1% of the width - invisible.

**Fix Applied:**
- Circle markers now use **caliber-scaled sizing** based on `pixelsPerInch` and `bulletDiameter`
- Formula: `holeRadiusPixels = (bulletDiameter / 2) × pixelsPerInch`
- Other UI elements (crosshair, line width, font) scale proportionally to image size
- A .308 caliber hole now renders at the correct physical size relative to the target

**Files Modified:**
- `TrueDope-iOS/TrueDope-iOS/Features/GroupMeasurement/ViewModels/QuickMeasureGroupViewModel.swift`
- `TrueDope-iOS/TrueDope-iOS/Features/GroupMeasurement/ViewModels/GroupMeasurementViewModel.swift`

---

## 4. ✅ Group Measurement Tool - Pinch to Zoom + Caliber-Scaled Markers
**Difficulty:** Medium | **Type:** iOS Feature | **Status:** COMPLETED (2024-12-31)

The group measurement tool should allow the user to pinch to zoom when establishing bullet holes or POA.

Additionally, the current green circles for the bullet markers are a bit large. Like Ballistic X, let users select caliber FIRST (after setting 1" reference), then scale the green impact circles to match actual bullet diameter. This prevents overcrowding on tight groups.

**Implementation Notes:**
- **Pinch to Zoom:** Added `MagnificationGesture` with 1x-5x zoom limits, `DragGesture` for panning when zoomed, and double-tap to reset zoom
- **Caliber-Scaled Markers:** Reordered flow to select caliber BEFORE hole marking (capture → group info → calibration → caliber → mark holes → review)
- **Marker Sizing:** Hole markers now scale to actual bullet diameter using `bulletDiameter × pixelsPerInch × displayScale`, with 20pt minimum for visibility
- **Coordinate Handling:** Used `onTapGesture` with proper coordinate transformation through zoom/pan transforms via Canvas API overlays

**Files Modified:**
- `QuickMeasureGroupFlow.swift` - Added zoom gestures, Canvas-based overlays, coordinate transformation
- `QuickMeasureGroupViewModel.swift` - Reordered Step enum, added `bulletDiameterInImagePixels` computed property
- `ZoomableImageView.swift` - Added zoom/pan gesture support with double-tap reset

---

## 5. Group Measurement - Overlay Widget & Export
**Difficulty:** Medium-Hard | **Type:** iOS Feature | **Effort:** ~6-10 hours

The measurement tool should allow the user to place a widget on top of their group pic (similar to Ballistic X).

**Requirements:**
- Widget overlay showing measurements
- Image with overlay saved to the group
- User should be able to export this image

**Widget Stats (Customizable):**
- Group size (inches/mm)
- MOA/MIL equivalent
- Mean radius
- Shot count
- Distance
- Date/time stamp
- Rifle/ammo info

**Configuration Approach:** Default + Override
- Global defaults configured in Settings > Export Preferences
- Per-export override available when exporting (tap to customize before saving/sharing)

**Why Medium-Hard:** Requires designing the widget UI, implementing drag-to-position, rendering overlay onto image, saving composite image, building settings UI for defaults, and share sheet integration.

---

## 6. Pin Drop for New Locations
**Difficulty:** Medium-Hard | **Type:** iOS Feature | **Effort:** ~8-12 hours

Instead of "Shared Locations" being an option in the sessions page, add an option for users to drop a pin on locations they've shot at previously but aren't currently at.

**Approach:** Integrated (matching webapp pattern)

The webapp's `LocationCombobox` provides a unified location picker with multiple sources. iOS should mirror this:

**Session Creation - Location Picker Options:**
1. **My Locations** - user's saved locations
2. **Current Location** - GPS button for immediate location
3. **Search/Drop Pin** - opens MapKit view for:
   - Geocoding search (type address/place name)
   - Tap-to-place pin anywhere on map
   - Drag pin to fine-tune position
   - After confirming, prompt: "Save this location for future use?"

**Dedicated Location Management:**
- Keep existing Settings > Data > Saved Locations
- Add "+" button to create location outside session context
- Same map picker UI as session flow

**Key UX Details (from webapp):**
- Auto-fetch elevation when pin is placed (use elevation API)
- Draggable pin for fine-tuning
- Show lat/lng coordinates in real-time for verification
- Geocoding search with debounce (300ms, min 3 chars)
- Location preview on map before saving

**Technical Notes:**
- Use MapKit for iOS map integration
- Elevation API: consider Open-Elevation or similar
- Store coordinates with high precision (match webapp: 8 decimal places)

**Reference Files (webapp implementation):**
- `TrueDope/frontend/src/components/location/LocationCombobox.tsx` - unified picker
- `TrueDope/frontend/src/components/map/LocationPicker.tsx` - interactive map
- `TrueDope/frontend/src/pages/locations/LocationForm.tsx` - location creation

**Why Medium-Hard:** New MapKit view, geocoding integration, elevation API, draggable annotations, and integration into session creation flow. Significant new UI but well-defined scope.

---

## 7. Computer Vision Auto-Measure Group Size
**Difficulty:** Hard | **Type:** iOS Feature | **Effort:** ~20-40+ hours

Use computer vision to auto-measure ES (extreme spread) of group sizes.

**Scale Reference Approach:** QR Target System
- Design custom targets with encoded scale markers for accurate measurement
- Distribution: Both printable PDFs (free) and physical targets (premium/sold)

**Considerations:**
- Auto mean radius unlikely (can't auto-place shots)
- Could auto-detect total group size
- Wouldn't be center-to-center (current method)
- If user supplies bullet diameter, radius could be subtracted (×2) from total size

**Proposed Flow:**
1. User shoots group
2. User creates session in TrueDope
3. User initiates group measurement and takes photo of target
4. App detects QR markers and establishes scale
5. App measures total size of group and provides that value
6. App lets user place individual shots and POA to calculate mean radius (optional)
7. User specifies range and number of shots (probably earlier in process)

**Target Design Considerations:**
- Multiple target sizes (pistol, rifle, precision)
- QR-like markers in corners for scale + orientation detection
- Aiming points that work for various disciplines
- Could partner with existing target manufacturers

**Why Hard:** Requires CV/ML for hole detection, QR marker design & detection, scale calibration algorithms, target design work, and significant testing across lighting/paper/distance conditions. R&D-heavy.

---

## 8. Data Value for Manufacturers
**Difficulty:** Hard (non-technical) | **Type:** Strategic | **Effort:** Ongoing

Position the app to provide valuable anonymized aggregate data for:
- Ammo manufacturers
- Barrel/rifle manufacturers

**Data Strategy:** Anonymized Aggregates
- No individual user data shared
- Statistical trends across user base (e.g., "average velocity for Federal GMM 77gr across 1,000+ users")
- Requires sufficient user base to be statistically meaningful

**Potential Data Points:**
- Velocity statistics by ammo type (mean, SD, ES)
- Velocity vs barrel length correlations
- Group size distributions by ammo/rifle combo
- Popular rifle/ammo pairings
- Regional usage patterns (anonymized)

**Privacy Considerations:**
- Clear privacy policy about aggregate data use
- Possibly opt-out option for users who don't want to contribute
- No PII ever included in aggregates

**Business Model Options:**
- Sell reports/dashboards to manufacturers
- Partner with manufacturers for sponsored ammo database entries
- Offer "verified by TrueDope" badge for manufacturer claims

**Why Hard:** Not technically hard, but requires: sufficient user base, business development with manufacturers, legal/privacy review, data pipeline infrastructure, and dashboard/reporting tools. Long-term strategic initiative.

---

## Priority Summary

| # | Item | Difficulty | Type | Status |
|---|------|------------|------|--------|
| 1 | ✅ Summary Cards - Make Functional | Easy | Feature | Done |
| 2 | ✅ Velocity Analytics - Multi-Rifle Filter | Easy-Medium | Feature | Done |
| 3 | ✅ Duplicate Thumbnails Bug | Medium | Bug Fix | Done |
| 4 | ✅ Pinch to Zoom + Caliber Markers | Medium | Feature | Done |
| 5 | Overlay Widget & Export | Medium-Hard | Feature | |
| 6 | Pin Drop Locations | Medium-Hard | Feature | |
| 7 | Computer Vision Auto-Measure | Hard | Feature | |
| 8 | Manufacturer Data | Hard (non-tech) | Strategic | |
