# Phase 1: Project Setup & Infrastructure

**Created**: December 7, 2024
**Status**: Planning
**Parent**: [Project Manifest](./20251206.MANIFEST.md)

---

## Overview

This phase establishes the foundational project structure, development environment, and CI/CD pipeline for TrueDope v2. By the end of this phase, we'll have an empty but fully runnable application with complete development and deployment infrastructure.

---

## Project Structure

```
TrueDope/
├── .github/
│   └── workflows/
│       └── deploy.yml              # CI/CD pipeline
├── .specs/                          # Specification documents (existing)
├── backend/
│   ├── src/
│   │   └── TrueDope.Api/
│   │       ├── Controllers/         # API endpoints
│   │       ├── Services/            # Business logic
│   │       ├── Data/
│   │       │   ├── Entities/        # EF Core entities
│   │       │   └── ApplicationDbContext.cs
│   │       ├── DTOs/                # Request/response models
│   │       ├── Migrations/          # EF migrations
│   │       ├── Properties/
│   │       │   └── launchSettings.json
│   │       ├── appsettings.json
│   │       ├── appsettings.Development.json
│   │       ├── Program.cs
│   │       └── TrueDope.Api.csproj
│   ├── tests/
│   │   └── TrueDope.Api.Tests/
│   │       └── TrueDope.Api.Tests.csproj
│   ├── TrueDope.sln
│   ├── Dockerfile
│   └── .dockerignore
├── frontend/
│   ├── public/
│   │   └── favicon.ico
│   ├── src/
│   │   ├── components/              # Reusable UI components
│   │   ├── pages/                   # Route pages
│   │   ├── hooks/                   # Custom React hooks
│   │   ├── services/                # API client
│   │   ├── stores/                  # State management (Zustand)
│   │   ├── types/                   # TypeScript types
│   │   ├── utils/                   # Helpers
│   │   ├── App.tsx
│   │   ├── main.tsx
│   │   └── index.css
│   ├── index.html
│   ├── package.json
│   ├── tsconfig.json
│   ├── vite.config.ts
│   ├── tailwind.config.js
│   ├── postcss.config.js
│   ├── Dockerfile
│   └── .dockerignore
├── docker-compose.yml               # Local development
├── docker-compose.prod.yml          # Production overrides
├── .env.example                     # Environment template
├── .gitignore
├── README.md
└── CLAUDE.md                        # AI assistant instructions
```

---

## Tasks

### Task 1: Initialize Backend Project

**Goal**: Create the .NET 8 Web API project with proper structure.

**Steps**:
1. Create `backend/` directory
2. Create .NET solution: `dotnet new sln -n TrueDope -o backend`
3. Create Web API project: `dotnet new webapi -n TrueDope.Api -o backend/src/TrueDope.Api`
4. Add project to solution: `dotnet sln backend/TrueDope.sln add backend/src/TrueDope.Api`
5. Create test project: `dotnet new xunit -n TrueDope.Api.Tests -o backend/tests/TrueDope.Api.Tests`
6. Add test project to solution
7. Add project reference from tests to API project

**NuGet Packages to Install**:
```
Microsoft.EntityFrameworkCore (9.0.x)
Microsoft.EntityFrameworkCore.Design (9.0.x)
Npgsql.EntityFrameworkCore.PostgreSQL (9.0.x)
Microsoft.AspNetCore.Identity.EntityFrameworkCore (9.0.x)
Microsoft.AspNetCore.Authentication.JwtBearer (9.0.x)
Swashbuckle.AspNetCore (latest)
Serilog.AspNetCore (latest)
Serilog.Sinks.Console (latest)
```

**Files to Create/Modify**:
- `backend/src/TrueDope.Api/Program.cs` - Configure services, middleware, Serilog
- `backend/src/TrueDope.Api/appsettings.json` - Base configuration
- `backend/src/TrueDope.Api/appsettings.Development.json` - Dev overrides
- `backend/src/TrueDope.Api/Properties/launchSettings.json` - Debug profiles
- Create empty folder structure (Controllers/, Services/, Data/, DTOs/, etc.)

**Acceptance Criteria**:
- [ ] `dotnet build backend/TrueDope.sln` succeeds
- [ ] `dotnet test backend/TrueDope.sln` succeeds (placeholder test)
- [ ] `dotnet run --project backend/src/TrueDope.Api` starts the API
- [ ] Swagger UI accessible at `/swagger`
- [ ] Health check endpoint responds at `/health`

---

### Task 2: Initialize Frontend Project

**Goal**: Create the React + Vite + TypeScript + Tailwind project.

**Steps**:
1. Create frontend with Vite: `npm create vite@latest frontend -- --template react-ts`
2. Navigate to frontend and install dependencies
3. Install and configure Tailwind CSS
4. Set up folder structure
5. Configure Vite for API proxy

**NPM Packages to Install**:
```
# Core
react-router-dom
zustand
axios

# Tailwind
tailwindcss
postcss
autoprefixer

# Dev dependencies
@types/react-router-dom
eslint
eslint-plugin-react-hooks
@typescript-eslint/eslint-plugin
@typescript-eslint/parser
prettier
```

**Files to Create/Modify**:
- `frontend/tailwind.config.js` - Tailwind configuration
- `frontend/postcss.config.js` - PostCSS configuration
- `frontend/vite.config.ts` - Vite config with API proxy to backend
- `frontend/src/index.css` - Tailwind directives
- `frontend/src/App.tsx` - Basic app shell with router
- `frontend/src/pages/Home.tsx` - Placeholder home page
- Create empty folder structure (components/, pages/, hooks/, services/, stores/, types/, utils/)

**Vite Proxy Configuration**:
```typescript
// vite.config.ts
export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true,
      },
    },
  },
});
```

**Acceptance Criteria**:
- [ ] `npm run dev` starts the dev server on port 3000
- [ ] `npm run build` produces production build without errors
- [ ] Tailwind CSS classes work correctly
- [ ] React Router is configured and working
- [ ] API proxy forwards `/api/*` requests to backend

---

### Task 3: Configure Docker Compose for Local Development

**Goal**: Set up Docker Compose with all required services for local development.

**Services**:
1. **backend**: .NET API (Dockerfile in `backend/`)
2. **frontend**: React dev server OR nginx for built assets
3. **db**: PostgreSQL 15
4. **minio**: MinIO S3-compatible storage
5. **redis**: Redis 7 Alpine (optional, for caching)

**Files to Create**:

**docker-compose.yml** (development):
```yaml
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "5000:80"
    depends_on:
      - db
      - minio
      - redis
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    networks:
      - truedope-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - truedope-network

  db:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${DB_NAME:-truedope}
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - truedope-network

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - truedope-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - truedope-network

networks:
  truedope-network:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
  redis_data:
```

**backend/Dockerfile**:
```dockerfile
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["src/TrueDope.Api/TrueDope.Api.csproj", "src/TrueDope.Api/"]
RUN dotnet restore "src/TrueDope.Api/TrueDope.Api.csproj"
COPY . .
WORKDIR "/src/src/TrueDope.Api"
RUN dotnet build -c Release -o /app/build
RUN dotnet publish -c Release -o /app/publish

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app/publish .
EXPOSE 80
ENTRYPOINT ["dotnet", "TrueDope.Api.dll"]
```

**frontend/Dockerfile** (production build with nginx):
```dockerfile
FROM node:20-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

**.env.example**:
```
# Database
DB_NAME=truedope
DB_USER=postgres
DB_PASSWORD=changeme

# MinIO
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin

# JWT
JWT_SECRET_KEY=your-256-bit-secret-key-here-change-in-production
JWT_ISSUER=TrueDope
JWT_AUDIENCE=TrueDope

# Optional services
OPENWEATHERMAP_API_KEY=
SMTP2GO__Username=
SMTP2GO__Password=
SMTP2GO__FromEmail=
```

**Acceptance Criteria**:
- [ ] `docker compose up -d` starts all services
- [ ] Backend API accessible at `http://localhost:5000`
- [ ] Frontend accessible at `http://localhost:3000`
- [ ] PostgreSQL accessible at `localhost:5432`
- [ ] MinIO console accessible at `http://localhost:9001`
- [ ] `docker compose down -v` stops and removes all containers/volumes

---

### Task 4: Set Up Logging and Error Handling

**Goal**: Configure structured logging with Serilog and global error handling.

**Steps**:
1. Configure Serilog in Program.cs
2. Add request logging middleware
3. Create global exception handler middleware
4. Configure correlation IDs for request tracing

**Program.cs Configuration**:
```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
    .MinimumLevel.Override("Microsoft.Hosting.Lifetime", LogEventLevel.Information)
    .Enrich.FromLogContext()
    .WriteTo.Console(outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}")
    .CreateLogger();

builder.Host.UseSerilog();
```

**Files to Create**:
- `backend/src/TrueDope.Api/Middleware/ExceptionHandlingMiddleware.cs`
- Update `Program.cs` with Serilog configuration

**Acceptance Criteria**:
- [ ] Structured logs appear in console output
- [ ] Unhandled exceptions return consistent JSON error response
- [ ] Request/response logging works
- [ ] No sensitive data (passwords, tokens) in logs

---

### Task 5: Create Base API Response Models

**Goal**: Establish consistent API response format across all endpoints.

**Response Wrapper Pattern**:
```csharp
// Success response
public class ApiResponse<T>
{
    public bool Success { get; set; } = true;
    public T? Data { get; set; }
    public string? Message { get; set; }
}

// Error response
public class ApiErrorResponse
{
    public bool Success { get; set; } = false;
    public ApiError? Error { get; set; }
    public string? Message { get; set; }
}

public class ApiError
{
    public string Code { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public Dictionary<string, string[]>? ValidationErrors { get; set; }
}

// Paginated response
public class PaginatedResponse<T>
{
    public bool Success { get; set; } = true;
    public List<T> Items { get; set; } = new();
    public PaginationInfo Pagination { get; set; } = new();
}

public class PaginationInfo
{
    public int CurrentPage { get; set; }
    public int PageSize { get; set; }
    public int TotalItems { get; set; }
    public int TotalPages { get; set; }
}
```

**Files to Create**:
- `backend/src/TrueDope.Api/DTOs/ApiResponse.cs`
- `backend/src/TrueDope.Api/DTOs/PaginatedResponse.cs`

**Acceptance Criteria**:
- [ ] All response wrapper classes created
- [ ] Health check endpoint returns wrapped response
- [ ] Error middleware returns consistent error format

---

### Task 6: Create Health Check Endpoint

**Goal**: Implement a health check endpoint that verifies all dependencies.

**Endpoint**: `GET /health`

**Response**:
```json
{
  "success": true,
  "data": {
    "status": "Healthy",
    "checks": {
      "database": "Healthy",
      "redis": "Healthy",
      "minio": "Degraded"
    },
    "version": "2.0.0",
    "environment": "Development"
  }
}
```

**Files to Create**:
- `backend/src/TrueDope.Api/Controllers/HealthController.cs`

**Acceptance Criteria**:
- [ ] `/health` endpoint returns status
- [ ] Shows individual service health (db, redis, minio)
- [ ] Returns version and environment info
- [ ] Works even if some services are down (graceful degradation)

---

### Task 7: Set Up GitHub Actions CI/CD

**Goal**: Create CI/CD pipeline for automated testing and deployment.

**Workflow Strategy**:
- **Build Job**: Runs on all branches and PRs
  - Restore, build, test backend
  - Install, lint, build frontend
- **Deploy Job**: Runs only on `main` branch
  - SSH to production server
  - Pull latest code
  - Docker compose rebuild
  - Health check verification
  - Rollback on failure

**Files to Create**:

**.github/workflows/ci.yml** (CI for all branches):
```yaml
name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]

jobs:
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore
        run: dotnet restore backend/TrueDope.sln
      - name: Build
        run: dotnet build backend/TrueDope.sln --no-restore
      - name: Test
        run: dotnet test backend/TrueDope.sln --no-build

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
        working-directory: frontend
      - name: Lint
        run: npm run lint
        working-directory: frontend
      - name: Build
        run: npm run build
        working-directory: frontend
```

**.github/workflows/deploy.yml** (Deploy on main only):
```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  build:
    # Same as CI workflow

  deploy:
    needs: build
    runs-on: self-hosted  # or configure for your deployment target
    steps:
      - name: Deploy to production
        # SSH commands to pull and rebuild
```

**Acceptance Criteria**:
- [ ] CI workflow runs on all branches
- [ ] Backend build and tests pass
- [ ] Frontend build passes
- [ ] Deploy workflow triggers only on main
- [ ] Workflow files pass YAML validation

---

### Task 8: Create Project Documentation

**Goal**: Create essential documentation files.

**Files to Create**:

**README.md** (project root):
```markdown
# TrueDope v2

Ballistics data logging and analytics platform.

## Quick Start

### Prerequisites
- Docker and Docker Compose
- .NET 8 SDK (for local development)
- Node.js 20+ (for local development)

### Running with Docker
docker compose up -d

### Local Development
# Terminal 1: Backend
cd backend
dotnet run --project src/TrueDope.Api

# Terminal 2: Frontend
cd frontend
npm run dev

## Project Structure
- `/backend` - ASP.NET Core 8 API
- `/frontend` - React + Vite + TypeScript
- `/.specs` - Project specifications
```

**CLAUDE.md** (AI assistant instructions):
```markdown
# TrueDope v2 - Claude Instructions

## Project Overview
TrueDope v2 is a ballistics data logging platform with:
- Backend: ASP.NET Core 8 Web API
- Frontend: React + Vite + TypeScript + Tailwind
- Database: PostgreSQL 15
- Storage: MinIO (S3-compatible)
- Cache: Redis

## Development Commands

### Backend
cd backend
dotnet run --project src/TrueDope.Api
dotnet test
dotnet ef migrations add <Name> --project src/TrueDope.Api

### Frontend
cd frontend
npm run dev
npm run build
npm run lint

### Docker
docker compose up -d
docker compose down -v

## Architecture
- API follows RESTful conventions
- Response format: { success, data, error, message }
- JWT authentication for all protected endpoints
- Direct DbContext usage (no repository pattern)

## Key Directories
- backend/src/TrueDope.Api/Controllers/ - API endpoints
- backend/src/TrueDope.Api/Services/ - Business logic
- backend/src/TrueDope.Api/Data/Entities/ - EF Core models
- frontend/src/pages/ - Route components
- frontend/src/components/ - Reusable UI
- frontend/src/services/ - API client
```

**.gitignore**:
```gitignore
# .NET
bin/
obj/
*.user
*.suo
.vs/

# Node
node_modules/
dist/

# Environment
.env
*.local

# IDE
.idea/
.vscode/

# OS
.DS_Store
Thumbs.db

# Logs
*.log
logs/
```

**Acceptance Criteria**:
- [ ] README provides clear quick-start instructions
- [ ] CLAUDE.md covers all essential commands and patterns
- [ ] .gitignore prevents committing sensitive/generated files

---

### Task 9: Verify Full Local Development Workflow

**Goal**: Confirm entire development environment works end-to-end.

**Verification Steps**:
1. Clone fresh copy of repository
2. Copy `.env.example` to `.env`
3. Run `docker compose up -d`
4. Wait for services to be healthy
5. Access frontend at `http://localhost:3000`
6. Verify Swagger at `http://localhost:5000/swagger`
7. Verify health check at `http://localhost:5000/health`
8. Run backend tests: `dotnet test backend/TrueDope.sln`
9. Run frontend build: `cd frontend && npm run build`
10. Stop services: `docker compose down -v`

**Acceptance Criteria**:
- [ ] All containers start successfully
- [ ] Frontend loads without errors
- [ ] Swagger UI is accessible
- [ ] Health check shows all services healthy
- [ ] Tests pass
- [ ] Frontend builds without errors
- [ ] Clean shutdown works

---

## Configuration Decisions

### Backend

| Setting | Development | Production |
|---------|-------------|------------|
| ASPNETCORE_ENVIRONMENT | Development | Production |
| Log Level | Debug | Information |
| Swagger | Enabled | Disabled |
| CORS | Allow localhost:3000 | Allow production domain |

### Frontend

| Setting | Development | Production |
|---------|-------------|------------|
| API URL | Proxy to localhost:5000 | Same origin |
| Source maps | Enabled | Disabled |
| Minification | Disabled | Enabled |

### Database

| Setting | Value |
|---------|-------|
| Database Name | truedope |
| Port | 5432 |
| EF Provider | Npgsql |

### JWT Configuration

| Setting | Value |
|---------|-------|
| Issuer | TrueDope |
| Audience | TrueDope |
| Access Token Expiry | 15 minutes |
| Refresh Token Expiry | 7 days |
| Algorithm | HS256 |

---

## Package Versions

### Backend (.NET)
| Package | Version |
|---------|---------|
| Microsoft.EntityFrameworkCore | 9.0.x |
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.x |
| Microsoft.AspNetCore.Authentication.JwtBearer | 9.0.x |
| Serilog.AspNetCore | Latest |
| Swashbuckle.AspNetCore | Latest |

### Frontend (npm)
| Package | Version |
|---------|---------|
| react | 18.x |
| react-router-dom | 6.x |
| zustand | 4.x |
| axios | 1.x |
| tailwindcss | 3.x |
| vite | 5.x |
| typescript | 5.x |

---

## Acceptance Criteria (Phase Complete)

Phase 1 is complete when ALL of the following are true:

- [ ] Backend project builds and runs
- [ ] Frontend project builds and runs
- [ ] Docker Compose starts all services (db, minio, redis, backend, frontend)
- [ ] Health check endpoint returns healthy status
- [ ] Swagger UI is accessible in development
- [ ] Structured logging is configured
- [ ] Global error handling returns consistent JSON
- [ ] API response wrappers are implemented
- [ ] GitHub Actions CI workflow passes
- [ ] Project documentation is complete
- [ ] Full local development workflow verified
- [ ] All code committed and pushed to repository

---

## Notes and Considerations

### Why These Choices

1. **Vite over CRA**: Faster build times, better DX, modern defaults
2. **Zustand over Redux**: Simpler API, less boilerplate, sufficient for this app
3. **Tailwind over CSS Modules**: Rapid prototyping, consistent design system
4. **Serilog over built-in logging**: Structured logging, better output formatting
5. **No repository pattern**: Direct DbContext usage per manifest decision

### Potential Issues to Watch

1. **CORS configuration**: Ensure backend allows frontend origin
2. **Docker networking**: Container-to-container communication uses service names
3. **Port conflicts**: Default ports may conflict with other services
4. **EF Core 9 + .NET 8**: Verify compatibility (should work)

### Future Considerations (Not This Phase)

- SSL/TLS configuration (Phase 14)
- Production database configuration (Phase 14)
- Secrets management (User Secrets for now)
- CDN for static assets (Future)

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-07 | Initial Phase 1 specification created |
