# Phase 4: Frontend Development

**Created**: December 7, 2024
**Status**: Planning
**Parent**: [Project Manifest](./20251206.MANIFEST.md)
**Depends On**: Phase 3 (Core Data Model & API) ✅

---

## Overview

Phase 4 builds out the React frontend to consume the Phase 3 APIs. This phase delivers the core user-facing functionality: managing rifles, ammunition, locations, and recording shooting sessions with DOPE, chrono, and group data.

### What Already Exists

The frontend scaffolding from Phase 2 includes:
- React 18 + TypeScript + Vite
- React Router with protected routes
- Zustand for auth state management
- Tailwind CSS v4 styling
- JWT authentication with token refresh
- Basic UI components (Button, Card, Input, Label, Alert)
- Login, Register, Settings, Admin Users pages
- Header navigation component

### What This Phase Delivers

1. **Rifles Management** - Full CRUD for rifle setups
2. **Ammunition Management** - Full CRUD with lot tracking
3. **Locations Management** - Saved shooting locations
4. **Sessions** - The core feature: create/view/edit range sessions with DOPE, chrono, and group data
5. **Dashboard** - Home page with stats and recent activity
6. **Reusable Components** - Modal, DataTable, Combobox, Tabs, etc.

---

## Design Decisions

### Navigation

**Decision: Keep top header navigation with dropdown menus**

The current header works well for TrueDope's flat hierarchy. Updated navigation structure:

```
TrueDope | Home | Sessions ▾ | Analytics ▾ | Setup ▾ | Admin ▾ | Settings | [User] | Logout
                    │              │            │           │
                    ├─ All         ├─ Dashboard ├─ Rifles   ├─ Users
                    ├─ New         ├─ DOPE      ├─ Ammo
                    └─ Calendar    ├─ Trends    └─ Locations
                                   └─ Compare
```

Note: Analytics section is mostly Phase 6, but we'll add the nav structure now with placeholder/coming-soon pages.

### Layout Patterns

| Page Type | Layout |
|-----------|--------|
| Dashboard | Cards for stats, Table for recent sessions |
| Rifles List | Card grid (small collection, visual) |
| Ammunition List | Table (many items, need to compare specs) |
| Sessions List | Table (scan dates, filter, sort) |
| Locations List | Simple table |
| Detail Views | Structured sections with clear hierarchy |
| Forms | Single-column, grouped fields, tabbed for complex data |

### Form Input Patterns

| Field | Component | Notes |
|-------|-----------|-------|
| Caliber | Combobox | ~30 common calibers + custom entry |
| Manufacturer | Combobox | Common manufacturers + custom entry |
| Bullet Type | Combobox | HPBT, SMK, OTM, FMJ, etc. + custom |
| Drag Model | Dropdown | Fixed options: G1, G7 |
| Rifle Selection | Dropdown | User's rifles only |
| Ammo Selection | Dropdown | User's ammo only, with "+ Add New" option |
| Location Selection | Dropdown | User's locations + "Use GPS" + "+ Add New" |
| Lot Selection | Dropdown | Lots for selected ammo (optional) |
| Date | Date picker | Native or library |
| Numbers | Number input | With validation |
| Text | Text input | With max length |
| Notes | Textarea | Optional, expandable |

### Session Recording Flow

**Decision: Single page with tabbed sections**

```
┌─────────────────────────────────────────────────────────────┐
│ New Session                                        [Save]   │
├─────────────────────────────────────────────────────────────┤
│ Date: [Dec 7, 2025]  Time: [14:30] (optional)              │
│ Rifle: [URGI ▾]                                             │
│ Location: [Panquitch Valley ▾] [Use GPS] [+ New]           │
│                                                             │
│ Conditions (optional)                    [Fetch Weather]    │
│ Temp: [72°F]  Humidity: [35%]  Wind: [8 mph]  Dir: [270°]  │
│ Pressure: [29.92 inHg]  Density Alt: [7200 ft]             │
│                                                             │
│ ┌──────────┬────────────┬────────────┐                     │
│ │   DOPE   │   Chrono   │   Groups   │  ← Tabs             │
│ └──────────┴────────────┴────────────┘                     │
│ ┌───────────────────────────────────────────────────────┐  │
│ │                                                       │  │
│ │  [Tab content here - see detailed specs below]        │  │
│ │                                                       │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ Notes: [_______________________________________________]    │
└─────────────────────────────────────────────────────────────┘
```

Users can fill in any combination of tabs (DOPE only, Chrono only, all three, etc.).

### DOPE Entry

**Decision: Distance + Elevation only (no windage)**

Windage is too variable to track meaningfully. The backend field exists but defaults to 0.

DOPE tab content:
```
┌─────────────────────────────────────────────────────────────┐
│ DOPE Entries                              [+ Add Distance]  │
├─────────────────────────────────────────────────────────────┤
│ Distance    Elevation     Notes           Actions           │
│ ──────────────────────────────────────────────────────────  │
│ 100 yds     0.3 MIL       Zero confirm    [Edit] [Delete]  │
│ 200 yds     1.2 MIL                       [Edit] [Delete]  │
│ 300 yds     2.1 MIL                       [Edit] [Delete]  │
│ 400 yds     3.2 MIL       Slight wind     [Edit] [Delete]  │
│                                                             │
│ [Empty state: "No DOPE entries yet. Click + Add Distance"] │
└─────────────────────────────────────────────────────────────┘
```

Add Distance modal:
```
┌──────────────────────────────────┐
│ Add DOPE Entry            [X]   │
├──────────────────────────────────┤
│ Distance: [____] yards          │
│ Elevation: [____] MIL           │
│ Notes: [____________________]   │
│                                  │
│            [Cancel] [Add]        │
└──────────────────────────────────┘
```

### Chrono Entry

**Decision: Individual velocity entry with live-calculated stats**

Chrono tab content:
```
┌─────────────────────────────────────────────────────────────┐
│ Chrono Session                                              │
├─────────────────────────────────────────────────────────────┤
│ Ammunition: [Hornady ELD-M (6.5 CM - 140gr) ▾] [+ Add New] │
│ Lot: [ABC123 ▾] (optional)                                  │
│ Barrel Temp: [____] °F (optional)                          │
│                                                             │
│ Velocity Readings                                           │
│ ┌─────┬──────────┬─────────┐                               │
│ │  #  │ Velocity │         │                               │
│ ├─────┼──────────┼─────────┤                               │
│ │  1  │ 2880     │   [×]   │                               │
│ │  2  │ 2873     │   [×]   │                               │
│ │  3  │ 2878     │   [×]   │                               │
│ │  4  │ 2869     │   [×]   │                               │
│ │  5  │ 2882     │   [×]   │                               │
│ │  +  │ [____]   │  [Add]  │  ← Quick add row              │
│ └─────┴──────────┴─────────┘                               │
│                                                             │
│ Statistics (auto-calculated)                                │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ Rounds: 5  │ Avg: 2876.4 │ SD: 5.2  │ ES: 13           ││
│ │            │ High: 2882  │ Low: 2869│                  ││
│ └─────────────────────────────────────────────────────────┘│
│                                                             │
│ Notes: [_______________________________________________]    │
└─────────────────────────────────────────────────────────────┘
```

Stats calculate live as velocities are entered. Provides immediate feedback and catches data entry errors.

### Group Entry

Groups tab content:
```
┌─────────────────────────────────────────────────────────────┐
│ Group Entries                                  [+ Add Group]│
├─────────────────────────────────────────────────────────────┤
│ #   Distance  Shots  Size    Ammo              Actions      │
│ ───────────────────────────────────────────────────────────│
│ 1   100 yds   5      0.75"   Hornady 140gr     [Edit] [Del]│
│ 2   100 yds   5      0.82"   Hornady 140gr     [Edit] [Del]│
│ 3   200 yds   5      1.45"   Hornady 140gr     [Edit] [Del]│
│                                                             │
│ [Empty state: "No group entries yet. Click + Add Group"]   │
└─────────────────────────────────────────────────────────────┘
```

Add Group modal:
```
┌──────────────────────────────────┐
│ Add Group Entry           [X]   │
├──────────────────────────────────┤
│ Distance: [____] yards          │
│ Number of Shots: [5]            │
│ Group Size: [____] MOA          │
│   (or) [____] inches            │
│ Mean Radius: [____] MOA (opt)   │
│                                  │
│ Ammunition: [____________ ▾]    │
│ Lot: [____________ ▾] (opt)     │
│                                  │
│ Notes: [____________________]   │
│                                  │
│            [Cancel] [Add]        │
└──────────────────────────────────┘
```

### Session Editing

**Decision: Separate page at `/sessions/{id}/edit`**

- Sessions have complex nested data
- Modal would feel cramped
- Reuses same SessionForm component as create
- URL-based for bookmarking/sharing

### Inline Entity Creation

**Decision: "+ Add New" option in dropdowns opens modal**

When recording a session and the needed Rifle/Ammo/Location doesn't exist:
- Dropdown shows "+ Add New Rifle" option at bottom
- Clicking opens a modal with the create form
- On save, new entity is created AND selected in the dropdown
- Session form retains all other data

This prevents workflow interruption while encouraging proper setup.

### Weather Integration

**Decision: Explicit "Fetch Weather" button**

- Requires location to be set first
- Does NOT auto-fetch (avoids API hammering, handles past-date entries)
- Populates all condition fields
- User can manually adjust after fetch
- Full implementation in Phase 8, but UI stub in Phase 4

### Error Handling & Feedback

**Decision: Toast notifications + inline validation**

- **Success actions**: Toast notification (bottom-right, auto-dismiss)
- **Validation errors**: Inline error messages under fields
- **API errors**: Toast notification with error message
- **Loading states**: Skeleton loaders for content, spinners for buttons

---

## Combobox Predefined Options

### Calibers (~30 common)

```typescript
const COMMON_CALIBERS = [
  // Rimfire
  ".22 LR",
  ".17 HMR",

  // Pistol
  "9mm Luger",
  ".45 ACP",
  ".40 S&W",
  "10mm Auto",
  ".357 Magnum",
  ".44 Magnum",

  // Rifle - Common
  ".223 Remington",
  "5.56 NATO",
  ".308 Winchester",
  "7.62 NATO",
  ".30-06 Springfield",

  // Rifle - Precision/Long Range
  "6.5 Creedmoor",
  "6.5 PRC",
  ".260 Remington",
  "6mm Creedmoor",
  ".243 Winchester",
  ".338 Lapua Magnum",
  ".300 Winchester Magnum",
  ".300 PRC",
  ".300 Norma Magnum",

  // Rifle - Other Popular
  ".270 Winchester",
  "7mm Remington Magnum",
  "7mm PRC",
  ".350 Legend",
  ".450 Bushmaster",
  ".224 Valkyrie",
  "6mm ARC",
  "6.8 Western",

  // Shotgun
  "12 Gauge",
  "20 Gauge",
];
```

### Manufacturers (~20 common)

```typescript
const COMMON_MANUFACTURERS = [
  "Federal",
  "Hornady",
  "Nosler",
  "Barnes",
  "Sierra",
  "Lapua",
  "Berger",
  "Norma",
  "Winchester",
  "Remington",
  "Speer",
  "PMC",
  "Fiocchi",
  "Sellier & Bellot",
  "Prvi Partizan",
  "Black Hills",
  "Sig Sauer",
  "Aguila",
  "CCI",
  "Magtech",
  // Custom entry for handloaders
];
```

### Bullet Types

```typescript
const COMMON_BULLET_TYPES = [
  "FMJ",      // Full Metal Jacket
  "HPBT",     // Hollow Point Boat Tail
  "OTM",      // Open Tip Match
  "SMK",      // Sierra MatchKing
  "ELD-M",    // Hornady Extremely Low Drag - Match
  "ELD-X",    // Hornady Extremely Low Drag - Expanding
  "BTHP",     // Boat Tail Hollow Point
  "TMK",      // Tipped MatchKing
  "Berger Hybrid",
  "Berger VLD",
  "A-Tip",    // Hornady A-Tip Match
  "SP",       // Soft Point
  "JSP",      // Jacketed Soft Point
  "JHP",      // Jacketed Hollow Point
  "SST",      // Hornady Super Shock Tip
  "Partition", // Nosler Partition
  "AccuBond",  // Nosler AccuBond
];
```

---

## Component Library

### New Components to Build

| Component | Description | Priority |
|-----------|-------------|----------|
| Modal | Dialog overlay with close button, backdrop | P0 |
| Combobox | Searchable dropdown with custom entry | P0 |
| Select | Standard dropdown (no custom entry) | P0 |
| DataTable | Sortable, paginated table with actions | P0 |
| Tabs | Tabbed content switcher | P0 |
| Badge | Small label (for session types, status) | P0 |
| StatCard | Dashboard metric card with icon | P0 |
| EmptyState | Friendly "no data" message with CTA | P0 |
| Toast | Notification popup | P0 |
| Skeleton | Loading placeholder | P1 |
| DatePicker | Date selection input | P1 |
| ConfirmDialog | "Are you sure?" modal | P0 |

### Component Specifications

#### Modal

```typescript
interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  footer?: React.ReactNode;
  size?: 'sm' | 'md' | 'lg' | 'xl';
}
```

Features:
- Backdrop click to close (optional)
- Escape key to close
- Focus trap
- Scroll lock on body
- Animated entrance/exit

#### Combobox

```typescript
interface ComboboxProps {
  value: string;
  onChange: (value: string) => void;
  options: string[];
  placeholder?: string;
  allowCustom?: boolean; // default true
  error?: boolean;
  disabled?: boolean;
}
```

Features:
- Type to filter options
- Arrow key navigation
- Enter to select
- Custom value entry (when allowCustom=true)
- Keyboard accessible

#### DataTable

```typescript
interface DataTableProps<T> {
  data: T[];
  columns: Column<T>[];
  loading?: boolean;
  emptyMessage?: string;
  pagination?: {
    currentPage: number;
    pageSize: number;
    totalItems: number;
    onPageChange: (page: number) => void;
  };
  sortable?: boolean;
  onSort?: (column: string, direction: 'asc' | 'desc') => void;
}

interface Column<T> {
  key: string;
  header: string;
  render?: (item: T) => React.ReactNode;
  sortable?: boolean;
  width?: string;
}
```

Features:
- Column sorting (client or server-side)
- Pagination controls
- Loading skeleton rows
- Empty state
- Custom cell rendering
- Action column support

#### Tabs

```typescript
interface TabsProps {
  tabs: { id: string; label: string; content: React.ReactNode }[];
  defaultTab?: string;
  onChange?: (tabId: string) => void;
}
```

Features:
- Keyboard navigation (arrow keys)
- Accessible tab panel pattern
- Animated indicator
- Controlled or uncontrolled

#### Toast

```typescript
interface Toast {
  id: string;
  type: 'success' | 'error' | 'warning' | 'info';
  message: string;
  duration?: number; // ms, default 5000
}

// Hook usage
const { addToast } = useToast();
addToast({ type: 'success', message: 'Session saved!' });
```

Features:
- Stack multiple toasts
- Auto-dismiss with timer
- Manual dismiss
- Different styles per type
- Position: bottom-right

---

## File Structure

```
frontend/src/
├── components/
│   ├── layout/
│   │   ├── Header.tsx          (update with dropdown nav)
│   │   ├── Layout.tsx
│   │   └── index.ts
│   ├── ui/
│   │   ├── alert.tsx           (existing)
│   │   ├── button.tsx          (existing)
│   │   ├── card.tsx            (existing)
│   │   ├── input.tsx           (existing)
│   │   ├── label.tsx           (existing)
│   │   ├── modal.tsx           NEW
│   │   ├── combobox.tsx        NEW
│   │   ├── select.tsx          NEW
│   │   ├── data-table.tsx      NEW
│   │   ├── tabs.tsx            NEW
│   │   ├── badge.tsx           NEW
│   │   ├── stat-card.tsx       NEW
│   │   ├── empty-state.tsx     NEW
│   │   ├── toast.tsx           NEW
│   │   ├── skeleton.tsx        NEW
│   │   ├── confirm-dialog.tsx  NEW
│   │   └── index.ts
│   ├── rifles/
│   │   ├── RifleCard.tsx       NEW
│   │   ├── RifleForm.tsx       NEW
│   │   └── index.ts
│   ├── ammunition/
│   │   ├── AmmoForm.tsx        NEW
│   │   ├── LotForm.tsx         NEW
│   │   └── index.ts
│   ├── locations/
│   │   ├── LocationForm.tsx    NEW
│   │   └── index.ts
│   ├── sessions/
│   │   ├── SessionForm.tsx     NEW
│   │   ├── DopeTab.tsx         NEW
│   │   ├── ChronoTab.tsx       NEW
│   │   ├── GroupsTab.tsx       NEW
│   │   ├── DopeEntryForm.tsx   NEW
│   │   ├── GroupEntryForm.tsx  NEW
│   │   ├── VelocityInput.tsx   NEW
│   │   ├── SessionCard.tsx     NEW
│   │   └── index.ts
│   └── dashboard/
│       ├── StatsRow.tsx        NEW
│       ├── RecentSessions.tsx  NEW
│       ├── PerformanceCard.tsx NEW
│       └── index.ts
├── pages/
│   ├── Home.tsx                (update to dashboard)
│   ├── auth/                   (existing)
│   ├── settings/               (existing)
│   ├── admin/                  (existing)
│   ├── rifles/
│   │   ├── RiflesList.tsx      NEW
│   │   ├── RifleDetail.tsx     NEW
│   │   └── index.ts
│   ├── ammunition/
│   │   ├── AmmoList.tsx        NEW
│   │   ├── AmmoDetail.tsx      NEW
│   │   └── index.ts
│   ├── locations/
│   │   ├── LocationsList.tsx   NEW
│   │   └── index.ts
│   ├── sessions/
│   │   ├── SessionsList.tsx    NEW
│   │   ├── SessionDetail.tsx   NEW
│   │   ├── SessionCreate.tsx   NEW
│   │   ├── SessionEdit.tsx     NEW
│   │   └── index.ts
│   └── analytics/
│       ├── AnalyticsDashboard.tsx  NEW (placeholder)
│       └── index.ts
├── services/
│   ├── api.ts                  (existing)
│   ├── auth.service.ts         (existing)
│   ├── admin.service.ts        (existing)
│   ├── rifles.service.ts       NEW
│   ├── ammunition.service.ts   NEW
│   ├── locations.service.ts    NEW
│   ├── sessions.service.ts     NEW
│   └── index.ts
├── types/
│   ├── auth.ts                 (existing)
│   ├── admin.ts                (existing)
│   ├── rifles.ts               NEW
│   ├── ammunition.ts           NEW
│   ├── locations.ts            NEW
│   ├── sessions.ts             NEW
│   ├── common.ts               NEW (pagination, API response)
│   └── index.ts
├── hooks/
│   ├── useAuth.ts              (existing)
│   ├── useToast.ts             NEW
│   ├── useDebounce.ts          NEW
│   └── index.ts
├── constants/
│   ├── calibers.ts             NEW
│   ├── manufacturers.ts        NEW
│   ├── bullet-types.ts         NEW
│   └── index.ts
└── lib/
    └── utils.ts                (existing)
```

---

## Routes

```typescript
// App.tsx routes

// Public
/login
/register
/forgot-password
/reset-password

// Protected (require auth)
/                           → Dashboard (Home)
/settings                   → User settings

// Rifles
/rifles                     → Rifles list
/rifles/:id                 → Rifle detail

// Ammunition
/ammunition                 → Ammunition list
/ammunition/:id             → Ammo detail (with lots)

// Locations
/locations                  → Locations list

// Sessions
/sessions                   → Sessions list
/sessions/new               → Create session
/sessions/:id               → Session detail
/sessions/:id/edit          → Edit session

// Analytics (placeholders for Phase 6)
/analytics                  → Analytics dashboard
/analytics/dope             → DOPE charts
/analytics/trends           → Velocity trends
/analytics/compare          → Ammo comparison

// Admin
/admin/users                → User management
```

---

## API Services

### rifles.service.ts

```typescript
import api from './api';
import {
  RifleListDto,
  RifleDetailDto,
  CreateRifleDto,
  UpdateRifleDto,
  RifleFilterDto,
  PaginatedResponse
} from '../types';

export const riflesService = {
  getAll: (filter?: RifleFilterDto) =>
    api.get<PaginatedResponse<RifleListDto>>('/rifles', { params: filter }),

  getById: (id: number) =>
    api.get<{ success: boolean; data: RifleDetailDto }>(`/rifles/${id}`),

  create: (data: CreateRifleDto) =>
    api.post<{ success: boolean; data: { id: number } }>('/rifles', data),

  update: (id: number, data: UpdateRifleDto) =>
    api.put<{ success: boolean }>(`/rifles/${id}`, data),

  delete: (id: number) =>
    api.delete<{ success: boolean }>(`/rifles/${id}`),
};
```

### ammunition.service.ts

```typescript
export const ammunitionService = {
  // Ammunition CRUD
  getAll: (filter?: AmmoFilterDto) =>
    api.get<PaginatedResponse<AmmoListDto>>('/ammunition', { params: filter }),

  getById: (id: number) =>
    api.get<{ success: boolean; data: AmmoDetailDto }>(`/ammunition/${id}`),

  create: (data: CreateAmmoDto) =>
    api.post<{ success: boolean; data: { id: number } }>('/ammunition', data),

  update: (id: number, data: UpdateAmmoDto) =>
    api.put<{ success: boolean }>(`/ammunition/${id}`, data),

  delete: (id: number) =>
    api.delete<{ success: boolean }>(`/ammunition/${id}`),

  // Lots CRUD (nested)
  getLots: (ammoId: number) =>
    api.get<{ success: boolean; data: AmmoLotDto[] }>(`/ammunition/${ammoId}/lots`),

  createLot: (ammoId: number, data: CreateAmmoLotDto) =>
    api.post<{ success: boolean; data: { id: number } }>(`/ammunition/${ammoId}/lots`, data),

  updateLot: (ammoId: number, lotId: number, data: UpdateAmmoLotDto) =>
    api.put<{ success: boolean }>(`/ammunition/${ammoId}/lots/${lotId}`, data),

  deleteLot: (ammoId: number, lotId: number) =>
    api.delete<{ success: boolean }>(`/ammunition/${ammoId}/lots/${lotId}`),
};
```

### locations.service.ts

```typescript
export const locationsService = {
  getAll: () =>
    api.get<{ success: boolean; data: LocationListDto[] }>('/locations'),

  getById: (id: number) =>
    api.get<{ success: boolean; data: LocationDetailDto }>(`/locations/${id}`),

  create: (data: CreateLocationDto) =>
    api.post<{ success: boolean; data: { id: number } }>('/locations', data),

  update: (id: number, data: UpdateLocationDto) =>
    api.put<{ success: boolean }>(`/locations/${id}`, data),

  delete: (id: number) =>
    api.delete<{ success: boolean }>(`/locations/${id}`),
};
```

### sessions.service.ts

```typescript
export const sessionsService = {
  // Session CRUD
  getAll: (filter?: SessionFilterDto) =>
    api.get<PaginatedResponse<SessionListDto>>('/sessions', { params: filter }),

  getById: (id: number) =>
    api.get<{ success: boolean; data: SessionDetailDto }>(`/sessions/${id}`),

  create: (data: CreateSessionDto) =>
    api.post<{ success: boolean; data: { id: number } }>('/sessions', data),

  update: (id: number, data: UpdateSessionDto) =>
    api.put<{ success: boolean }>(`/sessions/${id}`, data),

  delete: (id: number) =>
    api.delete<{ success: boolean }>(`/sessions/${id}`),

  // DOPE entries
  addDopeEntry: (sessionId: number, data: CreateDopeEntryDto) =>
    api.post(`/sessions/${sessionId}/dope`, data),

  updateDopeEntry: (sessionId: number, entryId: number, data: UpdateDopeEntryDto) =>
    api.put(`/sessions/${sessionId}/dope/${entryId}`, data),

  deleteDopeEntry: (sessionId: number, entryId: number) =>
    api.delete(`/sessions/${sessionId}/dope/${entryId}`),

  // Chrono session
  addChronoSession: (sessionId: number, data: CreateChronoSessionDto) =>
    api.post(`/sessions/${sessionId}/chrono`, data),

  updateChronoSession: (sessionId: number, data: UpdateChronoSessionDto) =>
    api.put(`/sessions/${sessionId}/chrono`, data),

  deleteChronoSession: (sessionId: number) =>
    api.delete(`/sessions/${sessionId}/chrono`),

  // Group entries
  addGroupEntry: (sessionId: number, data: CreateGroupEntryDto) =>
    api.post(`/sessions/${sessionId}/groups`, data),

  updateGroupEntry: (sessionId: number, groupId: number, data: UpdateGroupEntryDto) =>
    api.put(`/sessions/${sessionId}/groups/${groupId}`, data),

  deleteGroupEntry: (sessionId: number, groupId: number) =>
    api.delete(`/sessions/${sessionId}/groups/${groupId}`),
};
```

---

## Sub-Phases

### Phase 4.1: Foundation

**Goal**: Set up types, services, components, and routing infrastructure.

**Tasks**:

1. Create TypeScript types matching backend DTOs:
   - `types/rifles.ts`
   - `types/ammunition.ts`
   - `types/locations.ts`
   - `types/sessions.ts`
   - `types/common.ts` (PaginatedResponse, ApiResponse, etc.)

2. Create API service layer:
   - `services/rifles.service.ts`
   - `services/ammunition.service.ts`
   - `services/locations.service.ts`
   - `services/sessions.service.ts`

3. Create reusable UI components:
   - Modal
   - Select
   - Combobox
   - DataTable
   - Tabs
   - Badge
   - StatCard
   - EmptyState
   - Toast (with context provider)
   - ConfirmDialog
   - Skeleton

4. Create constants:
   - `constants/calibers.ts`
   - `constants/manufacturers.ts`
   - `constants/bullet-types.ts`

5. Update routing:
   - Add all new routes to App.tsx
   - Create placeholder pages

6. Update Header navigation:
   - Add dropdown menus for Sessions, Analytics, Setup
   - Highlight active section

**Acceptance Criteria**:
- [ ] All TypeScript types match backend DTOs
- [ ] All API services implemented and exported
- [ ] All reusable components working in isolation
- [ ] All routes defined (can be placeholder pages)
- [ ] Header navigation shows dropdowns
- [ ] Toast notifications working

---

### Phase 4.2: Rifles Management

**Goal**: Full CRUD for rifle setups.

**Tasks**:

1. Rifles list page (`/rifles`):
   - Card grid layout
   - Show: name, caliber, manufacturer/model, session count, last session date
   - Search by name/caliber
   - Sort by name, caliber, session count, last used
   - Empty state with "Add your first rifle" CTA
   - "+ New Rifle" button

2. Create rifle modal:
   - Form fields: name, manufacturer, model, caliber (combobox), barrel length, twist rate
   - Optic section: scope make, scope model, scope height
   - Zero section: zero distance, zero clicks (elevation/windage)
   - Ballistics section: muzzle velocity, BC, drag model
   - Notes textarea
   - Validation with error messages
   - Save creates rifle and closes modal

3. Edit rifle:
   - Same form as create, pre-populated
   - Save updates rifle

4. Rifle detail page (`/rifles/:id`):
   - Hero section with rifle name and key specs
   - Full specs display
   - Session history table (sessions using this rifle)
   - Edit and Delete buttons
   - Delete with confirmation (fails if sessions exist)

5. RifleCard component:
   - Used in list view
   - Click navigates to detail page
   - Shows key info at a glance

**Acceptance Criteria**:
- [ ] Can create new rifle with all fields
- [ ] Caliber uses combobox with suggestions + custom
- [ ] Can view rifle details
- [ ] Can edit rifle
- [ ] Can delete rifle (with confirmation)
- [ ] Delete fails with message if rifle has sessions
- [ ] Session history shows on detail page
- [ ] Search and sort work on list page
- [ ] Empty state shows when no rifles

---

### Phase 4.3: Ammunition Management

**Goal**: Full CRUD for ammunition with lot tracking.

**Tasks**:

1. Ammunition list page (`/ammunition`):
   - Table layout
   - Columns: display name, caliber, grain, bullet type, lot count, session count, cost/round
   - Filter by caliber (dropdown)
   - Search by manufacturer/name
   - Sort by name, caliber, grain, sessions
   - Empty state with "Add your first ammo" CTA
   - "+ New Ammo" button

2. Create ammo modal:
   - Form fields: manufacturer (combobox), name, caliber (combobox), grain, bullet type (combobox)
   - Optional: BC, drag model, cost per round, notes
   - Validation
   - Save creates and closes

3. Edit ammo:
   - Same form, pre-populated

4. Ammo detail page (`/ammunition/:id`):
   - Header with display name and key specs
   - Full specs section
   - Lots section:
     - Table of lots with lot number, purchase date, quantity, cost, session count
     - "+ Add Lot" button
     - Edit/Delete per lot
   - Session history (sessions using this ammo)
   - Delete ammo (fails if used in sessions)

5. Lot management:
   - Create lot modal: lot number, purchase date, initial quantity, purchase price, notes
   - Edit lot modal
   - Delete lot (fails if used in sessions)

**Acceptance Criteria**:
- [ ] Can create new ammunition with all fields
- [ ] Manufacturer, caliber, bullet type use comboboxes
- [ ] Can view ammo details
- [ ] Can edit ammo
- [ ] Can add lots to ammo
- [ ] Can edit lots
- [ ] Can delete lots (with restrictions)
- [ ] Can delete ammo (with restrictions)
- [ ] Filter and search work
- [ ] Session history shows

---

### Phase 4.4: Locations Management

**Goal**: CRUD for saved shooting locations.

**Tasks**:

1. Locations list page (`/locations`):
   - Simple table layout
   - Columns: name, coordinates, altitude, session count
   - "+ New Location" button
   - Edit/Delete actions per row
   - Empty state

2. Create location modal:
   - Name (required)
   - Latitude, Longitude (required)
   - Altitude (optional)
   - Description (optional)
   - "Use Current Location" button (browser geolocation)

3. Edit location modal

4. Delete location:
   - Confirmation dialog
   - Note: sessions using this location will have location nullified

**Acceptance Criteria**:
- [ ] Can create location with coordinates
- [ ] "Use Current Location" fills lat/long from browser GPS
- [ ] Can edit location
- [ ] Can delete location
- [ ] List shows session count

---

### Phase 4.5: Sessions - List & Core

**Goal**: Session list view and basic CRUD structure.

**Tasks**:

1. Sessions list page (`/sessions`):
   - Table layout
   - Columns: date, rifle, location, type badges (DOPE/Velocity/Group), conditions summary, actions
   - Filters:
     - Date range (from/to)
     - Rifle dropdown
     - Type checkboxes (has DOPE, has chrono, has groups)
   - Sort by date (default newest first)
   - Pagination
   - "+ New Session" button
   - Empty state

2. Session detail page (`/sessions/:id`):
   - Header: date, rifle name, location
   - Conditions section (if recorded)
   - Tabbed content:
     - DOPE tab: table of distance entries
     - Chrono tab: ammo info, velocity readings, stats
     - Groups tab: table of group entries
   - Notes section
   - Edit button (navigates to edit page)
   - Delete button (with confirmation)

3. Delete session:
   - Confirmation dialog
   - Deletes session and all child data

4. Badge component for session types:
   - "DOPE" badge (blue)
   - "Velocity" badge (green)
   - "Group" badge (purple)

**Acceptance Criteria**:
- [ ] Sessions list shows with all columns
- [ ] Filters work (date range, rifle, type)
- [ ] Pagination works
- [ ] Session detail shows all data in tabs
- [ ] Can delete session
- [ ] Type badges render correctly

---

### Phase 4.6: Sessions - Create/Edit Flow

**Goal**: Full session creation and editing.

**Tasks**:

1. Session create page (`/sessions/new`):
   - SessionForm component with:
     - Date picker (defaults to today)
     - Time input (optional)
     - Rifle dropdown (required) with "+ Add New" option
     - Location dropdown with "+ Add New" option + "Use GPS"
     - Conditions section (all optional):
       - Temperature (°F)
       - Humidity (%)
       - Wind speed (mph)
       - Wind direction (degrees, 0-359)
       - Pressure (inHg)
       - Density altitude (ft)
       - "Fetch Weather" button (disabled, shows tooltip "Coming in future update")
     - Tabs for DOPE, Chrono, Groups
     - Notes textarea
   - Save button creates session

2. Session edit page (`/sessions/:id/edit`):
   - Same SessionForm, pre-populated with existing data
   - Can add/edit/delete nested data (DOPE, chrono, groups)
   - Save button updates session

3. Inline entity creation:
   - "+ Add New Rifle" in dropdown opens RifleForm modal
   - On save, rifle is created AND selected
   - Same pattern for Ammo and Location

**Acceptance Criteria**:
- [ ] Can create session with basic info
- [ ] Rifle dropdown shows user's rifles
- [ ] "+ Add New" options work and return to form with selection
- [ ] Location dropdown works with GPS option
- [ ] Conditions are optional
- [ ] Tabs switch between DOPE/Chrono/Groups
- [ ] Can save session
- [ ] Edit page loads existing data
- [ ] Edit page saves changes

---

### Phase 4.7: DOPE Entry

**Goal**: DOPE data entry within sessions.

**Tasks**:

1. DopeTab component:
   - List of DOPE entries (distance, elevation, notes)
   - "+ Add Distance" button
   - Edit/Delete per entry
   - Empty state

2. DopeEntryForm modal:
   - Distance (yards, required, 1-2500)
   - Elevation (MIL, required, -50 to +50)
   - Notes (optional)
   - Validation

3. Inline editing:
   - Click edit opens modal with pre-populated values

4. Delete entry:
   - Confirmation
   - Removes from list

5. Display in session detail:
   - Table showing distance, elevation (MIL), elevation (calculated inches), notes

**Acceptance Criteria**:
- [ ] Can add DOPE entry with distance + elevation
- [ ] Windage is NOT shown (backend defaults to 0)
- [ ] Can edit entry
- [ ] Can delete entry
- [ ] Entries sorted by distance
- [ ] Duplicate distance shows validation error
- [ ] Detail view shows calculated inches

---

### Phase 4.8: Chrono Entry

**Goal**: Chronograph data entry within sessions.

**Tasks**:

1. ChronoTab component:
   - Ammo selection dropdown (required) with "+ Add New"
   - Lot selection dropdown (optional, filtered by selected ammo)
   - Barrel temperature input (optional)
   - Velocity readings section:
     - Table: shot #, velocity, delete button
     - Quick-add row at bottom
     - Renumbers shots on delete
   - Live-calculated stats:
     - Rounds fired
     - Average velocity
     - Standard deviation
     - Extreme spread
     - High/Low
   - Notes textarea

2. VelocityInput component:
   - Quick-add input at bottom of table
   - Enter key adds and focuses next
   - Validates range (500-5000 fps)

3. Stats calculation (client-side):
   ```typescript
   function calculateStats(velocities: number[]) {
     if (velocities.length === 0) return null;

     const n = velocities.length;
     const sum = velocities.reduce((a, b) => a + b, 0);
     const avg = sum / n;
     const high = Math.max(...velocities);
     const low = Math.min(...velocities);
     const es = high - low;

     const squaredDiffs = velocities.map(v => Math.pow(v - avg, 2));
     const variance = squaredDiffs.reduce((a, b) => a + b, 0) / n;
     const sd = Math.sqrt(variance);

     return {
       rounds: n,
       average: Math.round(avg * 10) / 10,
       standardDeviation: Math.round(sd * 100) / 100,
       extremeSpread: Math.round(es * 10) / 10,
       high: Math.round(high * 10) / 10,
       low: Math.round(low * 10) / 10,
     };
   }
   ```

4. Display in session detail:
   - Ammo name + lot
   - Stats summary
   - Velocity readings table

**Acceptance Criteria**:
- [ ] Can select ammo (required for chrono)
- [ ] "+ Add New Ammo" works inline
- [ ] Can select lot (optional)
- [ ] Can add velocity readings one by one
- [ ] Stats calculate live as readings added
- [ ] Can delete individual readings
- [ ] Shot numbers renumber on delete
- [ ] Can save chrono session
- [ ] Detail view shows all data

---

### Phase 4.9: Group Entry

**Goal**: Group data entry within sessions.

**Tasks**:

1. GroupsTab component:
   - List of group entries
   - "+ Add Group" button
   - Edit/Delete per entry
   - Empty state

2. GroupEntryForm modal:
   - Group # (auto-increment, editable)
   - Distance (yards, required)
   - Number of shots (required, 1-25)
   - Group size - choice of:
     - MOA input
     - Inches input (calculates MOA based on distance)
   - Mean radius MOA (optional)
   - Ammo dropdown (optional) with "+ Add New"
   - Lot dropdown (optional)
   - Notes

3. Group size conversion:
   ```typescript
   function moaToInches(moa: number, distanceYards: number): number {
     return (moa * distanceYards * 1.047) / 100;
   }

   function inchesToMoa(inches: number, distanceYards: number): number {
     return (inches * 100) / (distanceYards * 1.047);
   }
   ```

4. Display in session detail:
   - Table with group #, distance, shots, size (MOA and inches), ammo, notes

**Acceptance Criteria**:
- [ ] Can add group entry
- [ ] Can enter size in MOA or inches
- [ ] Conversion displays both values
- [ ] Ammo/lot selection optional
- [ ] Can edit group
- [ ] Can delete group
- [ ] Groups auto-number

---

### Phase 4.10: Dashboard

**Goal**: Home page with stats and recent activity.

**Tasks**:

1. Update Home.tsx to be full dashboard:
   - Hero section:
     - Welcome message
     - Prominent "+ New Session" button
   - Stats row (4 cards):
     - Total Sessions
     - Longest Shot (yards)
     - Best Group (MOA at distance)
     - Last Range Day (date)
   - Recent Sessions section:
     - Table showing last 5-10 sessions
     - "View All Sessions" link
   - Performance Snapshot card:
     - Best velocity consistency (lowest SD ammo)
     - Total rounds fired
     - "View Analytics" button (links to Phase 6 placeholder)
   - Quick links cards:
     - "View Trends" (placeholder)
     - "Compare Ammo" (placeholder)

2. Stats calculation:
   - API endpoint or client-side aggregation from session data
   - Consider adding a `/api/dashboard/stats` endpoint later

3. Responsive layout:
   - Stats cards: 4 columns on desktop, 2 on tablet, 1 on mobile
   - Recent sessions: horizontal scroll on mobile if needed

**Acceptance Criteria**:
- [ ] Dashboard shows on `/` for authenticated users
- [ ] Stats cards display meaningful data (or "--" if no data)
- [ ] "+ New Session" button prominent and works
- [ ] Recent sessions table shows latest sessions
- [ ] Empty states show appropriate messages
- [ ] Links to sessions, analytics (placeholders) work
- [ ] Responsive on mobile

---

### Phase 4.11: Polish & QA

**Goal**: Final polish, loading states, error handling, testing.

**Tasks**:

1. Loading states:
   - Add Skeleton loaders to all list/detail pages
   - Button loading states on form submissions
   - Page transition loading indicators

2. Error handling:
   - API error handling in all services
   - Toast notifications for errors
   - Form validation error messages
   - 404 handling for invalid IDs

3. Toast integration:
   - Success toasts on create/update/delete
   - Error toasts on API failures
   - Consistent messaging

4. Mobile responsive review:
   - Test all pages at mobile breakpoints
   - Ensure forms are usable on mobile
   - Tables scroll horizontally or stack
   - Navigation hamburger menu works

5. Cross-browser testing:
   - Chrome, Firefox, Safari
   - Basic functionality check

6. End-to-end testing (manual):
   - Create rifle → Create ammo → Create location → Create session with all data types
   - Edit session
   - Delete session
   - Verify data persists correctly
   - Test validation errors
   - Test delete restrictions

7. Accessibility basics:
   - Keyboard navigation works
   - Focus states visible
   - Form labels associated with inputs
   - Modal focus trap

**Acceptance Criteria**:
- [ ] All pages have loading states
- [ ] All API errors show user-friendly messages
- [ ] Toast notifications working throughout
- [ ] All forms validate and show errors
- [ ] Mobile experience is functional
- [ ] No console errors in normal operation
- [ ] Full user flow works end-to-end

---

## Acceptance Criteria (Phase Complete)

Phase 4 is complete when ALL of the following are true:

### Infrastructure
- [ ] All TypeScript types match backend DTOs
- [ ] All API services implemented
- [ ] All reusable components built and working
- [ ] Routing structure complete
- [ ] Header navigation updated with dropdowns

### Rifles
- [ ] List page with search/sort
- [ ] Create/edit forms with combobox caliber
- [ ] Detail page with session history
- [ ] Delete with restrictions

### Ammunition
- [ ] List page with filter/search
- [ ] Create/edit forms with comboboxes
- [ ] Detail page with lots section
- [ ] Lot CRUD working
- [ ] Delete with restrictions

### Locations
- [ ] List page
- [ ] Create/edit with GPS option
- [ ] Delete

### Sessions
- [ ] List page with filters (date, rifle, type)
- [ ] Detail page with tabbed data
- [ ] Create session flow complete
- [ ] DOPE entry (distance + elevation only)
- [ ] Chrono entry with live stats
- [ ] Group entry with size conversion
- [ ] Edit session flow complete
- [ ] Delete with confirmation
- [ ] Inline entity creation ("+ Add New" in dropdowns)

### Dashboard
- [ ] Stats cards with real data
- [ ] Recent sessions table
- [ ] "+ New Session" CTA
- [ ] Analytics placeholders

### Polish
- [ ] Loading states throughout
- [ ] Error handling with toasts
- [ ] Form validation
- [ ] Mobile responsive
- [ ] Keyboard accessible

---

## Notes and Considerations

### Design Patterns

1. **Optimistic Updates**: Consider for delete operations (show removed immediately, rollback on error)

2. **Form State Management**: React Hook Form + Zod continues to work well

3. **Data Fetching**: Consider React Query for caching/refetching in future, but useState/useEffect is fine for Phase 4

4. **Component Composition**: Keep components focused; SessionForm orchestrates tabs, each tab is its own component

### Future Enhancements (Not Phase 4)

1. **Bulk import**: CSV import for velocity readings
2. **Weather auto-fetch**: OpenWeatherMap integration (Phase 8)
3. **Image upload**: Photo attachment (Phase 7)
4. **Offline support**: PWA with sync
5. **Export**: PDF/CSV export of sessions

### Dependencies

This phase depends on:
- Phase 1 (project structure) ✅
- Phase 2 (authentication) ✅
- Phase 3 (core data model & API) ✅

This phase is required by:
- Phase 5 (Session Recording polish - if splitting)
- Phase 6 (Analytics)
- Phase 7 (Images)

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-07 | Initial Phase 4 specification created |
