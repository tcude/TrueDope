# Phase 10: Admin Panel - Specification

**Created**: December 13, 2024
**Status**: ✅ Complete
**Phase**: 10 of 14

---

## Overview

This phase expands the existing admin panel with system statistics and image maintenance. Database operations will be handled via CLI scripts only (not exposed through the web UI). The current implementation already includes user management and shared location management.

---

## Current State (Already Implemented)

### User Management ✅
- List all users with pagination, search, and sorting
- View user details (email, lockout status, login history)
- Update user profile (name, admin role)
- Reset user password (generates temporary password)
- Disable/enable user accounts

### Shared Locations Management ✅
- CRUD operations for shared locations
- Location picker with map integration
- Active/inactive status toggle

---

## Features to Implement

Based on manifest requirements and your clarifications:

### 1. Enhanced Admin Dashboard with System Stats

**Replaces**: Current simple navigation-only dashboard

**Statistics to display:**

| Category | Metrics |
|----------|---------|
| **Users** | Total users, Active in last 30 days, Admin count |
| **Sessions** | Total sessions, Sessions this month |
| **Equipment** | Total rifles, Total ammunition types, Total ammo lots |
| **Media** | Total images, Storage used (formatted as MB/GB) |

**UI Behavior:**
- Stats displayed as cards at top of dashboard
- Manual refresh button (no auto-refresh)
- Navigation cards below stats (existing + new pages)

---

### 2. Image Maintenance Page

**Route**: `/admin/images`

**Features:**

| Feature | Description |
|---------|-------------|
| Image Statistics | Count of images, total storage, images missing thumbnails |
| Regenerate All Thumbnails | Button to trigger background job |
| Progress Tracking | Shows progress during regeneration |
| Orphan Detection | List images in MinIO not referenced in DB |
| Orphan Cleanup | Button to delete orphaned files (with confirmation) |

**Implementation Notes:**
- Thumbnail regeneration runs as a background task
- Frontend polls for progress updates
- Orphan detection compares MinIO object list with DB Image records

---

### 3. Database Operations (CLI Scripts Only)

Database export/import will be handled via shell scripts, not through the web UI. This is safer and matches typical dev workflows.

**Scripts to create** (in `TrueDope/backend/scripts/`):

| Script | Purpose |
|--------|---------|
| `export-database.sh` | Export DB from Docker container (pg_dump) |
| `import-database.sh` | Import DB into local dev (destructive, with confirmation) |

**Use cases:**
- Export from production → Import to local dev for testing
- Create backups before major changes
- Share database state between developers

---

## Detailed Implementation Plan

### Backend

#### New Service: `AdminStatsService`

```csharp
public interface IAdminStatsService
{
    Task<SystemStatsDto> GetSystemStatsAsync();
    Task<ImageStatsDto> GetImageStatsAsync();
    Task<DatabaseStatsDto> GetDatabaseStatsAsync();
}
```

#### New Service: `ImageMaintenanceService`

```csharp
public interface IImageMaintenanceService
{
    Task<ThumbnailJobStatus> StartThumbnailRegenerationAsync();
    Task<ThumbnailJobStatus> GetThumbnailJobStatusAsync(string jobId);
    Task<List<OrphanedImageDto>> GetOrphanedImagesAsync();
    Task<int> DeleteOrphanedImagesAsync();
}
```

#### New Controller Endpoints

**AdminController additions:**
```
GET  /api/admin/stats                        - System statistics
```

**New ImageMaintenanceController:**
```
GET  /api/admin/images/stats                 - Image statistics
POST /api/admin/images/regenerate-thumbnails - Start regeneration job
GET  /api/admin/images/regenerate-thumbnails/{jobId} - Check job status
GET  /api/admin/images/orphaned              - List orphaned images
DELETE /api/admin/images/orphaned            - Delete orphaned images
```

### Frontend

#### Enhanced AdminDashboard.tsx

```
┌─────────────────────────────────────────────────────────────────┐
│  Admin Dashboard                                    [Refresh ↻] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │    Users     │  │   Sessions   │  │    Rifles    │          │
│  │     150      │  │    1,250     │  │     320      │          │
│  │  45 active   │  │  87 this mo  │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Ammunition  │  │    Images    │  │   Storage    │          │
│  │     180      │  │    2,300     │  │    5.0 GB    │          │
│  │  450 lots    │  │              │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                 │
│  ─────────────────── Management ─────────────────────          │
│                                                                 │
│  ┌─────────────────────┐  ┌─────────────────────┐              │
│  │  User Management    │  │  Shared Locations   │              │
│  │  Manage users...    │  │  Manage locations.. │              │
│  └─────────────────────┘  └─────────────────────┘              │
│                                                                 │
│  ┌─────────────────────┐                                       │
│  │  Image Maintenance  │                                       │
│  │  Thumbnails, stats  │                                       │
│  └─────────────────────┘                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### New AdminImages.tsx

```
┌─────────────────────────────────────────────────────────────────┐
│  Image Maintenance                              [← Back to Admin]│
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Image Statistics                                         │   │
│  │                                                          │   │
│  │   Total Images: 2,300                                    │   │
│  │   Storage Used: 5.2 GB                                   │   │
│  │   Missing Thumbnails: 12                                 │   │
│  │   Orphaned Files: 3                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Thumbnail Regeneration                                   │   │
│  │                                                          │   │
│  │   Regenerate thumbnails for all images. This may take    │   │
│  │   several minutes for large image libraries.             │   │
│  │                                                          │   │
│  │   [Regenerate All Thumbnails]                            │   │
│  │                                                          │   │
│  │   ████████████░░░░░░░░ 60% (1,380 / 2,300)              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Orphaned Images                                          │   │
│  │                                                          │   │
│  │   Found 3 files in storage not referenced in database:   │   │
│  │                                                          │   │
│  │   • abc123-image.jpg (2.3 MB)                           │   │
│  │   • def456-image.jpg (1.8 MB)                           │   │
│  │   • ghi789-thumb.jpg (0.1 MB)                           │   │
│  │                                                          │   │
│  │   [Delete Orphaned Files]                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Shell Scripts for Local Development

Create updated versions of the v1 scripts for v2's Docker setup:

**Location**: `TrueDope/backend/scripts/`

| Script | Purpose |
|--------|---------|
| `export-database.sh` | Export DB from Docker container |
| `import-database.sh` | Import DB (destructive, with confirmation) |

These will be similar to v1 but configured for the new container names and database credentials.

---

## API Response DTOs

### SystemStatsDto
```json
{
  "users": {
    "total": 150,
    "activeLastThirtyDays": 45,
    "admins": 2
  },
  "sessions": {
    "total": 1250,
    "thisMonth": 87
  },
  "rifles": {
    "total": 320
  },
  "ammunition": {
    "total": 180,
    "lots": 450
  },
  "images": {
    "total": 2300,
    "storageSizeBytes": 5582061568
  },
  "generatedAt": "2024-12-13T15:30:00Z"
}
```

### ImageStatsDto
```json
{
  "totalImages": 2300,
  "storageSizeBytes": 5582061568,
  "storageSizeFormatted": "5.2 GB",
  "missingThumbnails": 12,
  "orphanedFiles": 3
}
```

### ThumbnailJobStatus
```json
{
  "jobId": "abc-123",
  "status": "running",
  "totalImages": 2300,
  "processedImages": 1380,
  "failedImages": 2,
  "startedAt": "2024-12-13T15:30:00Z",
  "completedAt": null
}
```

---

## File Changes Summary

### Backend (New Files)
- `Services/AdminStatsService.cs`
- `Services/ImageMaintenanceService.cs`
- `Controllers/ImageMaintenanceController.cs`
- `DTOs/Admin/SystemStatsDto.cs`
- `DTOs/Admin/ImageStatsDto.cs`
- `DTOs/Admin/ThumbnailJobStatusDto.cs`
- `DTOs/Admin/OrphanedImageDto.cs`
- `scripts/export-database.sh`
- `scripts/import-database.sh`

### Backend (Modified Files)
- `Program.cs` - Register new services
- `Controllers/AdminController.cs` - Add stats endpoint

### Frontend (New Files)
- `pages/admin/AdminImages.tsx`
- `services/maintenance.service.ts`
- `types/maintenance.ts`

### Frontend (Modified Files)
- `pages/admin/AdminDashboard.tsx` - Add stats cards
- `services/admin.service.ts` - Add stats methods
- `types/admin.ts` - Add stats types
- `App.tsx` - Add new route for images page

---

## Implementation Order

1. **Backend: Stats Service & Endpoints**
   - Create AdminStatsService
   - Add GET /api/admin/stats endpoint

2. **Frontend: Enhanced Dashboard**
   - Update AdminDashboard to display stats cards
   - Add refresh functionality

3. **Backend: Image Maintenance**
   - Create ImageMaintenanceService
   - Add image maintenance endpoints
   - Implement thumbnail regeneration background job

4. **Frontend: Image Maintenance Page**
   - Create AdminImages.tsx
   - Implement progress polling for thumbnail job
   - Add orphan detection/cleanup UI

5. **Shell Scripts**
   - Create export-database.sh for v2
   - Create import-database.sh for v2

---

## Questions Resolved

| Question | Answer |
|----------|--------|
| Per-user breakdowns? | System-wide totals only |
| Additional metrics? | Open to recommendations (covered above) |
| Auto-refresh? | Manual refresh only |
| Thumbnail regen approach? | Background job with progress |
| Orphan cleanup? | Yes, nice-to-have - included |
| Regen scope? | All images (no filtering needed) |
| DB utilities in web UI? | **No** - CLI scripts only |
| Backup strategy? | VM-level backup, no app-level triggers needed |
| Priority? | Implement all features |
| Additional features? | None specified, open to recommendations |

---

## Recommendations (Optional Enhancements)

These are not required but could be useful:

1. **Recent Activity Feed** - Show last 10 admin actions (user disabled, password reset, etc.)
2. **Session Statistics Breakdown** - Sessions by type (DOPE only, Chrono only, mixed)
3. **Storage Trend** - Chart showing storage growth over time
4. **User Registration Trend** - New users per month

Let me know if any of these interest you - they could be added to this phase or saved for later.

---

## Changelog

| Date | Change |
|------|--------|
| 2024-12-13 | Initial specification created |
| 2024-12-13 | Updated with user clarifications, detailed implementation plan |
| 2024-12-13 | Removed database tools from web UI - CLI scripts only |
| 2024-12-13 | ✅ Implementation complete |
