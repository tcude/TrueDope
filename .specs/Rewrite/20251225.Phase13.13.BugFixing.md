# Phase 13.13 Bug Fixing - Analytics Feature

## Overview

The Analytics feature views were created but several are not working correctly due to mismatches between the iOS client and backend API expectations, as well as some UI/UX improvements needed.

## Issue 1: Analytics Should Be a Dedicated Tab

**Problem**: The Analytics dashboard is too information-dense to be buried as a sub-menu within the Home page. It should have dedicated, prominent access.

**Solution Options**:
1. Add Analytics as a 5th tab in the bottom bar (may be cramped)
2. Replace one of the existing tabs with Analytics
3. Add a floating action button or prominent card on Home that opens Analytics as a full-screen sheet
4. Add Analytics button to the navigation bar on Home

**Recommended**: Keep Analytics accessible from Home (via a prominent card) but also consider adding a small analytics icon to the tab bar or navigation. The user should decide the final placement.

---

## Issue 2: DOPE Chart Not Loading Data

**Problem**: DOPE chart shows "No elevation data recorded for this rifle in the selected date range" even when data exists.

**Root Cause Analysis**:
- Backend API requires `rifleId` as a **required** parameter (not optional)
- Backend endpoint signature: `GetDopeChart([FromQuery] int rifleId, ...)`
- iOS endpoint definition marks `rifleId` as optional: `dopeChart(rifleId: Int?, ...)`

**Files to Fix**:
- `TrueDope-iOS/TrueDope-iOS/Core/Network/APIEndpoints.swift` - Line 575
  - Change: `case dopeChart(rifleId: Int?, ammoId: Int?, fromDate: String?, toDate: String?)`
  - To: `case dopeChart(rifleId: Int, ammoId: Int?, fromDate: String?, toDate: String?)`

- `TrueDope-iOS/TrueDope-iOS/Core/Services/AnalyticsService.swift` - Line 12, 53-66
  - Update protocol and implementation to require rifleId

- `TrueDope-iOS/TrueDope-iOS/Features/Analytics/DopeChartView.swift`
  - Ensure `loadDopeChart()` only calls API when `selectedRifleId` is non-nil (already does this, but verify)

---

## Issue 3: Velocity Trends Not Loading Data

**Problem**: Velocity trends view not displaying data.

**Root Cause Analysis**:
- Backend API requires `ammoId` as a **required** parameter (not optional)
- Backend endpoint signature: `GetVelocityTrends([FromQuery] int ammoId, ...)`
- iOS endpoint definition marks `ammoId` as optional

**Files to Fix**:
- `TrueDope-iOS/TrueDope-iOS/Core/Network/APIEndpoints.swift` - Line 576
  - Change: `case velocityTrends(ammoId: Int?, lotId: Int?, fromDate: String?, toDate: String?)`
  - To: `case velocityTrends(ammoId: Int, lotId: Int?, fromDate: String?, toDate: String?)`

- `TrueDope-iOS/TrueDope-iOS/Core/Services/AnalyticsService.swift` - Lines 15, 68-81
  - Update protocol and implementation to require ammoId

---

## Issue 4: Cost Analysis Not Loading Data

**Problem**: Cost analysis view not displaying data.

**Root Cause Analysis**: Similar to above - need to verify API call is correct and data exists.

**Files to Check**:
- `TrueDope-iOS/TrueDope-iOS/Core/Network/APIEndpoints.swift` - Line 579
- Verify the API response model matches backend DTO structure

---

## Issue 5: Ammo Comparison Not Working

**Problem**: After selecting ammunition for comparison (as shown in screenshot), no comparison data is displayed.

**Root Cause Analysis**:
- iOS sends: `ammoIds=1,2` (comma-separated string)
- Backend expects: `ammoIds=1&ammoIds=2` (repeated query params for array)
- The endpoint definition at line 624-625 creates comma-separated string which ASP.NET Core won't parse as an array

**Files to Fix**:
- `TrueDope-iOS/TrueDope-iOS/Core/Network/APIEndpoints.swift` - Lines 624-625
  - Current: `return ["ammoIds": ammoIds.map { String($0) }.joined(separator: ",")]`
  - Need to change to use Alamofire's array encoding or manually build repeated params

**Potential Fix Options**:
1. Change to use URLEncoding with array expansion
2. Build parameters differently: `["ammoIds[]": ammoIds]` or similar
3. Modify backend to accept comma-separated string (less ideal)

---

## Issue 6: Lot Comparison Not Working

**Problem**: Lot comparison shows "No Lot Data" even for ammunition with lots.

**Root Cause Analysis**:
- Need to verify the API call is being made correctly
- Backend requires `ammoId` parameter

**Files to Check**:
- `TrueDope-iOS/TrueDope-iOS/Features/Analytics/LotComparisonView.swift`
- Verify `selectedAmmoId` is being passed correctly to the API

---

## Issue 7: API Response Parsing

**Problem**: Some API calls may be failing silently due to response parsing issues.

**Root Cause Analysis**:
The iOS models may not match the backend DTOs exactly. Need to verify:

**Files to Check**:
- `TrueDope-iOS/TrueDope-iOS/Models/Analytics/DopeChartData.swift`
- `TrueDope-iOS/TrueDope-iOS/Models/Analytics/VelocityTrendsData.swift`
- `TrueDope-iOS/TrueDope-iOS/Models/Analytics/AmmoComparisonData.swift`
- `TrueDope-iOS/TrueDope-iOS/Models/Analytics/LotComparisonData.swift`
- `TrueDope-iOS/TrueDope-iOS/Models/Analytics/CostSummaryData.swift`

**Compare Against Backend DTOs**:
- `TrueDope/backend/src/TrueDope.Api/DTOs/Analytics/DopeChartDataDto.cs`
- `TrueDope/backend/src/TrueDope.Api/DTOs/Analytics/VelocityTrendsDto.cs`
- `TrueDope/backend/src/TrueDope.Api/DTOs/Analytics/AmmoComparisonDto.cs`
- `TrueDope/backend/src/TrueDope.Api/DTOs/Analytics/LotComparisonDto.cs`
- `TrueDope/backend/src/TrueDope.Api/DTOs/Analytics/CostSummaryDto.cs`

---

## Implementation Steps

### Step 1: Fix API Endpoint Definitions
1. Update `APIEndpoints.swift` to match backend requirements
2. Make `rifleId` required for DOPE chart
3. Make `ammoId` required for velocity trends
4. Fix array parameter encoding for ammo comparison

### Step 2: Fix Service Layer
1. Update `AnalyticsService.swift` protocol to match new signatures
2. Update implementation methods

### Step 3: Verify Model Compatibility
1. Compare iOS models against backend DTOs
2. Fix any property name mismatches (camelCase vs snake_case)
3. Ensure optional vs required properties match

### Step 4: Add Error Handling/Logging
1. Add debug logging to see API responses
2. Improve error messages shown to user
3. Handle 404 responses gracefully (show "no data" instead of error)

### Step 5: Test Each View
1. DOPE Chart - Select rifle, verify data loads
2. Velocity Trends - Select ammo, verify data loads
3. Cost Analysis - Verify data loads with date range
4. Ammo Comparison - Select 2+ ammo, verify comparison displays
5. Lot Comparison - Select ammo with lots, verify lots display

### Step 6: Analytics Navigation Enhancement (Optional)
1. Consider adding Analytics to more prominent location
2. Add Analytics quick-access from Dashboard

---

## Testing Requirements

After fixes are implemented:

1. **DOPE Chart**:
   - Select a rifle that has sessions with DOPE data
   - Verify chart displays elevation vs distance
   - Verify date range filtering works

2. **Velocity Trends**:
   - Select ammunition that has chrono data
   - Verify line chart displays velocity over time
   - Verify lot filter works

3. **Cost Analysis**:
   - Ensure some ammunition has `costPerRound` set
   - Verify monthly spending chart displays
   - Verify breakdowns by rifle and ammo work

4. **Ammo Comparison**:
   - Select 2-5 ammunition types with chrono data
   - Verify bar charts display comparison metrics

5. **Lot Comparison**:
   - Select ammunition that has multiple lots with chrono data
   - Verify lot comparison chart displays

---

## Notes

- The Overview/Summary section on the Analytics dashboard works correctly
- The issue is specifically with the detailed chart views
- Backend API is functional - issues are in iOS client API calls and/or model parsing
