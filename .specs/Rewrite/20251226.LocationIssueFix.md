# iOS "Failed to Load Locations" Bug Fix Specification

## Issue Summary

When starting a new session in the iOS app, the Location section displays "Failed to load locations" below the "Use Current Location" and "Browse Shared Locations" buttons. However, clicking "Use Current Location" works correctly.

## Root Cause Analysis

The iOS app expects a **paginated response** from the `/api/locations` endpoint, but the backend returns a **simple list response**.

### API Contract Mismatch

**What iOS expects:**
```json
{
  "success": true,
  "items": [...],
  "pagination": {
    "currentPage": 1,
    "pageSize": 100,
    "totalItems": 5,
    "totalPages": 1
  }
}
```

**What backend returns:**
```json
{
  "success": true,
  "data": [...]
}
```

### Code Flow

1. `LocationPicker.swift:232-234` - View appears and triggers `.task { await viewModel.loadSavedLocations() }`
2. `LocationPicker.swift:315-327` - `loadSavedLocations()` calls `locationService.getAllLocations()`
3. `LocationService.swift:95-108` - `getAllLocations()` calls `getLocations(page: currentPage, pageSize: 100)`
4. `LocationService.swift:42-48` - `getLocations()` uses `apiClient.requestPaginated(endpoint)`
5. `APIClient.swift` - `requestPaginated()` tries to decode response as `PaginatedResponse<T>`
6. **Decoding fails** because backend returns `ApiResponse<List<T>>` (uses `data` key, no `pagination` object)
7. Error caught in `LocationPicker.swift:321-323` - displays "Failed to load locations"

### Why "Use Current Location" Works

The GPS feature uses CoreLocation directly (`requestCurrentLocation()` at line 329-366) and does not depend on the locations API at all.

## Affected Files

### iOS App

| File | Lines | Issue |
|------|-------|-------|
| `LocationService.swift` | 42-48 | `getLocations()` calls `requestPaginated()` |
| `LocationService.swift` | 95-108 | `getAllLocations()` expects paginated response |
| `LocationPicker.swift` | 232-234 | Triggers load on view appear |
| `LocationPicker.swift` | 315-327 | `loadSavedLocations()` catches error |

### Backend

| File | Lines | Issue |
|------|-------|-------|
| `LocationsController.cs` | 32-36 | Returns `ApiResponse<List<LocationListDto>>` (non-paginated) |

## Solution Options

### Option A: Fix iOS to Handle Non-Paginated Response (Recommended)

Modify `LocationService.swift` to use `requestData` instead of `requestPaginated` since the backend returns a simple list.

**Changes needed:**
1. Update `getLocations()` to return `[LocationListItem]` instead of `PaginatedResponse<LocationListItem>`
2. Use `apiClient.requestData(endpoint)` instead of `apiClient.requestPaginated(endpoint)`
3. Simplify `getAllLocations()` to just call `getLocations()` directly (no pagination loop needed)

**Pros:**
- Minimal change, single file modification
- Matches current backend behavior
- Quick fix

**Cons:**
- If backend later adds pagination, iOS would need updating again

### Option B: Update Backend to Support Pagination

Modify `LocationsController.cs` to return paginated responses.

**Changes needed:**
1. Add pagination parameters (`page`, `pageSize`) to `GetLocations()` endpoint
2. Update `ILocationService.GetLocationsAsync()` to support pagination
3. Return `PaginatedResponse<LocationListDto>` instead of `ApiResponse<List<LocationListDto>>`

**Pros:**
- Consistent with other endpoints (Sessions, Rifles, Ammunition use pagination)
- Better scalability for users with many locations

**Cons:**
- More changes required
- Need to update tests

### Option C: Both (Future-Proof Solution)

1. First, apply Option A to fix the immediate issue
2. Later, implement Option B for consistency and scalability
3. Update iOS to use pagination when backend is ready

## Recommended Implementation: Option A

The quickest path to resolution is modifying the iOS app to match the backend's current behavior.

### Implementation Steps

#### Step 1: Update LocationService.swift

```swift
// BEFORE (lines 42-48)
func getLocations(
    page: Int = 1,
    pageSize: Int = Config.defaultPageSize
) async throws -> PaginatedResponse<LocationListItem> {
    let endpoint = Endpoints.Locations.list(page: page, pageSize: pageSize)
    return try await apiClient.requestPaginated(endpoint)
}

// AFTER
func getLocations() async throws -> [LocationListItem] {
    let endpoint = Endpoints.Locations.list(page: 1, pageSize: 100)
    return try await apiClient.requestData(endpoint)
}
```

#### Step 2: Simplify getAllLocations()

```swift
// BEFORE (lines 95-108)
func getAllLocations() async throws -> [LocationListItem] {
    var allLocations: [LocationListItem] = []
    var currentPage = 1
    var hasMore = true

    while hasMore {
        let response = try await getLocations(page: currentPage, pageSize: 100)
        allLocations.append(contentsOf: response.items)
        hasMore = response.hasNextPage
        currentPage += 1
    }

    return allLocations
}

// AFTER
func getAllLocations() async throws -> [LocationListItem] {
    return try await getLocations()
}
```

#### Step 3: Update Protocol

```swift
// BEFORE (line 9)
func getLocations(page: Int, pageSize: Int) async throws -> PaginatedResponse<LocationListItem>

// AFTER
func getLocations() async throws -> [LocationListItem]
```

#### Step 4: Update any tests that mock LocationService

Check and update:
- `TrueDope-iOS/TrueDope-iOSTests/Services/LocationServiceTests.swift`

## Testing Plan

1. **Build iOS app** - Verify no compilation errors
2. **Launch app and navigate to "New Session"** - Error message should no longer appear
3. **Verify "My Locations" dropdown** - Should show user's saved locations if any exist
4. **Verify "Use Current Location"** - Should still work (unchanged)
5. **Verify "Browse Shared Locations"** - Should still work (unchanged)
6. **Create a session with each location type** - All should save correctly

## Files to Modify

1. `TrueDope-iOS/TrueDope-iOS/Core/Services/LocationService.swift`
2. `TrueDope-iOS/TrueDope-iOSTests/Services/LocationServiceTests.swift` (if needed)

## Estimated Effort

- **Option A (Recommended):** ~30 minutes including testing
- **Option B:** ~2 hours including backend changes and testing
- **Option C:** ~2.5 hours total
