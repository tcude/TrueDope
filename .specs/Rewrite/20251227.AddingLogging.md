# Adding Enterprise File Logging with Splunk Integration

**Date:** 2025-12-27
**Status:** Implemented
**Goal:** Configure TrueDope backend to write structured log files with rotation, enabling Splunk ingestion on the production VM.

---

## Implementation Summary

We implemented enterprise-grade logging for the TrueDope backend with the following capabilities:

### What Was Built

| Feature | Description |
|---------|-------------|
| **File-based logging** | Logs written to `/var/log/truedope/` with daily rotation, 30-day retention, and 50MB size limits |
| **Splunk integration** | Logs mounted to host filesystem for Splunk Universal Forwarder ingestion |
| **User tracking** | Every log entry includes the authenticated user's ID (or "anonymous") |
| **Request correlation** | Unique correlation ID links all logs from a single HTTP request |
| **Client IP logging** | Source IP captured for security analysis |
| **Request context** | HTTP method and path included on every log line |

### Log Output Format

```
2025-12-27 15:45:23.456 -06:00 [INF] [0HN8QJKL:00000001] [16c68796-8544-4b54-a78b-167249643b07] [192.168.1.100] GET /api/rifles Fetched 5 rifles
```

### Key Splunk Queries

```spl
# All errors
index=truedope_log "[ERR]"

# Activity by specific user
index=truedope_log "16c68796-8544-4b54-a78b-167249643b07"

# Trace a single request end-to-end
index=truedope_log "0HN8QJKL:00000001"

# Requests from specific IP
index=truedope_log "192.168.1.100"

# All POST requests
index=truedope_log "POST"
```

### Files Changed

| File | Change |
|------|--------|
| `TrueDope.Api.csproj` | Added Serilog.Sinks.File package |
| `Program.cs` | Configured file logging with enriched output template |
| `Middleware/UserLoggingMiddleware.cs` | New middleware for request context enrichment |
| `docker-compose.yml` | Added logs volume mount |

---

## Original Plan

### Overview

Previously, the TrueDope backend used Serilog but only wrote logs to the console (stdout). Docker captures these logs, but they're mixed with other containers on the host and not easily accessible for Splunk.

This plan adds file-based logging with daily rotation, size limits, and retention policies - the standard enterprise approach for log management.

---

## Implementation Steps

### Step 1: Add Serilog File Sink Package

**File:** `TrueDope/backend/src/TrueDope.Api/TrueDope.Api.csproj`

Add the Serilog file sink NuGet package:

```xml
<PackageReference Include="Serilog.Sinks.File" Version="5.0.0" />
```

---

### Step 2: Update Serilog Configuration

**File:** `TrueDope/backend/src/TrueDope.Api/Program.cs`

Update the logger configuration (lines 17-24) to add file logging:

```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
    .MinimumLevel.Override("Microsoft.Hosting.Lifetime", LogEventLevel.Information)
    .MinimumLevel.Override("Microsoft.AspNetCore.Hosting", LogEventLevel.Information)
    .Enrich.FromLogContext()
    .WriteTo.Console(outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}")
    .WriteTo.File(
        path: "/var/log/truedope/truedope-.log",
        rollingInterval: RollingInterval.Day,
        retainedFileCountLimit: 30,
        fileSizeLimitBytes: 50 * 1024 * 1024, // 50MB per file
        rollOnFileSizeLimit: true,
        outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {SourceContext} {Message:lj}{NewLine}{Exception}")
    .CreateLogger();
```

**Configuration explained:**
- `path: "/var/log/truedope/truedope-.log"` - Log file path inside container; the `-` before `.log` is where the date gets inserted
- `rollingInterval: RollingInterval.Day` - Creates new file daily (e.g., `truedope-20251227.log`)
- `retainedFileCountLimit: 30` - Keeps 30 days of logs, auto-deletes older
- `fileSizeLimitBytes: 50MB` - Maximum size per log file
- `rollOnFileSizeLimit: true` - Creates new file if size limit reached within a day
- `outputTemplate` - Structured format with full timestamp, level, source context, and message

---

### Step 3: Mount Log Directory in Docker Compose

**File:** `TrueDope/docker-compose.yml`

Add a volume mount to the backend service to persist logs on the host:

```yaml
backend:
  build:
    context: ./backend
    dockerfile: Dockerfile
  ports:
    - "8080:80"
  depends_on:
    - db
    - minio
    - redis
  environment:
    # ... existing environment variables ...
  volumes:
    - ./logs:/var/log/truedope
  networks:
    - truedope-network
  restart: unless-stopped
```

This maps the container's `/var/log/truedope` directory to `./logs` on the host (which becomes `/home/tcude/docker/TrueDope/logs` on the prod VM).

---

### Step 4: Configure Splunk Universal Forwarder

**On the production VM (`docker-external01`):**

Edit `/opt/splunkforwarder/etc/system/local/inputs.conf` and add:

```ini
[monitor:///home/tcude/docker/TrueDope/logs]
index = truedope_log
sourcetype = truedope:backend
disabled = false
```

**Note:** Ensure the `truedope_log` index exists on your Splunk indexer, or use an existing index like `main`.

---

### Step 5: Restart Services

After deploying changes:

```bash
# On prod VM - rebuild and restart containers
cd /home/tcude/docker/TrueDope
docker compose down
docker compose build backend
docker compose up -d

# Restart Splunk forwarder
sudo /opt/splunkforwarder/bin/splunk restart
```

---

## Verification

### Verify logs are being written:

```bash
# Check log directory exists and has files
ls -la /home/tcude/docker/TrueDope/logs

# Tail the current log file
tail -f /home/tcude/docker/TrueDope/logs/truedope-$(date +%Y%m%d).log
```

### Verify Splunk is monitoring:

```bash
# Check Splunk forwarder status
sudo /opt/splunkforwarder/bin/splunk list monitor

# Check for any errors
sudo tail -f /opt/splunkforwarder/var/log/splunk/splunkd.log
```

### Search in Splunk:

```
index=truedope_log sourcetype=truedope:backend
```

---

## Log File Naming Convention

Serilog will create files with this pattern:
- `truedope-20251227.log` - Daily log file
- `truedope-20251227_001.log` - If first file exceeds 50MB
- `truedope-20251227_002.log` - Additional rolls within same day

Files older than 30 days are automatically deleted.

---

## Future Considerations

1. **JSON Logging for Splunk** - Consider switching to JSON output format for better field extraction in Splunk:
   ```csharp
   .WriteTo.File(
       new JsonFormatter(),
       path: "/var/log/truedope/truedope-.json",
       // ... other options
   )
   ```

2. **Separate Log Files** - Could create separate files for different log levels:
   - `truedope-error-.log` for errors only
   - `truedope-info-.log` for info and above

3. **Request Logging** - The app already uses `UseSerilogRequestLogging()` which logs HTTP requests. Consider adding custom enrichers for user ID, correlation ID, etc.

4. **Frontend Logging** - Consider adding a logging endpoint for the React frontend to send client-side errors to the same log infrastructure.

---

## Git Ignore

The `logs/` directory and `*.log` files are already ignored in `TrueDope/.gitignore` (lines 35-37):

```gitignore
# Logs
*.log
logs/
```

No changes needed - log files will not be committed to source control.

---

## Files Modified

| File | Change |
|------|--------|
| `TrueDope/backend/src/TrueDope.Api/TrueDope.Api.csproj` | Add Serilog.Sinks.File package |
| `TrueDope/backend/src/TrueDope.Api/Program.cs` | Update Serilog configuration |
| `TrueDope/docker-compose.yml` | Add logs volume mount |
| `/opt/splunkforwarder/etc/system/local/inputs.conf` (on prod VM) | Add TrueDope log monitor |
