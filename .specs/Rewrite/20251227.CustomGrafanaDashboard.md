# TrueDope Custom Grafana Dashboard - Step-by-Step Guide

**Date:** 2025-12-27
**Purpose:** Create a comprehensive "TrueDope Overview" dashboard in Grafana
**Grafana URL:** `http://monitoring01.tcudelocal.net:3000`
**Data Source:** `TrueDope Prometheus` (docker-external01:9090)

---

## Prerequisites

Before starting, verify:
1. Grafana is accessible at `monitoring01.tcudelocal.net:3000`
2. "TrueDope Prometheus" data source is configured and working
3. Backend metrics are being scraped (check `http://docker-external01:9090/targets`)

---

## Step 1: Create the Dashboard

1. Log into Grafana at `http://monitoring01.tcudelocal.net:3000`
2. Click the **+** icon in the left sidebar
3. Select **Dashboard**
4. Click the **gear icon** (⚙️) in the top right for Dashboard Settings
5. Configure:
   - **Name:** `TrueDope Overview`
   - **Description:** `Application health, business metrics, and infrastructure monitoring for TrueDope`
   - **Folder:** Choose or create a folder (e.g., "TrueDope")
   - **Tags:** Add `truedope`, `application`, `monitoring`
6. Click **Save dashboard**

---

## Step 2: Add Dashboard Variables (Optional but Recommended)

Variables make the dashboard more flexible.

1. In Dashboard Settings, click **Variables** in the left sidebar
2. Click **Add variable**

### Variable: Time Range Multiplier
- **Name:** `rate_interval`
- **Type:** Custom
- **Values:** `1m,5m,15m,30m,1h`
- **Default:** `5m`
- **Label:** `Rate Interval`

This allows you to adjust the smoothing for rate() queries across all panels.

3. Click **Add** then **Save dashboard**

---

## Step 3: Row 1 - Application Health

This row provides at-a-glance health metrics using Stat panels.

### Create the Row

1. Click **Add** → **Row**
2. Click on the row title and rename it to **Application Health**
3. Click the row to expand it

### Panel 1: Request Rate

1. Click **Add** → **Visualization**
2. Select **Stat** visualization
3. In the Query section:
   - **Data source:** `TrueDope Prometheus`
   - **Query A:**
   ```promql
   sum(rate(http_requests_received_total{job="truedope-backend"}[$rate_interval]))
   ```
4. Panel options (right sidebar):
   - **Title:** `Request Rate`
   - **Description:** `HTTP requests per second`
5. Stat styles:
   - **Unit:** `requests/sec` (under Standard options → Unit)
   - **Color mode:** `Background Gradient`
   - **Graph mode:** `Area`
6. Thresholds:
   - Keep default (no specific thresholds needed for request rate)
7. Click **Apply**

### Panel 2: Error Rate

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   (sum(rate(http_requests_received_total{job="truedope-backend",code=~"5.."}[$rate_interval])) / sum(rate(http_requests_received_total{job="truedope-backend"}[$rate_interval]))) * 100
   ```
3. Panel options:
   - **Title:** `Error Rate`
   - **Description:** `Percentage of 5xx responses`
4. Stat styles:
   - **Unit:** `percent (0-100)`
   - **Color mode:** `Background Gradient`
   - **Graph mode:** `Area`
   - **Decimals:** `2`
5. Thresholds (click + to add):
   - Base: Green
   - `1`: Yellow (warning starts at 1%)
   - `5`: Red (critical at 5%)
6. Value mappings (optional):
   - Add: `NaN` → `0%` (when there's no traffic)
7. Click **Apply**

### Panel 3: P95 Latency

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[$rate_interval])) by (le)) * 1000
   ```
3. Panel options:
   - **Title:** `P95 Latency`
   - **Description:** `95th percentile response time`
4. Stat styles:
   - **Unit:** `milliseconds (ms)`
   - **Color mode:** `Background Gradient`
   - **Graph mode:** `Area`
   - **Decimals:** `0`
5. Thresholds:
   - Base: Green
   - `200`: Yellow (warning at 200ms)
   - `500`: Red (critical at 500ms)
6. Click **Apply**

### Panel 4: In-Flight Requests

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   sum(http_requests_in_progress{job="truedope-backend"})
   ```
3. Panel options:
   - **Title:** `In-Flight Requests`
   - **Description:** `Currently processing requests`
4. Stat styles:
   - **Unit:** `none`
   - **Color mode:** `Background Gradient`
   - **Graph mode:** `Area`
5. Thresholds:
   - Base: Green
   - `50`: Yellow
   - `100`: Red
6. Click **Apply**

### Arrange Row 1

1. Drag panels to arrange them in a single row
2. Resize each panel to equal width (approximately 6 units each for 4 panels)
3. Save the dashboard (Ctrl+S)

---

## Step 4: Row 2 - Business Metrics

### Create the Row

1. Click **Add** → **Row**
2. Rename to **Business Metrics (24h)**

### Panel 1: Sessions Today

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   sum(increase(truedope_sessions_created_total[24h]))
   ```
3. Panel options:
   - **Title:** `Sessions Today`
   - **Description:** `Shooting sessions created in last 24 hours`
4. Stat styles:
   - **Unit:** `none`
   - **Color mode:** `Value`
   - **Color:** Blue
   - **Decimals:** `0`
5. Click **Apply**

### Panel 2: DOPE Entries Today

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   sum(increase(truedope_dope_entries_created_total[24h]))
   ```
3. Panel options:
   - **Title:** `DOPE Entries`
   - **Description:** `DOPE entries logged in last 24 hours`
4. Stat styles:
   - **Unit:** `none`
   - **Color mode:** `Value`
   - **Color:** Purple
   - **Decimals:** `0`
5. Click **Apply**

### Panel 3: Successful Logins

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   sum(increase(truedope_logins_successful_total[24h]))
   ```
3. Panel options:
   - **Title:** `Logins Today`
   - **Description:** `Successful authentications in last 24 hours`
4. Stat styles:
   - **Unit:** `none`
   - **Color mode:** `Value`
   - **Color:** Green
   - **Decimals:** `0`
5. Click **Apply**

### Panel 4: Failed Logins (Security Indicator)

1. Click **Add** → **Visualization** → **Stat**
2. Query:
   ```promql
   sum(increase(truedope_logins_failed_total[24h]))
   ```
3. Panel options:
   - **Title:** `Failed Logins`
   - **Description:** `Failed login attempts (watch for brute force)`
4. Stat styles:
   - **Unit:** `none`
   - **Color mode:** `Background Gradient`
   - **Decimals:** `0`
5. Thresholds:
   - Base: Green
   - `10`: Yellow (some failures normal)
   - `50`: Orange
   - `100`: Red (possible brute force)
6. Click **Apply**

### Arrange Row 2

1. Arrange panels in a row, equal widths
2. Save dashboard

---

## Step 5: Row 3 - Traffic Over Time

### Create the Row

1. Click **Add** → **Row**
2. Rename to **Traffic Analysis**

### Panel 1: Requests by Status Code

1. Click **Add** → **Visualization** → **Time series**
2. Query:
   ```promql
   sum by (code) (rate(http_requests_received_total{job="truedope-backend"}[$rate_interval]))
   ```
3. Panel options:
   - **Title:** `Requests by Status Code`
   - **Description:** `Request rate grouped by HTTP status code`
4. Legend:
   - **Mode:** Table
   - **Placement:** Right
   - **Values:** Last, Mean
5. Standard options:
   - **Unit:** `requests/sec`
6. Series overrides (optional - for consistent coloring):
   - Click **Overrides** → **Add field override** → **Fields with name**
   - `200`: Green
   - `201`: Light Green
   - `400`: Yellow
   - `401`: Orange
   - `404`: Light Orange
   - `500`: Red
7. Click **Apply**

### Panel 2: Requests by Controller

1. Click **Add** → **Visualization** → **Time series**
2. Query:
   ```promql
   sum by (controller) (rate(http_requests_received_total{job="truedope-backend"}[$rate_interval]))
   ```
3. Panel options:
   - **Title:** `Requests by Controller`
   - **Description:** `Traffic distribution across API endpoints`
4. Legend:
   - **Mode:** Table
   - **Placement:** Right
   - **Values:** Last, Mean
5. Standard options:
   - **Unit:** `requests/sec`
6. Click **Apply**

### Arrange Row 3

1. Make each panel half width (12 units each)
2. Save dashboard

---

## Step 6: Row 4 - Latency Percentiles

### Create the Row

1. Click **Add** → **Row**
2. Rename to **Response Time Analysis**

### Panel 1: Latency Percentiles Over Time

1. Click **Add** → **Visualization** → **Time series**
2. Add THREE queries:

**Query A (P50):**
```promql
histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[$rate_interval])) by (le))
```
- **Legend:** `p50 (median)`

**Query B (P95):**
```promql
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[$rate_interval])) by (le))
```
- **Legend:** `p95`

**Query C (P99):**
```promql
histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[$rate_interval])) by (le))
```
- **Legend:** `p99`

3. Panel options:
   - **Title:** `Response Time Percentiles`
   - **Description:** `p50, p95, and p99 latency over time`
4. Standard options:
   - **Unit:** `seconds`
5. Legend:
   - **Mode:** Table
   - **Placement:** Bottom
   - **Values:** Last, Mean, Max
6. Click **Apply**

### Panel 2: Slowest Endpoints

1. Click **Add** → **Visualization** → **Bar gauge**
2. Query:
   ```promql
   topk(10, avg by (controller, action) (rate(http_request_duration_seconds_sum{job="truedope-backend"}[5m]) / rate(http_request_duration_seconds_count{job="truedope-backend"}[5m])))
   ```
3. Panel options:
   - **Title:** `Slowest Endpoints`
   - **Description:** `Average response time by endpoint`
4. Bar gauge options:
   - **Orientation:** Horizontal
   - **Display mode:** Gradient
5. Standard options:
   - **Unit:** `seconds`
   - **Min:** `0`
   - **Max:** `1` (or leave auto)
6. Thresholds:
   - Base: Green
   - `0.2`: Yellow (200ms)
   - `0.5`: Red (500ms)
7. Click **Apply**

### Arrange Row 4

1. Latency percentiles: 16 units wide
2. Slowest endpoints: 8 units wide
3. Save dashboard

---

## Step 7: Row 5 - Business Activity Over Time

### Create the Row

1. Click **Add** → **Row**
2. Rename to **Business Activity**

### Panel 1: Data Creation Activity

1. Click **Add** → **Visualization** → **Time series**
2. Add FOUR queries:

**Query A (Sessions):**
```promql
increase(truedope_sessions_created_total[1h])
```
- **Legend:** `Sessions`

**Query B (DOPE Entries):**
```promql
increase(truedope_dope_entries_created_total[1h])
```
- **Legend:** `DOPE Entries`

**Query C (Chrono Sessions):**
```promql
increase(truedope_chrono_sessions_created_total[1h])
```
- **Legend:** `Chrono Sessions`

**Query D (Groups):**
```promql
increase(truedope_group_entries_created_total[1h])
```
- **Legend:** `Groups`

3. Panel options:
   - **Title:** `Data Creation Activity`
   - **Description:** `Hourly data creation across entity types`
4. Graph styles:
   - **Style:** Lines
   - **Line interpolation:** Smooth
   - **Fill opacity:** 20
5. Legend:
   - **Mode:** Table
   - **Placement:** Right
   - **Values:** Last, Total
6. Click **Apply**

### Panel 2: Authentication Activity

1. Click **Add** → **Visualization** → **Time series**
2. Add THREE queries:

**Query A (Successful Logins):**
```promql
increase(truedope_logins_successful_total[1h])
```
- **Legend:** `Successful Logins`

**Query B (Failed Logins):**
```promql
increase(truedope_logins_failed_total[1h])
```
- **Legend:** `Failed Logins`

**Query C (Registrations):**
```promql
increase(truedope_registrations_total[1h])
```
- **Legend:** `Registrations`

3. Panel options:
   - **Title:** `Authentication Activity`
   - **Description:** `Hourly auth events`
4. Series overrides:
   - `Successful Logins`: Green
   - `Failed Logins`: Red
   - `Registrations`: Blue
5. Click **Apply**

### Panel 3: Equipment Creation (Optional)

1. Click **Add** → **Visualization** → **Time series**
2. Add THREE queries:

**Query A:**
```promql
increase(truedope_rifles_created_total[24h])
```
- **Legend:** `Rifles`

**Query B:**
```promql
increase(truedope_ammunition_created_total[24h])
```
- **Legend:** `Ammunition`

**Query C:**
```promql
increase(truedope_locations_created_total[24h])
```
- **Legend:** `Locations`

3. Panel options:
   - **Title:** `Equipment Creation (24h rolling)`
4. Click **Apply**

### Arrange Row 5

1. Data Creation: 8 units
2. Authentication: 8 units
3. Equipment: 8 units
4. Save dashboard

---

## Step 8: Row 6 - Infrastructure

### Create the Row

1. Click **Add** → **Row**
2. Rename to **Infrastructure**

### Panel 1: PostgreSQL Connections

1. Click **Add** → **Visualization** → **Time series**
2. Query:
   ```promql
   pg_stat_activity_count{job="postgres"}
   ```
3. Panel options:
   - **Title:** `PostgreSQL Active Connections`
4. Standard options:
   - **Unit:** `none`
5. Thresholds:
   - Base: Green
   - `80`: Yellow (nearing limit)
   - `95`: Red (near max)
6. Click **Apply**

### Panel 2: Redis Memory Usage

1. Click **Add** → **Visualization** → **Time series**
2. Query:
   ```promql
   redis_memory_used_bytes{job="redis"}
   ```
3. Panel options:
   - **Title:** `Redis Memory Usage`
4. Standard options:
   - **Unit:** `bytes (IEC)` (will show as MiB/GiB)
5. Click **Apply**

### Panel 3: Backend Process Memory

1. Click **Add** → **Visualization** → **Time series**
2. Query:
   ```promql
   process_working_set_bytes{job="truedope-backend"}
   ```
3. Panel options:
   - **Title:** `Backend Memory Usage`
   - **Description:** `.NET process working set`
4. Standard options:
   - **Unit:** `bytes (IEC)`
5. Click **Apply**

### Panel 4: .NET GC Collections (Optional)

1. Click **Add** → **Visualization** → **Time series**
2. Query:
   ```promql
   rate(dotnet_collection_count_total{job="truedope-backend"}[$rate_interval])
   ```
3. Panel options:
   - **Title:** `GC Collections/sec`
4. Legend format: `Gen {{generation}}`
5. Click **Apply**

### Arrange Row 6

1. PostgreSQL: 6 units
2. Redis: 6 units
3. Backend Memory: 6 units
4. GC Collections: 6 units
5. Save dashboard

---

## Step 9: Final Dashboard Settings

### Set Default Time Range

1. In the dashboard, set the time picker to **Last 6 hours**
2. Click the time picker dropdown
3. Select **Last 6 hours**
4. Save dashboard with **Save current time range as dashboard default** checked

### Set Auto-Refresh

1. Click the refresh dropdown (top right, next to time picker)
2. Select **30s** for auto-refresh
3. Save dashboard

### Add Dashboard Links (Optional)

1. Dashboard Settings → **Links**
2. Add links to related dashboards:
   - ASP.NET Core dashboard (ID 10915)
   - PostgreSQL dashboard (ID 9628)
   - Redis dashboard (ID 763)

### Add Annotations (Optional)

1. Dashboard Settings → **Annotations**
2. Add deployment annotations if you have them

---

## Step 10: Export and Backup

### Export Dashboard JSON

1. Dashboard Settings → **JSON Model**
2. Copy the entire JSON
3. Save to: `TrueDope/.grafana/dashboards/truedope-overview.json`

Or use the Grafana API:
```bash
curl -H "Authorization: Bearer YOUR_API_KEY" \
  "http://monitoring01.tcudelocal.net:3000/api/dashboards/uid/DASHBOARD_UID" \
  | jq '.dashboard' > truedope-overview.json
```

---

## Quick Reference: All PromQL Queries

### Application Health
```promql
# Request Rate
sum(rate(http_requests_received_total{job="truedope-backend"}[5m]))

# Error Rate (%)
(sum(rate(http_requests_received_total{job="truedope-backend",code=~"5.."}[5m])) / sum(rate(http_requests_received_total{job="truedope-backend"}[5m]))) * 100

# P95 Latency (ms)
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le)) * 1000

# In-Flight Requests
sum(http_requests_in_progress{job="truedope-backend"})
```

### Business Metrics (24h)
```promql
# Sessions Created
sum(increase(truedope_sessions_created_total[24h]))

# DOPE Entries
sum(increase(truedope_dope_entries_created_total[24h]))

# Successful Logins
sum(increase(truedope_logins_successful_total[24h]))

# Failed Logins
sum(increase(truedope_logins_failed_total[24h]))
```

### Traffic Analysis
```promql
# By Status Code
sum by (code) (rate(http_requests_received_total{job="truedope-backend"}[5m]))

# By Controller
sum by (controller) (rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

### Latency
```promql
# P50
histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))

# P95
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))

# P99
histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))

# Slowest Endpoints
topk(10, avg by (controller, action) (rate(http_request_duration_seconds_sum{job="truedope-backend"}[5m]) / rate(http_request_duration_seconds_count{job="truedope-backend"}[5m])))
```

### Business Activity
```promql
# Data Creation (hourly)
increase(truedope_sessions_created_total[1h])
increase(truedope_dope_entries_created_total[1h])
increase(truedope_chrono_sessions_created_total[1h])
increase(truedope_group_entries_created_total[1h])

# Auth Activity (hourly)
increase(truedope_logins_successful_total[1h])
increase(truedope_logins_failed_total[1h])
increase(truedope_registrations_total[1h])
```

### Infrastructure
```promql
# PostgreSQL Connections
pg_stat_activity_count{job="postgres"}

# Redis Memory
redis_memory_used_bytes{job="redis"}

# Backend Memory
process_working_set_bytes{job="truedope-backend"}

# GC Collections
rate(dotnet_collection_count_total{job="truedope-backend"}[5m])
```

---

## Bonus: Additional Useful Panels

### Login Success Rate
```promql
sum(rate(truedope_logins_successful_total[1h])) / (sum(rate(truedope_logins_successful_total[1h])) + sum(rate(truedope_logins_failed_total[1h]))) * 100
```
- Unit: percent
- Title: "Login Success Rate"

### Images Uploaded by Type
```promql
sum by (parent_type) (increase(truedope_images_uploaded_total[24h]))
```
- Visualization: Pie chart
- Title: "Images by Parent Type (24h)"

### Total Image Storage Uploaded
```promql
sum(increase(truedope_image_bytes_uploaded_total[7d]))
```
- Unit: bytes (IEC)
- Title: "Image Data Uploaded (7 days)"

### API Endpoint Heatmap
```promql
sum by (controller, action) (increase(http_requests_received_total{job="truedope-backend"}[1h]))
```
- Visualization: Heatmap or Table
- Title: "Endpoint Usage Heatmap"

---

## Troubleshooting

### No Data Showing

1. **Check data source:** Settings → Data Sources → TrueDope Prometheus → Save & Test
2. **Verify job name:** Run `up{job="truedope-backend"}` in Explore - should return 1
3. **Check time range:** Ensure the selected time range has data
4. **Verify metrics exist:** Run the raw metric name in Explore

### NaN or Infinite Values

For division queries (like error rate), add handling for zero denominators:
```promql
# Error rate with NaN protection
(sum(rate(http_requests_received_total{job="truedope-backend",code=~"5.."}[5m])) or vector(0)) / (sum(rate(http_requests_received_total{job="truedope-backend"}[5m])) > 0) * 100
```

### Rate Showing 0

- Ensure the time range is longer than the rate interval
- Check that the counter has actually incremented
- Use `increase()` instead of `rate()` for low-traffic metrics

---

## Summary

You now have a comprehensive TrueDope Overview dashboard with:

| Row | Content | Panel Count |
|-----|---------|-------------|
| 1 | Application Health | 4 Stat panels |
| 2 | Business Metrics (24h) | 4 Stat panels |
| 3 | Traffic Analysis | 2 Time series |
| 4 | Latency Analysis | 2 panels (Time series + Bar gauge) |
| 5 | Business Activity | 3 Time series |
| 6 | Infrastructure | 4 Time series |

**Total:** ~19 panels across 6 rows

This dashboard provides visibility into application health, user activity, and infrastructure status at a glance.
