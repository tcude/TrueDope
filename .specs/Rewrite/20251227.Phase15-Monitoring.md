# Phase 15: Monitoring and Observability with Grafana

**Date:** 2025-12-27
**Status:** Complete (Phases 15a-15d)
**Goal:** Add comprehensive application and infrastructure monitoring to TrueDope using Prometheus metrics, visualized in the existing Grafana instance on `monitoring01.tcudelocal.net`.

---

## Environment Strategy

**Single Docker Compose File:** Prometheus and exporters run in all environments, configured via `.env` variables. This keeps deployment simple while allowing environment-specific tuning.

| Environment | Retention | Grafana | Notes |
|-------------|-----------|---------|-------|
| **Development** | 30 days, 10GB | Not connected | Data stays local, useful for debugging |
| **Production** | 365 days, 50GB | Connected to `docker-external01:9090` | Long-term metrics storage |

**Configuration via `.env`:**
```bash
# Dev defaults (in .env.example)
PROMETHEUS_RETENTION_TIME=30d
PROMETHEUS_RETENTION_SIZE=10GB

# Prod settings (set in prod .env)
PROMETHEUS_RETENTION_TIME=365d
PROMETHEUS_RETENTION_SIZE=50GB
```

The monitoring stack overhead is minimal, and having Prometheus locally can help debug performance issues during development.

---

## Overview

### Current State
- **Logging:** Structured file logging with Splunk integration (see `20251227.AddingLogging.md`)
- **Monitoring:** Grafana + InfluxDB running on `monitoring01.tcudelocal.net:3000`
- **Gap:** No application metrics, no visibility into request rates, latencies, or error rates

### Target State
- Prometheus metrics exposed from TrueDope backend
- Infrastructure exporters for PostgreSQL, Redis, and Docker
- Grafana dashboards showing application health, performance, and business metrics
- Long-term metric retention (1+ year)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│  docker-external01 (TrueDope host)                                  │
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │  TrueDope       │  │  PostgreSQL     │  │  Redis          │      │
│  │  Backend        │  │                 │  │                 │      │
│  │  :80/metrics    │  │  :5432          │  │  :6379          │      │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘      │
│           │                    │                    │               │
│           │           ┌────────┴────────┐  ┌───────┴────────┐       │
│           │           │ postgres-       │  │ redis-         │       │
│           │           │ exporter :9187  │  │ exporter :9121 │       │
│           │           └────────┬────────┘  └───────┬────────┘       │
│           │                    │                   │                │
│  ┌────────┴────────────────────┴───────────────────┴───────────┐    │
│  │                     Prometheus :9090                         │    │
│  │                     (scrapes all targets)                    │    │
│  └──────────────────────────────┬──────────────────────────────┘    │
│                                 │                                   │
└─────────────────────────────────┼───────────────────────────────────┘
                                  │ :9090 exposed
                                  │
┌─────────────────────────────────┼───────────────────────────────────┐
│  monitoring01.tcudelocal.net    │                                   │
│                                 ▼                                   │
│  ┌─────────────────┐    ┌─────────────────┐                         │
│  │    Grafana      │◄───│   InfluxDB      │ (existing, for infra)   │
│  │    :3000        │    │   :8086         │                         │
│  │                 │◄─────────────────────┘                         │
│  │                 │◄─── Prometheus data source                     │
│  └─────────────────┘     (docker-external01:9090)                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Implementation Phases

### Phase 15a: Backend Prometheus Metrics
Add native .NET metrics to the TrueDope backend.

### Phase 15b: Prometheus + Exporters
Deploy Prometheus and database/cache exporters to the TrueDope stack.

### Phase 15c: Grafana Integration
Configure Grafana data source and import dashboards.

### Phase 15d: Custom Business Metrics
Add TrueDope-specific counters and gauges.

---

## Phase 15a: Backend Prometheus Metrics

### Step 1: Add NuGet Package

**File:** `TrueDope/backend/src/TrueDope.Api/TrueDope.Api.csproj`

```xml
<PackageReference Include="prometheus-net.AspNetCore" Version="8.2.1" />
```

### Step 2: Configure Metrics Middleware

**File:** `TrueDope/backend/src/TrueDope.Api/Program.cs`

Add after the existing middleware configuration:

```csharp
using Prometheus;

// ... existing code ...

// Add after app.UseAuthorization()
app.UseHttpMetrics(options =>
{
    options.AddCustomLabel("host", context => context.Request.Host.Host);
});

// Add before app.MapControllers()
app.MapMetrics();  // Exposes GET /metrics
```

### Step 3: Verify Metrics Endpoint

After deploying, verify metrics are exposed:

```bash
curl http://localhost:8080/metrics
```

Expected output includes:
```
# HELP http_requests_received_total Total number of HTTP requests received
# TYPE http_requests_received_total counter
http_requests_received_total{code="200",method="GET",controller="Rifles",action="GetAll"} 42

# HELP http_request_duration_seconds Duration of HTTP requests in seconds
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{code="200",method="GET",controller="Rifles",action="GetAll",le="0.1"} 40
```

### Metrics Automatically Provided

| Metric | Type | Description |
|--------|------|-------------|
| `http_requests_received_total` | Counter | Total requests by method, controller, action, status code |
| `http_request_duration_seconds` | Histogram | Request latency distribution |
| `http_requests_in_progress` | Gauge | Currently executing requests |
| `dotnet_total_memory_bytes` | Gauge | Total .NET memory allocated |
| `dotnet_collection_count_total` | Counter | GC collection counts by generation |
| `process_cpu_seconds_total` | Counter | Total CPU time consumed |
| `process_working_set_bytes` | Gauge | Process memory usage |

---

## Phase 15b: Prometheus + Exporters

### Step 1: Create Prometheus Configuration

**File:** `TrueDope/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # TrueDope Backend
  - job_name: 'truedope-backend'
    static_configs:
      - targets: ['backend:80']
    metrics_path: /metrics
    scrape_interval: 10s

  # PostgreSQL Exporter
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

### Step 2: Update Docker Compose

**File:** `TrueDope/docker-compose.yml`

Add these services:

```yaml
  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:latest
    container_name: truedope-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=365d'
      - '--storage.tsdb.retention.size=50GB'
      - '--web.enable-lifecycle'
    networks:
      - truedope-network
    restart: unless-stopped

  # PostgreSQL Exporter
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: truedope-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${DB_USER:-truedope}:${DB_PASSWORD:-truedope}@db:5432/${DB_NAME:-truedope}?sslmode=disable"
    networks:
      - truedope-network
    depends_on:
      - db
    restart: unless-stopped

  # Redis Exporter
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: truedope-redis-exporter
    environment:
      REDIS_ADDR: "redis://redis:6379"
    networks:
      - truedope-network
    depends_on:
      - redis
    restart: unless-stopped
```

Add to the `volumes` section at the bottom:

```yaml
volumes:
  postgres_data:
  minio_data:
  redis_data:
  prometheus_data:  # Add this line
```

### Prometheus Retention Configuration

The configuration above sets:
- `--storage.tsdb.retention.time=365d` - Keep metrics for 1 year
- `--storage.tsdb.retention.size=50GB` - Cap storage at 50GB (whichever limit hits first)

Adjust these values based on your storage capacity.

---

## Phase 15c: Grafana Integration

### Step 1: Add Prometheus Data Source

On `monitoring01.tcudelocal.net:3000`:

1. Navigate to **Configuration → Data Sources → Add data source**
2. Select **Prometheus**
3. Configure:
   - **Name:** `TrueDope Prometheus`
   - **URL:** `http://docker-external01:9090`
   - **Access:** Server (default)
   - **Scrape interval:** `15s`
4. Click **Save & Test**

### Step 2: Import Pre-built Dashboards

| Dashboard | Grafana ID | Purpose |
|-----------|------------|---------|
| ASP.NET Core | `10915` | Application metrics (requests, latency, errors) |
| .NET Runtime | `13532` | GC, thread pool, memory |
| PostgreSQL | `9628` | Database connections, query performance |
| Redis | `763` | Memory usage, commands, connections |

To import:
1. **Dashboards → Import**
2. Enter the Grafana ID
3. Select `TrueDope Prometheus` as the data source
4. Click **Import**

### Step 3: Create TrueDope Overview Dashboard

Create a custom dashboard with these panels:

#### Row 1: Key Metrics (Stat panels)

**Request Rate (requests/sec)**
```promql
sum(rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

**Average Latency (ms)**
```promql
histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le)) * 1000
```

**Error Rate (%)**
```promql
sum(rate(http_requests_received_total{job="truedope-backend",code=~"5.."}[5m])) / sum(rate(http_requests_received_total{job="truedope-backend"}[5m])) * 100
```

**Requests In Progress**
```promql
sum(http_requests_in_progress{job="truedope-backend"})
```

#### Row 2: Request Rate Over Time (Time series)

**Requests by Status Code**
```promql
sum by (code) (rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

**Requests by Endpoint**
```promql
sum by (controller) (rate(http_requests_received_total{job="truedope-backend"}[5m]))
```

#### Row 3: Latency (Time series)

**Response Time Percentiles**
```promql
histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))
histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))
```

#### Row 4: Infrastructure (Gauge/Time series)

**PostgreSQL Connections**
```promql
pg_stat_activity_count{job="postgres"}
```

**Redis Memory**
```promql
redis_memory_used_bytes{job="redis"}
```

**Process Memory**
```promql
process_working_set_bytes{job="truedope-backend"}
```

---

## Phase 15d: Custom Business Metrics (COMPLETED)

### Implemented Metrics

**File:** `TrueDope/backend/src/TrueDope.Api/Services/TrueDopeMetrics.cs`

All custom business metrics are now implemented and instrumented across the application:

| Metric Name | Type | Description |
|-------------|------|-------------|
| `truedope_sessions_created_total` | Counter | Shooting sessions created |
| `truedope_dope_entries_created_total` | Counter | DOPE entries logged |
| `truedope_chrono_sessions_created_total` | Counter | Chronograph sessions logged |
| `truedope_velocity_readings_created_total` | Counter | Velocity readings recorded |
| `truedope_group_entries_created_total` | Counter | Shot groups logged |
| `truedope_rifles_created_total` | Counter | Rifles added |
| `truedope_ammunition_created_total` | Counter | Ammunition records created |
| `truedope_locations_created_total` | Counter | Shooting locations created |
| `truedope_images_uploaded_total` | Counter | Images uploaded (with `parent_type` label) |
| `truedope_image_bytes_uploaded_total` | Counter | Total bytes of images uploaded |
| `truedope_logins_successful_total` | Counter | Successful logins |
| `truedope_logins_failed_total` | Counter | Failed login attempts |
| `truedope_registrations_total` | Counter | New user registrations |
| `truedope_password_resets_total` | Counter | Password reset completions |

### Controllers Instrumented

- **SessionsController:** CreateSession, AddDopeEntry, AddChronoSession, AddVelocityReading, AddGroupEntry
- **RiflesController:** CreateRifle
- **AmmunitionController:** CreateAmmo
- **LocationsController:** CreateLocation
- **AuthController:** Login (success/fail), Register, ResetPassword
- **ImagesController:** UploadImageAsync, BulkUploadImagesAsync

### Metric Initialization

Metrics are initialized at startup in `Program.cs` to ensure they appear in `/metrics` output immediately (even with zero values):

```csharp
var app = builder.Build();
TrueDopeMetrics.Initialize();
```

### Verification

```bash
# Check all TrueDope metrics are exposed
curl http://localhost:8080/metrics | grep truedope_

# Expected output:
truedope_sessions_created_total 0
truedope_dope_entries_created_total 0
truedope_logins_successful_total 5
truedope_logins_failed_total 2
# ... etc
```

---

## Creating the TrueDope Custom Grafana Dashboard

### Step 1: Create New Dashboard

1. In Grafana, go to **Dashboards → New → New Dashboard**
2. Click the gear icon (⚙️) for Dashboard Settings
3. Set **Name:** `TrueDope Overview`
4. Click **Save dashboard**

### Step 2: Add Variables (Optional but Recommended)

1. Dashboard Settings → **Variables** → **Add variable**
2. Add a `timeRange` variable for consistent time range across panels

### Step 3: Build Dashboard Rows

#### Row 1: Application Health (4 Stat Panels)

**Panel 1: Request Rate**
- Type: Stat
- Query: `sum(rate(http_requests_received_total{job="truedope-backend"}[5m]))`
- Unit: requests/sec
- Title: "Request Rate"

**Panel 2: Error Rate**
- Type: Stat
- Query: `sum(rate(http_requests_received_total{job="truedope-backend",code=~"5.."}[5m])) / sum(rate(http_requests_received_total{job="truedope-backend"}[5m])) * 100`
- Unit: percent (0-100)
- Title: "Error Rate"
- Thresholds: Green < 1%, Yellow < 5%, Red >= 5%

**Panel 3: P95 Latency**
- Type: Stat
- Query: `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le)) * 1000`
- Unit: ms
- Title: "P95 Latency"
- Thresholds: Green < 200ms, Yellow < 500ms, Red >= 500ms

**Panel 4: Active Connections**
- Type: Stat
- Query: `sum(http_requests_in_progress{job="truedope-backend"})`
- Title: "In-Flight Requests"

#### Row 2: Business Metrics (4 Stat Panels)

**Panel 1: Sessions Today**
- Type: Stat
- Query: `sum(increase(truedope_sessions_created_total[24h]))`
- Title: "Sessions Today"

**Panel 2: DOPE Entries Today**
- Type: Stat
- Query: `sum(increase(truedope_dope_entries_created_total[24h]))`
- Title: "DOPE Entries Today"

**Panel 3: Logins Today**
- Type: Stat
- Query: `sum(increase(truedope_logins_successful_total[24h]))`
- Title: "Logins Today"

**Panel 4: Failed Logins**
- Type: Stat
- Query: `sum(increase(truedope_logins_failed_total[24h]))`
- Title: "Failed Logins (24h)"
- Thresholds: Green < 10, Yellow < 50, Red >= 50

#### Row 3: Traffic Over Time (2 Time Series Panels)

**Panel 1: Requests by Status Code**
- Type: Time series
- Query: `sum by (code) (rate(http_requests_received_total{job="truedope-backend"}[5m]))`
- Title: "Requests by Status"
- Legend: `{{code}}`

**Panel 2: Requests by Controller**
- Type: Time series
- Query: `sum by (controller) (rate(http_requests_received_total{job="truedope-backend"}[5m]))`
- Title: "Requests by Controller"
- Legend: `{{controller}}`

#### Row 4: Latency Distribution (2 Panels)

**Panel 1: Response Time Percentiles**
- Type: Time series
- Queries:
  - `histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))` - Legend: "p50"
  - `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))` - Legend: "p95"
  - `histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="truedope-backend"}[5m])) by (le))` - Legend: "p99"
- Title: "Response Time Percentiles"
- Unit: seconds

**Panel 2: Slowest Endpoints**
- Type: Bar gauge or Table
- Query: `topk(5, avg by (controller, action) (rate(http_request_duration_seconds_sum{job="truedope-backend"}[5m]) / rate(http_request_duration_seconds_count{job="truedope-backend"}[5m])))`
- Title: "Slowest Endpoints (avg)"

#### Row 5: Business Activity (Time Series)

**Panel 1: Activity Over Time**
- Type: Time series
- Queries:
  - `rate(truedope_sessions_created_total[1h]) * 3600` - Legend: "Sessions/hour"
  - `rate(truedope_dope_entries_created_total[1h]) * 3600` - Legend: "DOPE entries/hour"
  - `rate(truedope_group_entries_created_total[1h]) * 3600` - Legend: "Groups/hour"
- Title: "User Activity"

**Panel 2: Authentication Activity**
- Type: Time series
- Queries:
  - `rate(truedope_logins_successful_total[5m]) * 300` - Legend: "Successful logins"
  - `rate(truedope_logins_failed_total[5m]) * 300` - Legend: "Failed logins"
  - `rate(truedope_registrations_total[5m]) * 300` - Legend: "Registrations"
- Title: "Authentication"

#### Row 6: Infrastructure (3 Panels)

**Panel 1: Database Connections**
- Type: Time series
- Query: `pg_stat_activity_count{job="postgres"}`
- Title: "PostgreSQL Connections"

**Panel 2: Redis Memory**
- Type: Time series
- Query: `redis_memory_used_bytes{job="redis"}`
- Unit: bytes (IEC)
- Title: "Redis Memory"

**Panel 3: Process Memory**
- Type: Time series
- Query: `process_working_set_bytes{job="truedope-backend"}`
- Unit: bytes (IEC)
- Title: "Backend Memory"

### Step 4: Save and Share

1. Click **Save dashboard** (Ctrl+S)
2. Optionally set as default or add to favorites
3. Consider creating a link on the Grafana home dashboard

### Sample PromQL Queries for Additional Panels

```promql
# Total images uploaded by type
sum by (parent_type) (truedope_images_uploaded_total)

# Equipment created this week
sum(increase(truedope_rifles_created_total[7d]))
sum(increase(truedope_ammunition_created_total[7d]))
sum(increase(truedope_locations_created_total[7d]))

# Login success rate
sum(rate(truedope_logins_successful_total[1h])) /
(sum(rate(truedope_logins_successful_total[1h])) + sum(rate(truedope_logins_failed_total[1h]))) * 100

# Chrono vs DOPE activity ratio
sum(rate(truedope_chrono_sessions_created_total[24h])) /
sum(rate(truedope_dope_entries_created_total[24h]))
```

---

## Deployment Steps

### On Development Machine

```bash
cd /Users/tcude/projects/BallisticApp_WebApp_and_iOS_App/TrueDope

# 1. Add the NuGet package
cd backend
dotnet add src/TrueDope.Api package prometheus-net.AspNetCore

# 2. Update Program.cs with metrics middleware (manual edit)

# 3. Create prometheus.yml (manual)

# 4. Update docker-compose.yml (manual edit)

# 5. Commit changes
git add -A
git commit -m "Add Prometheus metrics and monitoring infrastructure"
```

### On Production VM (docker-external01)

```bash
cd /home/tcude/docker/TrueDope

# Pull latest changes
git pull

# Update .env with prod retention settings (one-time)
# PROMETHEUS_RETENTION_TIME=365d
# PROMETHEUS_RETENTION_SIZE=50GB

# Rebuild and restart
docker compose down
docker compose build backend
docker compose up -d

# Verify Prometheus is running
curl http://localhost:9090/api/v1/status/config

# Verify metrics endpoint
curl http://localhost:8080/metrics

# Check all targets are UP
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'
```

### On Monitoring VM (monitoring01)

1. Open Grafana at `http://monitoring01.tcudelocal.net:3000`
2. Add Prometheus data source pointing to `http://docker-external01:9090`
3. Import dashboards (IDs: 10915, 13532, 9628, 763)
4. Create custom TrueDope overview dashboard

---

## Verification Checklist

- [ ] Backend `/metrics` endpoint returns Prometheus metrics
- [ ] Prometheus UI accessible at `docker-external01:9090`
- [ ] Prometheus shows all targets as "UP" in Status → Targets
- [ ] Grafana can query Prometheus data source successfully
- [ ] ASP.NET Core dashboard shows request metrics
- [ ] PostgreSQL dashboard shows database metrics
- [ ] Redis dashboard shows cache metrics
- [ ] Custom business metrics appear in Prometheus

---

## Files Changed/Created

| File | Change | Status |
|------|--------|--------|
| `TrueDope/backend/src/TrueDope.Api/TrueDope.Api.csproj` | Add prometheus-net.AspNetCore package | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Program.cs` | Add metrics middleware, endpoint, and TrueDopeMetrics.Initialize() | ✅ Done |
| `TrueDope/prometheus.yml` | New - Prometheus scrape configuration | ✅ Done |
| `TrueDope/docker-compose.yml` | Add prometheus, postgres-exporter, redis-exporter, node-exporter services | ✅ Done |
| `TrueDope/.env.example` | Add PROMETHEUS_RETENTION_TIME/SIZE variables | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Services/TrueDopeMetrics.cs` | New - Custom business metrics | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Controllers/SessionsController.cs` | Add metric recording for sessions, DOPE, chrono, groups | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Controllers/RiflesController.cs` | Add metric recording for rifle creation | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Controllers/AmmunitionController.cs` | Add metric recording for ammo creation | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Controllers/LocationsController.cs` | Add metric recording for location creation | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Controllers/AuthController.cs` | Add metric recording for login/register/password reset | ✅ Done |
| `TrueDope/backend/src/TrueDope.Api/Controllers/ImagesController.cs` | Add metric recording for image uploads | ✅ Done |

---

## Future Enhancements

1. **Alerting** - Configure Prometheus alerting rules and Grafana alert notifications
2. **SLO Tracking** - Define and track Service Level Objectives (e.g., p99 < 500ms)
3. **Distributed Tracing** - Add OpenTelemetry for request tracing across services
4. **Log-Metric Correlation** - Link Splunk logs with Prometheus metrics via correlation ID
5. **iOS App Metrics** - Add client-side metrics reporting from the iOS app

---

## Estimated Effort

| Phase | Tasks | Time |
|-------|-------|------|
| 15a | Backend Prometheus metrics | 30 min |
| 15b | Prometheus + exporters deployment | 1 hour |
| 15c | Grafana data source + dashboards | 1 hour |
| 15d | Custom business metrics | 2-3 hours |
| **Total** | | **~5 hours** |

---

## References

- [prometheus-net Documentation](https://github.com/prometheus-net/prometheus-net)
- [Prometheus Configuration](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)
- [Grafana Prometheus Data Source](https://grafana.com/docs/grafana/latest/datasources/prometheus/)
- [PostgreSQL Exporter](https://github.com/prometheus-community/postgres_exporter)
- [Redis Exporter](https://github.com/oliver006/redis_exporter)
