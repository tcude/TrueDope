# Priority 2: Pending Sessions Not Showing in Recent Sessions

**Status**: Completed
**Created**: 2026-01-04
**Completed**: 2026-01-04
**Parent Spec**: `20250103.UnifiedGroupMeasurementTool.md`

---

## Problem Statement

When a user creates a session while offline, it gets stored in the `OfflineSessionQueue` as a `PendingSession`. However, these pending sessions **do not appear** in the Recent Sessions section on the Dashboard. This creates a confusing UX where users can't see sessions they just created.

Currently:
- **Sessions List** (`SessionsListView`) correctly shows pending sessions in a "Pending Sync" section
- **Dashboard Recent Sessions** only shows synced sessions from the API
- Users may think their offline session was lost

---

## Current Architecture Analysis

### Dashboard Flow
```
DashboardView
  â””â”€â”€ DashboardViewModel.loadRecentSessions()
        â””â”€â”€ sessionService.getRecentSessions(limit: 5)  // API call only
              â””â”€â”€ Returns [SessionListItem]

RecentSessionsSection(sessions: [SessionListItem])
  â””â”€â”€ Renders only synced sessions
```

### Key Types

**`SessionListItem`** (synced session from API):
```swift
struct SessionListItem: Codable, Identifiable {
    let id: Int                    // Server-assigned integer ID
    let sessionDate: Date
    let rifleName: String
    let locationName: String?
    let dopeCount: Int
    let chronoCount: Int
    let groupCount: Int
}
```

**`PendingSession`** (offline session awaiting sync):
```swift
struct PendingSession: Identifiable, Codable {
    let id: UUID                   // Local UUID
    let rifleSetupId: Int
    let rifleName: String
    let sessionDate: Date
    let locationId: Int?
    let locationName: String?
    let dopeEntries: [CreateDopeEntryRequest]
    let chronoSessions: [CreateChronoSessionRequest]
    let groupEntries: [CreateGroupEntryRequest]
    let createdAt: Date
}
```

### The Problem
- `SessionListItem` uses `Int` id (server-assigned)
- `PendingSession` uses `UUID` id (local)
- `RecentSessionsSection` only accepts `[SessionListItem]`
- `DashboardViewModel` only fetches from API, ignoring `OfflineSessionQueue`

---

## Proposed Solution

### Approach: Union Type with Protocol

Create a `SessionDisplayItem` protocol/enum that can represent either type, allowing the Dashboard to show both synced and pending sessions in the Recent Sessions section.

### Option A: Protocol-Based (Recommended)

```swift
protocol SessionDisplayable: Identifiable {
    var displayId: String { get }
    var sessionDate: Date { get }
    var rifleName: String { get }
    var locationName: String? { get }
    var dopeCount: Int { get }
    var chronoCount: Int { get }
    var groupCount: Int { get }
    var isPending: Bool { get }
}

extension SessionListItem: SessionDisplayable {
    var displayId: String { String(id) }
    var isPending: Bool { false }
}

extension PendingSession: SessionDisplayable {
    var displayId: String { id.uuidString }
    var dopeCount: Int { dopeEntries.count }
    var chronoCount: Int { chronoSessions.count }
    var groupCount: Int { groupEntries.count }
    var isPending: Bool { true }
}
```

### Option B: Enum Wrapper

```swift
enum SessionDisplayItem: Identifiable {
    case synced(SessionListItem)
    case pending(PendingSession)

    var id: String {
        switch self {
        case .synced(let session): return "synced-\(session.id)"
        case .pending(let session): return "pending-\(session.id.uuidString)"
        }
    }

    var isPending: Bool {
        if case .pending = self { return true }
        return false
    }

    // Common accessors...
}
```

---

## Files to Modify

### 1. Create New File: `Core/Models/SessionDisplayable.swift`
- Define `SessionDisplayable` protocol
- Add extensions to `SessionListItem` and `PendingSession`

### 2. Modify: `Features/Dashboard/ViewModels/DashboardViewModel.swift`
- Add property: `@Published var recentDisplaySessions: [any SessionDisplayable] = []`
- Modify `loadRecentSessions()` to:
  1. Fetch synced sessions from API
  2. Get pending sessions from `OfflineSessionQueue.shared`
  3. Merge and sort by date (most recent first)
  4. Take top 5

```swift
func loadRecentSessions() async {
    do {
        let syncedSessions = try await sessionService.getRecentSessions(limit: 5)
        let pendingSessions = OfflineSessionQueue.shared.pendingSessions

        // Merge and sort
        var combined: [any SessionDisplayable] = syncedSessions
        combined.append(contentsOf: pendingSessions)
        combined.sort { $0.sessionDate > $1.sessionDate }

        await MainActor.run {
            self.recentDisplaySessions = Array(combined.prefix(5))
        }
    } catch {
        // Handle error...
    }
}
```

### 3. Modify: `Features/Dashboard/Components/RecentSessionsSection.swift`
- Change from `sessions: [SessionListItem]` to `sessions: [any SessionDisplayable]`
- Add visual indicator for pending sessions (similar to `PendingBadge`)
- Handle navigation differently for pending vs synced (pending can't navigate to detail yet)

```swift
struct RecentSessionsSection: View {
    let sessions: [any SessionDisplayable]

    var body: some View {
        ForEach(sessions, id: \.displayId) { session in
            if session.isPending {
                PendingSessionRow(session: session)
            } else {
                NavigationLink(value: /* synced session */) {
                    SessionRow(session: session)
                }
            }
        }
    }
}
```

### 4. Modify: `Features/Dashboard/DashboardView.swift`
- Update to use `recentDisplaySessions` instead of `recentSessions`
- Listen for `OfflineSessionQueue` changes to refresh

---

## Visual Design

### Pending Session Row
- Same layout as synced session row
- Add "Pending" badge (yellow/orange) similar to `PendingBadge`
- Slightly muted colors to indicate not yet synced
- No navigation (or navigate to read-only pending view)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”« Rifle Name                    [Pending] â”‚
â”‚ ğŸ“ Location Name (or "No location")        â”‚
â”‚ ğŸ“… Jan 4, 2026                             â”‚
â”‚ 3 DOPE â€¢ 0 Chrono â€¢ 1 Group                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Steps

1. **Create `SessionDisplayable.swift`**
   - Define protocol with common properties
   - Add extensions to both session types

2. **Update `DashboardViewModel`**
   - Add merged sessions property
   - Modify load function to include pending
   - Add listener for queue changes

3. **Update `RecentSessionsSection`**
   - Accept protocol type
   - Add pending visual treatment
   - Handle tap differently for pending

4. **Update `DashboardView`**
   - Wire up new property
   - Add notification observer for refresh

5. **Test scenarios**:
   - Dashboard with only synced sessions
   - Dashboard with only pending sessions
   - Dashboard with mix of both
   - Pending session syncs â†’ row updates to synced style
   - Create offline session â†’ appears immediately in Recent

---

## Edge Cases to Handle

1. **Pending session syncs while on Dashboard**
   - Should transition from pending to synced appearance
   - Listen for `.offlineSessionsSynced` notification

2. **More than 5 pending sessions**
   - Still show max 5 most recent (mixed)
   - "View All" goes to Sessions list which shows all

3. **Pending session has entries added while offline**
   - Counts should reflect queued entries from `PendingEntryQueue`

4. **Network error during sync**
   - Session remains pending with same appearance

---

## Related Files Reference

| File | Purpose |
|------|---------|
| `Models/Session.swift` | `SessionListItem` definition |
| `Core/Services/OfflineSessionQueue.swift` | `PendingSession` storage |
| `Features/Dashboard/DashboardView.swift` | Dashboard container |
| `Features/Dashboard/ViewModels/DashboardViewModel.swift` | Data loading |
| `Features/Dashboard/Components/RecentSessionsSection.swift` | Session list UI |
| `Features/Sessions/SessionsListView.swift` | Reference for pending display |
| `Core/UI/PendingBadge.swift` | Existing pending badge component |

---

## Success Criteria

- [x] Pending sessions appear in Dashboard Recent Sessions
- [x] Visual distinction between pending and synced sessions
- [x] Sorted by date (newest first) regardless of pending/synced
- [x] Pending sessions update to synced when sync completes
- [x] Creating offline session immediately shows in Recent
- [x] No navigation errors when tapping pending session

---

## Notes

This is a **UX improvement** with **medium complexity**. The main challenge is the type mismatch between `SessionListItem` (Int id) and `PendingSession` (UUID id), which requires introducing a unifying abstraction.

The protocol-based approach (Option A) is recommended because:
- Cleaner syntax in views
- Easier to extend
- Works well with SwiftUI's `ForEach`
- Matches existing patterns in codebase
